<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bluestar Bus – Live Departures</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
  <div class="max-w-xl mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">Bluestar Bus – Live Departures</h1>

    <div class="flex items-center mb-2">
      <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
      <span>ÉLŐ – BODS SIRI-VM</span>
    </div>

    <label class="block text-sm mb-1">Megálló neve</label>
    <div class="flex mb-2">
      <input id="stopName" type="text"
             class="flex-1 px-2 py-1 rounded text-black"
             placeholder="Írj be egy megállónevet...">
      <button onclick="searchStops()"
              class="ml-2 px-3 py-1 bg-blue-600 rounded">Keresés</button>
    </div>

    <div id="stopResults" class="space-y-1 mb-3"></div>

    <label class="block text-sm mb-1">Időablak (perc)</label>
    <input id="minutes" type="number" value="60"
           class="w-24 px-2 py-1 rounded text-black mb-2">

    <label class="block text-sm mb-1">Stop ID</label>
    <input id="stopId" type="text"
           class="w-full px-2 py-1 rounded text-black mb-3">

    <div class="flex space-x-2 mb-4">
      <button onclick="loadDepartures()"
              class="px-3 py-2 bg-blue-600 rounded">Indulások lekérése</button>
      <button onclick="clearResults()"
              class="px-3 py-2 bg-gray-600 rounded">Törlés</button>
    </div>

    <h2 class="text-xl font-semibold mb-2">Indulások</h2>
    <table class="w-full text-left border-collapse">
      <thead>
        <tr class="border-b border-gray-700">
          <th class="py-1">Route</th>
          <th class="py-1">Destination</th>
          <th class="py-1">Time</th>
        </tr>
      </thead>
      <tbody id="departuresTable"></tbody>
    </table>
  </div>

  <script>
    async function searchStops() {
      const q = document.getElementById("stopName").value.trim();
      if (!q) return;
      const res = await fetch(`/api/search_stops?q=${encodeURIComponent(q)}`);
      const data = await res.json();
      const box = document.getElementById("stopResults");
      box.innerHTML = "";
      data.forEach(st => {
        const btn = document.createElement("button");
        btn.className = "block w-full text-left px-2 py-1 bg-gray-800 rounded hover:bg-gray-700";
        btn.textContent = st.label;
        btn.onclick = () => {
          document.getElementById("stopId").value = st.stop_id;
          document.getElementById("stopName").value = st.name;
          box.innerHTML = "";
        };
        box.appendChild(btn);
      });
    }

    async function loadDepartures() {
      const stopId = document.getElementById("stopId").value.trim();
      const minutes = document.getElementById("minutes").value.trim() || "60";
      if (!stopId) return alert("Adj meg egy Stop ID-t!");
      const res = await fetch(`/api/departures?stop_id=${stopId}&minutes=${minutes}`);
      const data = await res.json();
      renderDepartures(data.departures || []);
    }

    function clearResults() {
      document.getElementById("departuresTable").innerHTML = "";
    }

    function renderDepartures(list) {
      const tbody = document.getElementById("departuresTable");
      tbody.innerHTML = "";
      if (!list.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 3;
        td.textContent = "Nincs indulás ebben az időablakban.";
        td.className = "py-2 text-gray-400";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }
      list.forEach(dep => {
        const tr = document.createElement("tr");
        tr.className = "border-b border-gray-800";
        const tdRoute = document.createElement("td");
        tdRoute.className = "py-1";
        tdRoute.textContent = dep.route;

        const tdDest = document.createElement("td");
        tdDest.className = "py-1";
        tdDest.textContent = dep.destination;

        const tdTime = document.createElement("td");
        tdTime.className = "py-1";
        tdTime.innerHTML = dep.time + (dep.live ? " <span class='text-green-400'>✅</span>" : " ⏰");

        tr.appendChild(tdRoute);
        tr.appendChild(tdDest);
        tr.appendChild(tdTime);
        tbody.appendChild(tr);
      });
    }
  </script>
</body>
</html>
