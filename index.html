<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Bluestar Bus – Live Departures</title>
  <style>
    :root{
      --bg:#0b0e12; --panel:#121723; --text:#e6eaf2; --muted:#98a3b8;
      --accent:#3b82f6; --accent2:#63f5a1; --row:#0e1420;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:900px;margin:32px auto;padding:0 16px}
    .card{background:var(--panel);border-radius:16px;padding:24px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    h1{margin:0 0 12px;font-weight:750;letter-spacing:.2px}
    .badge{display:inline-flex;align-items:center;gap:8px;background:#0f1e16;color:var(--accent2);border:1px solid #1c5d3b;border-radius:999px;padding:4px 10px;font-size:12px;font-weight:700}
    .grid{display:grid;grid-template-columns:1fr auto;gap:12px;margin-top:16px}
    label{display:block;font-size:13px;color:var(--muted);margin:12px 0 6px}
    input{width:100%;background:#0b1220;color:var(--text);border:1px solid #1b2740;border-radius:10px;padding:12px 14px;font-size:15px;outline:none}
    input:focus{border-color:#365bb5}
    .btn{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .row{display:flex;gap:12px;align-items:end;margin-top:6px;flex-wrap:wrap}
    .pill{background:#0f1422;border:1px solid #1b2740;border-radius:10px;padding:10px 12px;color:var(--muted);font-size:13px}
    .results{margin-top:8px}
    .result{background:#0c1322;border:1px solid #1b2740;border-radius:10px;padding:10px 12px;margin-top:8px;cursor:pointer}
    .result:hover{border-color:#2e467f}
    table{width:100%;border-collapse:collapse;margin-top:20px;overflow:hidden;border-radius:12px}
    thead th{background:#0c1322;color:#cbd5e1;text-align:left;padding:12px 10px;font-weight:700}
    tbody td{padding:12px 10px;border-top:1px solid #12203b;background:var(--row)}
    .live{background:#112b1c;color:var(--accent2);border:1px solid #1c5d3b;border-radius:8px;padding:2px 8px;font-size:11px;margin-left:8px;font-weight:800}
    .hint{color:var(--muted);font-size:13px;margin-top:6px}
    .error{color:#ffb4b4}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Bluestar Bus – Live Departures</h1>
      <div class="badge">ÉLŐ – BODS SIRI-VM</div>

      <label for="q">Megálló neve</label>
      <div class="grid">
        <input id="q" placeholder="pl. Vincents Walk">
        <button class="btn" id="btnSearch">Keresés</button>
      </div>
      <div id="searchResults" class="results"></div>

      <div class="row">
        <div style="flex:1">
          <label for="minutes">Időablak (perc)</label>
          <input id="minutes" value="60" inputmode="numeric">
        </div>
        <div style="flex:2">
          <label for="stopId">Stop ID</label>
          <input id="stopId" placeholder="pl. 1980SN12619E">
          <div class="hint">Tipp: találatra kattintva ez automatikusan kitöltődik.</div>
        </div>
        <div style="flex:0">
          <label>&nbsp;</label>
          <button class="btn" id="btnFetch">Indulások lekérése</button>
        </div>
      </div>

      <table>
        <thead>
        <tr><th>Route</th><th>Destination</th><th>Time</th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div id="err" class="hint error"></div>
      <div id="src" class="hint"></div>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const q = $('#q'), stopId = $('#stopId'), minutes = $('#minutes');
    const results = $('#searchResults'), tb = $('#tbody'), err = $('#err'), src = $('#src');

    async function searchStops() {
      results.innerHTML = ''; err.textContent = '';
      const term = q.value.trim();
      if (!term) { err.textContent = 'Adj meg egy megálló nevet.'; return; }
      try {
        const r = await fetch(`/search_stops?q=${encodeURIComponent(term)}`);
        if (!r.ok) throw new Error('search HTTP ' + r.status);
        const data = await r.json();
        if (!data.results || data.results.length === 0) {
          results.innerHTML = '<div class="hint">Nincs találat erre a névre.</div>';
          return;
        }
        data.results.forEach(s => {
          const div = document.createElement('div');
          div.className = 'result';
          div.textContent = `${s.stop_name} (${s.stop_id})`;
          div.title = 'Kattints a kiválasztáshoz';
          div.onclick = () => {
            stopId.value = s.stop_id;
            // plusz: a leggyakoribb stop_id kiválasztása után kérhet indulás listát is
          };
          results.appendChild(div);
        });
      } catch (e) {
        err.textContent = 'Hiba a keresés közben. Próbáld újra.';
      }
    }

    async function fetchDeps() {
      tb.innerHTML = ''; err.textContent = ''; src.textContent = '';
      const id = (stopId.value||'').trim();
      const mins = parseInt((minutes.value||'60'),10) || 60;
      if (!id) { err.textContent = 'Adj meg Stop ID-t.'; return; }
      try {
        const r = await fetch(`/next_departures/${encodeURIComponent(id)}?minutes=${mins}`);
        if (!r.ok) throw new Error('deps HTTP ' + r.status);
        const data = await r.json();
        const list = data.departures || [];
        if (list.length === 0) {
          tb.innerHTML = `<tr><td colspan="3" class="hint">Nincs indulás ebben az időablakban.</td></tr>`;
          return;
        }
        list.forEach(d => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${d.route ?? ''}</td>
            <td>${d.destination ?? ''}</td>
            <td>${d.departure_time ?? ''}${d.realtime ? ' <span class="live">ÉLŐ</span>' : ''}</td>
          `;
          tb.appendChild(tr);
        });
        src.textContent = 'Powered by Bluestar GTFS (menetrend) + BODS SIRI-VM (élő).';
      } catch (e) {
        err.textContent = 'Hiba az indulások lekérése közben. Próbáld újra.';
      }
    }

    $('#btnSearch').onclick = searchStops;
    $('#btnFetch').onclick  = fetchDeps;

    // Enterre is menjen a keresés/lekérés
    q.addEventListener('keydown',   ev => { if (ev.key === 'Enter') searchStops(); });
    stopId.addEventListener('keydown', ev => { if (ev.key === 'Enter') fetchDeps(); });
    minutes.addEventListener('keydown', ev => { if (ev.key === 'Enter') fetchDeps(); });
  </script>
</body>
</html>
