<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bluestar menetrend √©s meg√°ll√≥ keres≈ë</title>

<!-- Leaflet (t√©rk√©p) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<style>
:root{
  --bg:#0b1020;
  --card:#121936;
  --muted:#9aa4c7;
  --text:#e8ecff;
  --accent:#b9b8ff;
  --primary:#a9b2ff;
  --chip:#2a346b;
  --ok:#33d17a;
  --warn:#ffd829;
  --late:#ff6b6b;
  --line:#243066;
}
*{box-sizing:border-box}
body{
  margin:0;background:var(--bg);color:var(--text);font:16px/1.45 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
}
.container{max-width:980px;margin:24px auto;padding:0 16px}
.header{display:flex;align-items:center;gap:12px;margin-bottom:8px}
.header h1{font-size:clamp(22px,4vw,36px);margin:0 0 2px;font-weight:800}
.sub{color:var(--muted);font-size:14px}

.langs{display:flex;gap:10px;align-items:center;margin:10px 0 18px}
.flag-btn{border:0;background:transparent;font-size:22px;filter:saturate(0.9);cursor:pointer;opacity:.85}
.flag-btn.active{transform:translateY(-1px);opacity:1}
.settings-btn{margin-left:auto;background:var(--primary);color:#0b0f26;border:0;border-radius:14px;padding:10px 16px;font-weight:700;cursor:pointer}

.tabs{display:flex;gap:10px;margin:8px 0 16px}
.tab{padding:10px 16px;border-radius:12px;background:#141b3c;color:#c7cffb;cursor:pointer}
.tab.active{background:#202a59;color:#fff}

.card{background:var(--card);border-radius:16px;padding:14px 14px 10px;box-shadow:0 10px 30px rgba(0,0,0,.22);margin-bottom:14px}
.row{display:flex;gap:10px;align-items:center}
input[type="text"],input[type="number"]{
  width:100%;background:#0f1531;border:1px solid #1f2a5c;border-radius:12px;color:var(--text);
  padding:14px 14px;font-size:16px;outline:none
}
.btn{background:var(--primary);color:#0b0f26;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
.btn:disabled{opacity:.6;cursor:not-allowed}
.list{margin:10px 0 4px;display:flex;flex-direction:column;gap:10px}

.item{display:flex;gap:14px;align-items:center;justify-content:space-between;background:#0f1633;border:1px solid #1b2452;border-radius:14px;padding:12px 14px}
.badge{background:var(--chip);color:#d6dbff;border-radius:10px;padding:6px 10px;font-weight:800;min-width:38px;text-align:center}
.title{font-weight:800}
.subtle{color:var(--muted);font-size:13px}

.kpi{display:flex;gap:8px;align-items:center}
.kpi .live{color:var(--ok);font-weight:900}
.kpi .sch{color:#fff;font-weight:900}
.chip{background:var(--chip);border-radius:999px;padding:4px 8px;font-size:12px}
.chip.ok{background:rgba(51,209,122,.15);color:var(--ok);border:1px solid rgba(51,209,122,.35)}
.chip.warn{background:rgba(255,216,41,.15);color:var(--warn);border:1px solid rgba(255,216,41,.35)}
.chip.late{background:rgba(255,107,107,.15);color:var(--late);border:1px solid rgba(255,107,107,.35)}

.star{background:#2a2f55;border:1px solid #3c4482;color:#cfd6ff;border-radius:10px;padding:6px 9px;cursor:pointer}
.star.active{background:#ffd829;color:#302400;border-color:#ffd829}

.blink{animation:blink 1s steps(1,end) infinite}
@keyframes blink{50%{opacity:.25}}

.toast{
  position:fixed;left:16px;right:16px;bottom:16px;background:#2a0f12;color:#ffd7d7;
  border:1px solid #7a222a;border-radius:12px;padding:12px 14px;display:none;z-index:10
}
.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.62);display:none;align-items:center;justify-content:center;z-index:20
}
.modal .sheet{background:var(--card);border:1px solid #26306e;border-radius:18px;padding:16px;max-width:520px;width:92%}
.sheet h3{margin:4px 0 10px}
.sheet .row{margin:8px 0}
.sheet .foot{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}

#map{height:380px;border-radius:16px;border:1px solid #1b2452;margin-top:10px}
.small{font-size:12px;color:var(--muted)}
hr.sep{border:none;border-top:1px solid #1b2452;margin:8px 0}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div style="font-size:28px">üöå</div>
    <div>
      <h1 id="title">Bluestar menetrend √©s meg√°ll√≥ keres≈ë</h1>
      <div class="sub" id="ukTime">UK: --:--</div>
    </div>
  </div>

  <div class="langs">
    <button class="flag-btn" data-lang="en" title="English">üá¨üáß</button>
    <button class="flag-btn" data-lang="hu" title="Magyar">üá≠üá∫</button>
    <button class="flag-btn" data-lang="de" title="Deutsch">üá©üá™</button>
    <button class="flag-btn" data-lang="fr" title="Fran√ßais">üá´üá∑</button>
    <button class="flag-btn" data-lang="pl" title="Polski">üáµüá±</button>
    <button class="flag-btn" data-lang="ro" title="Rom√¢nƒÉ">üá∑üá¥</button>
    <button class="settings-btn" id="btnSettings">‚öôÔ∏è <span data-i18n="settings">Be√°ll√≠t√°sok</span></button>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="stop"><span data-i18n="tab_stop">Meg√°ll√≥</span></div>
    <div class="tab" data-tab="route"><span data-i18n="tab_route">Viszonylat</span></div>
    <div class="tab" data-tab="fav"><span data-i18n="tab_fav">Kedvencek</span></div>
  </div>

  <!-- STOP SEARCH -->
  <div class="card" id="panel-stop">
    <div class="row">
      <input id="stopQuery" type="text" placeholder="Shirley / stop code‚Ä¶" />
      <button class="btn" id="btnStopSearch" data-i18n="search">Keres√©s</button>
    </div>
    <div class="list" id="stopResults"></div>
    <div id="selectedStopWrap" style="display:none">
      <hr class="sep"/>
      <div class="row">
        <div>
          <div class="title" id="selStopName"></div>
          <div class="subtle small" id="selStopMeta"></div>
          <div class="small" id="selStopRefresh"></div>
        </div>
        <button id="btnFavStop" class="star">‚òÖ</button>
      </div>
      <div class="list" id="departures"></div>
      <div id="tripWrap" style="display:none">
        <hr class="sep"/>
        <div class="title" data-i18n="trip_title">J√°rat r√©szletek</div>
        <div id="tripMeta" class="subtle small"></div>
        <div id="tripStops" class="list"></div>
        <div id="map"></div>
      </div>
    </div>
  </div>

  <!-- ROUTE SEARCH -->
  <div class="card" id="panel-route" style="display:none">
    <div class="row">
      <input id="routeQuery" type="text" placeholder="17 / U1 / Langley‚Ä¶" />
      <button class="btn" id="btnRouteSearch" data-i18n="search">Keres√©s</button>
    </div>
    <div class="list" id="routeResults"></div>
  </div>

  <!-- FAVOURITES -->
  <div class="card" id="panel-fav" style="display:none">
    <div class="list" id="favList"></div>
    <div class="small subtle" data-i18n="fav_hint">A kedvencekhez csillagozd be a meg√°ll√≥t.</div>
  </div>

  <div class="toast" id="toast"></div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal" id="modal">
  <div class="sheet">
    <h3 data-i18n="settings">Be√°ll√≠t√°sok</h3>
    <div class="row">
      <label class="small" style="min-width:180px" for="apiBase" data-i18n="api_base">API el√©r√©si √∫t (√ºres = ugyanarr√≥l a domainr≈ël)</label>
      <input id="apiBase" type="text" placeholder="/api" />
    </div>
    <div class="row">
      <label class="small" style="min-width:180px" for="refreshSec" data-i18n="refresh">Friss√≠t√©si id≈ë (mp)</label>
      <input id="refreshSec" type="number" min="5" max="120" step="1" />
    </div>
    <div class="row">
      <label class="small" style="min-width:180px" for="lookahead" data-i18n="lookahead">El≈ëretekint√©si ablak (perc)</label>
      <input id="lookahead" type="number" min="15" max="240" step="5" />
    </div>
    <div class="foot">
      <button class="btn" id="btnCancel" data-i18n="cancel">M√©gse</button>
      <button class="btn" id="btnSave" data-i18n="save">Ment√©s</button>
    </div>
    <div class="small subtle">v<span id="ver">-</span></div>
  </div>
</div>

<script>
/* ========= i18n ========= */
const I18N = {
  en:{ title:"Bluestar timetable & stop finder", settings:"Settings",
       tab_stop:"Stop", tab_route:"Route", tab_fav:"Favourites",
       search:"Search", fav_hint:"Star a stop to save it.",
       api_base:"API base (empty = same origin)", refresh:"Refresh (s)",
       lookahead:"Lookahead window (min)", cancel:"Cancel", save:"Save",
       results:"Results", trip_title:"Trip details", open:"Open",
       no_results:"No results", selected_stop:"Selected stop",
       due:"DUE", ontime:"on time", late:"late", early:"early",
       live_refresh:"Refresh: {s}s ‚Ä¢ Build: {b}"
  },
  hu:{ title:"Bluestar menetrend √©s meg√°ll√≥ keres≈ë", settings:"Be√°ll√≠t√°sok",
       tab_stop:"Meg√°ll√≥", tab_route:"Viszonylat", tab_fav:"Kedvencek",
       search:"Keres√©s", fav_hint:"A kedvencekhez csillagozd be a meg√°ll√≥t.",
       api_base:"API el√©r√©si √∫t (√ºres = ugyanarr√≥l a domainr≈ël)",
       refresh:"Friss√≠t√©si id≈ë (mp)", lookahead:"El≈ëretekint√©si ablak (perc)",
       cancel:"M√©gse", save:"Ment√©s", results:"Tal√°latok",
       trip_title:"J√°rat r√©szletek", open:"Megnyit", no_results:"Nincs tal√°lat",
       selected_stop:"Kiv√°lasztott meg√°ll√≥",
       due:"DUE", ontime:"id≈ëben", late:"k√©s√©s", early:"kor√°bban",
       live_refresh:"Friss√≠t√©s: {s} s ‚Ä¢ Build: {b}"
  },
  de:{ title:"Bluestar Fahrpl√§ne & Haltestellensuche", settings:"Einstellungen",
       tab_stop:"Haltestelle", tab_route:"Linie", tab_fav:"Favoriten",
       search:"Suchen", fav_hint:"Markiere eine Haltestelle mit ‚òÖ.",
       api_base:"API-Basis (leer = gleiche Domain)", refresh:"Aktualisierung (s)",
       lookahead:"Vorschau (Min)", cancel:"Abbrechen", save:"Speichern",
       results:"Treffer", trip_title:"Fahrt-Details", open:"√ñffnen",
       no_results:"Keine Treffer", selected_stop:"Gew√§hlte Haltestelle",
       due:"DUE", ontime:"p√ºnktlich", late:"sp√§t", early:"fr√ºher",
       live_refresh:"Aktualisierung: {s}s ‚Ä¢ Build: {b}"
  },
  fr:{ title:"Bluestar horaires & recherche d'arr√™t", settings:"R√©glages",
       tab_stop:"Arr√™t", tab_route:"Ligne", tab_fav:"Favoris",
       search:"Rechercher", fav_hint:"Ajoutez ‚òÖ pour enregistrer l'arr√™t.",
       api_base:"Base API (vide = m√™me domaine)", refresh:"Rafra√Æchissement (s)",
       lookahead:"Fen√™tre (min)", cancel:"Annuler", save:"Enregistrer",
       results:"R√©sultats", trip_title:"D√©tails du trajet", open:"Ouvrir",
       no_results:"Aucun r√©sultat", selected_stop:"Arr√™t s√©lectionn√©",
       due:"DUE", ontime:"√† l'heure", late:"en retard", early:"en avance",
       live_refresh:"Rafra√Æch.: {s}s ‚Ä¢ Build: {b}"
  },
  pl:{ title:"Bluestar rozk≈Çad i wyszukiwarka przystank√≥w", settings:"Ustawienia",
       tab_stop:"Przystanek", tab_route:"Linia", tab_fav:"Ulubione",
       search:"Szukaj", fav_hint:"Zapisz przystanek klikajƒÖc ‚òÖ.",
       api_base:"Adres API (puste = ten sam host)", refresh:"Od≈õwie≈ºanie (s)",
       lookahead:"Horyzont (min)", cancel:"Anuluj", save:"Zapisz",
       results:"Wyniki", trip_title:"Szczeg√≥≈Çy kursu", open:"Otw√≥rz",
       no_results:"Brak wynik√≥w", selected_stop:"Wybrany przystanek",
       due:"DUE", ontime:"punktualnie", late:"op√≥≈∫nienie", early:"wcze≈õniej",
       live_refresh:"Od≈õwie≈ºanie: {s}s ‚Ä¢ Build: {b}"
  },
  ro:{ title:"Bluestar orar & cƒÉutare sta»õii", settings:"SetƒÉri",
       tab_stop:"Sta»õie", tab_route:"Linie", tab_fav:"Favorite",
       search:"CautƒÉ", fav_hint:"SalveazƒÉ sta»õia cu ‚òÖ.",
       api_base:"Baza API (gol = acela»ôi domeniu)", refresh:"Re√ÆmprospƒÉtare (s)",
       lookahead:"FereastrƒÉ (min)", cancel:"AnuleazƒÉ", save:"SalveazƒÉ",
       results:"Rezultate", trip_title:"Detalii cursƒÉ", open:"Deschide",
       no_results:"FƒÉrƒÉ rezultate", selected_stop:"Sta»õie selectatƒÉ",
       due:"DUE", ontime:"la timp", late:"√Ænt√¢rziere", early:"mai devreme",
       live_refresh:"Refresh: {s}s ‚Ä¢ Build: {b}"
  }
};
let lang = localStorage.getItem("lang") || "hu";
function t(key){ return (I18N[lang] && I18N[lang][key]) || I18N["en"][key] || key; }
function applyI18n(){
  document.getElementById("title").textContent = t("title");
  document.querySelectorAll("[data-i18n]").forEach(el => el.textContent = t(el.dataset.i18n));
  document.querySelectorAll(".flag-btn").forEach(b=>b.classList.toggle("active", b.dataset.lang===lang));
}
applyI18n();

/* ========= √°llapot ========= */
const state = {
  api: localStorage.getItem("apiBase") || "/api",
  refreshSec: +(localStorage.getItem("refreshSec") || 10),
  lookahead: +(localStorage.getItem("lookahead") || 60),
  build:"-",
  drift:0, // server-now - client-now
  selectedStop:null,
  selectedStopMeta:null,
  tickHandle:null,
  map:null, mapLayer:null, shapeLayer:null, vehiclesLayer:null,
  lastVehiclesRoute:null,
};

/* ========= util ========= */
const $ = sel => document.querySelector(sel);
function toast(msg){ const el=$("#toast"); el.textContent=msg; el.style.display="block"; setTimeout(()=>el.style.display="none", 3500); }
function fmtHM(ts){ const d=new Date(ts*1000); return d.toTimeString().slice(0,5); }
function mins(x){ return Math.round(x/60); }
function pad2(n){ return n<10?"0"+n:""+n; }
function sinceServerNow(){ return Math.floor(Date.now()/1000 + state.drift); }

/* ========= status poll ========= */
async function loadStatus(){
  try{
    const r = await fetch(state.api+"/status");
    const j = await r.json();
    state.build = j.build || "-";
    const serverNow = Math.floor(Date.now()/1000);
    // j.time is string HH:MM:SS in server TZ ‚Äì only show
    $("#ukTime").textContent = "UK: " + (j.time || "--:--");
    applyI18n();
  }catch(e){}
}
loadStatus(); setInterval(loadStatus, 30000);

/* ========= be√°ll√≠t√°sok ========= */
$("#btnSettings").onclick=()=>{
  $("#apiBase").value = state.api;
  $("#refreshSec").value = state.refreshSec;
  $("#lookahead").value = state.lookahead;
  $("#ver").textContent = state.build;
  $("#modal").style.display="flex";
};
$("#btnCancel").onclick=()=>$("#modal").style.display="none";
$("#btnSave").onclick=()=>{
  state.api = ($("#apiBase").value||"/api").trim();
  state.refreshSec = Math.max(5, Math.min(120, +$("#refreshSec").value||10));
  state.lookahead = Math.max(15, Math.min(240, +$("#lookahead").value||60));
  localStorage.setItem("apiBase", state.api);
  localStorage.setItem("refreshSec", state.refreshSec);
  localStorage.setItem("lookahead", state.lookahead);
  $("#modal").style.display="none";
  if(state.selectedStop) refreshDepartures(true);
};

/* ========= nyelv ========= */
document.querySelectorAll(".flag-btn").forEach(btn=>{
  btn.onclick=()=>{ lang=btn.dataset.lang; localStorage.setItem("lang", lang); applyI18n(); };
});

/* ========= tabok ========= */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.onclick=()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    tab.classList.add("active");
    const name=tab.dataset.tab;
    $("#panel-stop").style.display = (name==="stop")?"block":"none";
    $("#panel-route").style.display = (name==="route")?"block":"none";
    $("#panel-fav").style.display = (name==="fav")?"block":"none";
  };
});

/* ========= kedvencek ========= */
function loadFavs(){
  try{ return JSON.parse(localStorage.getItem("favs")||"[]"); }catch{return []}
}
function saveFavs(v){ localStorage.setItem("favs", JSON.stringify(v)); renderFavs(); }
function renderFavs(){
  const box=$("#favList"); box.innerHTML="";
  const favs=loadFavs();
  if(!favs.length){ box.innerHTML=`<div class="subtle">${t("no_results")}</div>`; return; }
  favs.forEach(f=>{
    const row=document.createElement("div"); row.className="item";
    row.innerHTML=`<div><div class="title">${f.name}</div><div class="subtle small">${f.stop_id}${f.code?(" ‚Ä¢ "+f.code):""}</div></div>
      <div class="row">
        <button class="btn open">${t("open")}</button>
        <button class="star del">üóë</button>
      </div>`;
    row.querySelector(".open").onclick=()=>openStop(f.stop_id, f.name, f.code, f.lat, f.lon);
    row.querySelector(".del").onclick=()=>saveFavs(favs.filter(x=>x.stop_id!==f.stop_id));
    box.appendChild(row);
  });
}
renderFavs();

/* ========= meg√°ll√≥ keres≈ë ========= */
$("#btnStopSearch").onclick = async ()=>{
  const q = $("#stopQuery").value.trim();
  if(!q){ toast(t("no_results")); return; }
  try{
    const r = await fetch(state.api+"/stops/search?q="+encodeURIComponent(q));
    const j = await r.json();
    const list = $("#stopResults"); list.innerHTML="";
    const items = (j && j.results) || [];
    if(!items.length){ list.innerHTML=`<div class="subtle">${t("no_results")}</div>`; return; }
    items.forEach(s=>{
      const row=document.createElement("div"); row.className="item";
      row.innerHTML = `
        <div class="row" style="gap:12px">
          <div class="badge">BUS</div>
          <div>
            <div class="title">${s.name}</div>
            <div class="subtle small">ID: ${s.stop_id}${s.code?(" ‚Ä¢ "+s.code):""}</div>
          </div>
        </div>
        <div class="row">
          <button class="star fav">‚òÖ</button>
          <button class="btn open">${t("open")}</button>
        </div>`;
      row.querySelector(".open").onclick=()=>openStop(s.stop_id, s.name, s.code, s.lat, s.lon);
      row.querySelector(".fav").onclick=()=>{
        const favs=loadFavs();
        if(!favs.find(x=>x.stop_id===s.stop_id)){
          favs.push(s); saveFavs(favs);
        }
      };
      list.appendChild(row);
    });
  }catch(e){ toast("Stop search failed."); }
};

/* ========= meg√°ll√≥ megnyit√°sa & indul√°sok ========= */
async function openStop(stop_id, name, code, lat, lon){
  state.selectedStop = stop_id;
  state.selectedStopMeta = {name, code, lat, lon};
  $("#stopResults").innerHTML="";
  $("#selectedStopWrap").style.display="block";
  $("#selStopName").textContent = name;
  $("#selStopMeta").textContent = `${t("selected_stop")}: ${stop_id}${code?(" ‚Ä¢ "+code):""}`;
  const favs=loadFavs();
  $("#btnFavStop").classList.toggle("active", !!favs.find(x=>x.stop_id===stop_id));
  $("#btnFavStop").onclick=()=>{
    const f=loadFavs();
    const idx=f.findIndex(x=>x.stop_id===stop_id);
    if(idx===-1){ f.push({stop_id,name,code,lat,lon}); } else { f.splice(idx,1); }
    saveFavs(f);
    $("#btnFavStop").classList.toggle("active", idx===-1);
  };
  refreshDepartures(true);
}

function etaText(item, now){
  const base = item.predicted_epoch || item.scheduled_epoch;
  let diff = base - now;
  if(diff <= 60) return `<span class="live blink">${t("due")}</span>`;
  const m = Math.floor(diff/60);
  return `<span class="${item.live?'live':'sch'}">${m} min</span>`;
}
function delayChip(item){
  if(item.delay_sec==null) return `<span class="chip ok">${t("ontime")}</span>`;
  const m = Math.round(item.delay_sec/60);
  if(Math.abs(m)<=0) return `<span class="chip ok">${t("ontime")}</span>`;
  if(m>0) return `<span class="chip late">+${m} ${t("late")}</span>`;
  return `<span class="chip warn">${m} ${t("early")}</span>`;
}

async function refreshDepartures(first=false){
  if(!state.selectedStop) return;
  if(first && state.tickHandle){ clearInterval(state.tickHandle); state.tickHandle=null; }

  try{
    const r = await fetch(`${state.api}/departures?stopId=${encodeURIComponent(state.selectedStop)}&lookahead_mins=${state.lookahead}`);
    const j = await r.json();
    // drift
    const clientNow = Math.floor(Date.now()/1000);
    state.drift = (j.now_epoch||clientNow) - clientNow;

    // header info
    $("#selStopRefresh").textContent = t("live_refresh").replace("{s}", state.refreshSec).replace("{b}", state.build);

    const box = $("#departures"); box.innerHTML="";
    (j.items||[]).forEach(d=>{
      const row=document.createElement("div"); row.className="item";
      row.innerHTML=`
        <div class="row" style="gap:12px">
          <div class="badge">${d.route||"‚Äî"}</div>
          <div>
            <div class="title">${d.headsign||""}</div>
            <div class="subtle small">${t("selected_stop")} ‚Ä¢ ${fmtHM(d.scheduled_epoch)}</div>
          </div>
        </div>
        <div class="kpi">
          <div class="when">${etaText(d, sinceServerNow())}</div>
          <div class="chipline">${delayChip(d)}</div>
          <button class="star openTrip" title="Trip">‚§≥</button>
        </div>`;
      row.querySelector(".openTrip").onclick=()=>openTrip(d.trip_id, d.route);
      box.appendChild(row);
    });

    if(first){
      // per-second countdown repaint
      state.tickHandle = setInterval(()=>{
        document.querySelectorAll("#departures .item").forEach((el, idx)=>{
          const item = (j.items||[])[idx]; if(!item) return;
          el.querySelector(".when").innerHTML = etaText(item, sinceServerNow());
        });
      }, 1000);
      // periodic reload
      setInterval(()=>refreshDepartures(false), state.refreshSec*1000);
    }
  }catch(e){
    toast("Departures failed.");
  }
}

/* ========= trip + t√©rk√©p ========= */
async function openTrip(tripId, routeShort){
  $("#tripWrap").style.display="block";
  $("#tripStops").innerHTML="...";
  try{
    const r = await fetch(`${state.api}/trip?tripId=${encodeURIComponent(tripId)}`);
    if(!r.ok){ $("#tripStops").innerHTML="<div class='subtle'>Trip not found</div>"; return; }
    const j = await r.json();
    $("#tripMeta").textContent = `${j.route.short_name||""} ‚Ä¢ ${j.headsign||""}`;

    // stops list
    const list=$("#tripStops"); list.innerHTML="";
    (j.stops||[]).forEach(s=>{
      const line=document.createElement("div"); line.className="item";
      line.innerHTML = `
        <div>
          <div class="title">${s.name}</div>
          <div class="subtle small">${s.code? (s.code+" ‚Ä¢ "):""}${s.stop_id}</div>
        </div>
        <div class="kpi">
          <div class="chip">${(s.dep||s.arr||"").slice(0,5)}</div>
        </div>`;
      list.appendChild(line);
    });

    // map
    ensureMap();
    drawShape(j.shape||[]);
    await drawVehicles(routeShort||j.route.short_name||"");
    // refresh vehicles every 10s
    state.lastVehiclesRoute = routeShort||j.route.short_name||"";
    if(state.vTimer) clearInterval(state.vTimer);
    state.vTimer = setInterval(()=>drawVehicles(state.lastVehiclesRoute), 10000);
  }catch(e){
    $("#tripStops").innerHTML="<div class='subtle'>Trip error</div>";
  }
}

function ensureMap(){
  if(state.map) return;
  state.map = L.map('map');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'¬© OpenStreetMap'}).addTo(state.map);
  state.map.setView([50.9,-1.4], 12);
  state.shapeLayer = L.polyline([], {color:"#8ad"}).addTo(state.map);
  state.vehiclesLayer = L.layerGroup().addTo(state.map);
}
function drawShape(points){
  const latlngs = points.map(p=>[p.lat,p.lon]);
  state.shapeLayer.setLatLngs(latlngs);
  if(latlngs.length) state.map.fitBounds(L.latLngBounds(latlngs), {padding:[20,20]});
}
async function drawVehicles(routeShort){
  if(!state.map) return;
  try{
    state.vehiclesLayer.clearLayers();
    const r = await fetch(`${state.api}/vehicles?route=${encodeURIComponent(routeShort)}`);
    const j = await r.json();
    if(!j.ok) return;
    (j.vehicles||[]).forEach(v=>{
      const m = L.circleMarker([v.lat, v.lon], {radius:7, color:"#5cf", fill:true, fillOpacity:.9});
      m.bindPopup(`${v.line} ‚Üí ${v.dest||""}<br><span class="small">${v.vehicle_ref||""}</span>`);
      m.addTo(state.vehiclesLayer);
    });
  }catch(e){}
}

/* ========= viszonylat keres≈ë ========= */
$("#btnRouteSearch").onclick=async ()=>{
  const q=$("#routeQuery").value.trim(); if(!q) return;
  try{
    const r=await fetch(state.api+"/routes/search?q="+encodeURIComponent(q));
    const j=await r.json();
    const list=$("#routeResults"); list.innerHTML="";
    const items = (j && j.results) || [];
    if(!items.length){ list.innerHTML=`<div class="subtle">${t("no_results")}</div>`; return; }
    items.forEach(rte=>{
      const row=document.createElement("div"); row.className="item";
      row.innerHTML = `
        <div class="row" style="gap:12px">
          <div class="badge">${rte.short_name||"‚Äî"}</div>
          <div>
            <div class="title">${rte.long_name||""}</div>
            <div class="subtle small">ID: ${rte.route_id}</div>
          </div>
        </div>`;
      list.appendChild(row);
    });
  }catch(e){ toast("Route search failed."); }
};

/* ========= inicializ√°l√°s ========= */
document.addEventListener("DOMContentLoaded", ()=>{
  // default language flag
  document.querySelector(`.flag-btn[data-lang="${lang}"]`)?.classList.add("active");
});
</script>
</body>
</html>
