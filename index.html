<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bluestar Bus – Live Departures</title>
  <style>
    body{background:#0b1020;color:#e7ecf4;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;margin:0;padding:24px}
    .card{background:#131a2a;border:1px solid #24304a;border-radius:14px;max-width:860px;margin:0 auto;padding:20px}
    h1{margin:0 0 16px;font-weight:700}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#0e2f18;border:1px solid #0f6f3f;color:#8ff0b6;font-size:13px;margin-bottom:14px}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0}
    .row label{display:block;font-size:12px;color:#9fb1d1;margin-bottom:6px}
    input,button{padding:10px 12px;border-radius:10px;border:1px solid #2a3754;background:#0f1525;color:#e7ecf4}
    input{min-width:220px}
    button{cursor:pointer;background:#315ef3;border-color:#315ef3}
    button.secondary{background:#1e2639;border-color:#2a3754}
    table{width:100%;border-collapse:collapse;margin-top:16px}
    th,td{padding:10px;border-bottom:1px solid #24304a;text-align:left}
    th{color:#9fb1d1;font-weight:600}
    .muted{color:#9fb1d1}
    .live{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #0f6f3f;background:#0e2f18;color:#8ff0b6;font-size:12px;margin-left:8px}
    .error{background:#2a1520;border:1px solid #a03b59;color:#ffc6d1;padding:10px;border-radius:10px;margin-top:10px;white-space:pre-wrap}
    .hint{font-size:12px;color:#9fb1d1;margin-top:4px}
  </style>
</head>
<body>
  <div class="card">
    <h1>Bluestar Bus – Live Departures</h1>
    <div class="pill">
      <span style="background:#25d17b;width:8px;height:8px;border-radius:50%"></span>
      <strong>ÉLŐ – BODS SIRI-VM</strong>
    </div>

    <div class="row">
      <div style="flex:1;min-width:260px">
        <label for="stopName">Megálló neve</label>
        <input id="stopName" placeholder="pl. Hanover / Vincents Walk / Four Post Hill" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="btnSearch">Keresés</button>
      </div>
    </div>

    <div id="stopResults" class="row" style="display:none;flex-direction:column"></div>

    <div class="row">
      <div>
        <label for="minutes">Időablak (perc)</label>
        <input id="minutes" type="number" value="60" min="1" />
      </div>
      <div style="flex:1;min-width:260px">
        <label for="stopId">Stop ID</label>
        <input id="stopId" placeholder="pl. 1980SN12619A" />
        <div class="hint">Tipp: a találatra kattintva ez automatikusan kitöltődik.</div>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="btnFetch">Indulások lekérése</button>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="btnClear" class="secondary">Törlés</button>
      </div>
    </div>

    <div id="err" class="error" style="display:none"></div>

    <h3 style="margin-top:18px">Indulások</h3>
    <table>
      <thead><tr><th>Route</th><th>Destination</th><th>Time</th></tr></thead>
      <tbody id="rows"><tr><td colspan="3" class="muted">Nincs indulás ebben az időablakban.</td></tr></tbody>
    </table>

    <div class="hint" style="margin-top:10px">Powered by GTFS (menetrend) és BODS SIRI-VM (élő adatok).</div>
  </div>

<script>
const API = ""; // ugyanazon a domainen fut az API

const $ = (id)=>document.getElementById(id);
const rows = $("rows");
const errBox = $("err");
const stopResults = $("stopResults");

function showError(text){
  errBox.textContent = text;
  errBox.style.display = "block";
}
function clearError(){ errBox.style.display = "none"; errBox.textContent = ""; }

function renderRows(items){
  rows.innerHTML = "";
  if(!items || !items.length){
    rows.innerHTML = `<tr><td colspan="3" class="muted">Nincs indulás ebben az időablakban.</td></tr>`;
    return;
  }
  for(const it of items){
    const live = it.is_live ? `<span class="live">LIVE</span>` : "";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${it.route ?? ""}</td>
      <td>${(it.destination ?? "").toString()}</td>
      <td>${(it.time ?? "").toString()} ${live}</td>
    `;
    rows.appendChild(tr);
  }
}

$("btnSearch").addEventListener("click", async ()=>{
  clearError(); stopResults.style.display="none"; stopResults.innerHTML="";
  const q = ($("stopName").value || "").trim();
  if(!q) return;
  try{
    const res = await fetch(`${API}/search_stops?q=${encodeURIComponent(q)}`);
    if(!res.ok){
      const t = await res.text();
      showError(`Hiba a kereséskor.\nHTTP ${res.status}\n${t}`);
      return;
    }
    const data = await res.json();
    const results = data.results || [];
    if(!results.length){ showError("Nincs találat erre a névre."); return; }
    stopResults.style.display = "flex";
    results.slice(0,20).forEach(r=>{
      const btn = document.createElement("button");
      btn.className = "secondary";
      btn.style.textAlign="left";
      btn.textContent = `${r.display_name} (${r.stop_id})`;
      btn.addEventListener("click", ()=>{
        $("stopId").value = r.stop_id;
        stopResults.style.display="none";
      });
      stopResults.appendChild(btn);
    });
  }catch(e){
    showError(String(e));
  }
});

$("btnFetch").addEventListener("click", async ()=>{
  clearError();
  const stopId = ($("stopId").value || "").trim();
  const minutes = Math.max(1, parseInt($("minutes").value || "60", 10));
  if(!stopId){ showError("Adj meg Stop ID-t (pl. 1980SN12619A)."); return; }
  try{
    const res = await fetch(`${API}/next_departures/${encodeURIComponent(stopId)}?minutes=${minutes}`);
    if(!res.ok){
      const t = await res.text();
      showError(`Hiba az indulások lekérésekor.\nHTTP ${res.status}\n${t}`);
      return;
    }
    const data = await res.json();
    renderRows(data.results || []);
  }catch(e){
    showError(String(e));
  }
});

$("btnClear").addEventListener("click", ()=>{
  $("stopName").value = "";
  $("stopId").value = "";
  renderRows([]);
  clearError();
  stopResults.style.display="none";
});
</script>
</body>
</html>
