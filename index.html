<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bluestar Bus – Live Departures</title>
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <style>
    body{padding:1rem}
    .badge-live{display:inline-block;padding:.15rem .45rem;border-radius:999px;
      font-size:.75rem;background:#10b981;color:#041b0d;margin-left:.5rem}
    .muted{opacity:.7}
    .mono{font-variant-numeric: tabular-nums;}
    .scroll{max-height:320px;overflow:auto}
    .card{padding:1rem;border:1px solid #2a2f3a;border-radius:.75rem}
  </style>
</head>
<body>
  <main class="container">
    <h2>Bluestar Bus – Live Departures</h2>

    <div class="card">
      <small>
        <span style="display:inline-flex;align-items:center;gap:.4rem">
          <span style="width:.6rem;height:.6rem;background:#10b981;border-radius:50%"></span>
          <strong>ÉLŐ – BODS SIRI-VM</strong>
        </span>
      </small>

      <label>Megálló neve
        <input id="q" type="text" placeholder="pl. Hanover, Vincents Walk, ..." />
      </label>
      <button id="btnSearch">Keresés</button>
      <div id="searchResults" class="scroll"></div>

      <div class="grid">
        <label>Időablak (perc)
          <input id="minutes" type="number" min="1" max="480" value="60"/>
        </label>
        <label>Stop ID
          <input id="stopId" type="text" placeholder="pl. 1980SN12619A"/>
        </label>
      </div>
      <div class="grid">
        <button id="btnFetch" class="contrast">Indulások lekérése</button>
        <button id="btnClear" class="secondary">Törlés</button>
      </div>

      <div id="err" class="muted" style="color:#f87171"></div>
    </div>

    <h3>Indulások</h3>
    <table id="tbl" role="grid">
      <thead>
        <tr><th>Route</th><th>Destination</th><th>Time</th></tr>
      </thead>
      <tbody id="rows"><tr><td colspan="3" class="muted">Nincs indulás ebben az időablakban.</td></tr></tbody>
    </table>

    <p class="muted"><small>Powered by GTFS (menetrend) és BODS SIRI-VM (élő adatok).</small></p>
  </main>

<script>
const $ = sel => document.querySelector(sel);
const rows = $("#rows");
const errBox = $("#err");
const API = ""; // ugyanazon domainen fut (relative path)

function clearRows(msg="Nincs indulás ebben az időablakban.") {
  rows.innerHTML = `<tr><td colspan="3" class="muted">${msg}</td></tr>`;
}

function setError(msg) {
  errBox.textContent = msg || "";
}

function addSearchResults(list) {
  const box = $("#searchResults");
  if (!list.length) { box.innerHTML = `<small class="muted">Nincs találat erre a névre.</small>`; return; }
  box.innerHTML = "";
  list.forEach(item => {
    const btn = document.createElement("button");
    btn.className = "secondary";
    btn.style.width = "100%";
    btn.style.textAlign = "left";
    btn.textContent = `${item.display_name}`;
    btn.onclick = () => {
      $("#stopId").value = item.stop_id;
      setError("");
    };
    box.appendChild(btn);
  });
}

$("#btnSearch").addEventListener("click", async () => {
  const q = $("#q").value.trim();
  setError("");
  if (!q) { setError("Adj meg keresési kifejezést (megálló neve)."); return; }
  try {
    const r = await fetch(`${API}/search_stops?name=${encodeURIComponent(q)}`);
    if (!r.ok) throw new Error(await r.text());
    const data = await r.json();
    addSearchResults(data.results || []);
  } catch (e) {
    setError("Keresési hiba: " + (e?.message || e));
  }
});

$("#btnClear").addEventListener("click", () => {
  $("#q").value = "";
  $("#stopId").value = "";
  $("#minutes").value = 60;
  $("#searchResults").innerHTML = "";
  clearRows();
  setError("");
});

$("#btnFetch").addEventListener("click", async () => {
  const stopId = $("#stopId").value.trim();
  const minutes = parseInt($("#minutes").value || "60", 10);
  setError("");
  if (!stopId) { setError("Adj meg Stop ID-t (pl. 1980SN12619A)."); return; }

  try {
    const r = await fetch(`${API}/siri/next_departures/${encodeURIComponent(stopId)}?minutes=${minutes}`);
    const text = await r.text();
    if (!r.ok) throw new Error(text);
    const data = JSON.parse(text);

    const list = data.results || [];
    if (!list.length) { clearRows(); return; }

    rows.innerHTML = "";
    list.forEach(it => {
      const tr = document.createElement("tr");
      const liveBadge = it.is_live ? `<span class="badge-live">• ÉLŐ</span>` : "";
      const time = it.time_hhmm ? it.time_hhmm : "";
      tr.innerHTML = `
        <td><strong>${it.route || ""}</strong></td>
        <td>${it.destination || ""}</td>
        <td class="mono">${time} ${liveBadge}</td>
      `;
      rows.appendChild(tr);
    });
  } catch (e) {
    setError("Hiba az indulások lekéréskor.\n" + (e?.message || e));
  }
});

// kezdeti állapot
clearRows();
</script>
</body>
</html>
