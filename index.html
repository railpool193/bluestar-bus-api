<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Bluestar Bus â€“ stop & route finder</title>
<link rel="preconnect" href="https://unpkg.com"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  :root { --bg:#0c1220; --card:#111a2f; --muted:#95a3b8; --text:#eaf0ff; --accent:#8ea2ff; --green:#48d597; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px}
  h1{display:flex;align-items:center;gap:12px;font-size:28px;margin:0 0 12px}
  .bus{font-size:32px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:6px}
  .pill{background:var(--card);padding:10px 14px;border-radius:12px;border:1px solid #22314f}
  .muted{color:var(--muted)}
  .tabs{display:flex;gap:8px;margin:10px 0}
  .tab{padding:8px 14px;border-radius:999px;background:#1a2540;color:#cfe0ff;cursor:pointer;user-select:none}
  .tab.active{background:#5568ff;color:#fff}
  .card{background:var(--card);border:1px solid #22314f;border-radius:20px;padding:16px;margin-top:12px}
  label{display:block;margin-bottom:6px;color:#c6d1e9}
  input,select{width:100%;padding:12px;border-radius:12px;border:1px solid #2b3a5c;background:#0f1830;color:#fff}
  button{padding:12px 16px;border:none;border-radius:12px;background:#6b7dff;color:#fff;font-weight:600;cursor:pointer}
  .grid{display:grid;gap:10px}
  .two{grid-template-columns:1fr auto}
  .list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
  .item{background:#0f1830;border:1px solid #233258;border-radius:16px;padding:14px 16px;display:grid;grid-template-columns:64px 1fr auto;gap:14px;align-items:center}
  .route{width:44px;height:44px;border-radius:999px;background:#1b2746;display:grid;place-items:center;font-weight:700}
  .live{color:var(--green);font-weight:700}
  .muter{color:#9fb0cc}
  .time{font-variant-numeric:tabular-nums;font-weight:700}
  .foot{margin-top:8px;color:#8d9bb8;font-size:13px}
  #tripModal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px}
  .modal{max-width:700px;width:100%;background:#0f1830;border:1px solid #2b3a5c;border-radius:16px;padding:8px 8px 12px}
  .modal h3{margin:8px 8px 4px}
  .triprow{padding:10px 12px;border-radius:10px;display:flex;gap:12px}
  .triprow.past{color:#9aa8c2}
  .triprow.live{color:#48d597;font-weight:700}
  .triprow.sched{color:#eaf0ff}
  #map{height:360px;border-radius:16px;border:1px solid #233258}
  .select-lang{margin-left:auto}
</style>
</head>
<body>
<div class="wrap">
  <div class="row">
    <h1><span class="bus">ðŸšŒ</span><span id="title">Bluestar Bus â€” stop & route finder</span></h1>
    <div class="pill select-lang">
      <select id="langSel" style="background:#0f1830;color:#fff;border-radius:8px;padding:6px;border:1px solid #2b3a5c">
        <option value="en">EN</option>
        <option value="de">DE</option>
        <option value="hu">HU</option>
        <option value="pl">PL</option>
        <option value="ro">RO</option>
      </select>
    </div>
  </div>
  <div class="row muted">
    <span id="clockLbl">UK time:</span>&nbsp;<strong id="clock">--:--:--</strong>
    <span>&nbsp;Â·&nbsp;</span>
    <span id="refresh">Refresh: â€“</span>
  </div>

  <div class="tabs">
    <div id="tabStop" class="tab active" data-tab="stop"></div>
    <div id="tabRoute" class="tab" data-tab="route"></div>
  </div>

  <div id="paneStop" class="card">
    <div class="grid two">
      <div>
        <label id="lblStop"></label>
        <input id="qStop" placeholder="Shirley, Central, ..."/>
      </div>
      <div>
        <label id="lblWin"></label>
        <input id="win" type="number" min="5" max="720" step="5" value="60"/>
      </div>
      <div style="grid-column:1/-1;display:flex;gap:10px;align-items:end">
        <select id="stopSel"></select>
        <button id="btnSearch"></button>
      </div>
    </div>

    <div class="foot"><span id="selStop">â€“</span> <span style="float:right" id="every">Refresh every 20 s</span></div>

    <div id="list" class="list"></div>

    <div class="foot">Build: <span id="build">-</span> Â· <span id="cache">Cache-bypass</span><br/>
      <span id="livehint"></span>
    </div>
  </div>

  <div id="paneRoute" class="card" style="display:none">
    <div class="grid two">
      <div>
        <label id="lblRoute"></label>
        <input id="qRoute" placeholder="17"/>
      </div>
      <div style="display:flex;align-items:flex-end;justify-content:flex-end">
        <button id="btnRouteSearch"></button>
      </div>
      <div style="grid-column:1/-1">
        <select id="routeSel"></select>
      </div>
    </div>
    <div id="map" class="card" style="margin-top:12px"></div>
    <div class="foot" id="vehHelp"></div>
  </div>
</div>

<div id="tripModal">
  <div class="modal">
    <div style="display:flex;align-items:center;gap:8px;justify-content:space-between">
      <h3 id="tripTitle">Trip</h3>
      <button onclick="hideTrip()">Ã—</button>
    </div>
    <div id="tripList" style="max-height:60vh;overflow:auto;padding:8px"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const T = {
  en: {
    title: "Bluestar Bus â€” stop & route finder",
    clock: "UK time:",
    tabStop: "Stop",
    tabRoute: "Route",
    lblStop: "Stop name",
    lblWin: "Window (min)",
    search: "Search",
    results: "Results â€” choose a stop",
    selected: "Selected stop:",
    refresh: "Refresh every 20 s",
    routeHdr: "Route",
    destHdr: "Destination",
    depHdr: "Departure",
    tripTitle: "Trip details",
    noTrip: "No details for this trip.",
    vehiclesHelp: "If there are no live vehicles on this route, the map stays empty.",
    liveHint: "Set live feed at: /api/live/config",
  },
  de: {
    title: "Bluestar Bus â€” Haltestellen & Linien",
    clock: "UK-Zeit:",
    tabStop: "Haltestelle",
    tabRoute: "Linie",
    lblStop: "Haltestellenname",
    lblWin: "Zeitfenster (Min)",
    search: "Suche",
    results: "Treffer â€” wÃ¤hle eine Haltestelle",
    selected: "GewÃ¤hlte Haltestelle:",
    refresh: "Aktualisierung alle 20 s",
    routeHdr: "Linie",
    destHdr: "Ziel",
    depHdr: "Abfahrt",
    tripTitle: "Fahrtdetails",
    noTrip: "Keine Details zu dieser Fahrt.",
    vehiclesHelp: "Wenn keine Live-Fahrzeuge vorhanden sind, bleibt die Karte leer.",
    liveHint: "Live-Feed setzen unter: /api/live/config",
  },
  hu: {
    title: "Bluestar Bus â€“ megÃ¡llÃ³ & jÃ¡rat keresÅ‘",
    clock: "UK idÅ‘:",
    tabStop: "MegÃ¡llÃ³",
    tabRoute: "Vonal",
    lblStop: "MegÃ¡llÃ³ nÃ©v",
    lblWin: "IdÅ‘ablak (perc)",
    search: "KeresÃ©s",
    results: "TalÃ¡latok â€“ vÃ¡lassz megÃ¡llÃ³t",
    selected: "VÃ¡lasztott megÃ¡llÃ³:",
    refresh: "FrissÃ­tÃ©s 20 s",
    routeHdr: "JÃ¡rat",
    destHdr: "CÃ©l",
    depHdr: "IndulÃ¡s",
    tripTitle: "JÃ¡rat rÃ©szletei",
    noTrip: "Nincs rÃ©szlet ehhez a jÃ¡rathoz.",
    vehiclesHelp: "Ha nincs Ã©lÅ‘ jÃ¡rmÅ± a vonalon, a tÃ©rkÃ©p Ã¼res marad.",
    liveHint: "Ã‰lÅ‘ feed beÃ¡llÃ­tÃ¡sa: /api/live/config",
  },
  pl: {
    title: "Bluestar Bus â€” wyszukiwarka przystankÃ³w i linii",
    clock: "Czas UK:",
    tabStop: "Przystanek",
    tabRoute: "Linia",
    lblStop: "Nazwa przystanku",
    lblWin: "Okno (min)",
    search: "Szukaj",
    results: "Wyniki â€” wybierz przystanek",
    selected: "Wybrany przystanek:",
    refresh: "OdÅ›wieÅ¼anie co 20 s",
    routeHdr: "Linia",
    destHdr: "Kierunek",
    depHdr: "Odjazd",
    tripTitle: "SzczegÃ³Å‚y kursu",
    noTrip: "Brak szczegÃ³Å‚Ã³w dla tego kursu.",
    vehiclesHelp: "JeÅ›li brak pojazdÃ³w na Å¼ywo, mapa zostanie pusta.",
    liveHint: "Ustaw feed live: /api/live/config",
  },
  ro: {
    title: "Bluestar Bus â€” cÄƒutare staÈ›ii & linii",
    clock: "Ora UK:",
    tabStop: "StaÈ›ie",
    tabRoute: "Linie",
    lblStop: "Numele staÈ›iei",
    lblWin: "FereastrÄƒ (min)",
    search: "CautÄƒ",
    results: "Rezultate â€” alege o staÈ›ie",
    selected: "StaÈ›ie selectatÄƒ:",
    refresh: "ReÃ®mprospÄƒtare la 20 s",
    routeHdr: "Linie",
    destHdr: "DestinaÈ›ie",
    depHdr: "Plecarea",
    tripTitle: "Detalii cursÄƒ",
    noTrip: "Nu existÄƒ detalii pentru aceastÄƒ cursÄƒ.",
    vehiclesHelp: "DacÄƒ nu sunt vehicule live pe linie, harta rÄƒmÃ¢ne goalÄƒ.",
    liveHint: "SeteazÄƒ feed live: /api/live/config",
  },
};

let lang = (localStorage.getItem("lang") || (navigator.language||"en").slice(0,2) || "en").toLowerCase();
if (!T[lang]) lang = "en";
const $ = sel => document.querySelector(sel);
const listEl = $("#list");
const stopSel = $("#stopSel");
const routeSel = $("#routeSel");
let refreshTimer = null;
let map, markersLayer;

function t(key){ return (T[lang]||T.en)[key]; }
function setTexts(){
  $("#title").textContent = t("title");
  $("#clockLbl").textContent = t("clock");
  $("#tabStop").textContent = t("tabStop");
  $("#tabRoute").textContent = t("tabRoute");
  $("#lblStop").textContent = t("lblStop");
  $("#lblWin").textContent = t("lblWin");
  $("#btnSearch").textContent = t("search");
  $("#lblRoute").textContent = t("tabRoute");
  $("#btnRouteSearch").textContent = t("search");
  $("#every").textContent = t("refresh");
  $("#livehint").textContent = t("liveHint");
  $("#vehHelp").textContent = t("vehiclesHelp");
}
$("#langSel").value = lang;
$("#langSel").addEventListener("change", e=>{
  lang = e.target.value; localStorage.setItem("lang", lang); setTexts();
});

function tabSwitch(which){
  $("#tabStop").classList.toggle("active", which==="stop");
  $("#tabRoute").classList.toggle("active", which==="route");
  $("#paneStop").style.display = which==="stop" ? "" : "none";
  $("#paneRoute").style.display = which==="route" ? "" : "none";
}
$("#tabStop").onclick = ()=>tabSwitch("stop");
$("#tabRoute").onclick = ()=>tabSwitch("route");

async function tickClock(){
  try{
    const r = await fetch("/api/status").then(r=>r.json());
    $("#clock").textContent = r.uk_time || "--:--:--";
    $("#refresh").textContent = (t("refresh").split(" ")[0]==="Refresh" ? "Refresh:" : "FrissÃ­tÃ©s:") + " 10s";
    $("#build").textContent = r.build || "-";
  }catch(e){}
}
setInterval(tickClock, 10000);
tickClock();

async function searchStops(){
  const q = $("#qStop").value.trim();
  if (q.length<2) return;
  const res = await fetch(`/api/stops/search?q=${encodeURIComponent(q)}`).then(r=>r.json());
  stopSel.innerHTML = "";
  res.forEach(o=>{
    const opt = document.createElement("option");
    opt.value = o.id; opt.textContent = o.name;
    stopSel.appendChild(opt);
  });
  $("#selStop").textContent = (res.length? (t("selected")+" "+res[0].name) : "â€“");
  if (res.length) loadDepartures();
}
$("#btnSearch").onclick = searchStops;

async function loadDepartures(){
  const id = stopSel.value;
  const mins = +$("#win").value || 60;
  if (!id) { listEl.innerHTML=""; return; }
  const res = await fetch(`/api/stops/${encodeURIComponent(id)}/next_departures?minutes=${mins}`).then(r=>r.json());
  listEl.innerHTML = "";
  res.forEach(row=>{
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="route">${row.route}</div>
      <div>
        <div>${row.headsign}</div>
        <div class="muter">${t("destHdr")}</div>
      </div>
      <div class="time ${row.live?'live':''}">${row.live?'Due':row.departure}</div>`;
    div.onclick = ()=>openTrip(row.trip_id, row.route, row.headsign);
    listEl.appendChild(div);
  });
  if (refreshTimer) clearTimeout(refreshTimer);
  refreshTimer = setTimeout(loadDepartures, 20000);
}

async function openTrip(trip_id, route, headsign){
  $("#tripTitle").textContent = `${t("tripTitle")} Â· ${route} â†’ ${headsign}`;
  $("#tripList").innerHTML = "";
  $("#tripModal").style.display = "flex";
  try{
    const r = await fetch(`/api/trips/${encodeURIComponent(trip_id)}`).then(r=>r.json());
    r.stops.forEach(s=>{
      const row = document.createElement("div");
      row.className = `triprow ${s.status}`;
      row.innerHTML = `<div class="time" style="width:70px">${s.time}</div><div>${s.stop_name}</div>`;
      $("#tripList").appendChild(row);
    });
    if (!r.stops.length){
      $("#tripList").textContent = t("noTrip");
    }
  }catch(e){
    $("#tripList").textContent = t("noTrip");
  }
}
function hideTrip(){ $("#tripModal").style.display="none"; }

async function searchRoutes(){
  const q = $("#qRoute").value.trim();
  if (!q) return;
  const rows = await fetch(`/api/routes/search?q=${encodeURIComponent(q)}`).then(r=>r.json());
  routeSel.innerHTML = "";
  rows.forEach(r=>{
    const opt = document.createElement("option");
    opt.value = r.label;
    opt.textContent = r.label;
    routeSel.appendChild(opt);
  });
  if (rows.length) loadVehicles();
}
$("#btnRouteSearch").onclick = searchRoutes;

function ensureMap(){
  if (map) return;
  map = L.map('map').setView([50.908, -1.404], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap'
  }).addTo(map);
  markersLayer = L.layerGroup().addTo(map);
}

async function loadVehicles(){
  ensureMap();
  markersLayer.clearLayers();
  const r = routeSel.value;
  if (!r) return;
  const items = await fetch(`/api/routes/${encodeURIComponent(r)}/vehicles`).then(r=>r.json());
  if (!items.length) return;
  items.forEach(v=>{
    L.marker([v.lat, v.lon]).addTo(markersLayer)
     .bindPopup(`${r} Â· ${v.id || ""}`);
  });
}

setTexts();
tabSwitch("stop");

// auto-detect language once (only first visit)
if (!localStorage.getItem("langSetOnce")){
  localStorage.setItem("langSetOnce","1");
  $("#langSel").value = lang;
  setTexts();
}
</script>
</body>
</html>
