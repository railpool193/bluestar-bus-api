<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bluestar menetrend √©s meg√°ll√≥ keres≈ë</title>
  <link rel="preconnect" href="https://unpkg.com" />
  <link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root{
      --bg:#0f1420; --panel:#151b2b; --muted:#9aa4c7; --text:#e8eafd; --primary:#bfc6ff;
      --chip:#2a3350; --chip2:#202743; --green:#28d17c; --white:#ffffff; --danger:#ff595e;
      --accent:#9aa8ff;
    }
    body{ background: var(--bg); color: var(--text); font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .wrap{ max-width: 960px; margin: 20px auto; padding: 0 12px; }
    h1{ font-size: clamp(22px, 4vw, 40px); font-weight: 800; margin: 8px 0 4px; }
    .time{ color: var(--muted); margin-bottom: 12px; }
    .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .btn{ background: var(--accent); color:#101221; border:0; padding:10px 16px; border-radius:14px; font-weight:700; }
    .btn.secondary{ background: var(--chip); color: var(--text); }
    .card{ background: var(--panel); border-radius:18px; padding:14px; box-shadow: 0 8px 30px #0000003a; }
    .tabs{ gap:10px; margin:12px 0; }
    .tab{ background:var(--chip2); padding:10px 16px; border-radius:14px; }
    .tab.active{ outline:2px solid var(--accent); }
    .input{ width:100%; outline:none; background:#0c1222; color:var(--text); border:1px solid #233056; padding:12px 14px; border-radius:14px; }
    .pill{ background:var(--chip); padding:8px 12px; border-radius:12px; color:var(--primary); display:inline-block; margin:4px 6px 0 0; }
    .result{ display:flex; align-items:center; justify-content:space-between; padding:12px; background:#0e1528; border-radius:12px; margin-top:10px; }
    .result .l{ display:flex; gap:12px; align-items:center;}
    .badge{ background:#1c2442; padding:10px 12px; border-radius:12px; font-weight:800; min-width:44px; text-align:center;}
    .fav{ background:#293155; border:0; color:#9eb0ff; padding:10px 12px; border-radius:12px; }
    .muted{ color: var(--muted); }
    .dep{ display:flex; gap:10px; align-items:center; justify-content:space-between; padding:12px; background:#0d1425; border-radius:12px; margin-top:8px; }
    .dep .time{ font-size:20px; color:var(--white); }
    .dep.live .time{ color: var(--green); }
    .due-blink{ color: var(--green); font-weight:900; animation: blink 1s step-start infinite; }
    @keyframes blink { 50%{opacity: .15;} }
    #map{ height: 360px; border-radius:18px; margin-top:10px; }
    .lang{ background:#1c2442; border:0; width:42px; height:32px; display:grid; place-items:center; border-radius:8px; }
    .lang img{ width:24px; height:18px; display:block; }
    .grid{ display:grid; grid-template-columns: 1fr; gap:10px; }
    @media (min-width:700px){ .grid{ grid-template-columns: 1fr 1fr; } }
    .small{ font-size:12px; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="row" style="justify-content: space-between;">
    <div class="row"><span style="font-size:28px;">üöå</span></div>
    <div class="row" id="langRow">
      <!-- z√°szl√≥k -->
      <button class="lang" data-lang="en" title="English"><img alt="en" src="https://flagcdn.com/24x18/gb.png"></button>
      <button class="lang" data-lang="hu" title="Magyar"><img alt="hu" src="https://flagcdn.com/24x18/hu.png"></button>
      <button class="lang" data-lang="de" title="Deutsch"><img alt="de" src="https://flagcdn.com/24x18/de.png"></button>
      <button class="lang" data-lang="fr" title="Fran√ßais"><img alt="fr" src="https://flagcdn.com/24x18/fr.png"></button>
      <button class="lang" data-lang="pl" title="Polski"><img alt="pl" src="https://flagcdn.com/24x18/pl.png"></button>
      <button class="lang" data-lang="ro" title="Rom√¢nƒÉ"><img alt="ro" src="https://flagcdn.com/24x18/ro.png"></button>
      <button class="btn secondary" id="btnSettings">‚öôÔ∏è <span data-i="settings">Be√°ll√≠t√°sok</span></button>
    </div>
  </div>

  <h1>Bluestar menetrend √©s meg√°ll√≥ keres≈ë</h1>
  <div class="time">UK: <span id="clock">--:--:--</span></div>

  <div class="row tabs">
    <div class="tab active" data-tab="stop" id="tabStop" data-i="tab_stop">Meg√°ll√≥</div>
    <div class="tab" data-tab="route" id="tabRoute" data-i="tab_route">Viszonylat</div>
    <div class="tab" data-tab="fav" id="tabFav" data-i="tab_fav">Kedvencek</div>
  </div>

  <!-- STOP SEARCH -->
  <div class="card" id="panelStop">
    <input class="input" id="stopQuery" placeholder="Shirley, Vincent, ..." />
    <div class="row" style="margin-top:8px;"><button class="btn" id="btnStopSearch" data-i="search">Keres√©s</button></div>
    <div style="margin-top:10px;">
      <div class="muted" data-i="featured_disr">Kiemelt forgalmi v√°ltoz√°sok</div>
      <div id="chips" style="margin-top:6px;">
        <span class="pill">18</span><span class="pill">19</span><span class="pill">1</span><span class="pill">7</span><span class="pill">U1</span><span class="pill">X4</span>
      </div>
      <h3 style="margin:12px 0 6px;" data-i="results">Tal√°latok</h3>
      <div id="stopResults"></div>
    </div>
  </div>

  <!-- ROUTE SEARCH -->
  <div class="card" id="panelRoute" style="display:none;">
    <input class="input" id="routeQuery" placeholder="pl. 17" />
    <div class="row" style="margin-top:8px;"><button class="btn" id="btnRouteSearch" data-i="search">Keres√©s</button></div>
    <div id="routeResults" style="margin-top:10px;"></div>
  </div>

  <!-- FAVOURITES -->
  <div class="card" id="panelFav" style="display:none;">
    <div id="favList"></div>
  </div>

  <!-- DETAILS -->
  <div class="card" id="panelDetails" style="display:none;">
    <div class="row" style="justify-content:space-between; align-items: baseline;">
      <div>
        <div id="detailsTitle" style="font-weight:800;"></div>
        <div class="small muted" id="detailsSub"></div>
      </div>
      <button class="fav" id="btnFavToggle">‚òÖ</button>
    </div>
    <div id="deps"></div>
    <div id="map"></div>
  </div>

  <!-- SETTINGS -->
  <div class="card" id="panelSettings" style="display:none;">
    <div class="muted" style="margin-bottom:6px;" data-i="api_base">API el√©r√©si √∫t (√ºres = ugyanarr√≥l a domainr≈ël)</div>
    <input class="input" id="apiBase">
    <div class="muted" style="margin:10px 0 6px;" data-i="refresh">Friss√≠t√©si id≈ë (mp)</div>
    <input class="input" id="refreshSec" type="number" min="5" value="10">
    <div class="muted" style="margin:10px 0 6px;" data-i="lookahead">El≈ëretekint√©si ablak (perc)</div>
    <input class="input" id="lookaheadMin" type="number" min="10" value="60">
    <div class="row" style="margin-top:10px;">
      <button class="btn" id="btnSaveSettings" data-i="save">Ment√©s</button>
    </div>
  </div>

  <div id="toast" class="card" style="position:fixed; left:12px; right:12px; bottom:12px; display:none; background:#3c1c22;">...</div>
</div>

<script>
const i18n = {
  en:{ settings:"Settings", tab_stop:"Stop", tab_route:"Route", tab_fav:"Favourites",
       search:"Search", results:"Results", featured_disr:"Featured service changes",
       api_base:"API base path (empty = same origin)", refresh:"Refresh (sec)",
       lookahead:"Lookahead window (min)", save:"Save", open:"Open", remove:"Remove",
       selected_stop:"Selected stop", live:"LIVE", due:"DUE" },
  hu:{ settings:"Be√°ll√≠t√°sok", tab_stop:"Meg√°ll√≥", tab_route:"Viszonylat", tab_fav:"Kedvencek",
       search:"Keres√©s", results:"Tal√°latok", featured_disr:"Kiemelt forgalmi v√°ltoz√°sok",
       api_base:"API el√©r√©si √∫t (√ºres = ugyanarr√≥l a domainr≈ël)", refresh:"Friss√≠t√©si id≈ë (mp)",
       lookahead:"El≈ëretekint√©si ablak (perc)", save:"Ment√©s", open:"Megnyit", remove:"T√∂rl√©s",
       selected_stop:"Kiv√°lasztott meg√°ll√≥", live:"√âL≈ê", due:"DUE" },
  de:{ settings:"Einstellungen", tab_stop:"Haltestelle", tab_route:"Linie", tab_fav:"Favoriten",
       search:"Suchen", results:"Ergebnisse", featured_disr:"Wichtige √Ñnderungen",
       api_base:"API-Basis (leer = gleiche Domain)", refresh:"Aktualisierung (s)",
       lookahead:"Vorschau (Min)", save:"Speichern", open:"√ñffnen", remove:"Entfernen",
       selected_stop:"Ausgew√§hlte Haltestelle", live:"LIVE", due:"DUE" },
  fr:{ settings:"Param√®tres", tab_stop:"Arr√™t", tab_route:"Ligne", tab_fav:"Favoris",
       search:"Rechercher", results:"R√©sultats", featured_disr:"Perturbations",
       api_base:"Base API (vide = m√™me domaine)", refresh:"Rafra√Æchir (s)",
       lookahead:"Fen√™tre (min)", save:"Enregistrer", open:"Ouvrir", remove:"Supprimer",
       selected_stop:"Arr√™t s√©lectionn√©", live:"EN DIRECT", due:"DUE" },
  pl:{ settings:"Ustawienia", tab_stop:"Przystanek", tab_route:"Linia", tab_fav:"Ulubione",
       search:"Szukaj", results:"Wyniki", featured_disr:"Zmiany w ruchu",
       api_base:"Adres API (puste = ta sama domena)", refresh:"Od≈õwie≈ºanie (s)",
       lookahead:"Okno (min)", save:"Zapisz", open:"Otw√≥rz", remove:"Usu≈Ñ",
       selected_stop:"Wybrany przystanek", live:"LIVE", due:"DUE" },
  ro:{ settings:"SetƒÉri", tab_stop:"Sta»õie", tab_route:"Linie", tab_fav:"Favorite",
       search:"CautƒÉ", results:"Rezultate", featured_disr:"ModificƒÉri servicii",
       api_base:"Baza API (gol = acela»ôi domeniu)", refresh:"Re√ÆmprospƒÉtare (s)",
       lookahead:"FereastrƒÉ (min)", save:"SalveazƒÉ", open:"Deschide", remove:"»òterge",
       selected_stop:"Sta»õie selectatƒÉ", live:"LIVE", due:"DUE" },
};
let lang = localStorage.getItem("lang") || "hu";
function applyI18n(){
  const t=i18n[lang]||i18n.hu;
  document.querySelectorAll("[data-i]").forEach(el=>{
    const k=el.getAttribute("data-i");
    if(t[k]) el.textContent=t[k];
  });
}
document.querySelectorAll(".lang").forEach(b=>{
  b.addEventListener("click", ()=>{ lang=b.dataset.lang; localStorage.setItem("lang",lang); applyI18n(); });
});
applyI18n();

function showToast(msg){ const t=document.getElementById("toast"); t.style.display="block"; t.textContent=msg; setTimeout(()=>t.style.display="none", 4000); }

const S = {
  apiBase: localStorage.getItem("apiBase") || "/api",
  refreshSec: +(localStorage.getItem("refreshSec") || 10),
  lookahead: +(localStorage.getItem("lookahead") || 60),
};
document.getElementById("apiBase").value = S.apiBase;
document.getElementById("refreshSec").value = S.refreshSec;
document.getElementById("lookaheadMin").value = S.lookahead;

document.getElementById("btnSaveSettings").onclick = ()=>{
  S.apiBase = document.getElementById("apiBase").value || "/api";
  S.refreshSec = +document.getElementById("refreshSec").value || 10;
  S.lookahead = +document.getElementById("lookaheadMin").value || 60;
  localStorage.setItem("apiBase", S.apiBase);
  localStorage.setItem("refreshSec", S.refreshSec);
  localStorage.setItem("lookahead", S.lookahead);
  showToast("‚úîÔ∏è OK");
};
document.getElementById("btnSettings").onclick = ()=>{
  togglePanel("panelSettings");
};

// √≥ra
setInterval(()=>{
  const d=new Date();
  const hh=String(d.getUTCHours()).padStart(2,"0"); // London id≈ë ny√°ron +1, itt el√©g kijelz√©sre UTC + ‚ÄúUK‚Äù
  const mm=String(d.getUTCMinutes()).padStart(2,"0");
  const ss=String(d.getUTCSeconds()).padStart(2,"0");
  document.getElementById("clock").textContent=`${hh}:${mm}:${ss}`;
},1000);

// Tabs/panelek
function togglePanel(id){
  ["panelStop","panelRoute","panelFav","panelDetails","panelSettings"].forEach(x=>{
    document.getElementById(x).style.display = (x===id) ? "block" : "none";
  });
}
document.getElementById("tabStop").onclick=()=>{ togglePanel("panelStop"); setActive("tabStop"); };
document.getElementById("tabRoute").onclick=()=>{ togglePanel("panelRoute"); setActive("tabRoute"); };
document.getElementById("tabFav").onclick=()=>{ renderFav(); togglePanel("panelFav"); setActive("tabFav"); };
function setActive(id){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

// API seg√©d
async function api(path){
  const url = (S.apiBase.endsWith("/")? S.apiBase.slice(0,-1):S.apiBase) + path;
  const r = await fetch(url);
  if(!r.ok) throw new Error(`${r.status}`);
  return await r.json();
}

// STOP keres√©s
document.getElementById("btnStopSearch").onclick = async ()=>{
  const q = document.getElementById("stopQuery").value.trim();
  if(!q) return;
  try{
    const d = await api(`/stops/search?q=${encodeURIComponent(q)}`);
    renderStopResults(d.results||[]);
  }catch(e){ showToast("Stop search failed."); }
};
function renderStopResults(list){
  const box = document.getElementById("stopResults");
  box.innerHTML = "";
  list.forEach(s=>{
    const div = document.createElement("div");
    div.className="result";
    div.innerHTML = `
      <div class="l">
        <div class="badge">BUS</div>
        <div><div style="font-weight:800;">${s.name}</div><div class="muted small">ID: ${s.stop_id}${s.code? " ‚Ä¢ "+s.code:""}</div></div>
      </div>
      <div class="row">
        <button class="fav" title="‚òÖ" data-stop='${JSON.stringify(s)}'>‚òÖ</button>
        <button class="btn open" data-id="${s.stop_id}">${i18n[lang].open}</button>
      </div>`;
    div.querySelector(".open").onclick=()=>openStop(s);
    div.querySelector(".fav").onclick=()=>addFav(s);
    box.appendChild(div);
  });
}

// ROUTE keres√©s (majd b≈ëv√≠thet≈ë √∫tvonal/shape megjelen√≠t√©ssel)
document.getElementById("btnRouteSearch").onclick = async ()=>{
  const q = document.getElementById("routeQuery").value.trim();
  if(!q) return;
  try{
    const d = await api(`/routes/search?q=${encodeURIComponent(q)}`);
    const box = document.getElementById("routeResults");
    box.innerHTML="";
    d.results.forEach(r=>{
      const div=document.createElement("div");
      div.className="result";
      div.innerHTML = `<div class="l"><div class="badge">${r.short_name||"‚Äî"}</div><div>${r.long_name||""}</div></div>`;
      box.appendChild(div);
    });
  }catch(e){ showToast("Route search failed."); }
};

// Kedvencek
function getFav(){ try{ return JSON.parse(localStorage.getItem("favs")||"[]"); }catch{return[]}}
function setFav(arr){ localStorage.setItem("favs", JSON.stringify(arr)); }
function addFav(s){
  const f=getFav();
  if(!f.find(x=>x.stop_id===s.stop_id)){ f.push(s); setFav(f); showToast("‚òÖ added"); }
}
function removeFav(id){ setFav(getFav().filter(x=>x.stop_id!==id)); renderFav(); }
function renderFav(){
  const box=document.getElementById("favList");
  box.innerHTML="";
  getFav().forEach(s=>{
    const div=document.createElement("div");
    div.className="result";
    div.innerHTML=`<div class="l"><div class="badge">BUS</div><div>${s.name}<div class="small muted">ID: ${s.stop_id}</div></div></div>
                   <div class="row"><button class="btn open" data-id="${s.stop_id}">${i18n[lang].open}</button>
                   <button class="fav" data-id="${s.stop_id}">${i18n[lang].remove}</button></div>`;
    div.querySelector(".open").onclick=()=>openStop(s);
    div.querySelector(".fav").onclick=()=>removeFav(s.stop_id);
    box.appendChild(div);
  });
}

// Meg√°ll√≥ megnyit√°sa + indul√°sok + t√©rk√©p
let map, mapInited=false, vehTimer=null, depTimer=null, currentStop=null;
async function openStop(s){
  currentStop = s;
  togglePanel("panelDetails");
  document.getElementById("detailsTitle").textContent = `${s.name}`;
  document.getElementById("detailsSub").textContent = `${i18n[lang].selected_stop}: ${s.stop_id}${s.code? " ‚Ä¢ "+s.code:""}`;
  // t√©rk√©p
  setTimeout(()=>initMap(s.lat, s.lon), 50);
  // indul√°sok
  await refreshDepartures();
  if(depTimer) clearInterval(depTimer);
  depTimer = setInterval(refreshDepartures, Math.max(5,S.refreshSec)*1000);
}
async function refreshDepartures(){
  if(!currentStop) return;
  try{
    const d = await api(`/departures?stopId=${encodeURIComponent(currentStop.stop_id)}&lookahead_mins=${S.lookahead}`);
    renderDepartures(d.items||[], d.now_epoch||Math.floor(Date.now()/1000));
  }catch(e){ showToast("Departures failed."); }
}
function renderDepartures(list, nowEpoch){
  const box=document.getElementById("deps");
  box.innerHTML="";
  list.slice(0,40).forEach(it=>{
    const etaSec = (it.predicted_epoch || it.scheduled_epoch) - nowEpoch;
    const mins = Math.max(0, Math.floor(etaSec/60));
    const due = etaSec<=60;
    const live = !!it.live;

    const row=document.createElement("div");
    row.className = "dep"+(live?" live":"");
    const tLabel = due? `<span class="due-blink">${i18n[lang].due}</span>` :
                  (mins<=90? `<span class="time">${mins} min</span>` : `<span class="time">${new Date((it.predicted_epoch||it.scheduled_epoch)*1000).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>`);
    const delay = (it.delay_sec!=null && Math.abs(it.delay_sec)>=30) ? 
                  `<span class="small ${it.delay_sec>0?'muted':''}">(${it.delay_sec>0?'+':''}${Math.round(it.delay_sec/60)}‚Ä≤)</span>` : "";
    row.innerHTML = `
      <div class="l">
        <div class="badge">${it.route||"‚Äî"}</div>
        <div>
          <div style="font-weight:800;">${it.headsign||""}</div>
          <div class="small muted">${it.scheduled_time} ${live? '¬∑ <span style="color:#28d17c">'+i18n[lang].live+'</span>':''} ${delay}</div>
        </div>
      </div>
      <div>${tLabel}</div>
    `;
    row.onclick = ()=>openTrip(it.trip_id, it.route);
    box.appendChild(row);
  });
}

// Trip r√©szletek + shape + j√°rm≈±k√∂vet√©s (10 mp)
async function openTrip(tripId, routeShort){
  try{
    const d = await api(`/trip?tripId=${encodeURIComponent(tripId)}`);
    // rajz a t√©rk√©pen
    if(d.shape && d.shape.length){
      const pts = d.shape.map(p=>[p.lat, p.lon]);
      if(window._shape){ window._shape.remove(); }
      window._shape = L.polyline(pts).addTo(map);
      map.fitBounds(window._shape.getBounds(), {padding:[20,20]});
    }
    // stop lista popup helyett: kirakjuk a details al√°
    const box=document.getElementById("deps");
    const title=document.createElement("div");
    title.className="muted"; title.style.margin="10px 0 6px"; title.textContent = d.route.short_name+" ‚Üí "+(d.headsign||"");
    box.prepend(title);

    if(vehTimer) clearInterval(vehTimer);
    const refreshVehicles = async ()=>{
      try{
        const v = await api(`/vehicles?route=${encodeURIComponent(routeShort||'')}`);
        renderVehicles(v.vehicles||[]);
      }catch(e){}
    };
    await refreshVehicles();
    vehTimer = setInterval(refreshVehicles, 10000);
  }catch(e){ showToast("Trip open failed."); }
}

function initMap(lat, lon){
  if(!mapInited){
    map = L.map('map', { zoomControl:true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom:19, attribution:'¬© OpenStreetMap'
    }).addTo(map);
    mapInited=true;
  }
  map.setView([lat||50.9, lon||-1.4], 14);
  if(window._stop) window._stop.remove();
  window._stop = L.marker([lat,lon]).addTo(map).bindPopup("Stop");
  if(window._shape){ window._shape.remove(); window._shape=null; }
  if(window._vehLayer){ window._vehLayer.clearLayers(); }
}

function renderVehicles(list){
  if(!mapInited) return;
  if(!window._vehLayer){ window._vehLayer = L.layerGroup().addTo(map); }
  window._vehLayer.clearLayers();
  list.forEach(v=>{
    if(!v.lat || !v.lon) return;
    L.circleMarker([v.lat, v.lon], {radius:6}).addTo(window._vehLayer).bindPopup(`${v.line||''} ‚Üí ${v.dest||''}`);
  });
}
</script>
</body>
</html>
