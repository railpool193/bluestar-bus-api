<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bluestar Bus – Live Departures</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    body{background:#0f1220;color:#e6e7ea;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .card{max-width:820px;margin:24px auto;padding:24px;border:1px solid #24283e;border-radius:16px;background:#101426}
    h1{margin:0 0 12px;font-weight:800;font-size:32px}
    .pill{display:inline-block;background:#123d2b;color:#7ef0b5;padding:6px 10px;border-radius:999px;font-size:12px;margin-bottom:8px}
    .row{display:flex;gap:12px;align-items:center;margin:10px 0}
    input,button{padding:12px 14px;border-radius:10px;border:1px solid #2a3153;background:#0e1322;color:#e6e7ea}
    button{background:#1461ff;border-color:#1461ff;font-weight:700;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:#9aa3bc;font-size:13px}
    .results{margin-top:8px;border:1px solid #222a49;border-radius:10px;overflow:hidden}
    .result{padding:10px 12px;border-top:1px solid #222a49;cursor:pointer}
    .result:hover{background:#0f1a33}
    .hidden{display:none}
    table{width:100%;border-collapse:collapse;margin-top:16px}
    th,td{border-bottom:1px solid #1d2440;padding:10px;text-align:left}
    .tag{font-size:11px;padding:2px 6px;border-radius:6px}
    .live{background:#0c4128;color:#6ee7a2}
    .sched{background:#3a2a0c;color:#ffd479}
    .error{background:#3a1116;color:#ffb4bf;border:1px solid #5c1a22;padding:10px;border-radius:10px;margin-top:8px;white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="card">
    <div class="pill">ÉLŐ – BODS SIRI-VM</div>
    <h1>Bluestar Bus – Live Departures</h1>

    <label>Megálló neve</label>
    <div class="row">
      <input id="name" placeholder="pl. Hanover, Vincents Walk, ..." />
      <button id="btnSearch">Keresés</button>
    </div>
    <div id="nores" class="muted hidden">Nincs találat erre a névre.</div>
    <div id="results" class="results hidden"></div>

    <div class="row">
      <div>
        <div class="muted">Időablak (perc)</div>
        <input id="minutes" type="number" value="60" min="5" max="720"/>
      </div>
      <div style="flex:1"></div>
    </div>

    <!-- Stop ID belső használatra – rejtve -->
    <input id="stopId" class="hidden" />

    <div class="row">
      <button id="btnGo" style="width:100%">Indulások lekérése</button>
    </div>

    <div id="err" class="error hidden"></div>

    <h2>Indulások</h2>
    <table id="table">
      <thead><tr><th>Route</th><th>Destination</th><th>Time</th></tr></thead>
      <tbody id="tbody"><tr><td colspan="3" class="muted">Nincs indulás ebben az időablakban.</td></tr></tbody>
    </table>
  </div>

<script>
const $ = s => document.querySelector(s);
const api = p => (location.origin + p);

function showError(msg){
  const e = $("#err");
  e.textContent = msg;
  e.classList.remove("hidden");
}
function hideError(){ $("#err").classList.add("hidden"); }

async function searchStops(){
  hideError();
  const q = $("#name").value.trim();
  $("#results").classList.add("hidden");
  $("#nores").classList.add("hidden");
  if(!q){ return; }
  try{
    const r = await fetch(api(`/api/stops/search?name=${encodeURIComponent(q)}`));
    if(!r.ok){
      $("#nores").classList.remove("hidden");
      return;
    }
    const data = await r.json();
    const box = $("#results");
    box.innerHTML = "";
    (data.results||[]).forEach(item=>{
      const div = document.createElement("div");
      div.className = "result";
      div.textContent = `${item.display_name} (${item.stop_id})`;
      div.onclick = ()=>{
        $("#stopId").value = item.stop_id;
        $("#name").value = item.display_name; // címke marad
        box.classList.add("hidden");
        getDeps();
      };
      box.appendChild(div);
    });
    if((data.results||[]).length){
      box.classList.remove("hidden");
    }else{
      $("#nores").classList.remove("hidden");
    }
  }catch(e){
    showError(`Keresési hiba: ${e}`);
  }
}

function fmtTime(iso){
  try{
    const d = new Date(iso);
    return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
  }catch(_){ return iso; }
}

async function getDeps(){
  hideError();
  const stopId = $("#stopId").value.trim();
  const minutes = parseInt($("#minutes").value || "60", 10);
  if(!stopId){
    showError("Adj meg Stop ID-t (egy találatra kattints a listából).");
    return;
  }
  $("#tbody").innerHTML = `<tr><td colspan="3" class="muted">Betöltés…</td></tr>`;
  try{
    const r = await fetch(api(`/api/stops/${encodeURIComponent(stopId)}/next_departures?minutes=${minutes}`));
    if(!r.ok){
      const err = await r.json().catch(()=>({detail:r.statusText}));
      throw new Error(err.detail || r.statusText);
    }
    const data = await r.json();
    const rows = data.results||[];
    if(!rows.length){
      $("#tbody").innerHTML = `<tr><td colspan="3" class="muted">Nincs indulás ebben az időablakban.</td></tr>`;
      return;
    }
    $("#tbody").innerHTML = rows.map(x=>{
      const tag = x.is_live ? `<span class="tag live">élő</span>` : `<span class="tag sched">menetrend</span>`;
      return `<tr>
        <td>${x.route} ${tag}</td>
        <td>${x.destination||""}</td>
        <td>${fmtTime(x.time_iso)}</td>
      </tr>`;
    }).join("");
  }catch(e){
    showError(`Hiba az indulások lekérésekor. ${e}`);
  }
}

$("#btnSearch").onclick = searchStops;
$("#btnGo").onclick = getDeps;
$("#name").addEventListener("keydown", (ev)=>{ if(ev.key==="Enter") searchStops(); });
</script>
</body>
</html>
