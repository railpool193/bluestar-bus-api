<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë</title>
<link rel="preconnect" href="https://unpkg.com">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  :root{--bg:#0e1220;--card:#141a2b;--muted:#a7b0c0;--fg:#eaf0ff;--pill:#2a3350;--accent:#6c82ff;--live:#18c27e;}
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
  .wrap{max-width:980px;margin:30px auto;padding:0 16px;}
  h1{font-weight:800;letter-spacing:.5px}
  .tabs{display:flex;gap:10px;margin:6px 0 12px}
  .tab{padding:10px 16px;border-radius:999px;background:#1c2440;color:#b9c4da;cursor:pointer;font-weight:600}
  .tab.active{background:var(--accent);color:#fff}
  .card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
  label{display:block;font-size:14px;color:#c9d2e4;margin:4px 0}
  input,select{width:100%;background:#0f1430;border:1px solid #223;outline:none;border-radius:10px;color:#fff;padding:14px 12px;font-size:16px}
  button{background:var(--accent);border:none;border-radius:12px;padding:12px 20px;font-weight:700;color:#fff;cursor:pointer}
  .row{display:flex;gap:14px;align-items:end}
  .muted{color:var(--muted)}
  .th{opacity:.85;font-weight:700;letter-spacing:.3px}
  .grid{margin-top:12px}
  .tr{display:grid;grid-template-columns:64px 1fr 110px 90px 120px;gap:10px;align-items:center;padding:12px;border-radius:12px;background:#0f1430;margin:8px 0;cursor:pointer}
  .tr:hover{background:#10183a}
  .pill{width:42px;height:42px;border-radius:50%;background:var(--pill);display:flex;align-items:center;justify-content:center;font-weight:800}
  .time{font-weight:800}
  .liveDot{display:inline-block;width:9px;height:9px;border-radius:50%;background:var(--live);margin-right:6px;box-shadow:0 0 0 0 rgba(24,194,126,.9);animation:pulse 1.4s infinite}
  @keyframes pulse { 0%{box-shadow:0 0 0 0 rgba(24,194,126,.7)}70%{box-shadow:0 0 0 10px rgba(24,194,126,0)}100%{box-shadow:0 0 0 0 rgba(24,194,126,0)}}
  .due{color:var(--live);font-weight:800;animation:blink 1s infinite}
  @keyframes blink {0%,49%{opacity:1}50%,100%{opacity:.2}}
  .hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .badge{font-size:12px;padding:3px 9px;border-radius:999px;background:#0f1430;color:#b7c0d4}
  .small{font-size:13px}
  #map{height:420px;border-radius:16px;overflow:hidden}
  .footer{margin-top:12px;color:#8e97ab}
  .link{color:#9fb3ff;text-decoration:none}
  /* modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:50}
  .modal .box{background:#0f1430;border:1px solid #233055;border-radius:16px;max-width:760px;width:92%;max-height:80vh;overflow:auto}
  .modal .hd{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #222845}
  .modal .bd{padding:12px 16px}
  .x{cursor:pointer;background:#222a46;border:none;color:#b9c4da;border-radius:10px;padding:6px 10px}
</style>
</head>
<body>
<div class="wrap">
  <div class="hdr">
    <h1>üöå Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë</h1>
    <div class="muted small">Friss√≠t√©s: <span id="tick">‚Äì</span></div>
  </div>

  <div class="tabs">
    <div id="tabStop" class="tab active">Meg√°ll√≥</div>
    <div id="tabRoute" class="tab">Vonal</div>
  </div>

  <!-- STOP CARD -->
  <div id="cardStop" class="card">
    <div class="row">
      <div style="flex:2">
        <label>Meg√°ll√≥ n√©v</label>
        <input id="qStop" placeholder="pl. Albion, Vincent, ...">
      </div>
      <div style="flex:1">
        <label>Id≈ëablak (perc)</label>
        <input id="minutes" type="number" min="5" max="240" value="60">
      </div>
      <div style="flex:0">
        <button id="btnStop">Keres√©s</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <label>Tal√°latok ‚Äì v√°lassz meg√°ll√≥t</label>
      <select id="selStops"></select>
    </div>

    <div class="hdr" style="margin-top:12px">
      <div class="small">V√°lasztott meg√°ll√≥: <b id="selStopLbl">‚Äì</b></div>
      <div class="small">Friss√≠t√©s 20 mp-enk√©nt</div>
    </div>

    <div class="grid">
      <div class="tr th" style="cursor:default">
        <div>J√°rat</div><div>C√©l</div><div>Indul√°s</div><div>√âl≈ë</div><div>Rendsz√°m</div>
      </div>
      <div id="rows"></div>
    </div>

    <div class="footer small">
      Build: <span id="build">-</span> ¬∑ <span id="cache">Cache-bypass akt√≠v</span>
    </div>
  </div>

  <!-- ROUTE CARD -->
  <div id="cardRoute" class="card" style="display:none">
    <div class="row">
      <div style="flex:1">
        <label>Vonal sz√°ma</label>
        <input id="qRoute" placeholder="pl. 9, 17, 18...">
      </div>
      <div style="flex:0">
        <button id="btnRoute">Keres√©s</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <label>Tal√°latok ‚Äì v√°lassz vonalat</label>
      <select id="selRoute"></select>
    </div>

    <div id="map" style="margin-top:12px"></div>
    <div id="vehList" class="small" style="margin-top:10px"></div>

    <div class="footer small">
      Ha nincs √©l≈ë j√°rm≈±, a t√©rk√©p √ºres marad.
    </div>
  </div>

  <div style="margin-top:16px" class="small muted">
    √âl≈ë feed be√°ll√≠t√°sa: <code>/api/live/config</code> ‚Äì a BODS URL-t (api_key-kel) POST-olhatod.
  </div>
</div>

<!-- Trip modal -->
<div id="tripModal" class="modal">
  <div class="box">
    <div class="hd">
      <div><b>J√°rat r√©szletei</b> ¬∑ <span id="tripIdLbl" class="muted"></span></div>
      <button class="x" onclick="hideTrip()">Bez√°r</button>
    </div>
    <div class="bd">
      <div id="tripBody" class="small"></div>
    </div>
  </div>
</div>

<script>
const state = {
  stopId:null, minutes:60, route:null, map:null, markers:[],
  lastUpdate:null, active:"stop"
}
const qs = s=>document.querySelector(s);

async function api(path){
  const u = `${path}${path.includes('?')?'&':'?'}_=${Date.now()}`;
  const r = await fetch(u, {headers:{'Cache-Control':'no-cache'}});
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
function setTick(txt){ qs('#tick').textContent = txt; }

// tabs
qs('#tabStop').onclick = ()=>{ state.active='stop'; qs('#tabStop').classList.add('active'); qs('#tabRoute').classList.remove('active'); qs('#cardStop').style.display='block'; qs('#cardRoute').style.display='none'; }
qs('#tabRoute').onclick= ()=>{ state.active='route'; qs('#tabRoute').classList.add('active'); qs('#tabStop').classList.remove('active'); qs('#cardStop').style.display='none'; qs('#cardRoute').style.display='block'; if(!state.map) initMap(); }

async function boot(){
  try{
    const st = await api('/api/status');
    qs('#build').textContent = st.build;
  }catch{}
}
boot();

// ------------ STOP ------------
qs('#btnStop').onclick = async ()=>{
  const q = qs('#qStop').value.trim();
  state.minutes = Math.max(5, Math.min(240, parseInt(qs('#minutes').value||'60')));
  if(!q) return;
  const hits = await api(`/api/stops/search?q=${encodeURIComponent(q)}`);
  const sel = qs('#selStops'); sel.innerHTML = '';
  hits.forEach((s,i)=>{
    const o=document.createElement('option');
    o.value = s.stop_id; o.textContent = `${s.stop_name} (${s.stop_id})`;
    sel.appendChild(o);
  });
  if(hits.length){ sel.selectedIndex=0; state.stopId=hits[0].stop_id; qs('#selStopLbl').textContent = hits[0].stop_id; refreshStop(); }
};

qs('#selStops').onchange = (e)=>{ state.stopId = e.target.value; qs('#selStopLbl').textContent = state.stopId; refreshStop(); }

function fmtTime(t){ if(!t) return '‚Äî'; const [h,m]=t.split(':'); return `${h.padStart(2,'0')}:${m.padStart(2,'0')}`; }

function fmtRow(it){
  const live = !!it.live;
  const eta = (typeof it.eta_min === 'number') ? it.eta_min : null;

  let when;
  if (eta !== null) {
    when = (eta <= 1) ? `<span class="due">Due</span>` : `<span class="time">${eta} min</span>`;
  } else {
    when = `<span class="time">${fmtTime(it.time)}</span>`;
  }
  if (it.day_offset && it.day_offset > 0) {
    when += ` <span class="muted">(+${it.day_offset})</span>`;
  }

  let liveCell = live ? `<span class="liveDot"></span><span class="muted">LIVE</span>` : `<span class="muted">‚Äì</span>`;
  const reg = it.vehicle_reg || '‚Äì';
  const trip = it.trip_id || '';
  return `<div class="tr" data-trip="${trip}">
    <div class="pill">${it.route||'‚Äì'}</div>
    <div>${it.destination||'‚Äì'}</div>
    <div>${when}</div>
    <div>${liveCell}</div>
    <div>${reg}</div>
  </div>`;
}

function renderRows(list){
  // client-oldali dedupe (biztons√°gi h√°l√≥)
  const seen=new Set(); const uniq=[];
  for(const it of list||[]){
    const k=`${it.route}|${it.destination}|${it.time}`;
    if(seen.has(k)) continue; seen.add(k); uniq.push(it);
  }
  const el=qs('#rows');
  if(!uniq.length){ el.innerHTML=`<div class="muted" style="padding:10px 4px">Nincs adat erre az id≈ëablakra.</div>`; return; }
  el.innerHTML = uniq.map(fmtRow).join("");
  [...el.querySelectorAll(".tr")].forEach(row=>{
    const tid=row.dataset.trip;
    if(tid) row.addEventListener("click",()=>showTrip(tid));
  });
}

async function refreshStop(){
  if(!state.stopId) return;
  const items = await api(`/api/stops/${encodeURIComponent(state.stopId)}/next_departures?minutes=${state.minutes}&live=true`);
  renderRows(items);
  state.lastUpdate=new Date();
}

function startTicker(){
  let t=20;
  setInterval(async ()=>{
    if(state.active==='stop' && state.stopId){ if(--t<=0){ await refreshStop(); t=20; } setTick(`${t}s`); }
    else if(state.active==='route' && state.route){ if(--t<=0){ await refreshRoute(); t=20; } setTick(`${t}s`); }
    else setTick('‚Äì');
  },1000);
}
startTicker();

// ------------ ROUTE ------------
function initMap(){
  state.map=L.map('map').setView([50.909, -1.404], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(state.map);
}
qs('#btnRoute').onclick = async ()=>{
  const q = qs('#qRoute').value.trim();
  if(!q) return;
  const hits = await api(`/api/routes/search?q=${encodeURIComponent(q)}`);
  const sel = qs('#selRoute'); sel.innerHTML='';
  if(!hits.length){ const o=document.createElement('option'); o.textContent='Nincs tal√°lat'; sel.appendChild(o); return; }
  hits.forEach((r,i)=>{ const o=document.createElement('option'); o.value=r.route; o.textContent=r.route; sel.appendChild(o); });
  sel.selectedIndex=0; state.route=hits[0].route; refreshRoute();
};
qs('#selRoute').onchange=(e)=>{ state.route=e.target.value; refreshRoute(); }

function clearMarkers(){ state.markers.forEach(m=>state.map.removeLayer(m)); state.markers=[]; }
function renderRouteList(vs){
  const el = document.getElementById("vehList");
  if(!vs || !vs.length){ el.innerHTML = `<span class="muted">Nincs √©l≈ë j√°rm≈± ezen a vonalon.</span>`; return; }
  const rows = vs
    .sort((a,b)=>String(a.reg||"").localeCompare(String(b.reg||"")))
    .map(v=>`<div style="padding:6px 0;border-bottom:1px solid #222845">
      <b>${v.reg||"‚Äì"}</b>
      ${v.trip_id?` ¬∑ trip: <span class="muted">${v.trip_id}</span>`:""}
      ${v.bearing!=null?` ¬∑ bearing: <span class="muted">${v.bearing}</span>`:""}
    </div>`).join("");
  el.innerHTML = `<div class="th" style="margin:10px 0 6px 0">J√°rm≈±vek a(z) ${state.route} vonalon</div>${rows}`;
}

async function refreshRoute(){
  if(!state.route) return;
  const vs = await api(`/api/routes/${encodeURIComponent(state.route)}/vehicles`);
  clearMarkers();
  const seen = new Set();
  const list=[];
  vs.forEach(v=>{
    const key = `${v.reg||""}|${v.trip_id||""}`; if(seen.has(key)) return; seen.add(key);
    list.push(v);
    const icon = L.divIcon({className:'', html:`<div style="background:#2a4bff;color:#fff;border-radius:6px;padding:2px 5px;font-weight:800">${state.route}</div>`});
    const m=L.marker([v.lat,v.lon],{icon}).addTo(state.map);
    m.bindPopup(`<b>${state.route}</b><br>${v.reg||""}${v.trip_id?`<br>trip: ${v.trip_id}`:""}${v.dest?`<br>${v.dest}`:""}`);
    state.markers.push(m);
  });
  if(list.length){
    state.map.setView([list[0].lat,list[0].lon], 12);
  }
  renderRouteList(list);
  state.lastUpdate=new Date();
}

// ------------ TRIP MODAL ------------
function showTrip(tid){
  qs('#tripIdLbl').textContent = tid;
  qs('#tripBody').innerHTML = `<div class="muted">Bet√∂lt√©s‚Ä¶</div>`;
  qs('#tripModal').style.display='flex';
  api(`/api/trips/${encodeURIComponent(tid)}`).then(d=>{
    if(!d || !d.calls || !d.calls.length){ qs('#tripBody').innerHTML = `<div class="muted">Nincs r√©szlet ehhez a j√°rathoz.</div>`; return; }
    const rows = d.calls.map(c=>`<div style="display:flex;gap:10px;padding:8px 0;border-bottom:1px solid #222845">
      <div style="width:80px;font-weight:700">${fmtTime(c.time||'')}</div>
      <div>${c.stop_name||c.stop_id}</div>
    </div>`).join("");
    qs('#tripBody').innerHTML = rows;
  }).catch(()=>{ qs('#tripBody').innerHTML = `<div class="muted">Hiba t√∂rt√©nt.</div>`; })
}
function hideTrip(){ qs('#tripModal').style.display='none'; }
</script>
</body>
</html>
