<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë</title>
  <style>
    :root{
      --bg:#0f1320; --card:#151a2c; --muted:#8ea2c0; --text:#e8eefc;
      --accent:#6ea8fe; --ok:#44d17a; --bad:#ff5d6c; --btn:#6a76ff;
      --chip:#23304d; --chip-b:#3b4c74;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
         background:var(--bg); color:var(--text);}
    .wrap{max-width:1000px; margin:24px auto; padding:0 16px;}
    h1{font-size:2.2rem; margin:0 0 18px}
    .card{background:var(--card); border-radius:14px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    label{display:block; font-size:.9rem; color:var(--muted); margin:6px 0}
    input[type="text"], input[type="number"]{
      width:100%; padding:12px 14px; border-radius:10px; border:1px solid #2b3553; background:#0f1526; color:var(--text);
      outline:none;
    }
    button{
      background:var(--btn); border:none; color:white; padding:12px 18px; border-radius:12px; font-weight:600;
      cursor:pointer;
    }
    button:disabled{opacity:.5; cursor:default}
    .tabs{display:flex; gap:10px; margin:10px 0 16px}
    .tab{padding:10px 14px; border-radius:999px; background:var(--chip); color:var(--muted); cursor:pointer; user-select:none}
    .tab.active{background:var(--chip-b); color:var(--text)}
    .status{display:flex; gap:10px; align-items:center; margin-top:8px}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.ok{background:var(--ok)} .dot.bad{background:var(--bad)}
    .list{margin-top:16px; border-radius:12px; overflow:hidden; border:1px solid #2b3553}
    table{width:100%; border-collapse:collapse}
    th,td{padding:12px 12px; border-bottom:1px solid #2b3553; text-align:left}
    th{color:var(--muted); font-weight:600; background:#111833}
    tr:hover{background:#111a36}
    .chip-min{padding:4px 8px; border-radius:999px; background:#0e1a33; border:1px solid #2b3553; color:#cfe0ff; font-size:.85rem}
    .live-tag{display:inline-flex; gap:6px; align-items:center}
    .muted{color:var(--muted)}
    .sub{font-size:.9rem; color:var(--muted)}
    .select{width:100%; background:#0f1526; border:1px solid #2b3553; color:var(--text); padding:10px; border-radius:10px}
    /* modal */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; padding:16px}
    .modal .content{background:var(--card); width:min(700px, 96vw); max-height:90vh; overflow:auto; border-radius:14px; padding:16px}
    .modal h3{margin:0 0 8px}
    .modal .close{float:right; cursor:pointer; color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üöå Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë</h1>

    <div class="card">
      <div class="tabs">
        <div class="tab active" data-tab="stops">Meg√°ll√≥</div>
        <div class="tab" data-tab="routes">Vonal</div>
      </div>

      <!-- STOPS TAB -->
      <div id="tab-stops">
        <div class="row">
          <div style="flex:2">
            <label>Meg√°ll√≥ n√©v (pl. ‚ÄûVincent‚Äù)</label>
            <input id="qStop" type="text" placeholder="Kezdj el √≠rni‚Ä¶" />
          </div>
          <div style="flex:1; min-width:160px">
            <label>Id≈ëablak (perc)</label>
            <input id="win" type="number" value="60" />
          </div>
          <div style="flex:0">
            <label>&nbsp;</label>
            <button id="btnSearchStop">Keres√©s</button>
          </div>
        </div>

        <div id="stopSelectWrap" style="margin-top:10px; display:none">
          <label>Tal√°latok ‚Äì v√°lassz meg√°ll√≥t</label>
          <select id="stopSelect" class="select"></select>
        </div>

        <div class="status">
          <div class="live-tag"><span class="dot" id="dot-api"></span><span class="muted">API</span></div>
          <div class="live-tag"><span class="dot" id="dot-gtfs"></span><span class="muted">GTFS</span></div>
          <div class="live-tag"><span class="dot" id="dot-live"></span><span class="muted">Live</span></div>
        </div>

        <div id="depWrap" class="list" style="display:none">
          <table>
            <thead><tr><th>J√°rat</th><th>C√©l</th><th>Indul√°s</th><th>√âl≈ë</th></tr></thead>
            <tbody id="depBody"></tbody>
          </table>
        </div>
      </div>

      <!-- ROUTES TAB -->
      <div id="tab-routes" style="display:none">
        <div class="row">
          <div style="flex:2">
            <label>Vonal sz√°ma (pl. ‚Äû18‚Äù)</label>
            <input id="qRoute" type="text" placeholder="√çrd be a j√°rat sz√°m√°t‚Ä¶" />
          </div>
          <div style="flex:0">
            <label>&nbsp;</label>
            <button id="btnSearchRoute">Keres√©s</button>
          </div>
        </div>

        <div id="routeSelectWrap" style="margin-top:10px; display:none">
          <label>Tal√°latok ‚Äì v√°lassz vonalat</label>
          <select id="routeSelect" class="select"></select>
        </div>

        <div id="vehWrap" class="list" style="display:none">
            <!-- Vonal f√ºl t√°bl√°ja -->
          <table class="table">
  <thead>
    <tr>
      <th>Rendsz√°m</th>
      <th>T√≠pus</th>
      <th>Ir√°ny</th>
      <th>Poz√≠ci√≥</th>
      <th>Meg√°ll√≥</th>
      <th>Trip</th>
    </tr>
  </thead>
  <tbody id="routeVehiclesBody">
    <tr><td colspan="6" style="opacity:.7">Ha nincs √©l≈ë j√°rm≈±, a lista √ºres.</td></tr>
  </tbody>
            <thead><tr><th>Rendsz√°m</th><th>T√≠pus</th><th>Ir√°ny</th><th>Poz√≠ci√≥</th><th>Meg√°ll√≥</th><th>Friss√≠tve</th></tr></thead>
            <tbody id="vehBody"></tbody>
          </table>
        </div>
        <div class="sub" id="vehHint" style="display:none; margin-top:8px">
          Ha nincs √©l≈ë j√°rm≈±, a lista √ºres. (Live nincs vagy jelenleg nem bejelentkezett j√°rm≈±.)
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <div id="chosenInfo" class="sub">V√°lasztott meg√°ll√≥ ID: <span id="chosenStop">‚Äì</span></div>
    </div>
  </div>

  <!-- Trip modal -->
  <div class="modal" id="tripModal">
    <div class="content">
      <div class="close" id="closeTrip">‚úñ</div>
      <h3>J√°rat r√©szletek</h3>
      <div id="tripTitle" class="sub" style="margin-bottom:8px"></div>
      <div class="list">
        <table>
          <thead><tr><th>Id≈ë</th><th>Meg√°ll√≥</th></tr></thead>
          <tbody id="tripBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
/* ------- VONAL F√úL: √âL≈ê J√ÅRM≈∞VEK ------- */
// Seg√©d: fok -> ir√°ny string + ny√≠l
function bearingToDir(b) {
  if (b == null || isNaN(b)) return "‚Äì";
  const dirs = [
    ["√â", 337.5, 22.5, "‚Üë"],
    ["√âK", 22.5, 67.5, "‚Üó"],
    ["K", 67.5, 112.5, "‚Üí"],
    ["DK", 112.5, 157.5, "‚Üò"],
    ["D", 157.5, 202.5, "‚Üì"],
    ["DNY", 202.5, 247.5, "‚Üô"],
    ["NY", 247.5, 292.5, "‚Üê"],
    ["√âNY", 292.5, 337.5, "‚Üñ"],
  ];
  for (const [n, a, c, sym] of dirs) {
    if (a > c && (b >= a || b < c)) return `${n} ${sym}`;
    if (b >= a && b < c) return `${n} ${sym}`;
  }
  return "‚Äì";
}

async function loadRouteVehicles(routeNo) {
  const url = `/api/routes/${encodeURIComponent(routeNo)}/vehicles?v=${Date.now()}`;
  const tbody = document.querySelector("#routeVehiclesBody");
  tbody.innerHTML = `
    <tr><td colspan="6" style="opacity:.7">Bet√∂lt√©s‚Ä¶</td></tr>
  `;
  try {
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json(); // v√°rjuk: t√∂mb j√°rm≈± objektumokkal

    if (!Array.isArray(data) || data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6" style="opacity:.7">
        Ha nincs √©l≈ë j√°rm≈±, a lista √ºres. (Live nincs vagy jelenleg nem bejelentkezett j√°rm≈±.)
      </td></tr>`;
      return;
    }

    // Elfogadott kulcsok ‚Äì ami nincs, ‚Äû‚Äì‚Äù-k√©nt jelenik meg.
    // P√©lda nevez√©sek: reg, vehicle_registration, fleet_no; type, vehicle_type; bearing; lat/lon;
    // stop_name / stop, trip_id, headsign / destination
    const rows = data.map(v => {
      const reg = v.reg || v.vehicle_registration || v.fleet_no || "‚Äì";
      const type = v.type || v.vehicle_type || "‚Äì";
      const dir = bearingToDir(Number(v.bearing));
      const pos = (v.lat && v.lon) ? `${v.lat.toFixed(5)}, ${v.lon.toFixed(5)}` : "‚Äì";
      const stop = v.stop_name || v.stop || "‚Äì";
      const tripId = v.trip_id || v.tripId || null;
      const headsign = v.headsign || v.destination || "";
      const tripBtn = tripId
        ? `<button class="linklike" data-trip="${tripId}">Trip megnyit√°sa</button>`
        : "‚Äì";

      return `
        <tr>
          <td>${reg}</td>
          <td>${type}</td>
          <td>${dir}</td>
          <td>${pos}</td>
          <td>${stop}</td>
          <td>${headsign ? headsign : ""} ${tripBtn}</td>
        </tr>`;
    }).join("");

    tbody.innerHTML = rows || `<tr><td colspan="6">‚Äì</td></tr>`;

    // Trip gombok √∂sszek√∂t√©se
    tbody.querySelectorAll("button.linklike[data-trip]").forEach(btn => {
      btn.addEventListener("click", (e) => {
        const tripId = e.currentTarget.getAttribute("data-trip");
        if (tripId) openTripModal(tripId); // ez a m√°r megl√©v≈ë modal f√ºggv√©nyed
      });
    });

  } catch (err) {
    tbody.innerHTML = `<tr><td colspan="6" style="color:#f88">
      Hiba a j√°rm≈±vek lek√©r√©sekor: ${String(err).replace(/</g,"&lt;")}
    </td></tr>`;
  }
}

// ‚ÄûKeres√©s‚Äù a Vonal f√ºl√∂n
document.querySelector("#btnRouteSearch")?.addEventListener("click", () => {
  const routeNo = document.querySelector("#routeInput")?.value?.trim();
  if (!routeNo) return;
  // tal√°lati leg√∂rd√ºl≈ë friss√≠t√©s n√©lk√ºl is t√∂lthet√ºnk:
  loadRouteVehicles(routeNo);
});

// Ha a ‚ÄûTal√°latok ‚Äì v√°lassz vonalat‚Äù select v√°ltozik
document.querySelector("#routeSelect")?.addEventListener("change", (e) => {
  const routeNo = e.target.value;
  if (routeNo) loadRouteVehicles(routeNo);
});
    const dotApi  = document.getElementById('dot-api');
    const dotGtfs = document.getElementById('dot-gtfs');
    const dotLive = document.getElementById('dot-live');

    const stopSelWrap = document.getElementById('stopSelectWrap');
    const stopSelect  = document.getElementById('stopSelect');
    const depWrap     = document.getElementById('depWrap');
    const depBody     = document.getElementById('depBody');
    const chosenStop  = document.getElementById('chosenStop');

    const routeSelWrap = document.getElementById('routeSelectWrap');
    const routeSelect  = document.getElementById('routeSelect');
    const vehWrap      = document.getElementById('vehWrap');
    const vehBody      = document.getElementById('vehBody');
    const vehHint      = document.getElementById('vehHint');

    const tripModal  = document.getElementById('tripModal');
    const tripBody   = document.getElementById('tripBody');
    const tripTitle  = document.getElementById('tripTitle');
    document.getElementById('closeTrip').onclick = () => (tripModal.style.display = 'none');

    // Tabs
    document.querySelectorAll('.tab').forEach(t=>{
      t.onclick = () => {
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        const target = t.dataset.tab;
        document.getElementById('tab-stops').style.display  = (target==='stops')?'block':'none';
        document.getElementById('tab-routes').style.display = (target==='routes')?'block':'none';
      };
    });

    // Status
    async function refreshStatus(){
      const r = await fetch('/api/status?v=' + Date.now());
      const s = await r.json();
      dotApi.className = 'dot ok';
      dotGtfs.className = 'dot ' + (s.gtfs ? 'ok' : 'bad');
      dotLive.className = 'dot ' + (s.live ? 'ok' : 'bad');
    }
    refreshStatus();

    // ---- Stops flow ----
    document.getElementById('btnSearchStop').onclick = async ()=>{
      const q = document.getElementById('qStop').value.trim();
      if(!q) return;
      const res = await fetch('/api/stops/search?q=' + encodeURIComponent(q));
      const arr = await res.json();
      stopSelect.innerHTML = '';
      arr.forEach(s=>{
        const opt = document.createElement('option');
        opt.value = s.stop_id;
        opt.textContent = `${s.stop_name} (${s.stop_id}${s.stop_code? ' ‚Ä¢ ' + s.stop_code : ''})`;
        stopSelect.appendChild(opt);
      });
      if(arr.length){
        stopSelWrap.style.display = 'block';
        chosenStop.textContent = arr[0].stop_id;
        stopSelect.onchange = ()=> { chosenStop.textContent = stopSelect.value; };
      }else{
        stopSelWrap.style.display = 'none';
        chosenStop.textContent = '‚Äì';
      }
    };

    stopSelect.addEventListener('change', ()=> getDepartures());

    async function getDepartures(){
      const id = stopSelect.value;
      if(!id) return;
      const win = parseInt(document.getElementById('win').value || '60', 10);
      const r = await fetch(`/api/stops/${encodeURIComponent(id)}/next_departures?minutes=${win}&v=${Date.now()}`);
      const deps = await r.json();
      depBody.innerHTML = '';
      deps.forEach(d=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><span class="chip-min">${d.route}</span></td>
          <td>${escapeHtml(d.destination||'')}</td>
          <td>${d.live ? `<span class="live-tag"><span class="dot ok"></span> ${d.in_minutes}'</span>` : `${d.in_minutes}'`}</td>
          <td>${d.vehicle && d.vehicle.reg ? `${d.vehicle.reg}${d.vehicle.model? ' ‚Ä¢ '+d.vehicle.model : ''}` : (d.live?'√©l≈ë':'‚Äì')}</td>
        `;
        tr.style.cursor = 'pointer';
        tr.onclick = ()=> openTrip(d, id);
        depBody.appendChild(tr);
      });
      depWrap.style.display = deps.length ? 'block' : 'none';
    }

    // ---- Trip modal ----
    async function openTrip(dep, stopId){
      tripTitle.textContent = `J√°rat ${dep.route} ‚Äì ${dep.destination} (trip: ${dep.trip_id||'ismeretlen'})`;
      tripBody.innerHTML = '<tr><td colspan="2" class="muted">Bet√∂lt√©s‚Ä¶</td></tr>';
      tripModal.style.display = 'flex';
      if(!dep.trip_id){
        tripBody.innerHTML = '<tr><td colspan="2" class="muted">Ehhez a sorhoz nincs trip ID.</td></tr>';
        return;
      }
      const r = await fetch(`/api/trips/${encodeURIComponent(dep.trip_id)}?v=${Date.now()}`);
      const data = await r.json();
      tripBody.innerHTML = '';
      data.stops.forEach(s=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${s.time||''}</td><td>${escapeHtml(s.stop_name||s.stop_id)}</td>`;
        if(s.stop_id === stopId) tr.style.background = '#0f1e3f';
        tripBody.appendChild(tr);
      });
    }

    // ---- Route flow ----
    document.getElementById('btnSearchRoute').onclick = async ()=>{
      const q = document.getElementById('qRoute').value.trim();
      if(!q) return;
      const res = await fetch('/api/routes/search?q=' + encodeURIComponent(q));
      const arr = await res.json();
      routeSelect.innerHTML = '';
      arr.forEach(r=>{
        const opt = document.createElement('option');
        opt.value = r;
        opt.textContent = r;
        routeSelect.appendChild(opt);
      });
      routeSelWrap.style.display = arr.length ? 'block' : 'none';
      vehWrap.style.display = 'none';
      vehHint.style.display = 'none';
      if(arr.length){
        routeSelect.onchange = ()=> loadVehicles();
        await loadVehicles();
      }
    };

    async function loadVehicles(){
      const route = routeSelect.value;
      if(!route) return;
      const r = await fetch(`/api/routes/${encodeURIComponent(route)}/vehicles?v=${Date.now()}`);
      const arr = await r.json();
      vehBody.innerHTML = '';
      arr.forEach(v=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(v.reg || '‚Äì')}</td>
          <td>${escapeHtml(v.model || v.fleet_no || '‚Äì')}</td>
          <td>${escapeHtml(v.dir || '')}</td>
          <td>${v.lat && v.lon ? `${v.lat.toFixed(5)}, ${v.lon.toFixed(5)}${v.bearing? ' ‚Ä¢ ' + v.bearing+'¬∞':''}` : '‚Äì'}</td>
          <td>${escapeHtml(v.next_stop || '')}</td>
          <td class="muted">${escapeHtml(v.when || '')}</td>
        `;
        vehBody.appendChild(tr);
      });
      vehWrap.style.display = 'block';
      vehHint.style.display = arr.length ? 'none' : 'block';
    }

    // Utils
    function escapeHtml(s){
      return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    }
  </script>
</body>
</html>
