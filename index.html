<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë</title>
  <link rel="icon" href="data:,">
  <style>
    :root{
      --bg:#0e1220; --card:#171b2b; --muted:#8892b0; --text:#e6e6e6;
      --accent:#8ab4ff; --green:#00d97e; --chip:#26314a;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,Arial,sans-serif}
    body{margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:900px;margin:20px auto;padding:16px}
    .h1{font-size:32px;font-weight:800;margin:10px 0 16px}
    .card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 6px 30px rgba(0,0,0,.25)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>.col{flex:1 1 260px}
    input,select,button{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #2a3050;background:#0f1322;color:var(--text)}
    button{background:#6573ff;border:0;font-weight:700}
    button:active{opacity:.85}
    .tabs{display:flex;gap:10px;margin-bottom:14px}
    .tab{padding:10px 14px;border-radius:999px;background:#222845;color:#bcd;border:1px solid #2d3558;cursor:default}
    .table{width:100%;border-collapse:separate;border-spacing:0 10px}
    .tr{display:grid;grid-template-columns:72px 1fr 110px 80px 110px;gap:8px;align-items:center;background:#12172a;border-radius:14px;padding:12px 14px}
    .th{opacity:.7;font-size:12px;text-transform:uppercase;letter-spacing:.05em;margin:6px 4px}
    .chip{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:999px;background:var(--chip);font-weight:800}
    .muted{color:var(--muted)}
    .live{color:var(--green);font-weight:800}
    .due{animation:blink 1s linear infinite}
    @keyframes blink { 50%{opacity:.3} }
    .foot{margin-top:14px;font-size:12px;color:var(--muted);display:flex;justify-content:space-between}
    .small{font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="h1">üöå Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë</div>

    <div class="card">
      <div class="tabs">
        <div class="tab">Meg√°ll√≥</div>
        <div class="muted small">Friss√≠t√©s: <span id="refreshIn">‚Äì</span></div>
      </div>

      <div class="row">
        <div class="col">
          <label class="small muted">Meg√°ll√≥ n√©v</label>
          <input id="q" placeholder="pl. Albion, Vincent, Hanover..."/>
          <div id="stopListWrap" class="small muted" style="margin-top:6px;display:none">Tal√°latok ‚Äì v√°lassz meg√°ll√≥t:</div>
          <select id="stopList" style="display:none;margin-top:6px"></select>
        </div>
        <div class="col" style="max-width:200px">
          <label class="small muted">Id≈ëablak (perc)</label>
          <input id="window" type="number" value="60" min="5" max="240"/>
        </div>
        <div class="col" style="max-width:180px;align-self:end">
          <button id="btn">Keres√©s</button>
        </div>
      </div>

      <div id="meta" class="foot" style="display:none">
        <div>V√°lasztott meg√°ll√≥: <b id="selStop"></b></div>
        <div>Friss√≠t√©s: <b id="tick">20s</b></div>
      </div>

      <div class="th" style="margin-top:16px">Indul√°sok</div>
      <div class="th tr" style="background:transparent;padding:0">
        <div>J√°rat</div><div>C√©l</div><div>Indul√°s</div><div>√âl≈ë</div><div>Rendsz√°m</div>
      </div>
      <div id="rows" class="col"></div>

      <div class="foot">
        <div>Build: <span id="build">‚Äì</span> ¬∑ Cache-bypass akt√≠v</div>
        <div><a class="muted" href="/docs" target="_blank">API</a> ¬∑ <a class="muted" href="/openapi.json" target="_blank">OpenAPI</a></div>
      </div>
    </div>
  </div>

<script>
const API = "";
const REFRESH_SEC = 20; // 20 mp
let state = { stopId:null, minutes:60, timer:null, tick:REFRESH_SEC, build:"" };

async function api(path){
  const r = await fetch(API+path, {cache:"no-store"});
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

function fmtRow(it){
  const live = it.live && (it.eta_min ?? null) !== null;
  let dep = `<span>${it.time || ""}</span>`;
  let liveTxt = "‚Äì";
  if(live){
    if(it.eta_min <= 0){
      liveTxt = `<span class="live due">DUE</span>`;
    }else{
      liveTxt = `<span class="live">${it.eta_min}‚Ä≤</span>`;
    }
  }
  return `
    <div class="tr">
      <div><div class="chip">${(it.route||"").toString().slice(0,3)}</div></div>
      <div>${it.destination||""}</div>
      <div style="color:${live?'var(--muted)':'#fff'}">${dep}</div>
      <div>${liveTxt}</div>
      <div>${it.vehicle_reg||"‚Äì"}</div>
    </div>`;
}

function renderRows(list){
  const el = document.getElementById("rows");
  if(!list || !list.length){
    el.innerHTML = `<div class="muted" style="padding:10px 4px">Nincs adat erre az id≈ëablakra.</div>`;
    return;
  }
  el.innerHTML = list.map(fmtRow).join("");
}

async function refresh(){
  if(!state.stopId) return;
  try{
    const items = await api(`/api/stops/${encodeURIComponent(state.stopId)}/next_departures?minutes=${state.minutes}&live=true&_=${Date.now()}`);
    renderRows(items);
  }catch(e){
    console.error(e);
  }
}

function startTicker(){
  clearInterval(state.timer);
  state.tick = REFRESH_SEC;
  document.getElementById("tick").innerText = `${state.tick}s`;
  state.timer = setInterval(()=>{
    state.tick--;
    if(state.tick<=0){
      state.tick = REFRESH_SEC;
      refresh();
    }
    document.getElementById("tick").innerText = `${state.tick}s`;
  }, 1000);
}

async function onSearchStops(){
  const q = document.getElementById("q").value.trim();
  if(!q) return;
  const arr = await api(`/api/stops/search?q=${encodeURIComponent(q)}`);
  const wrap = document.getElementById("stopListWrap");
  const sel = document.getElementById("stopList");
  wrap.style.display = "block";
  sel.style.display = "block";
  sel.innerHTML = arr.map(s=>`<option value="${s.stop_id}">${s.stop_name} (${s.stop_id})</option>`).join("");
  if(arr.length){
    sel.value = arr[0].stop_id;
  }
}

async function onPick(){
  state.stopId = document.getElementById("stopList").value;
  state.minutes = Math.max(5, Math.min(240, parseInt(document.getElementById("window").value||"60")));
  document.getElementById("selStop").innerText = state.stopId || "‚Äì";
  document.getElementById("meta").style.display = state.stopId ? "flex" : "none";
  await refresh();
  startTicker();
}

async function boot(){
  const st = await api("/api/status");
  document.getElementById("build").innerText = st.build;
  document.getElementById("btn").addEventListener("click", async ()=>{
    await onSearchStops();
    await onPick();
  });
  document.getElementById("stopList").addEventListener("change", onPick);
}
boot();
</script>
</body>
</html>
