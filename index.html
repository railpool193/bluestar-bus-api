<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bluestar Bus ‚Äî stop & route finder</title>
<link rel="preconnect" href="https://unpkg.com">
<link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  :root { --bg:#0d1220; --card:#131a2c; --text:#e6e8ef; --muted:#9aa3b2; --accent:#7c8cff; --good:#2bd576; --chip:#1a2442; --board:#0a0d10;}
  body { background:var(--bg); color:var(--text); font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
  .container{ max-width:980px; margin:24px auto; padding:0 12px; }
  .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .card{ background:var(--card); border-radius:16px; padding:16px; box-shadow:0 4px 24px rgba(0,0,0,.25); }
  .btn{ background:var(--accent); color:#fff; border:none; border-radius:12px; padding:10px 14px; font-weight:600; cursor:pointer; }
  .ghost{ background:#0f1424; color:var(--text); border:1px solid #273153; }
  .input, select{ background:#0f1424; color:var(--text); border:1px solid #202844; border-radius:12px; padding:10px 12px; width:100%; }
  .list{ display:grid; gap:10px; margin-top:12px; }
  .item{ background:#0f1424; border-radius:12px; padding:12px; display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:10px; }
  .pill{ min-width:48px; height:38px; border-radius:10px; background:var(--chip); display:grid; place-items:center; font-weight:800; padding:0 10px; }
  .muted{ color:var(--muted); }
  .good{ color:var(--good); }
  .blink{ animation:blink 1s step-start infinite; } @keyframes blink { 50%{opacity:0} }
  .tabs{ display:flex; gap:8px; margin:16px 0; }
  .tab{ padding:10px 14px; border-radius:999px; background:#0f1424; cursor:pointer; }
  .tab.active{ background:#2a3354; }
  .map{ height:360px; border-radius:12px; overflow:hidden; }
  .lang{ margin-left:auto; }
  .title { font-size:clamp(22px,4vw,34px); font-weight:800; display:flex; align-items:center; gap:10px }
  .gear { background:#213058; border:1px solid #2c3c6a; border-radius:10px; padding:8px 10px; cursor:pointer; }
  .star { cursor:pointer; user-select:none }
  .mono{ font-variant-numeric: tabular-nums; }

  /* Board mode */
  .board { max-width:none; margin:0; padding:14px; }
  .board .card{ background:var(--board); }
  .board .title{ font-size:38px }
  .board .item{ grid-template-columns: 80px 1fr auto auto; padding:16px; }
  .board .pill{ font-size:22px; height:44px; min-width:68px; }
  .board .item .dest{ font-size:24px }
  .board .item .time{ font-size:26px; font-weight:800 }
  .board .item .op{ font-size:18px; padding:6px 10px; border:1px solid #2c3c6a; border-radius:8px; }
  .fs { position:fixed; inset:12px; z-index:9999; overflow:auto; }
</style>
</head>
<body>
  <div class="container" id="wrap">
    <div class="row">
      <div class="title">üöå <span id="app-title"></span></div>
      <div class="muted" id="ukTime" style="margin-left:12px">‚Äì:‚Äì</div>
      <button class="btn ghost" id="toggleBoard" title="Display board mode">Board</button>
      <button class="btn ghost" id="toggleFS" title="Fullscreen">‚õ∂</button>
      <div class="gear" id="openCfg" title="Feed config">‚öôÔ∏è</div>
      <select id="lang" class="input lang" style="width:100px"></select>
    </div>

    <div class="muted" style="margin:6px 0 18px">
      <span id="refreshLbl"></span> ¬∑ Build: <span id="build"></span>
    </div>

    <div class="tabs">
      <div id="tabStop" class="tab active"></div>
      <div id="tabRoute" class="tab"></div>
      <div id="tabFav" class="tab"></div>
    </div>

    <!-- STOP -->
    <div id="stopCard" class="card">
      <div class="row">
        <input id="stopQuery" class="input" />
        <input id="windowMin" class="input" type="number" value="60" style="max-width:140px" />
        <button id="stopSearchBtn" class="btn"></button>
      </div>
      <select id="stopSelect" class="input" style="margin-top:10px"></select>
      <div class="row" style="margin-top:6px; justify-content:space-between">
        <div class="muted"><span id="selectedStopLbl"></span></div>
        <div class="muted"><span id="refreshEvery"></span></div>
      </div>
      <div class="list" id="stopList"></div>
      <div class="muted" style="margin-top:8px">
        <span class="star" id="favStopBtn">‚òÜ</span>
        <span id="favStopLbl"></span>
      </div>
    </div>

    <!-- ROUTE -->
    <div id="routeCard" class="card" style="display:none">
      <div class="row">
        <input id="routeQuery" class="input" />
        <button id="routeSearchBtn" class="btn"></button>
      </div>
      <select id="routeSelect" class="input" style="margin-top:10px"></select>
      <div id="map" class="map" style="margin-top:12px"></div>
      <div class="row" style="margin-top:8px; justify-content:space-between">
        <div class="muted" id="mapHint"></div>
        <div class="muted">
          <span class="star" id="favRouteBtn">‚òÜ</span>
          <span id="favRouteLbl"></span>
        </div>
      </div>
    </div>

    <!-- FAVS -->
    <div id="favCard" class="card" style="display:none">
      <h3 style="margin-bottom:10px">‚òÖ Favorites</h3>
      <div class="row" style="align-items:flex-start">
        <div style="flex:1">
          <strong>Stops</strong>
          <div id="favStops" class="list" style="margin-top:10px"></div>
        </div>
        <div style="flex:1">
          <strong>Routes</strong>
          <div id="favRoutes" class="list" style="margin-top:10px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Config modal -->
  <div id="cfgModal" class="modal" style="display:none">
    <div class="box">
      <div class="row" style="justify-content:space-between;align-items:center">
        <strong>Live feed config</strong>
        <button id="closeCfg" class="btn">√ó</button>
      </div>
      <div class="row" style="margin-top:12px; gap:10px">
        <input id="feedUrl" class="input" placeholder="https://data.bus-data.dft.gov.uk/api/v1/datafeed/...." />
        <button id="saveFeed" class="btn">Save</button>
      </div>
      <div class="muted" style="margin-top:8px">Paste the BODS SIRI-VM URL above and press Save.</div>
    </div>
  </div>

<script>
/* ---------- i18n ---------- */
const I18N = {
 EN:{app:"Bluestar Bus ‚Äî stop & route finder",stopTab:"Stop",routeTab:"Route",favTab:"Favourites",search:"Search",stopName:"Stop name",window:"Window (min)",resultsChoose:"Results ‚Äî choose a stop",chosenStop:"Selected stop:",refreshEvery:"Refresh every 20 s",ukTime:"UK time:",mapHint:"If there are no live vehicles on the route, the map will be empty.",destination:"Destination",departure:"Departure",due:"Due",late:"late",early:"early",addFav:"Add to favourites",rmFav:"Remove from favourites"},
 HU:{app:"Bluestar Bus ‚Äî meg√°ll√≥ & j√°rat keres≈ë",stopTab:"Meg√°ll√≥",routeTab:"Vonal",favTab:"Kedvencek",search:"Keres√©s",stopName:"Meg√°ll√≥ n√©v",window:"Id≈ëablak (perc)",resultsChoose:"Tal√°latok ‚Äî v√°lassz meg√°ll√≥t",chosenStop:"V√°lasztott meg√°ll√≥:",refreshEvery:"Friss√≠t√©s 20 s",ukTime:"UK id≈ë:",mapHint:"Ha nincs √©l≈ë j√°rm≈± a vonalon, a t√©rk√©p √ºres marad.",destination:"C√©l",departure:"Indul√°s",due:"Due",late:"k√©s√©s",early:"el≈ëny",addFav:"Hozz√°ad√°s a kedvencekhez",rmFav:"Elt√°vol√≠t√°s a kedvencekb≈ël"},
 DE:{app:"Bluestar Bus ‚Äî Haltestellen & Linien",stopTab:"Haltestelle",routeTab:"Linie",favTab:"Favoriten",search:"Suche",stopName:"Haltestellenname",window:"Zeitfenster (Min.)",resultsChoose:"Treffer ‚Äî w√§hle eine Haltestelle",chosenStop:"Gew√§hlte Haltestelle:",refreshEvery:"Aktualisierung alle 20 s",ukTime:"UK-Zeit:",mapHint:"Wenn keine Live-Fahrzeuge vorhanden sind, bleibt die Karte leer.",destination:"Ziel",departure:"Abfahrt",due:"Due",late:"sp√§t",early:"fr√ºh",addFav:"Zu Favoriten",rmFav:"Aus Favoriten entfernen"},
 PL:{app:"Bluestar Bus ‚Äî wyszukiwarka przystank√≥w i linii",stopTab:"Przystanek",routeTab:"Linia",favTab:"Ulubione",search:"Szukaj",stopName:"Nazwa przystanku",window:"Okno (min)",resultsChoose:"Wyniki ‚Äî wybierz przystanek",chosenStop:"Wybrany przystanek:",refreshEvery:"Od≈õwie≈ºanie co 20 s",ukTime:"Czas UK:",mapHint:"Je≈õli brak pojazd√≥w na ≈ºywo, mapa bƒôdzie pusta.",destination:"Kierunek",departure:"Odjazd",due:"Due",late:"op√≥≈∫.",early:"wcze≈õ.",addFav:"Dodaj do ulubionych",rmFav:"Usu≈Ñ z ulubionych"},
 RO:{app:"Bluestar Bus ‚Äî cƒÉutare sta»õii & linii",stopTab:"Sta»õie",routeTab:"Linie",favTab:"Preferate",search:"CƒÉutare",stopName:"Numele sta»õiei",window:"FereastrƒÉ (min)",resultsChoose:"Rezultate ‚Äî alege o sta»õie",chosenStop:"Sta»õie selectatƒÉ:",refreshEvery:"Re√ÆmprospƒÉtare la 20 s",ukTime:"Ora UK:",mapHint:"DacƒÉ nu existƒÉ vehicule live, harta rƒÉm√¢ne goalƒÉ.",destination:"Destina»õie",departure:"Plecare",due:"Due",late:"√Ænt√¢rziere",early:"mai devreme",addFav:"AdaugƒÉ la preferate",rmFav:"»òterge din preferate"}
};
const LANGS=["EN","HU","DE","PL","RO"];
function guessLang(){const n=(navigator.language||"en").slice(0,2).toUpperCase();return LANGS.includes(n)?n:"EN";}
let LANG=localStorage.getItem("lang")||guessLang();
function t(k){return (I18N[LANG]||I18N.EN)[k]||k;}

/* ---------- helpers ---------- */
const $=sel=>document.querySelector(sel);
function el(tag, cls, txt){const e=document.createElement(tag); if(cls)e.className=cls; if(txt!=null)e.textContent=txt; return e;}
function setSel(select, arr, valKey, textKey){ select.innerHTML=""; arr.forEach(x=>{const o=document.createElement("option"); o.value=x[valKey]; o.textContent=x[textKey]; select.appendChild(o);});}
function hhmm(x){ const d=new Date(x); return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false}); }
const UK = new Intl.DateTimeFormat([], {hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false, timeZone:'Europe/London'});

/* ---------- UI refs ---------- */
const wrap=$("#wrap"), appTitle=$("#app-title"), langSel=$("#lang");
const tabStop=$("#tabStop"), tabRoute=$("#tabRoute"), tabFav=$("#tabFav");
const ukTimeLbl=$("#ukTime"), buildSpan=$("#build"), refreshLbl=$("#refreshLbl");
const stopCard=$("#stopCard"), routeCard=$("#routeCard"), favCard=$("#favCard");
const stopQuery=$("#stopQuery"), windowMin=$("#windowMin"), stopSearchBtn=$("#stopSearchBtn"), stopSelect=$("#stopSelect");
const selectedStopLbl=$("#selectedStopLbl"), refreshEvery=$("#refreshEvery"), stopList=$("#stopList");
const routeQuery=$("#routeQuery"), routeSearchBtn=$("#routeSearchBtn"), routeSelect=$("#routeSelect");
const mapHint=$("#mapHint"), toggleBoard=$("#toggleBoard"), toggleFS=$("#toggleFS");
const cfgModal=$("#cfgModal"), openCfg=$("#openCfg"), closeCfg=$("#closeCfg"), feedUrl=$("#feedUrl"), saveFeed=$("#saveFeed");
const favStopBtn=$("#favStopBtn"), favStopLbl=$("#favStopLbl"), favRouteBtn=$("#favRouteBtn"), favRouteLbl=$("#favRouteLbl");
const favStops=$("#favStops"), favRoutes=$("#favRoutes");

/* ---------- i18n apply ---------- */
function fillLang(){ langSel.innerHTML=""; LANGS.forEach(c=>{const o=document.createElement("option"); o.value=c; o.textContent=c; if(c===LANG)o.selected=true; langSel.appendChild(o);});}
function applyI18n(){
  appTitle.textContent=t("app");
  tabStop.textContent=t("stopTab"); tabRoute.textContent=t("routeTab"); tabFav.textContent=t("favTab");
  stopQuery.placeholder=t("stopName"); stopSearchBtn.textContent=t("search");
  routeQuery.placeholder=t("routeTab"); routeSearchBtn.textContent=t("search");
  refreshEvery.textContent=t("refreshEvery"); mapHint.textContent=t("mapHint");
}
langSel.onchange=()=>{LANG=langSel.value; localStorage.setItem("lang",LANG); applyI18n();};
fillLang(); applyI18n();

/* ---------- tabs ---------- */
function showStop(){ tabStop.classList.add("active"); tabRoute.classList.remove("active"); tabFav.classList.remove("active"); stopCard.style.display="block"; routeCard.style.display="none"; favCard.style.display="none"; }
function showRoute(){ tabRoute.classList.add("active"); tabStop.classList.remove("active"); tabFav.classList.remove("active"); routeCard.style.display="block"; stopCard.style.display="none"; favCard.style.display="none"; }
function showFav(){ tabFav.classList.add("active"); tabStop.classList.remove("active"); tabRoute.classList.remove("active"); favCard.style.display="block"; stopCard.style.display="none"; routeCard.style.display="none"; renderFavs(); }
tabStop.onclick=showStop; tabRoute.onclick=showRoute; tabFav.onclick=showFav;

/* ---------- clock & status ---------- */
async function tick(){
  try{ const r=await fetch("/api/status"); const j=await r.json();
       ukTimeLbl.textContent=`${t("ukTime")} ${j.uk_time}`; buildSpan.textContent=j.build;
  }catch(e){}
}
setInterval(tick, 1000); tick(); refreshLbl.textContent=`Refresh every 20 s`;

/* ---------- config modal ---------- */
openCfg.onclick=async()=>{ cfgModal.style.display="grid"; try{ const r=await fetch("/api/live/config"); const j=await r.json(); feedUrl.value=j.feed_url||"";}catch(e){} };
closeCfg.onclick=()=> cfgModal.style.display="none";
saveFeed.onclick=async()=>{ try{ await fetch("/api/live/config",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({feed_url:feedUrl.value.trim()})}); cfgModal.style.display="none"; }catch(e){ alert("Save failed"); } };

/* ---------- stop search ---------- */
stopSearchBtn.onclick=async()=>{
  const q=stopQuery.value.trim(); if(!q) return;
  const r=await fetch(`/api/stops/search?q=${encodeURIComponent(q)}`); const items=await r.json();
  setSel(stopSelect, items, "id", "name");
  if(items[0]){ stopSelect.value=items[0].id; selectedStopLbl.textContent=`${t("chosenStop")} ${items[0].name}`; renderDepartures(); }
  else selectedStopLbl.textContent=t("resultsChoose");
};
stopSelect.onchange=()=>{ selectedStopLbl.textContent=`${t("chosenStop")} ${stopSelect.options[stopSelect.selectedIndex]?.text||"‚Äì"}`; renderDepartures(); };

function delayBadge(d){ if(!d) return ""; const n=Number(d); if(!n) return "";
  const sign=n>0?"+":""; const cls=n>0?"":"muted";
  return `<span class="mono ${n>0?'good':''} ${cls}" style="margin-left:8px">${sign}${n} min</span>`;
}
async function renderDepartures(){
  const id=stopSelect.value; if(!id) return;
  const w=Math.max(1, Number(windowMin.value||60));
  const r=await fetch(`/api/stops/${encodeURIComponent(id)}/next_departures?window=${w}`); const j=await r.json();
  stopList.innerHTML="";
  (j.departures||[]).forEach(row=>{
    const it=el("div","item");
    it.innerHTML = `
      <div class="pill">${row.route||"‚Äì"}</div>
      <div class="dest">${row.destination||"‚Äì"}</div>
      <div class="time mono ${row.is_due?'good blink':row.is_live?'good':''}">${row.is_due?t("due"):row.time_display}${delayBadge(row.delay_min)}</div>
      <div class="op muted">bluestar</div>`;
    it.onclick=()=>openTrip(row.trip_id,row.route,row.destination);
    stopList.appendChild(it);
  });
}
setInterval(renderDepartures, 20000);

/* ---------- trip modal ---------- */
function openTrip(tripId, route, headsign){
  if(!tripId) return;
  (async()=>{
    const r=await fetch(`/api/trips/${encodeURIComponent(tripId)}`); const j=await r.json();
    const wrap=document.createElement("div"); wrap.className="modal";
    const box=document.createElement("div"); box.className="box";
    box.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div><strong>Trip</strong> ¬∑ ${route||""} ‚Üí ${headsign||""}</div><button class="btn" id="closeTrip">√ó</button></div>`;
    const list=document.createElement("div"); list.className="list";
    (j.stops||[]).forEach(s=>{ const row=document.createElement("div"); row.className="item";
      const left=el("div","muted mono",s.time_display); if(s.is_past) left.style.opacity=.6;
      const name=el("div","",s.stop_name); if(s.is_past) name.style.opacity=.6;
      row.appendChild(el("div","pill", "")); row.appendChild(name); row.appendChild(left); row.appendChild(el("div","op muted","")); list.appendChild(row);});
    box.appendChild(list); wrap.appendChild(box); document.body.appendChild(wrap);
    document.getElementById("closeTrip").onclick=()=>document.body.removeChild(wrap);
  })();
}

/* ---------- map / route vehicles ---------- */
let map, markers=[];
function ensureMap(){ if(map) return; map = L.map('map',{zoomControl:true}).setView([50.9097,-1.4044],12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'Leaflet | ¬© OpenStreetMap'}).addTo(map); }
routeSearchBtn.onclick=async()=>{ const q=routeQuery.value.trim(); if(!q) return;
  const r=await fetch(`/api/routes/search?q=${encodeURIComponent(q)}`); const items=await r.json(); setSel(routeSelect, items, "route","route"); if(items[0]){ routeSelect.value=items[0].route; renderVehicles(); } };
routeSelect.onchange=renderVehicles;
async function renderVehicles(){
  ensureMap(); markers.forEach(m=>m.remove()); markers=[];
  const route=routeSelect.value; if(!route) return;
  const r=await fetch(`/api/routes/${encodeURIComponent(route)}/vehicles`); const j=await r.json(); const vs=j.vehicles||[];
  vs.forEach(v=>{ const m=L.marker([v.lat,v.lon]).addTo(map).bindPopup(`${v.label||""}`); markers.push(m); });
  if(vs.length){ const g=L.featureGroup(markers); map.fitBounds(g.getBounds().pad(0.2)); }
}

/* ---------- favourites (localStorage) ---------- */
function getFav(){ return JSON.parse(localStorage.getItem("favs")||'{"stops":[],"routes":[]}'); }
function setFav(x){ localStorage.setItem("favs", JSON.stringify(x)); renderFavState(); renderFavs(); }
function renderFavState(){
  const f=getFav(); const sid=stopSelect.value; const sname=stopSelect.options[stopSelect.selectedIndex]?.text||"";
  const rid=routeSelect.value;
  const stopOn=f.stops.find(s=>s.id===sid); favStopBtn.textContent=stopOn?"‚òÖ":"‚òÜ"; favStopLbl.textContent=stopOn?t("rmFav"):t("addFav");
  const routeOn=f.routes.find(r=>r.id===rid); favRouteBtn.textContent=routeOn?"‚òÖ":"‚òÜ"; favRouteLbl.textContent=routeOn?t("rmFav"):t("addFav");
}
favStopBtn.onclick=()=>{ const f=getFav(); const id=stopSelect.value; if(!id) return; const name=stopSelect.options[stopSelect.selectedIndex]?.text||id;
  const i=f.stops.findIndex(s=>s.id===id); if(i>=0) f.stops.splice(i,1); else f.stops.push({id,name}); setFav(f); };
favRouteBtn.onclick=()=>{ const f=getFav(); const id=routeSelect.value; if(!id) return; const i=f.routes.findIndex(r=>r.id===id); if(i>=0) f.routes.splice(i,1); else f.routes.push({id}); setFav(f); };
function renderFavs(){
  const f=getFav(); favStops.innerHTML=""; favRoutes.innerHTML="";
  f.stops.forEach(s=>{ const it=el("div","item"); it.innerHTML=`<div class="pill">‚òÖ</div><div>${s.name}</div><div class="mono">Stop</div><div class="op"><button class="btn ghost">Open</button></div>`;
    it.querySelector("button").onclick=()=>{ showStop(); stopQuery.value=""; stopSelect.innerHTML=`<option value="${s.id}">${s.name}</option>`; stopSelect.value=s.id; selectedStopLbl.textContent=`${t("chosenStop")} ${s.name}`; renderDepartures(); };
    favStops.appendChild(it);
  });
  f.routes.forEach(r=>{ const it=el("div","item"); it.innerHTML=`<div class="pill">‚òÖ</div><div>${r.id}</div><div class="mono">Route</div><div class="op"><button class="btn ghost">Open</button></div>`;
    it.querySelector("button").onclick=()=>{ showRoute(); routeQuery.value=""; routeSelect.innerHTML=`<option value="${r.id}">${r.id}</option>`; routeSelect.value=r.id; renderVehicles(); };
    favRoutes.appendChild(it);
  });
}
setInterval(renderFavState, 2000);

/* ---------- board mode & fullscreen ---------- */
let board=false, fs=false;
function applyBoard(){
  if(board){ wrap.classList.add("board"); }
  else { wrap.classList.remove("board"); }
}
toggleBoard.onclick=()=>{ board=!board; applyBoard(); };
toggleFS.onclick=()=>{ fs=!fs; if(fs){ wrap.classList.add("fs"); } else { wrap.classList.remove("fs"); } };

/* ---------- initial ---------- */
(function init(){
  refreshLbl.textContent="Refresh every 20 s";
  showStop(); renderFavs(); renderFavState(); applyBoard();
})();
</script>
</body>
</html>
