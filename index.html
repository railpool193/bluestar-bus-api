<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bluestar Bus – Live Departures</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    :root {
      --bg:#0b0f14; --card:#121826; --muted:#9aa4b2; --text:#e6edf3;
      --accent:#2563eb; --accent-2:#38bdf8; --live:#22c55e; --border:#1f2937;
    }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:900px;margin:28px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px 18px 8px}
    h1{margin:0 0 18px;font-weight:700}
    .live{display:inline-flex;align-items:center;gap:8px;background:rgba(34,197,94,.12);color:#86efac;border:1px solid rgba(34,197,94,.35);padding:3px 10px;border-radius:999px;font-size:12px}
    label{display:block;margin:12px 0 6px;color:var(--muted);font-size:14px}
    .row{display:grid;grid-template-columns:1fr auto;gap:10px}
    .input{width:100%;background:#0f1522;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:12px 12px;font-size:16px;outline:none}
    .btn{background:var(--accent);color:#fff;border:0;border-radius:10px;padding:12px 16px;font-size:16px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .grid{margin-top:18px;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 14px;border-bottom:1px solid var(--border)}
    th{color:var(--muted);text-align:left;font-weight:600;background:#0f1522}
    tr:last-child td{border-bottom:0}
    /* Autocomplete */
    .ac-wrap{position:relative}
    .ac-list{position:absolute;top:100%;left:0;right:0;background:#0f1522;border:1px solid var(--border);border-radius:10px;margin-top:6px;overflow:hidden;z-index:50;max-height:260px;overflow-y:auto;display:none}
    .ac-item{padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer}
    .ac-item:last-child{border-bottom:none}
    .ac-item strong{color:#fff}
    .ac-item small{color:var(--muted)}
    .ac-item:hover,.ac-item.active{background:#111a2b}
    .meta{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:14px;margin:8px 0 14px}
    .ok{background:#0f1522;border:1px solid var(--border);color:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}
    .ok:hover{border-color:#2a364a}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Bluestar Bus – Live Departures</h1>
      <div class="meta">
        <span class="live">ÉLŐ</span>
        <span>jelzés: BODS SIRI-VM adatok szerint</span>
      </div>

      <label for="q">Megálló neve</label>
      <div class="row ac-wrap">
        <input id="q" class="input" placeholder="pl. Vincents Walk" autocomplete="off" />
        <button id="searchBtn" class="btn">Keresés</button>

        <!-- legördülő találatlista -->
        <div id="acList" class="ac-list"></div>
      </div>

      <div class="row" style="grid-template-columns: 1fr 150px;">
        <div>
          <label for="stopId">Stop ID</label>
          <input id="stopId" class="input" placeholder="pl. 1980SN12619E" />
        </div>
        <div>
          <label for="minutes">Időablak (perc)</label>
          <input id="minutes" class="input" type="number" min="1" value="60" />
        </div>
      </div>

      <div style="margin-top:12px">
        <button id="okBtn" class="btn" style="width:100%">Indulások lekérése</button>
      </div>

      <div class="grid" id="grid" style="display:none">
        <table>
          <thead><tr><th>Route</th><th>Destination</th><th>Time</th></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  // --- helpers
  const $ = (s)=>document.querySelector(s);
  const acWrap = $('.ac-wrap'); const acList = $('#acList');
  const q = $('#q'); const stopId = $('#stopId'); const minutes = $('#minutes');
  const tbody = $('#tbody'); const grid = $('#grid');

  // Debounce
  let t=null; const debounce = (fn,ms=250)=>(...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),ms);};

  // Render list
  function renderList(items){
    acList.innerHTML='';
    if(!items.length){ acList.style.display='none'; return; }
    items.forEach((it,idx)=>{
      const div=document.createElement('div');
      div.className='ac-item'+(idx===0?' active':'');
      div.innerHTML=`<strong>${it.stop_name}</strong><br><small>${it.stop_id}</small>`;
      div.addEventListener('click',()=> selectItem(it));
      acList.appendChild(div);
    });
    acList.style.display='block';
  }

  function selectItem(it){
    q.value = it.stop_name;
    stopId.value = it.stop_id;
    acList.style.display='none';
  }

  // Keyboard navigation
  q.addEventListener('keydown',(e)=>{
    const items=[...acList.querySelectorAll('.ac-item')];
    if(!items.length) return;
    const idx=items.findIndex(x=>x.classList.contains('active'));
    if(e.key==='ArrowDown'){ e.preventDefault(); const ni=Math.min(idx+1,items.length-1); items.forEach(x=>x.classList.remove('active')); items[ni].classList.add('active'); items[ni].scrollIntoView({block:'nearest'}); }
    if(e.key==='ArrowUp'){ e.preventDefault(); const ni=Math.max(idx-1,0); items.forEach(x=>x.classList.remove('active')); items[ni].classList.add('active'); items[ni].scrollIntoView({block:'nearest'}); }
    if(e.key==='Enter'){ e.preventDefault(); const cur=acList.querySelector('.ac-item.active'); if(cur){ cur.click(); } else { doSearch(); } }
    if(e.key==='Escape'){ acList.style.display='none'; }
  });

  // Live search while typing
  q.addEventListener('input', debounce(async ()=>{
    const term=q.value.trim();
    if(term.length<2){ acList.style.display='none'; return; }
    try{
      const res = await fetch(`/search_stops?q=${encodeURIComponent(term)}`);
      if(!res.ok) throw new Error('search failed');
      const data = await res.json();  // [{stop_id, stop_name}, ...]
      renderList(data.slice(0,20));
    }catch(e){ acList.style.display='none'; }
  }, 250));

  // Click outside to close
  document.addEventListener('click', (e)=>{
    if(!acWrap.contains(e.target)) acList.style.display='none';
  });

  async function doSearch(){
    const term=q.value.trim();
    if(!term){ alert('Adj meg egy megállónevet!'); return; }
    try{
      const res = await fetch(`/search_stops?q=${encodeURIComponent(term)}`);
      if(!res.ok) throw 0;
      const data = await res.json();
      if(!data.length){ alert('Nincs találat erre a névre.'); return; }
      // ha több találat van, a legelsőt vesszük (a legördülőből kattintva úgyis pontos lesz)
      selectItem(data[0]);
    }catch{ alert('Hiba a keresés közben. Próbáld újra.'); }
  }

  async function loadDepartures(){
    const id = stopId.value.trim();
    const mins = Math.max(1, parseInt(minutes.value||'60',10));
    if(!id){ alert('Stop ID szükséges.'); return; }
    try{
      const res = await fetch(`/next_departures/${encodeURIComponent(id)}?minutes=${mins}`);
      if(!res.ok) throw 0;
      const data = await res.json();
      tbody.innerHTML='';
      (data.departures||[]).forEach(d=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${d.route||''}</td><td>${d.destination||''}</td><td>${d.departure_time||''}</td>`;
        tbody.appendChild(tr);
      });
      grid.style.display='block';
      if((data.departures||[]).length===0){
        const tr=document.createElement('tr'); tr.innerHTML=`<td colspan="3" style="color:#9aa4b2">Nincs indulás ebben az időablakban.</td>`;
        tbody.appendChild(tr);
      }
    }catch{ alert('Hiba az indulások lekérésekor.'); }
  }

  $('#searchBtn').addEventListener('click', doSearch);
  $('#okBtn').addEventListener('click', loadDepartures);
</script>
</body>
</html>
