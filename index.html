<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bluestar Bus â€” stop & route finder</title>
<link rel="preconnect" href="https://unpkg.com">
<link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  :root { --bg:#0d1220; --card:#131a2c; --text:#e6e8ef; --muted:#9aa3b2; --accent:#7c8cff; --good:#2bd576; }
  body { background:var(--bg); color:var(--text); font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  .container{ max-width:980px; margin:24px auto; padding:0 12px; }
  .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .card{ background:var(--card); border-radius:16px; padding:16px; box-shadow:0 4px 24px rgba(0,0,0,.25); }
  .btn{ background:var(--accent); color:#fff; border:none; border-radius:12px; padding:10px 14px; font-weight:600; cursor:pointer; }
  .input, select{ background:#0f1424; color:var(--text); border:1px solid #202844; border-radius:12px; padding:10px 12px; width:100%; }
  .list{ display:grid; gap:10px; margin-top:12px; }
  .item{ background:#0f1424; border-radius:12px; padding:12px; display:flex; align-items:center; justify-content:space-between; }
  .pill{ width:42px; height:42px; border-radius:999px; background:#1a2442; display:grid; place-items:center; font-weight:800; }
  .muted{ color:var(--muted); }
  .good{ color:var(--good); }
  .blink{ animation:blink 1s step-start infinite; }
  @keyframes blink { 50%{ opacity:0; } }
  .tabs{ display:flex; gap:8px; margin:16px 0; }
  .tab{ padding:10px 14px; border-radius:999px; background:#0f1424; cursor:pointer; }
  .tab.active{ background:#2a3354; }
  .map{ height:360px; border-radius:12px; overflow:hidden; }
  .lang{ margin-left:auto; }
  .title { font-size:clamp(22px, 4vw, 34px); font-weight:800; display:flex; align-items:center; gap:10px }
</style>
</head>
<body>
  <div class="container">
    <div class="row">
      <div class="title">ðŸšŒ <span id="app-title"></span></div>
      <select id="lang" class="input lang" style="width:100px"></select>
    </div>

    <div class="muted" style="margin:6px 0 18px">
      <span id="ukTime">â€“:â€“</span> Â· <span id="refreshLbl"></span>
    </div>

    <div class="tabs">
      <div id="tabStop" class="tab active"></div>
      <div id="tabRoute" class="tab"></div>
    </div>

    <!-- Stop card -->
    <div id="stopCard" class="card">
      <div class="row">
        <input id="stopQuery" class="input" placeholder="" />
        <input id="windowMin" class="input" type="number" value="60" style="max-width:140px" />
        <button id="stopSearchBtn" class="btn"></button>
      </div>
      <select id="stopSelect" class="input" style="margin-top:10px"></select>
      <div class="muted" style="margin-top:6px">
        <span id="selectedStopLbl"></span>
        <span style="float:right"><span id="refreshEvery"></span></span>
      </div>
      <div id="stopList" class="list"></div>
      <div class="muted" style="margin-top:8px">Build: <span id="build"></span> Â· Cache-bypass</div>
    </div>

    <!-- Route card -->
    <div id="routeCard" class="card" style="display:none">
      <div class="row">
        <input id="routeQuery" class="input" placeholder="" />
        <button id="routeSearchBtn" class="btn"></button>
      </div>
      <select id="routeSelect" class="input" style="margin-top:10px"></select>
      <div id="map" class="map" style="margin-top:12px"></div>
      <div class="muted" style="margin-top:8px" id="mapHint"></div>
    </div>
  </div>

<script>
/* ---------------- i18n ---------------- */
const I18N = {
  EN:{app:"Bluestar Bus â€” stop & route finder",stopTab:"Stop",routeTab:"Route",search:"Search",stopName:"Stop name",window:"Window (min)",resultsChoose:"Results â€” choose a stop",chosenStop:"Selected stop:",refreshEvery:"Refresh every 20 s",ukTime:"UK time:",mapHint:"If there are no live vehicles on the route, the map will be empty.",destination:"Destination",departure:"Departure",due:"Due"},
  DE:{app:"Bluestar Bus â€” Haltestellen & Linien",stopTab:"Haltestelle",routeTab:"Linie",search:"Suche",stopName:"Haltestellenname",window:"Zeitfenster (Min.)",resultsChoose:"Treffer â€” wÃ¤hle eine Haltestelle",chosenStop:"GewÃ¤hlte Haltestelle:",refreshEvery:"Aktualisierung alle 20 s",ukTime:"UK-Zeit:",mapHint:"Wenn keine Live-Fahrzeuge vorhanden sind, bleibt die Karte leer.",destination:"Ziel",departure:"Abfahrt",due:"Due"},
  HU:{app:"Bluestar Bus â€” megÃ¡llÃ³ & jÃ¡rat keresÅ‘",stopTab:"MegÃ¡llÃ³",routeTab:"Vonal",search:"KeresÃ©s",stopName:"MegÃ¡llÃ³ nÃ©v",window:"IdÅ‘ablak (perc)",resultsChoose:"TalÃ¡latok â€” vÃ¡lassz megÃ¡llÃ³t",chosenStop:"VÃ¡lasztott megÃ¡llÃ³:",refreshEvery:"FrissÃ­tÃ©s 20 s",ukTime:"UK idÅ‘:",mapHint:"Ha nincs Ã©lÅ‘ jÃ¡rmÅ± a vonalon, a tÃ©rkÃ©p Ã¼res marad.",destination:"CÃ©l",departure:"IndulÃ¡s",due:"Due"},
  PL:{app:"Bluestar Bus â€” wyszukiwarka przystankÃ³w i linii",stopTab:"Przystanek",routeTab:"Linia",search:"Szukaj",stopName:"Nazwa przystanku",window:"Okno (min)",resultsChoose:"Wyniki â€” wybierz przystanek",chosenStop:"Wybrany przystanek:",refreshEvery:"OdÅ›wieÅ¼anie co 20 s",ukTime:"Czas UK:",mapHint:"JeÅ›li brak pojazdÃ³w na Å¼ywo, mapa bÄ™dzie pusta.",destination:"Kierunek",departure:"Odjazd",due:"Due"},
  RO:{app:"Bluestar Bus â€” cÄƒutare staÈ›ii & linii",stopTab:"StaÈ›ie",routeTab:"Linie",search:"CÄƒutare",stopName:"Numele staÈ›iei",window:"FereastrÄƒ (min)",resultsChoose:"Rezultate â€” alege o staÈ›ie",chosenStop:"StaÈ›ie selectatÄƒ:",refreshEvery:"ReÃ®mprospÄƒtare la 20 s",ukTime:"Ora UK:",mapHint:"DacÄƒ nu existÄƒ vehicule live, harta rÄƒmÃ¢ne goalÄƒ.",destination:"DestinaÈ›ie",departure:"Plecare",due:"Due"}
};
const LANGS=["EN","DE","HU","PL","RO"];
function guessLang(){const n=(navigator.language||"en").slice(0,2).toUpperCase();return LANGS.includes(n)?n:"EN";}
let LANG=localStorage.getItem("lang")||guessLang();

/* ---------------- helpers ---------------- */
function t(k){return (I18N[LANG]||I18N.EN)[k]||k;}
function hhmm(x){const d=new Date(x);return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',hour12:false});}
function el(tag,cls,txt){const e=document.createElement(tag);if(cls)e.className=cls;if(txt!=null)e.textContent=txt;return e;}

/* ---------------- UI refs ---------------- */
const appTitle=document.getElementById("app-title"),langSel=document.getElementById("lang"),tabStop=document.getElementById("tabStop"),tabRoute=document.getElementById("tabRoute"),ukTimeLbl=document.getElementById("ukTime"),refreshLbl=document.getElementById("refreshLbl"),stopCard=document.getElementById("stopCard"),routeCard=document.getElementById("routeCard"),stopQuery=document.getElementById("stopQuery"),windowMin=document.getElementById("windowMin"),stopSearchBtn=document.getElementById("stopSearchBtn"),stopSelect=document.getElementById("stopSelect"),selectedStopLbl=document.getElementById("selectedStopLbl"),refreshEvery=document.getElementById("refreshEvery"),stopList=document.getElementById("stopList"),buildSpan=document.getElementById("build"),routeQuery=document.getElementById("routeQuery"),routeSearchBtn=document.getElementById("routeSearchBtn"),routeSelect=document.getElementById("routeSelect"),mapHint=document.getElementById("mapHint");

/* init i18n */
function fillLang(){langSel.innerHTML="";LANGS.forEach(c=>{const o=document.createElement("option");o.value=c;o.textContent=c;if(c===LANG)o.selected=true;langSel.appendChild(o);});}
function applyI18n(){appTitle.textContent=t("app");tabStop.textContent=t("stopTab");tabRoute.textContent=t("routeTab");stopQuery.placeholder=t("stopName");stopSearchBtn.textContent=t("search");routeQuery.placeholder=t("routeTab");routeSearchBtn.textContent=t("search");refreshEvery.textContent=t("refreshEvery");mapHint.textContent=t("mapHint");}
fillLang();applyI18n();
langSel.onchange=()=>{LANG=langSel.value;localStorage.setItem("lang",LANG);applyI18n();};

/* tabs */
function showStop(){tabStop.classList.add("active");tabRoute.classList.remove("active");stopCard.style.display="block";routeCard.style.display="none";}
function showRoute(){tabRoute.classList.add("active");tabStop.classList.remove("active");stopCard.style.display="none";routeCard.style.display="block";}
tabStop.onclick=showStop;tabRoute.onclick=showRoute;

/* status clock */
async function tick(){try{const r=await fetch("/api/status");const j=await r.json();ukTimeLbl.textContent=`${t("ukTime")} ${j.uk_time}`;buildSpan.textContent=j.build;}catch(e){}}
setInterval(tick,1000);tick();
refreshLbl.textContent=t("refreshEvery");

/* stop search */
stopSearchBtn.onclick=async()=>{const q=stopQuery.value.trim();if(!q)return;const r=await fetch(`/api/stops/search?q=${encodeURIComponent(q)}`);const items=await r.json();stopSelect.innerHTML="";items.forEach(it=>{const o=document.createElement("option");o.value=it.id;o.textContent=it.name;stopSelect.appendChild(o);});selectedStopLbl.textContent=`${t("chosenStop")} ${items[0]?.name||"â€“"}`;if(items[0]){stopSelect.value=items[0].id;renderDepartures();}};
stopSelect.onchange=()=>{selectedStopLbl.textContent=`${t("chosenStop")} ${stopSelect.options[stopSelect.selectedIndex]?.text||"â€“"}`;renderDepartures();};

/* departures */
async function renderDepartures(){
  const id=stopSelect.value;if(!id)return;
  const w=Math.max(1,Number(windowMin.value||60));
  const r=await fetch(`/api/stops/${encodeURIComponent(id)}/next_departures?window=${w}`);
  const j=await r.json();
  stopList.innerHTML="";
  (j.departures||[]).forEach(row=>{
    const it=el("div","item");
    const left=el("div","row");left.style.gap="10px";
    left.appendChild(el("div","pill",row.route||"â€“"));
    const mid=el("div");mid.appendChild(el("div","",row.destination||"â€“"));
    const right=el("div","");
    const timeSpan=el("span",(row.is_due?"good blink":(row.is_live?"good":"")),row.is_due?t("due"):row.time_display);
    right.appendChild(timeSpan);
    it.appendChild(left);it.appendChild(mid);it.appendChild(right);
    it.onclick=()=>openTrip(row.trip_id,row.route,row.destination);
    stopList.appendChild(it);
  });
}
setInterval(renderDepartures,20000);

/* trip modal */
let modal;
function openTrip(tripId,route,headsign){
  if(!tripId)return;(async()=>{
    const r=await fetch(`/api/trips/${encodeURIComponent(tripId)}`);const j=await r.json();
    const wrap=document.createElement("div");wrap.style.position="fixed";wrap.style.inset="0";wrap.style.background="rgba(0,0,0,.6)";wrap.style.display="grid";wrap.style.placeItems="center";wrap.style.zIndex="9999";
    const box=document.createElement("div");box.className="card";box.style.maxWidth="700px";box.style.width="90%";
    box.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div><strong>Trip</strong> Â· ${route||""} â†’ ${headsign||""}</div>
      <button class="btn" id="closeTrip">Ã—</button>
    </div>`;
    const list=document.createElement("div");list.className="list";
    (j.stops||[]).forEach(s=>{const row=document.createElement("div");row.className="item";
      const left=document.createElement("div");left.className="muted";left.textContent=s.time_display;if(s.is_past){left.style.opacity=.6;}
      const name=document.createElement("div");name.textContent=s.stop_name;if(s.is_past){name.style.opacity=.6;}
      row.appendChild(left);row.appendChild(name);list.appendChild(row);
    });
    box.appendChild(list);wrap.appendChild(box);document.body.appendChild(wrap);
    document.getElementById("closeTrip").onclick=()=>document.body.removeChild(wrap);
    modal=wrap;
  })();
}

/* route + map */
let map,markers=[];
function ensureMap(){if(map)return;map=L.map('map',{zoomControl:true}).setView([50.9097,-1.4044],12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'Leaflet | Â© OpenStreetMap'}).addTo(map);}
routeSearchBtn.onclick=async()=>{const q=routeQuery.value.trim();if(!q)return;const r=await fetch(`/api/routes/search?q=${encodeURIComponent(q)}`);const items=await r.json();
  routeSelect.innerHTML="";items.forEach(it=>{const o=document.createElement("option");o.value=it.route;o.textContent=it.route;routeSelect.appendChild(o);});
  if(items[0]){routeSelect.value=items[0].route;renderVehicles();}
};
routeSelect.onchange=renderVehicles;

async function renderVehicles(){
  ensureMap();markers.forEach(m=>m.remove());markers=[];
  const route=routeSelect.value;if(!route)return;
  const r=await fetch(`/api/routes/${encodeURIComponent(route)}/vehicles`);const j=await r.json();const vs=j.vehicles||[];
  vs.forEach(v=>{const m=L.marker([v.lat,v.lon]).addTo(map).bindPopup(`${route} Â· ${v.label||""}`);markers.push(m);});
  if(vs.length){const g=L.featureGroup(markers);map.fitBounds(g.getBounds().pad(0.2));}
}

/* auto start */
showStop();
</script>
</body>
</html>
