<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bluestar Bus ‚Äî stop & route finder</title>
<link rel="preconnect" href="https://unpkg.com">
<link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  :root { --bg:#0d1220; --card:#131a2c; --text:#e6e8ef; --muted:#9aa3b2; --accent:#8e97ff; --good:#2bd576; --chip:#1a2442; --board:#0a0d10; --danger:#d85252; }
  html,body{height:100%}
  body { background:var(--bg); color:var(--text); font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif; }
  a{color:var(--accent);text-decoration:none}
  .container{ max-width:980px; margin:24px auto 80px; padding:0 12px; }
  .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .card{ background:var(--card); border-radius:16px; padding:16px; box-shadow:0 4px 24px rgba(0,0,0,.25); }
  .btn{ background:var(--accent); color:#fff; border:none; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer; }
  .btn.ghost{ background:#0f1424; color:var(--text); border:1px solid #273153; }
  .btn.danger{ background:var(--danger); }
  .input, select, textarea{ background:#0f1424; color:var(--text); border:1px solid #202844; border-radius:12px; padding:10px 12px; width:100%; }
  .list{ display:grid; gap:10px; margin-top:12px; }
  .item{ background:#0f1424; border-radius:12px; padding:12px; display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:10px; }
  .pill{ min-width:48px; height:38px; border-radius:10px; background:var(--chip); display:grid; place-items:center; font-weight:800; padding:0 10px; }
  .muted{ color:var(--muted); }
  .good{ color:var(--good); }
  .blink{ animation:blink 1s step-start infinite; } @keyframes blink { 50%{opacity:0} }
  .tabs{ display:flex; gap:8px; margin:16px 0; }
  .tab{ padding:10px 14px; border-radius:999px; background:#0f1424; cursor:pointer; }
  .tab.active{ background:#2a3354; }
  .map{ height:360px; border-radius:12px; overflow:hidden; }
  .lang{ margin-left:auto; }
  .title { font-size:clamp(22px,4vw,34px); font-weight:800; display:flex; align-items:center; gap:10px }
  .gear { background:#213058; border:1px solid #2c3c6a; border-radius:10px; padding:8px 10px; cursor:pointer; }
  .star { cursor:pointer; user-select:none }
  .mono{ font-variant-numeric: tabular-nums; }
  .toast{ position:fixed; left:16px; right:16px; bottom:16px; background:#3a2a2a; color:#fff; padding:14px 16px; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.35); display:none; z-index:10000 }
  .toast.show{ display:block }
  /* modal */
  .modal{position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.45); z-index:9999}
  .box{ background:var(--card); border:1px solid #2b365e; border-radius:14px; padding:16px; width:min(720px,94vw); box-shadow:0 18px 60px rgba(0,0,0,.55)}
  .box .row{align-items:flex-end}
  .box h3{margin:0 0 6px 0}
  /* Board mode */
  .board .card{ background:var(--board); }
  .board .title{ font-size:38px }
  .board .item{ grid-template-columns: 90px 1fr auto auto; padding:16px; }
  .board .pill{ font-size:22px; height:44px; min-width:72px; }
  .board .item .dest{ font-size:24px }
  .board .item .time{ font-size:26px; font-weight:800 }
  .board .item .op{ font-size:18px; padding:6px 10px; border:1px solid #2c3c6a; border-radius:8px; }
  .fs { position:fixed; inset:12px; z-index:9998; overflow:auto; }
</style>
</head>
<body>
  <div class="container" id="wrap">
    <div class="row">
      <div class="title">üöå <span id="app-title"></span></div>
      <div class="muted" id="ukTime" style="margin-left:12px">‚Äì:‚Äì</div>
      <button class="btn ghost" id="toggleBoard" title="Display board mode">Board</button>
      <button class="btn ghost" id="toggleFS" title="Fullscreen">‚õ∂</button>
      <div class="gear" id="openCfg" title="Settings">‚öôÔ∏è</div>
      <select id="lang" class="input lang" style="width:100px"></select>
    </div>

    <div class="muted" style="margin:6px 0 18px">
      <span id="refreshLbl"></span> ¬∑ Build: <span id="build"></span>
    </div>

    <div class="tabs">
      <div id="tabStop" class="tab active"></div>
      <div id="tabRoute" class="tab"></div>
      <div id="tabFav" class="tab"></div>
    </div>

    <!-- STOP -->
    <div id="stopCard" class="card">
      <div class="row">
        <input id="stopQuery" class="input" />
        <input id="windowMin" class="input" type="number" value="60" style="max-width:140px" />
        <button id="stopSearchBtn" class="btn"></button>
      </div>
      <select id="stopSelect" class="input" style="margin-top:10px"></select>
      <div class="row" style="margin-top:6px; justify-content:space-between">
        <div class="muted"><span id="selectedStopLbl"></span></div>
        <div class="muted"><span id="refreshEvery"></span></div>
      </div>
      <div class="list" id="stopList"></div>
      <div class="muted" style="margin-top:8px">
        <span class="star" id="favStopBtn">‚òÜ</span>
        <span id="favStopLbl"></span>
      </div>
    </div>

    <!-- ROUTE -->
    <div id="routeCard" class="card" style="display:none">
      <div class="row">
        <input id="routeQuery" class="input" />
        <button id="routeSearchBtn" class="btn"></button>
      </div>
      <select id="routeSelect" class="input" style="margin-top:10px"></select>
      <div id="map" class="map" style="margin-top:12px"></div>
      <div class="row" style="margin-top:8px; justify-content:space-between">
        <div class="muted" id="mapHint"></div>
        <div class="muted">
          <span class="star" id="favRouteBtn">‚òÜ</span>
          <span id="favRouteLbl"></span>
        </div>
      </div>
    </div>

    <!-- FAVS -->
    <div id="favCard" class="card" style="display:none">
      <h3 style="margin-bottom:10px">‚òÖ <span id="favTitle">Favourites</span></h3>
      <div class="row" style="align-items:flex-start">
        <div style="flex:1">
          <strong id="favStopsTitle">Stops</strong>
          <div id="favStops" class="list" style="margin-top:10px"></div>
        </div>
        <div style="flex:1">
          <strong id="favRoutesTitle">Routes</strong>
          <div id="favRoutes" class="list" style="margin-top:10px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings modal -->
  <div id="cfgModal" class="modal" style="display:none">
    <div class="box">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:4px">
        <strong>Settings</strong>
        <button id="closeCfg" class="btn">√ó</button>
      </div>

      <h3>API base URL</h3>
      <div class="row" style="gap:10px">
        <input id="apiBase" class="input" placeholder="https://your-backend.up.railway.app" />
        <button id="saveApiBase" class="btn">Save</button>
        <button id="resetApiBase" class="btn ghost">Reset</button>
      </div>
      <div class="muted" style="margin:6px 0 14px">The UI calls this backend. You can also override via <code>?api=...</code>.</div>

      <h3>Live feed (BODS SIRI-VM)</h3>
      <div class="row" style="gap:10px">
        <input id="feedUrl" class="input" placeholder="https://data.bus-data.dft.gov.uk/api/v1/datafeed/....?api_key=..." />
        <button id="saveFeed" class="btn">Save Live URL</button>
      </div>
      <div class="muted" style="margin:6px 0 14px">Paste the full BODS Vehicle Monitoring URL including <code>api_key</code>.</div>

      <h3>Upload GTFS ZIP</h3>
      <div class="row" style="gap:10px">
        <input id="gtfsFile" type="file" accept=".zip" class="input" />
        <button id="uploadGtfs" class="btn">Upload GTFS</button>
      </div>
      <div class="muted" style="margin-top:6px">Sent to <code>/api/upload</code> as <code>multipart/form-data</code> with field name <code>file</code>.</div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* ---------- CONFIG ---------- */
// Default API (your backend on Railway). Change here if sz√ºks√©ges:
const DEFAULT_API = "https://bluestar-bus-api-production-5886.up.railway.app";
// Allow override via query (?api=...) or localStorage
const qApi = new URLSearchParams(location.search).get("api");
if(qApi){ localStorage.setItem("api_base", qApi); }
let API_BASE = localStorage.getItem("api_base") || DEFAULT_API;

/* ---------- i18n ---------- */
const I18N = {
 EN:{app:"Bluestar Bus ‚Äî stop & route finder",stopTab:"Stop",routeTab:"Route",favTab:"Favourites",search:"Search",stopName:"Stop name",window:"Window (min)",resultsChoose:"Results ‚Äî choose a stop",chosenStop:"Selected stop:",refreshEvery:"Refresh every 20 s",ukTime:"UK:",mapHint:"If there are no live vehicles on the route, the map will be empty.",destination:"Destination",departure:"Departure",due:"Due",late:"late",early:"early",addFav:"Add to favourites",rmFav:"Remove from favourites"},
 HU:{app:"Bluestar Bus ‚Äî meg√°ll√≥ & j√°rat keres≈ë",stopTab:"Meg√°ll√≥",routeTab:"Vonal",favTab:"Kedvencek",search:"Keres√©s",stopName:"Meg√°ll√≥ n√©v",window:"Id≈ëablak (perc)",resultsChoose:"Tal√°latok ‚Äî v√°lassz meg√°ll√≥t",chosenStop:"V√°lasztott meg√°ll√≥:",refreshEvery:"Friss√≠t√©s 20 s",ukTime:"UK:",mapHint:"Ha nincs √©l≈ë j√°rm≈± a vonalon, a t√©rk√©p √ºres marad.",destination:"C√©l",departure:"Indul√°s",due:"Mindj√°rt",late:"k√©s√©s",early:"el≈ëny",addFav:"Hozz√°ad√°s a kedvencekhez",rmFav:"Elt√°vol√≠t√°s a kedvencekb≈ël"},
 DE:{app:"Bluestar Bus ‚Äî Haltestellen & Linien",stopTab:"Haltestelle",routeTab:"Linie",favTab:"Favoriten",search:"Suche",stopName:"Haltestellenname",window:"Zeitfenster (Min.)",resultsChoose:"Treffer ‚Äî w√§hle eine Haltestelle",chosenStop:"Gew√§hlte Haltestelle:",refreshEvery:"Aktualisierung alle 20 s",ukTime:"UK:",mapHint:"Wenn keine Live-Fahrzeuge vorhanden sind, bleibt die Karte leer.",destination:"Ziel",departure:"Abfahrt",due:"Sofort",late:"sp√§t",early:"fr√ºh",addFav:"Zu Favoriten",rmFav:"Aus Favoriten entfernen"},
 PL:{app:"Bluestar Bus ‚Äî przystanki i linie",stopTab:"Przystanek",routeTab:"Linia",favTab:"Ulubione",search:"Szukaj",stopName:"Nazwa przystanku",window:"Okno (min)",resultsChoose:"Wyniki ‚Äî wybierz przystanek",chosenStop:"Wybrany przystanek:",refreshEvery:"Od≈õwie≈ºanie co 20 s",ukTime:"UK:",mapHint:"Je≈õli brak pojazd√≥w na ≈ºywo, mapa bƒôdzie pusta.",destination:"Kierunek",departure:"Odjazd",due:"Zaraz",late:"op√≥≈∫.",early:"wcze≈õ.",addFav:"Dodaj do ulubionych",rmFav:"Usu≈Ñ z ulubionych"},
 RO:{app:"Bluestar Bus ‚Äî sta»õii & linii",stopTab:"Sta»õie",routeTab:"Linie",favTab:"Preferate",search:"CƒÉutare",stopName:"Numele sta»õiei",window:"FereastrƒÉ (min)",resultsChoose:"Rezultate ‚Äî alege o sta»õie",chosenStop:"Sta»õie selectatƒÉ:",refreshEvery:"Re√ÆmprospƒÉtare la 20 s",ukTime:"UK:",mapHint:"DacƒÉ nu existƒÉ vehicule live, harta rƒÉm√¢ne goalƒÉ.",destination:"Destina»õie",departure:"Plecare",due:"Imediat",late:"√Ænt√¢rziere",early:"mai devreme",addFav:"AdaugƒÉ la preferate",rmFav:"»òterge din preferate"}
};
const LANGS=["EN","HU","DE","PL","RO"];
function guessLang(){const n=(navigator.language||"en").slice(0,2).toUpperCase();return LANGS.includes(n)?n:"EN";}
let LANG=localStorage.getItem("lang")||guessLang();
function t(k){return (I18N[LANG]||I18N.EN)[k]||k;}

/* ---------- helpers ---------- */
const $=sel=>document.querySelector(sel);
function el(tag, cls, txt){const e=document.createElement(tag); if(cls)e.className=cls; if(txt!=null)e.textContent=txt; return e;}
function setSel(select, arr, valKey, textKey){ select.innerHTML=""; arr.forEach(x=>{const o=document.createElement("option"); o.value=x[valKey]; o.textContent=x[textKey]; select.appendChild(o);});}
function hhmm(x){ const d=new Date(x); return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:false}); }
const UK = new Intl.DateTimeFormat([], {hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false, timeZone:'Europe/London'});
function toast(msg, isErr=false){ const tEl=$("#toast"); tEl.textContent=msg; tEl.style.background=isErr?"#6b2a2a":"#2b3b65"; tEl.classList.add("show"); setTimeout(()=>tEl.classList.remove("show"), 4200); }

/* ---------- UI refs ---------- */
const wrap=$("#wrap"), appTitle=$("#app-title"), langSel=$("#lang");
const tabStop=$("#tabStop"), tabRoute=$("#tabRoute"), tabFav=$("#tabFav");
const ukTimeLbl=$("#ukTime"), buildSpan=$("#build"), refreshLbl=$("#refreshLbl");
const stopCard=$("#stopCard"), routeCard=$("#routeCard"), favCard=$("#favCard");
const stopQuery=$("#stopQuery"), windowMin=$("#windowMin"), stopSearchBtn=$("#stopSearchBtn"), stopSelect=$("#stopSelect");
const selectedStopLbl=$("#selectedStopLbl"), refreshEvery=$("#refreshEvery"), stopList=$("#stopList");
const routeQuery=$("#routeQuery"), routeSearchBtn=$("#routeSearchBtn"), routeSelect=$("#routeSelect");
const mapHint=$("#mapHint"), toggleBoard=$("#toggleBoard"), toggleFS=$("#toggleFS");
const cfgModal=$("#cfgModal"), openCfg=$("#openCfg"), closeCfg=$("#closeCfg"),
      feedUrl=$("#feedUrl"), saveFeed=$("#saveFeed"),
      apiBase=$("#apiBase"), saveApiBase=$("#saveApiBase"), resetApiBase=$("#resetApiBase"),
      gtfsFile=$("#gtfsFile"), uploadGtfs=$("#uploadGtfs");
const favStopBtn=$("#favStopBtn"), favStopLbl=$("#favStopLbl"), favRouteBtn=$("#favRouteBtn"), favRouteLbl=$("#favRouteLbl");
const favStops=$("#favStops"), favRoutes=$("#favRoutes"), favTitle=$("#favTitle"), favStopsTitle=$("#favStopsTitle"), favRoutesTitle=$("#favRoutesTitle");

/* ---------- i18n apply ---------- */
function fillLang(){ langSel.innerHTML=""; LANGS.forEach(c=>{const o=document.createElement("option"); o.value=c; o.textContent=c; if(c===LANG)o.selected=true; langSel.appendChild(o);});}
function applyI18n(){
  appTitle.textContent=t("app");
  tabStop.textContent=t("stopTab"); tabRoute.textContent=t("routeTab"); tabFav.textContent=t("favTab");
  stopQuery.placeholder=t("stopName"); stopSearchBtn.textContent=t("search");
  routeQuery.placeholder=t("routeTab"); routeSearchBtn.textContent=t("search");
  refreshEvery.textContent=t("refreshEvery"); mapHint.textContent=t("mapHint");
  favTitle.textContent=t("favTab"); favStopsTitle.textContent=t("stopTab")+"s"; favRoutesTitle.textContent=t("routeTab")+"s";
}
langSel.onchange=()=>{LANG=langSel.value; localStorage.setItem("lang",LANG); applyI18n();};
fillLang(); applyI18n();

/* ---------- tabs ---------- */
function showStop(){ tabStop.classList.add("active"); tabRoute.classList.remove("active"); tabFav.classList.remove("active"); stopCard.style.display="block"; routeCard.style.display="none"; favCard.style.display="none"; }
function showRoute(){ tabRoute.classList.add("active"); tabStop.classList.remove("active"); tabFav.classList.remove("active"); routeCard.style.display="block"; stopCard.style.display="none"; favCard.style.display="none"; }
function showFav(){ tabFav.classList.add("active"); tabStop.classList.remove("active"); tabRoute.classList.remove("active"); favCard.style.display="block"; stopCard.style.display="none"; routeCard.style.display="none"; renderFavs(); }
tabStop.onclick=showStop; tabRoute.onclick=showRoute; tabFav.onclick=showFav;

/* ---------- clock & status ---------- */
async function tick(){
  try{
    const r=await fetch(`${API_BASE}/api/status`);
    const j=await r.json();
    ukTimeLbl.textContent=`${t("ukTime")} ${j.uk_time||"--:--:--"}`;
    buildSpan.textContent=j.build||"-";
  }catch(e){
    ukTimeLbl.textContent=`${t("ukTime")} --:--:--`;
  }
}
setInterval(tick, 1000); tick();
refreshLbl.textContent=`Refresh every 20 s`;

/* ---------- Settings modal ---------- */
openCfg.onclick=async()=>{
  cfgModal.style.display="grid";
  apiBase.value=API_BASE;
  try{
    const r=await fetch(`${API_BASE}/api/live/config`);
    const j=await r.json();
    feedUrl.value=j.feed_url||"";
  }catch(e){}
};
closeCfg.onclick=()=> cfgModal.style.display="none";
saveApiBase.onclick=()=>{
  const v=(apiBase.value||"").trim();
  if(!v){ toast("API base cannot be empty", true); return; }
  localStorage.setItem("api_base", v);
  API_BASE=v;
  toast("API base saved. Reloading‚Ä¶");
  setTimeout(()=>location.reload(), 600);
};
resetApiBase.onclick=()=>{
  localStorage.removeItem("api_base");
  API_BASE=DEFAULT_API;
  toast("API base reset. Reloading‚Ä¶");
  setTimeout(()=>location.reload(), 600);
};
saveFeed.onclick=async()=>{
  try{
    const url=(feedUrl.value||"").trim();
    const r=await fetch(`${API_BASE}/api/live/config`,{
      method:"POST",headers:{'Content-Type':'application/json'},
      body:JSON.stringify({feed_url:url})
    });
    if(!r.ok) throw new Error(await r.text());
    toast("Live URL saved ‚úî");
    cfgModal.style.display="none";
  }catch(e){ toast("Save failed: "+e.message, true); }
};
uploadGtfs.onclick=async()=>{
  try{
    const f=gtfsFile.files?.[0]; if(!f){ toast("Pick a ZIP first", true); return; }
    const fd=new FormData(); fd.append("file", f);
    const r=await fetch(`${API_BASE}/api/upload`, {method:"POST", body:fd});
    if(!r.ok) throw new Error(await r.text());
    toast("GTFS uploaded ‚úî");
  }catch(e){ toast("Upload failed: "+e.message, true); }
};

/* ---------- Stop search ---------- */
stopSearchBtn.onclick=async()=>{
  const q=stopQuery.value.trim(); if(!q) return;
  try{
    const r=await fetch(`${API_BASE}/api/stops/search?q=${encodeURIComponent(q)}`);
    if(!r.ok) throw new Error(await r.text());
    const items=await r.json();
    setSel(stopSelect, items, "id", "name");
    if(items[0]){
      stopSelect.value=items[0].id;
      selectedStopLbl.textContent=`${t("chosenStop")} ${items[0].name}`;
      renderDepartures();
    }else{
      selectedStopLbl.textContent=t("resultsChoose");
      stopList.innerHTML="";
    }
  }catch(e){
    toast("Stop search failed: "+e.message, true);
  }
};
stopSelect.onchange=()=>{ selectedStopLbl.textContent=`${t("chosenStop")} ${stopSelect.options[stopSelect.selectedIndex]?.text||"‚Äì"}`; renderDepartures(); };

function delayBadge(d){
  if(d==null) return "";
  const n=Number(d); if(Number.isNaN(n)) return "";
  const sign=n>0?"+":"";
  const cls=n>0?" good":"";
  return `<span class="mono${cls}" style="margin-left:8px">${sign}${n} min</span>`;
}
async function renderDepartures(){
  const id=stopSelect.value; if(!id) return;
  const w=Math.max(1, Number(windowMin.value||60));
  try{
    const r=await fetch(`${API_BASE}/api/stops/${encodeURIComponent(id)}/next_departures?window=${w}`);
    if(!r.ok) throw new Error(await r.text());
    const j=await r.json();
    stopList.innerHTML="";
    (j.departures||[]).forEach(row=>{
      const it=el("div","item");
      it.innerHTML = `
        <div class="pill">${row.route||"‚Äì"}</div>
        <div class="dest">${row.destination||"‚Äì"}</div>
        <div class="time mono ${row.is_due?'good blink':row.is_live?'good':''}">
          ${row.is_due? t("due") : (row.time_display||"")}
          ${delayBadge(row.delay_min)}
        </div>`;
      it.onclick=()=>openTrip(row.trip_id,row.route,row.destination);
      stopList.appendChild(it);
    });
  }catch(e){
    toast("Departures failed: "+e.message, true);
  }
}
setInterval(renderDepartures, 20000);

/* ---------- Trip modal ---------- */
function openTrip(tripId, route, headsign){
  if(!tripId) return;
  (async()=>{
    try{
      const r=await fetch(`${API_BASE}/api/trips/${encodeURIComponent(tripId)}`);
      if(!r.ok) throw new Error(await r.text());
      const j=await r.json();
      const wrap=document.createElement("div"); wrap.className="modal";
      const box=document.createElement("div"); box.className="box";
      box.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div><strong>Trip</strong> ¬∑ ${route||""} ‚Üí ${headsign||""}</div><button class="btn" id="closeTrip">√ó</button></div>`;
      const list=document.createElement("div"); list.className="list";
      (j.stops||[]).forEach(s=>{
        const row
