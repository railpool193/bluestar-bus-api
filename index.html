<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
/>
  <title>Bluestar Bus – Élő indulások</title>
  <style>
    :root{
      --bg:#0f1220; --card:#171a2b; --muted:#9aa3b2; --text:#e8ecf3;
      --accent:#4ea8ff; --accent-2:#2f72ff; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --chip:#243149;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{color:var(--accent)}
    .wrap{max-width:860px;margin:0 auto;padding:24px}
    .card{background:var(--card);border:1px solid #21253b;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{font-size:clamp(22px,3.5vw,36px);margin:0 0 14px}
    .pill{display:inline-flex;align-items:center;gap:8px;background:var(--chip);padding:6px 10px;border-radius:999px;font-size:13px}
    .dot{width:8px;height:8px;border-radius:50%}
    .grid{display:grid;gap:14px}
    @media(min-width:720px){.grid-2{grid-template-columns:2fr 1fr}}
    .row{display:flex;align-items:center;gap:10px}
    .muted{color:var(--muted)}
    input,button{font:inherit}
    .input{width:100%;padding:12px 14px;background:#0c0f1b;border:1px solid #1d2237;border-radius:12px;color:var(--text);outline:none}
    .input:focus{border-color:var(--accent)}
    .btn{display:inline-flex;justify-content:center;align-items:center;gap:8px;padding:12px 16px;border:0;border-radius:12px;color:#fff;background:linear-gradient(135deg,var(--accent),var(--accent-2));cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-secondary{background:#22263f}
    .help{font-size:13px;margin-top:6px}
    .list{margin:8px 0 0;padding:0;list-style:none;border:1px solid #232944;border-radius:12px;overflow:hidden}
    .item{padding:10px 12px;background:#0c0f1b;cursor:pointer}
    .item + .item{border-top:1px solid #1b2138}
    .item:hover{background:#121731}
    .item small{color:var(--muted)}
    .table{width:100%;border-collapse:collapse;margin-top:8px}
    .table th,.table td{padding:12px;border-bottom:1px solid #232944;text-align:left}
    .badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 8px;border-radius:10px}
    .badge-live{background:rgba(34,197,94,.15);color:#86efac}
    .badge-timetable{background:rgba(148,163,184,.12);color:#cbd5e1}
    .status{font-size:13px;margin-top:8px}
    .error{color:#fecaca;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.35);padding:10px 12px;border-radius:12px}
    .empty{padding:14px;border:1px dashed #2a2f4a;border-radius:12px;text-align:center;color:var(--muted)}
    .footer{margin-top:26px;color:var(--muted);font-size:13px}
    .sr{position:absolute;left:-9999px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Bluestar Bus – Live Departures</h1>
      <span class="pill"><span class="dot" style="background:var(--ok)"></span> ÉLŐ – BODS SIRI-VM</span>

      <div class="grid grid-2" style="margin-top:18px">
        <div>
          <label for="q" class="muted">Megálló neve</label>
          <div class="row">
            <input id="q" class="input" placeholder="pl. Hanover, Vincents Walk, Above Bar Street…" autocomplete="off" />
            <button id="btnSearch" class="btn" aria-label="Keresés">Keresés</button>
          </div>
          <div class="help muted">Írj be néhány karaktert, majd kattints a találatra.</div>
          <ul id="results" class="list" hidden></ul>
          <div id="searchError" class="error" hidden></div>
        </div>
        <div>
          <label for="minutes" class="muted">Időablak (perc)</label>
          <div class="row">
            <input id="minutes" class="input" type="number" min="5" max="720" step="5" value="60" />
            <button id="btnClear" class="btn btn-secondary">Törlés</button>
          </div>
        </div>
      </div>

      <div id="picked" class="status muted" hidden></div>

      <div id="depsWrap" style="margin-top:16px">
        <div id="depsError" class="error" hidden></div>
        <table class="table" id="depsTable" hidden>
          <thead>
            <tr>
              <th>Route</th>
              <th>Destination</th>
              <th>Time</th>
              <th>Állapot</th>
            </tr>
          </thead>
          <tbody id="depsBody"></tbody>
        </table>
        <div id="empty" class="empty" hidden>Nincs indulás ebben az időablakban.</div>
      </div>

      <div class="footer">
        <div>Powered by GTFS (menetrend) &amp; BODS SIRI-VM (élő adatok).</div>
        <div id="apiStatus" class="muted"></div>
      </div>
    </div>
  </div>

  <script>
    // ------- Helpers
    const $ = sel => document.querySelector(sel);
    const el = id => document.getElementById(id);
    const api = p => (p.startsWith("/") ? p : "/" + p);
    const fmtTime = iso => {
      try {
        const d = new Date(iso);
        return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      } catch { return iso }
    };
    const debounce = (fn, ms=350) => {
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),ms); };
    };

    // ------- Elements
    const q = el('q');
    const btnSearch = el('btnSearch');
    const results = el('results');
    const searchError = el('searchError');

    const minutes = el('minutes');
    const btnClear = el('btnClear');

    const picked = el('picked');

    const depsTable = el('depsTable');
    const depsBody = el('depsBody');
    const depsError = el('depsError');
    const empty = el('empty');

    const apiStatus = el('apiStatus');

    let currentStop = null; // {id, name}

    // ------- Status ping
    (async ()=>{
      try{
        const r = await fetch(api('api/status'));
        const j = await r.json();
        apiStatus.textContent = `API státusz: OK • GTFS: ${j.gtfs_loaded ? 'betöltve' : 'nincs'} • SIRI: ${j.siri_configured ? 'beállítva' : 'nincs'}`;
      }catch(e){
        apiStatus.textContent = 'API státusz: ismeretlen';
      }
    })();

    // ------- Search
    async function doSearch() {
      const term = q.value.trim();
      results.innerHTML = '';
      results.hidden = true;
      searchError.hidden = true;

      if (!term || term.length < 2) {
        return;
      }
      try {
        btnSearch.disabled = true;
        const r = await fetch(api(`api/stops/search?query=${encodeURIComponent(term)}`));
        if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
        const arr = await r.json(); // [{stop_id, name, locality}]
        if (!arr || !arr.length) {
          results.hidden = false;
          results.innerHTML = `<li class="item muted">Nincs találat erre a névre.</li>`;
          return;
        }
        results.hidden = false;
        results.innerHTML = arr.map(s => `
          <li class="item" data-id="${s.stop_id}" data-name="${escapeHtml(s.name)}">
            <div><strong>${escapeHtml(s.name)}</strong></div>
            <small>${escapeHtml(s.locality || '')} <span class="muted">(${s.stop_id})</span></small>
          </li>`).join('');

        // attach clicks
        Array.from(results.children).forEach(li=>{
          li.addEventListener('click', ()=>{
            currentStop = { id: li.dataset.id, name: li.dataset.name };
            results.hidden = true;
            q.value = currentStop.name;
            picked.hidden = false;
            picked.textContent = `Kijelölt megálló: ${currentStop.name} (${currentStop.id})`;
            loadDepartures();
          });
        });
      } catch(err){
        searchError.hidden = false;
        searchError.textContent = `Keresési hiba: ${err.message}`;
      } finally {
        btnSearch.disabled = false;
      }
    }
    const escapeHtml = (s) => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

    btnSearch.addEventListener('click', doSearch);
    q.addEventListener('input', debounce(()=>{ results.hidden = true; searchError.hidden = true; }, 150));
    q.addEventListener('keydown', e => { if(e.key==='Enter') doSearch(); });

    // ------- Departures
    async function loadDepartures() {
      depsError.hidden = true; empty.hidden = true; depsTable.hidden = true;
      depsBody.innerHTML = '';

      if (!currentStop) return;
      try{
        const mins = Math.max(5, Math.min(720, parseInt(minutes.value||60,10)));
        const r = await fetch(api(`api/stops/${encodeURIComponent(currentStop.id)}/next_departures?minutes=${mins}`));
        const j = await r.json(); // { stop_id, minutes, results: [{route,destination,time_iso,is_live}] }
        if (!r.ok) throw new Error((j && j.detail) || r.statusText);

        const rows = (j.results||[]).map(dep => `
          <tr>
            <td>${escapeHtml(dep.route)}</td>
            <td>${escapeHtml(dep.destination)}</td>
            <td>${fmtTime(dep.time_iso)}</td>
            <td>
              ${dep.is_live
                ? `<span class="badge badge-live"><span class="dot" style="background:var(--ok)"></span> ÉLŐ</span>`
                : `<span class="badge badge-timetable">Menetrendi</span>`
              }
            </td>
          </tr>
        `).join('');

        if (!rows) {
          empty.hidden = false;
        } else {
          depsBody.innerHTML = rows;
          depsTable.hidden = false;
        }
      }catch(err){
        depsError.hidden = false;
        depsError.textContent = `Hiba az indulások lekérésekor. ${err.message ? err.message : ''}`;
      }
    }

    minutes.addEventListener('change', ()=> currentStop && loadDepartures());
    btnClear.addEventListener('click', ()=>{
      q.value=''; results.hidden=true; searchError.hidden=true;
      picked.hidden=true; currentStop=null;
      depsTable.hidden=true; empty.hidden=true; depsError.hidden=true; depsBody.innerHTML='';
      q.focus();
    });

    // Optional: indulások auto-frissítése 30 mp-enként, ha van kijelölt megálló
    setInterval(()=>{ if(currentStop) loadDepartures(); }, 30000);
  </script>
</body>
</html>
