<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bluestar Bus – Live Departures</title>
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
           margin: 0; background: #0b0e13; color: #e8eef7; }
    .wrap { max-width: 900px; margin: 32px auto; padding: 0 16px; }
    h1 { margin: 0 0 16px; font-weight: 700; }
    .card { background: #121826; border: 1px solid #1f2a44; border-radius: 12px; padding: 20px; }
    label { display:block; font-size: 14px; opacity: .8; margin: 12px 0 6px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    input[type="text"], input[type="number"]{
      background:#0d1220;border:1px solid #24304d;color:#e8eef7;border-radius:10px;
      padding:10px 12px; outline:none; min-width: 240px;
    }
    button{ background:#2e5bff; border:none; color:white; padding:10px 14px; border-radius:10px; cursor:pointer; }
    button.secondary{ background:#1f2a44; }
    button.ghost{ background:transparent; border:1px solid #24304d; }
    .live-badge{ display:inline-flex; align-items:center; gap:8px; background:#112b1c;
      color:#63f5a1; border:1px solid #1c5d3b; border-radius:999px; padding:4px 10px; font-size:12px; }
    .live-badge .dot{ width:8px; height:8px; border-radius:50%; background:#63f5a1; box-shadow:0 0 10px #63f5a1; }
    .hint{ font-size:12px; opacity:.75; }
    .results, .favs { margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
    .chip{ background:#0d1220; border:1px solid #24304d; border-radius:999px; padding:6px 10px; cursor:pointer; }
    .table{ width:100%; border-collapse: collapse; margin-top:14px; }
    .table th, .table td{ padding:10px 12px; border-bottom:1px solid #1f2a44; text-align:left; }
    .star{ font-size:18px; cursor:pointer; user-select:none; }
    .star.active{ color:#ffd85a; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h1 style="margin-bottom:0">Bluestar Bus – Live Departures</h1>
        <div class="live-badge"><span class="dot"></span> ÉLŐ – BODS SIRI-VM</div>
      </div>

      <label for="q">Megálló neve</label>
      <div class="row">
        <input id="q" type="text" placeholder="pl. Vincents Walk" />
        <button id="btnSearch">Keresés</button>
      </div>
      <div id="searchResults" class="results"></div>

      <label for="minutes">Időablak (perc)</label>
      <input id="minutes" type="number" min="1" max="240" value="60" />

      <label for="stop">Stop ID</label>
      <div class="row">
        <input id="stop" type="text" placeholder="pl. 1980SN12619E" />
        <button id="btnFetch">Indulások lekérése</button>
        <button id="btnClear" class="secondary">Törlés</button>
        <span id="favStar" class="star" title="Hozzáadás a kedvencekhez">☆</span>
      </div>
      <div class="hint">Tipp: megálló választáskor a Stop ID mező automatikusan kitöltődik.</div>

      <label style="margin-top:16px">Kedvencek</label>
      <div id="favs" class="favs"></div>

      <div id="title" style="margin-top:18px; font-weight:600;"></div>
      <table class="table" id="tbl" style="display:none">
        <thead><tr><th>Route</th><th>Destination</th><th>Time</th></tr></thead>
        <tbody id="tb"></tbody>
      </table>
    </div>
  </div>

<script>
const $ = (sel) => document.querySelector(sel);
const api = (p) => (p.startsWith('/') ? p : '/' + p);

const q = $('#q'), btnSearch = $('#btnSearch'), res = $('#searchResults');
const stop = $('#stop'), minutes = $('#minutes'), btnFetch = $('#btnFetch'), btnClear = $('#btnClear');
const tbl = $('#tbl'), tb = $('#tb'), title = $('#title');
const favsWrap = $('#favs'), favStar = $('#favStar');

let currentStopMeta = null;

// ----- Kedvencek (localStorage) -----
const FAV_KEY = 'bluestar_favs_v1';
const getFavs = () => { try { return JSON.parse(localStorage.getItem(FAV_KEY)||'[]'); } catch { return []; } }
const setFavs = (arr) => localStorage.setItem(FAV_KEY, JSON.stringify(arr));
const isFav = (id) => getFavs().some(f => f.stop_id === id);
function renderFavs(){
  favsWrap.innerHTML = '';
  const arr = getFavs();
  if(!arr.length){ favsWrap.innerHTML = '<span class="hint">Nincs kedvenc még.</span>'; return; }
  arr.forEach(f => {
    const chip = document.createElement('span');
    chip.className = 'chip';
    chip.textContent = `${f.stop_name} (${f.stop_id})`;
    chip.onclick = () => { stop.value = f.stop_id; currentStopMeta = f; syncStar(); fetchDeps(); };
    favsWrap.appendChild(chip);
  });
}
function syncStar(){
  favStar.classList.toggle('active', !!(currentStopMeta && isFav(currentStopMeta.stop_id)));
  favStar.textContent = favStar.classList.contains('active') ? '★' : '☆';
}
favStar.onclick = () => {
  if(!currentStopMeta){ alert('Előbb válassz megállót!'); return; }
  let arr = getFavs();
  if(isFav(currentStopMeta.stop_id)){
    arr = arr.filter(f => f.stop_id !== currentStopMeta.stop_id);
  } else {
    arr.unshift(currentStopMeta);
    arr = arr.slice(0, 20);
  }
  setFavs(arr);
  renderFavs(); syncStar();
};

// ----- Keresés -----
async function search(){
  const term = q.value.trim();
  res.innerHTML = '';
  if(!term) return;
  try{
    const r = await fetch(api(`search_stops?q=${encodeURIComponent(term)}&limit=20`));
    const data = await r.json();
    if(!data.length){ alert('Nincs találat erre a névre.'); return; }
    data.forEach(item => {
      const chip = document.createElement('span');
      chip.className = 'chip';
      chip.textContent = `${item.stop_name} (${item.stop_id})`;
      chip.onclick = () => {
        stop.value = item.stop_id;
        currentStopMeta = { stop_id: item.stop_id, stop_name: item.stop_name };
        syncStar();
        fetchDeps();
      };
      res.appendChild(chip);
    });
  }catch(e){
    console.error(e); alert('Hiba a keresés közben. Próbáld újra.');
  }
}
btnSearch.onclick = search;

// ----- Indulások -----
async function fetchDeps(){
  const sid = stop.value.trim(), min = Math.max(1, Math.min(240, Number(minutes.value)||60));
  if(!sid){ alert('Adj meg egy Stop ID-t!'); return; }
  try{
    const r = await fetch(api(`next_departures/${encodeURIComponent(sid)}?minutes=${min}`));
    const data = await r.json();
    title.textContent = `Indulások — stop ${sid}, next ${min} min`;
    tb.innerHTML = '';
    (data.departures || []).forEach(d => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${d.route||''}</td><td>${d.destination||''}</td><td>${d.departure_time||''}</td>`;
      tb.appendChild(tr);
    });
    tbl.style.display = 'table';
  }catch(e){
    console.error(e); alert('Hiba az indulások lekérése közben.');
  }
}
btnFetch.onclick = fetchDeps;
btnClear.onclick = () => { tb.innerHTML=''; tbl.style.display='none'; title.textContent=''; }

renderFavs();
syncStar();
</script>
</body>
</html>
