<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Bluestar Bus – Élő indulások</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0e12; --panel:#121723; --text:#e6eaf2; --muted:#98a3b8;
      --accent:#3b82f6; --ok:#63f5a1; --no:#8a94a6;
    }
    html,body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:900px;margin:28px auto;padding:0 16px}
    h1{margin:0 0 8px;font-weight:800}
    .card{background:var(--panel);border-radius:14px;padding:20px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    label{display:block;font-size:13px;color:var(--muted);margin:10px 0 6px}
    input,button{border-radius:10px;border:1px solid #1b2740;outline:none}
    input{background:#0b1220;color:var(--text);padding:10px 12px;width:100%}
    input:focus{border-color:#335ad6}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{background:var(--accent);color:#fff;border:none;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .suggestion{display:flex;justify-content:space-between;align-items:center;gap:10px;
      background:#0c1322;border:1px solid #1b2740;border-radius:10px;padding:10px 12px;margin-top:8px;cursor:pointer}
    .suggestion:hover{border-color:#335ad6}
    .badge{font-size:11px;font-weight:800;border-radius:999px;padding:3px 8px;white-space:nowrap}
    .live{background:#102819;color:var(--ok);border:1px solid #1e5a3b}
    .nolive{background:#141925;color:#b7c0d3;border:1px solid #2a3553}
    .pending{background:#141925;color:#b7c0d3;border:1px dashed #2a3553}
    table{width:100%;border-collapse:collapse;margin-top:16px}
    th,td{padding:10px;border-bottom:1px solid #142140;text-align:left}
    th{color:#cbd5e1;background:#0c1322}
    .hint{color:var(--muted);font-size:13px;margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Bluestar Bus – Élő indulások</h1>
      <div class="hint">A keresési találatoknál jelöljük, hogy jelenleg van-e élő indulás (60 percen belül).</div>

      <label for="search">Megálló keresése</label>
      <div class="row">
        <input id="search" type="text" placeholder="pl. Hanover, Vincents Walk, Adanac..." />
        <button class="btn" id="btnSearch">Keresés</button>
      </div>
      <div id="suggestions"></div>

      <div class="row" style="margin-top:12px">
        <div style="flex:2">
          <label for="stopId">Stop ID (ATCO/NaPTAN – automatikusan kitöltjük)</label>
          <input id="stopId" type="text" placeholder="pl. 1980SN12619E vagy 1900HAA..." />
        </div>
        <div>
          <label for="minutes">Időablak (perc)</label>
          <input id="minutes" type="number" min="1" max="360" value="60" style="width:120px" />
        </div>
        <div style="align-self:end">
          <button class="btn" id="btnFetch">Indulások lekérése</button>
        </div>
      </div>

      <table>
        <thead>
          <tr><th>Járat</th><th>Úticél</th><th>Indulás</th><th>Forrás</th></tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="4" class="hint">Nincs adat. Keress megállóra, majd válassz a listából.</td></tr>
        </tbody>
      </table>
      <div id="note" class="hint"></div>
    </div>
  </div>

  <script>
    const $ = (s) => document.querySelector(s);
    const suggestions = $('#suggestions');
    const tbody = $('#tbody');
    const note = $('#note');

    $('#btnSearch').onclick = () => doSearch();
    $('#btnFetch').onclick  = () => fetchDepartures();
    $('#search').addEventListener('keydown', e => { if (e.key === 'Enter') doSearch(); });
    $('#stopId').addEventListener('keydown', e => { if (e.key === 'Enter') fetchDepartures(); });
    $('#minutes').addEventListener('keydown', e => { if (e.key === 'Enter') fetchDepartures(); });

    async function doSearch(){
      const q = $('#search').value.trim();
      suggestions.innerHTML = '';
      if(!q){ return; }
      try{
        const r = await fetch(`/stops/search?q=${encodeURIComponent(q)}`);
        const data = await r.json();
        const list = (data && data.results) ? data.results : [];
        if(!list.length){
          suggestions.innerHTML = `<div class="hint">Nincs találat.</div>`;
          return;
        }
        // render azonnal, majd külön szálon bekérjük az élő státuszt
        list.forEach(item => {
          const row = document.createElement('div');
          row.className = 'suggestion';
          row.innerHTML = `
            <div>
              <div style="font-weight:700">${escapeHtml(item.display_name)}</div>
              <div class="hint">stop_code: ${escapeHtml(item.stop_code)} • stop_id: ${escapeHtml(item.stop_id)}</div>
            </div>
            <span class="badge pending" id="live-${cssId(item.stop_code)}">ellenőrzés…</span>
          `;
          row.onclick = () => {
            // stop_code-ot használjuk (ATCO/NaPTAN), mert a SIRI ezt várja
            $('#stopId').value = item.stop_code || item.stop_id;
            $('#minutes').value = 60;
            fetchDepartures(); // azonnal lekérjük
            // kiürítjük a listát
            suggestions.innerHTML = '';
          };
          suggestions.appendChild(row);
        });

        // élő státusz ellenőrzése párhuzamosan (limitálva)
        checkLiveStatuses(list.slice(0, 8)); // max 8-at pingelünk egyszerre
      }catch(e){
        suggestions.innerHTML = `<div class="hint">Hiba a keresés közben.</div>`;
      }
    }

    async function checkLiveStatuses(items){
      // minutes=60-at nézünk; ha van legalább 1 indulás, LIVE
      await Promise.all(items.map(async (it) => {
        const el = document.getElementById(`live-${cssId(it.stop_code)}`);
        if(!el) return;
        try{
          const r = await fetch(`/next_departures/${encodeURIComponent(it.stop_code)}?minutes=60`);
          const data = await r.json();
          const has = data && Array.isArray(data.departures) && data.departures.length > 0;
          el.className = `badge ${has ? 'live' : 'nolive'}`;
          el.textContent = has ? 'LIVE' : 'no live';
        }catch(_){
          el.className = 'badge nolive';
          el.textContent = 'no live';
        }
      }));
    }

    async function fetchDepartures(){
      const stop = $('#stopId').value.trim();
      const mins = Math.max(1, Math.min(360, parseInt($('#minutes').value || '60',10)));
      if(!stop){ alert('Adj meg egy Stop ID-t!'); return; }
      tbody.innerHTML = `<tr><td colspan="4" class="hint">Töltés…</td></tr>`;
      note.textContent = '';
      try{
        const r = await fetch(`/next_departures/${encodeURIComponent(stop)}?minutes=${mins}`);
        const data = await r.json();
        const list = data.departures || [];
        tbody.innerHTML = '';
        if(!list.length){
          tbody.innerHTML = `<tr><td colspan="4" class="hint">Nincs indulás ebben az időablakban.</td></tr>`;
        }else{
          list.forEach(dep => {
            const tr = document.createElement('tr');
            const route = dep.route || dep.line || '';
            const dest  = dep.destination || '';
            const time  = dep.time || dep.expected_departure_time || dep.departure_time || '';
            const live  = dep.live === true || dep.is_live === true;
            const src   = dep.source || (live ? 'live' : 'timetable');
            tr.innerHTML = `
              <td>${escapeHtml(route)}</td>
              <td>${escapeHtml(dest)}</td>
              <td>${escapeHtml(time)} ${live ? ' <span class="badge live">LIVE</span>' : ''}</td>
              <td>${escapeHtml(src)}</td>
            `;
            tbody.appendChild(tr);
          });
        }
        if (data.note) { note.textContent = data.note; }
      }catch(e){
        tbody.innerHTML = `<tr><td colspan="4" class="hint">Hiba a lekérés közben.</td></tr>`;
      }
    }

    // kis segédek
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function cssId(s){ return String(s||'').replace(/[^a-zA-Z0-9_-]/g,'_'); }
  </script>
</body>
</html>
