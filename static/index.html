<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bluestar timetable & stop finder</title>
<link rel="preconnect" href="https://unpkg.com">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  :root{
    --bg:#0b1222; --card:#121a2d; --muted:#9aa4c0; --txt:#e8edff;
    --pill:#2b3557; --live:#17b26a; --due:#17b26a; --sched:#e8edff;
    --accent:#b5befd; --shadow:0 8px 24px rgba(0,0,0,.25);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:900px;margin:0 auto;padding:20px}
  h1{font-size:28px;margin:8px 0 2px;display:flex;gap:12px;align-items:center}
  .muted{color:var(--muted)}
  .row{display:flex;gap:12px;align-items:center}
  .tabs{display:flex;gap:12px;margin:16px 0}
  .tab{padding:12px 18px;border-radius:14px;background:#0d1426;color:#cbd5ff;cursor:pointer}
  .tab.active{background:#1b2443;color:#fff}
  .card{background:var(--card);border-radius:18px;padding:18px;box-shadow:var(--shadow);margin:14px 0}
  .input{width:100%;background:#0d1426;border:1px solid #1e2747;border-radius:14px;color:#fff;padding:12px 14px}
  .btn{background:#909cff;color:#0b1222;border:none;border-radius:14px;padding:12px 16px;font-weight:700;cursor:pointer}
  .list{display:flex;flex-direction:column;gap:12px}
  .item{display:flex;justify-content:space-between;align-items:center;background:#0f1930;border:1px solid #1e2747;border-radius:16px;padding:14px;gap:12px}
  .item .left{display:flex;gap:12px;align-items:center}
  .pill{background:#202a4f;color:#cfe1ff;border-radius:14px;padding:8px 12px;font-weight:800}
  .live{color:var(--live);font-weight:800}
  .sched{color:var(--sched);font-weight:800}
  .due{color:var(--due);font-weight:800;animation:blink 1s steps(2,end) infinite}
  @keyframes blink{50%{opacity:.35}}
  .tiny{font-size:12px}
  .hidden{display:none}
  #map{height:360px;border-radius:16px;overflow:hidden}
</style>
</head>
<body>
<div class="wrap">
  <h1>ðŸšŒ Bluestar timetable & stop finder</h1>
  <div class="muted" id="clock">UK: --:--:--</div>

  <div class="tabs">
    <div class="tab active" id="tabStop">Stop</div>
    <div class="tab" id="tabRoute">Route</div>
    <div class="tab" id="tabFav">Favourites</div>
    <button class="btn" id="btnSettings">Settings</button>
  </div>

  <!-- STOP PANEL -->
  <div class="card" id="panelStops">
    <div class="row">
      <input id="qStop" class="input" placeholder="Search stopâ€¦"/>
      <button class="btn" id="btnStopSearch">Search</button>
    </div>
    <div id="selStop" class="muted tiny" style="margin:6px 2px 10px"></div>
    <div class="list" id="depList"></div>
  </div>

  <!-- ROUTE PANEL -->
  <div class="card hidden" id="panelRoutes">
    <div class="row">
      <input id="qRoute" class="input" placeholder="Search route (e.g. 17)â€¦"/>
      <button class="btn" id="btnRouteSearch">Search</button>
    </div>
    <div class="list" id="routeList"></div>
  </div>

  <!-- FAV PANEL -->
  <div class="card hidden" id="panelFav">
    <div class="list" id="favList"></div>
    <div class="tiny muted">Star a stop in the results to save here.</div>
  </div>

  <!-- TRIP PANEL -->
  <div class="card hidden" id="tripCard">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div>
        <div id="tripTitle" style="font-weight:800;font-size:18px"></div>
        <div id="tripMeta" class="tiny muted"></div>
        <div class="tiny muted" style="margin-top:6px">
          <label><input type="checkbox" id="chkVeh" checked> Live vehicles â€¢ 10s</label>
        </div>
      </div>
      <button class="btn" id="btnTripClose">Close</button>
    </div>
    <div id="tripLegs" class="list" style="margin:10px 0 12px"></div>
    <div id="map"></div>
  </div>

  <!-- SETTINGS -->
  <div class="card hidden" id="settingsCard">
    <div class="row"><input id="apiBase" class="input" placeholder="API base (default: /api)" value="/api"/><button class="btn" id="btnSaveCfg">Save</button></div>
    <div class="tiny muted">Build: <span id="build"></span></div>
  </div>
</div>

<script>
const LS = {
  api: localStorage.getItem("api") || "/api",
  favs: JSON.parse(localStorage.getItem("favs")||"[]")
};
function el(s){return document.querySelector(s)}
function showPanel(id){
  ['#panelStops','#panelRoutes','#panelFav','#tripCard','#settingsCard'].forEach(p=>el(p).classList.add('hidden'));
  el(id).classList.remove('hidden');
}
function qs(o){return Object.entries(o).map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&')}
function minutesDiff(a,b){return Math.round((a-b)/60000)}
function T(x){return {"live":"live","scheduled":"scheduled","due":"DUE","late":"min late","early":"min early","ontime":"on time"}[x]||x}

async function heartbeat(){
  const r = await fetch(`${LS.api}/status`).then(r=>r.json()).catch(()=>({}));
  el('#clock').textContent = `UK: ${r.time||'--:--:--'}`;
  el('#build').textContent = r.build||'';
}
setInterval(heartbeat,1000); heartbeat();

// Tabs
el('#tabStop').onclick=()=>{showPanel('#panelStops'); setActive('#tabStop')}
el('#tabRoute').onclick=()=>{showPanel('#panelRoutes'); setActive('#tabRoute')}
el('#tabFav').onclick=()=>{showPanel('#panelFav'); setActive('#tabFav'); renderFavs()}
function setActive(id){['#tabStop','#tabRoute','#tabFav'].forEach(t=>el(t).classList.remove('active')); el(id).classList.add('active')}

// Settings
el('#btnSettings').onclick=()=>showPanel('#settingsCard')
el('#btnSaveCfg').onclick=()=>{ LS.api = el('#apiBase').value||"/api"; localStorage.setItem("api",LS.api); alert('Saved'); showPanel('#panelStops') }

// STOP search + departures
let currentStop=null, depTimer=null, map=null, routePolyline=null, vehTimer=null;

el('#btnStopSearch').onclick = async ()=>{
  const q = el('#qStop').value.trim();
  if(!q) return;
  const js = await (await fetch(`${LS.api}/stops/search?${qs({q})}`)).json();
  if(!js.results?.length){ el('#depList').innerHTML = '<div class="muted">No results.</div>'; return }
  // pick the first and load departures
  currentStop = js.results[0];
  el('#selStop').textContent = `${currentStop.name} â€¢ Selected stop: ${currentStop.stop_id}`;
  await loadDepartures();
  clearInterval(depTimer); depTimer=setInterval(loadDepartures, 10000);
};

async function loadDepartures(){
  const host = el('#depList'); host.innerHTML='';
  const js = await (await fetch(`${LS.api}/departures?${qs({stop_id: currentStop.stop_id, lookahead_min: 60})}`)).json();

  const now = new Date();
  (js.departures||[])
    .filter(d=>{
      const w = new Date(d.expected||d.scheduled);
      if (w.getTime() < now.getTime() - 5*60*1000) return false; // stale szÅ±rÅ‘
      return true;
    })
    .forEach(d=>{
      const it = document.createElement('div'); it.className='item dep'; it.style.cursor='pointer';

      const when = new Date(d.expected||d.scheduled);
      const isLive = !!d.expected;
      const minTo = minutesDiff(when, new Date());
      const dueNow = minTo<=1;
      const delta = (d.delay_min!=null)? d.delay_min :
                    (d.expected? minutesDiff(new Date(d.expected), new Date(d.scheduled)) : 0);
      const statusTxt = (delta>1? `${delta} ${T('late')}` : (delta<-1? `${-delta} ${T('early')}` : T('ontime')));

      it.innerHTML = `
        <div class="left">
          <div class="pill">${d.route_short || d.route || 'â€“'}</div>
          <div>
            <div style="font-weight:700">${d.headsign || d.destination || ''}</div>
            <div class="tiny muted">${d.operator || ''} â€¢ ${d.trip_id||''}</div>
          </div>
        </div>
        <div style="text-align:right">
          <div class="${isLive ? (dueNow?'due':'live') : 'sched'}">
            ${dueNow? T('due') : when.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'})}
          </div>
          <div class="tiny muted">${isLive? T('live'):T('scheduled')} â€¢ ${statusTxt}</div>
        </div>`;

      it.addEventListener('click', ()=>openTrip(d.trip_id, d)); // teljes kÃ¡rtya nyit
      host.appendChild(it);
    });
}

// ROUTE search (opcionÃ¡lis listÃ¡zÃ¡s)
el('#btnRouteSearch').onclick = async ()=>{
  const q = el('#qRoute').value.trim(); if(!q) return;
  const js = await (await fetch(`${LS.api}/routes/search?${qs({q})}`)).json();
  const host = el('#routeList'); host.innerHTML='';
  (js.results||[]).forEach(r=>{
    const it = document.createElement('div'); it.className='item';
    it.innerHTML = `<div class="left"><div class="pill">${r.route_short_name||'â€“'}</div><div>${r.route_long_name||''}</div></div>`;
    host.appendChild(it);
  });
}

// Trip + Map + Vehicles
async function openTrip(trip_id, depRow){
  showPanel('#tripCard');
  el('#tripTitle').textContent = `${depRow.route_short||depRow.route||''} â€“ ${depRow.headsign||''}`;
  el('#tripMeta').textContent  = `${depRow.trip_id||trip_id||''} â€¢ ${depRow.operator||''}`;

  // init map once
  if(!map){
    map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'Â© OpenStreetMap'}).addTo(map);
  }

  // trip details
  const t = await (await fetch(`${LS.api}/trip?${qs({trip_id})}`)).json();
  const legsHost = el('#tripLegs'); legsHost.innerHTML='';

  if(t.shape && t.shape.length){
    const latlngs = t.shape.map(p=>[p.lat,p.lon]);
    if(routePolyline) routePolyline.remove();
    routePolyline = L.polyline(latlngs).addTo(map);
    map.fitBounds(routePolyline.getBounds(),{padding:[24,24]});
  }

  (t.stops||[]).forEach(s=>{
    const row = document.createElement('div'); row.className='item';
    row.innerHTML = `<div style="font-weight:700">${s.name}</div>
                     <div class="tiny muted">${s.time}</div>`;
    legsHost.appendChild(row);
  });

  function clearVehLayer(){
    if(map && map._vehLayer){ map.removeLayer(map._vehLayer); map._vehLayer=null; }
  }

  async function refreshVeh(){
    if(!el('#chkVeh').checked){ clearVehLayer(); return; }
    try{
      let url = `${LS.api}/vehicles?${qs({trip_id})}`;
      let r   = await fetch(url);
      if(r.status===404 || r.status===400){ // fallback: route alapjÃ¡n
        const route = depRow.route_short || depRow.route || '';
        url = `${LS.api}/vehicles?${qs({route})}`;
        r   = await fetch(url);
      }
      const v = await r.json();
      clearVehLayer();
      const g = L.layerGroup();
      (v.vehicles||[]).forEach(vh=>{
        const m = L.marker([vh.lat,vh.lon]).bindPopup(
          `${vh.label||vh.id||'veh'}<br>${vh.timestamp||''}`
        );
        g.addLayer(m);
      });
      g.addTo(map); map._vehLayer=g;
    }catch(e){}
  }

  clearInterval(vehTimer);
  await refreshVeh();
  vehTimer = setInterval(refreshVeh, 10000);

  el('#chkVeh').onchange = refreshVeh;
  el('#btnTripClose').onclick = ()=>{
    showPanel('#panelStops');
    clearInterval(vehTimer); clearVehLayer();
  };
}

// Favourites â€“ placeholder (megÃ¡llÃ³ csillagozÃ¡sÃ¡t teheted a listÃ¡ba)
function renderFavs(){
  const host=el('#favList'); host.innerHTML='';
  LS.favs.forEach(f=>{
    const it=document.createElement('div'); it.className='item';
    it.innerHTML = `<div>${f.name} <span class="tiny muted">â€¢ ${f.stop_id}</span></div>
                    <button class="btn">Open</button>`;
    it.querySelector('button').onclick=()=>{ currentStop=f; showPanel('#panelStops'); el('#selStop').textContent=`${f.name} â€¢ Selected stop: ${f.stop_id}`; loadDepartures() }
    host.appendChild(it);
  })
}
</script>
</body>
</html>
