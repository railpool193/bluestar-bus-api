<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bluestar Bus ‚Äì meg√°ll√≥ & √©l≈ë indul√°sok</title>
  <style>
    :root{ --bg:#0b1020; --card:#121a2f; --txt:#eaf1ff; --muted:#9fb4d6; --ok:#16a34a; --bad:#ef4444; --btn:#5b8cff; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    h1{font-weight:800;margin:0 0 16px}
    .card{background:var(--card);border-radius:16px;padding:18px;border:1px solid #1b2543;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input,button{border-radius:12px;padding:12px 14px;border:1px solid #223050}
    input{background:#0c1428;color:var(--txt);flex:1;min-width:260px}
    button{background:var(--btn);color:#fff;border:none;font-weight:800;cursor:pointer}
    .pills{display:flex;gap:8px;margin-top:10px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#0c1428;border:1px solid #223050;color:var(--muted)}
    .dot{width:10px;height:10px;border-radius:50%}.ok{background:var(--ok)}.bad{background:var(--bad)}
    .list{margin-top:14px}
    .item{padding:10px 12px;border:1px solid #223050;background:#0c1428;border-radius:10px;margin:8px 0;cursor:pointer}
    .item:hover{background:#0f1a33}
    table{width:100%;border-collapse:separate;border-spacing:0 10px;margin-top:12px}
    th{color:#cbd5e1;text-align:left;padding:6px 8px}
    td{background:#0c1428;border:1px solid #223050;padding:12px 10px}
    td:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
    td:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
    .route{font-weight:900;background:#2e4998;padding:4px 10px;border-radius:999px}
    .liveBadge{display:inline-flex;align-items:center;gap:6px}
    .liveDot{width:8px;height:8px;border-radius:50%;background:var(--ok)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üöå Bluestar Bus ‚Äì Meg√°ll√≥ & √©l≈ë indul√°sok (UK id≈ë)</h1>

    <div class="card">
      <div class="row">
        <input id="q" type="text" placeholder="Meg√°ll√≥ neve (pl. Vincent, Shirley‚Ä¶)" />
        <input id="mins" type="number" value="60" min="5" max="240" style="width:110px" />
        <button id="go">Keres√©s</button>
      </div>

      <div class="pills">
        <span class="pill"><span id="apiDot" class="dot bad"></span> API</span>
        <span class="pill"><span id="gtfsDot" class="dot bad"></span> GTFS</span>
        <span class="pill"><span id="liveDot" class="dot bad"></span> Live</span>
      </div>

      <div id="choices" class="list" style="display:none"></div>

      <div id="res" class="list" style="display:none">
        <div id="title" style="margin:6px 2px;color:#cbd5e1"></div>
        <table>
          <thead><tr><th>J√°rat</th><th>C√©l</th><th>Indul</th><th>DUE</th><th>Live</th></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
const $ = s => document.querySelector(s);
const api = p => fetch(p, {cache:'no-store'}).then(r => r.json());

async function refreshStatus(){
  try{
    const s = await api('/api/status');
    $('#apiDot').className = 'dot ok';
    $('#gtfsDot').className = 'dot ' + (s.gtfs ? 'ok' : 'bad');
    $('#liveDot').className = 'dot ' + (s.live ? 'ok' : 'bad');
  }catch(_){
    $('#apiDot').className = 'dot bad';
    $('#gtfsDot').className = 'dot bad';
    $('#liveDot').className = 'dot bad';
  }
}
refreshStatus();

async function search(){
  const q = $('#q').value.trim();
  const mins = Math.max(5, Math.min(240, parseInt($('#mins').value||'60',10)));
  if(q.length < 2){ alert('√çrj be legal√°bb 2 karaktert.'); return; }
  const stops = await api('/api/stops/search?q='+encodeURIComponent(q));

  $('#res').style.display = 'none';
  const box = $('#choices'); box.innerHTML=''; box.style.display='none';

  if(!stops.length){ alert('Nincs tal√°lat erre a n√©vre.'); return; }
  if(stops.length === 1){ return loadStop(stops[0], mins); }

  // t√∂bb tal√°lat
  box.style.display='block';
  for(const s of stops){
    const div = document.createElement('div');
    div.className = 'item';
    div.textContent = `${s.stop_name} (${s.stop_id})`;
    div.onclick = ()=> loadStop(s, mins);
    box.appendChild(div);
  }
}

async function loadStop(stop, mins){
  $('#choices').style.display='none';
  $('#res').style.display='block';
  $('#title').textContent = `Meg√°ll√≥: ${stop.stop_name} ‚Ä¢ (${stop.stop_id})`;

  const rows = await api(`/api/stops/${encodeURIComponent(stop.stop_id)}/next_departures?minutes=${mins}`);
  const tb = $('#tbody'); tb.innerHTML = '';
  if(!rows.length){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="5" style="color:#9fb4d6">Nincs indul√°s ebben az id≈ëablakban.</td>`;
    tb.appendChild(tr); return;
  }

  for(const r of rows){
    const hhmm = r.planned_hhmm || (r.time_iso ? r.time_iso.slice(11,16) : '');
    const due = (typeof r.due_in_min === 'number')
      ? (r.due_in_min <= 0 ? 'DUE' : (r.due_in_min + ' min'))
      : '‚Äì';
    const live = r.is_live ? '<span class="liveBadge"><span class="liveDot"></span>live</span>' : '‚Äì';

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span class="route">${r.route||''}</span></td>
      <td>${escapeHtml(r.destination||'')}</td>
      <td>${hhmm}</td>
      <td>${due}</td>
      <td>${live}</td>
    `;
    tb.appendChild(tr);
  }
}

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c])); }

$('#go').onclick = search;
$('#q').addEventListener('keydown', e => { if(e.key === 'Enter') search(); });
</script>
</body>
</html>
