<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë</title>
  <style>
    :root {
      --bg: #0b1220;
      --card: #121a2b;
      --muted: #9fb3c8;
      --text: #e9f1fb;
      --accent: #64d2a3;
      --accent-2: #4aa3ff;
      --danger: #ff6b6b;
      --warning: #f6c454;
      --border: #1e2a41;
    }
    * { box-sizing: border-box }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Segoe UI Emoji", "Apple Color Emoji";
    }
    .wrap { max-width: 980px; margin: 0 auto; padding: 24px 16px 48px }
    h1 {
      margin: 0 0 16px; font-size: clamp(22px, 4.5vw, 34px); font-weight: 800;
      letter-spacing: .2px; display: flex; align-items: center; gap: 10px;
    }
    .bus { font-size: 1.2em }
    .card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 14px; padding: 14px; margin-bottom: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.04);
    }
    .row { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center }
    .row input {
      width: 100%; padding: 14px 14px; border-radius: 12px; border: 1px solid var(--border);
      background: #0f1726; color: var(--text); outline: none;
    }
    .row input::placeholder { color: #7b90a8 }
    .btn {
      appearance: none; border: 0; cursor: pointer;
      padding: 12px 18px; border-radius: 12px; font-weight: 700;
      color: #072014; background: var(--accent); box-shadow: 0 6px 20px rgba(100,210,163,.35);
    }
    .meta {
      display: flex; flex-wrap: wrap; gap: 10px; align-items: center; color: var(--muted);
      font-size: 14px; margin-top: 10px;
    }
    .badge {
      display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px;
      background: #0f1726; border: 1px solid var(--border); color: var(--muted);
    }
    .dot { width: 10px; height: 10px; border-radius: 50% }
    .ok { background: #29d17e; box-shadow: 0 0 0 2px rgba(41,209,126,.18) inset }
    .warn { background: var(--warning) }
    .err { background: var(--danger) }
    .table {
      width: 100%; border-collapse: collapse; overflow: hidden; border-radius: 14px;
      border: 1px solid var(--border);
    }
    .table th, .table td {
      padding: 12px 14px; text-align: left; border-bottom: 1px solid var(--border);
    }
    .table th {
      background: #0f1726; color: var(--muted); font-weight: 700; text-transform: uppercase; font-size: 12px; letter-spacing: .8px;
    }
    .table tr:last-child td { border-bottom: 0 }
    .liveDot {
      display: inline-flex; align-items: center; gap: 8px; font-weight: 600;
    }
    .liveDot .dot { width: 10px; height: 10px; border-radius: 50%; background: #29d17e }
    .muted { color: var(--muted) }
    .footer { margin-top: 24px; text-align: center; color: var(--muted); font-size: 14px }
    .statusline { margin-top: 6px; font-size: 14px; color: var(--muted) }
    .link { color: var(--accent-2); text-decoration: none }
    .empty {
      padding: 18px; text-align: center; color: var(--muted);
      border: 1px dashed var(--border); border-radius: 12px; background: #0f1726;
    }
    @media (max-width: 640px) {
      .row { grid-template-columns: 1fr 120px }
      .table th:nth-child(2), .table td:nth-child(2) { display: none } /* rejts√ºk a c√©l √°llom√°st nagyon kis kijelz≈ën */
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1><span class="bus">üöå</span> Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë</h1>

    <div class="card">
      <div class="row">
        <input id="q" type="search" placeholder="√çrj be egy meg√°ll√≥nevet (pl. Vincent, Shirley‚Ä¶)" />
        <button id="go" class="btn">Keres√©s</button>
      </div>
      <div class="meta">
        <span class="badge" id="apiBadge"><span class="dot err"></span> API</span>
        <span class="badge" id="gtfsBadge"><span class="dot warn"></span> GTFS</span>
        <span class="badge" id="liveBadge"><span class="dot warn"></span> Live</span>
        <span class="statusline" id="statusLine"></span>
      </div>
    </div>

    <div id="resultsCard" class="card" style="display:none">
      <div class="muted" id="placeFor"></div>
      <div style="overflow:auto">
        <table class="table" id="tbl">
          <thead>
            <tr>
              <th>J√°rat</th>
              <th>C√©l</th>
              <th>Indul√°s</th>
              <th>√âl≈ë</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="footer">UI & API: te ‚Äì ‚ù§Ô∏è</div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const api = (p) => `${p.startsWith('/') ? p : '/' + p}`;

    // --- St√°tusz jelz≈ëk -------------------------------------------------------
    async function loadStatus() {
      try {
        const r = await fetch(api('/api/status'));
        const ok = r.ok;
        const js = ok ? await r.json() : {};
        setBadge('#apiBadge', ok);
        setBadge('#gtfsBadge', !!js.gtfs_loaded);
        setBadge('#liveBadge', !!js.siri_configured);
        $('#statusLine').textContent =
          `API: ${ok ? 'ok' : 'hiba'} ¬∑ GTFS: ${js.gtfs_loaded ? 'bet√∂ltve' : 'nincs'} ¬∑ Live: ${js.siri_configured ? 'el√©rhet≈ë' : 'nincs'}`;
      } catch (e) {
        setBadge('#apiBadge', false);
        $('#statusLine').textContent = 'Nem siker√ºlt lek√©rdezni az API st√°tusz√°t.';
      }
    }

    function setBadge(sel, isOk) {
      const el = $(sel);
      const dot = el.querySelector('.dot');
      dot.classList.remove('ok','warn','err');
      if (isOk) {
        dot.classList.add('ok');
      } else {
        dot.classList.add('err');
      }
    }

    // --- Keres√©s --------------------------------------------------------------
    async function search() {
      const q = $('#q').value.trim();
      if (q.length < 2) {
        alert('√çrj be legal√°bb 2 karaktert.');
        return;
      }
      $('#resultsCard').style.display = 'block';
      $('#tbody').innerHTML = `<tr><td colspan="4" class="muted">Keres√©s‚Ä¶</td></tr>`;
      $('#placeFor').textContent = '';

      try {
        // A /api/stops/search param√©terneve egyes build-ekben ?query, m√°shol ?q
        let res = await fetch(api(`/api/stops/search?query=${encodeURIComponent(q)}`));
        if (!res.ok) res = await fetch(api(`/api/stops/search?q=${encodeURIComponent(q)}`));
        if (!res.ok) throw new Error('search failed');
        const stops = await res.json();
        if (!Array.isArray(stops) || stops.length === 0) {
          $('#tbody').innerHTML = `<tr><td colspan="4" class="muted">Nincs tal√°lat.</td></tr>`;
          return;
        }

        // Els≈ë tal√°lat ‚Äì meg√°ll√≥ azonos√≠t√≥
        const stop = stops[0];
        $('#placeFor').textContent = `Meg√°ll√≥: ${stop.stop_name}  ‚Ä¢  (${stop.stop_id})`;

        const depRes = await fetch(api(`/api/stops/${encodeURIComponent(stop.stop_id)}/next_departures?minutes=60`));
        const dep = depRes.ok ? await depRes.json() : null;
        if (!dep || !Array.isArray(dep.results) || dep.results.length === 0) {
          $('#tbody').innerHTML = `<tr><td colspan="4" class="muted">Nincs k√∂zelg≈ë indul√°s.</td></tr>`;
          return;
        }

        const rows = dep.results.map(item => {
          const when = formatTime(item.time_iso);
          const live = item.is_live === true;
          return `
            <tr>
              <td><strong>${escapeHtml(item.route ?? '')}</strong></td>
              <td>${escapeHtml(item.destination ?? '')}</td>
              <td>${when}</td>
              <td>
                ${live
                  ? `<span class="liveDot"><span class="dot"></span> √©l≈ë</span>`
                  : `<span class="muted">‚Äì</span>`}
              </td>
            </tr>
          `;
        }).join('');
        $('#tbody').innerHTML = rows;

      } catch (e) {
        console.error(e);
        $('#tbody').innerHTML = `<tr><td colspan="4" class="muted">Hiba t√∂rt√©nt a keres√©s k√∂zben.</td></tr>`;
      }
    }

    // --- Helper ---------------------------------------------------------------
    function formatTime(iso) {
      try {
        const d = new Date(iso);
        if (isNaN(d.getTime())) return iso ?? '';
        return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      } catch { return iso ?? '' }
    }
    function escapeHtml(s) {
      return String(s ?? '')
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    // --- Esem√©nyek ------------------------------------------------------------
    $('#go').addEventListener('click', search);
    $('#q').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') search();
    });

    // Init
    loadStatus();
  </script>
</body>
</html>
