<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f1a" />
  <title>Bluestar menetrend √©s meg√°ll√≥ keres≈ë</title>
  <style>
    :root{
      --bg:#0b0f1a; --panel:#121829; --panel-2:#0f1524; --muted:#8fa3b8;
      --text:#e8ecf1; --brand:#9aa6ff; --accent:#3b82f6; --ok:#25d366; --warn:#f59e0b; --err:#ef4444;
      --chip:#1b2238; --chip-b:#273255; --chip-t:#bcd0ff; --shadow:0 6px 24px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;
      color:var(--text); background:radial-gradient(1200px 800px at 70% -20%,#1b2441 0%,#0b0f1a 55%) fixed,var(--bg);
    }
    .container{max-width:980px;margin:0 auto;padding:16px 16px 48px}
    header{display:flex;align-items:center;gap:12px;padding:18px 0 6px}
    header h1{margin:0;font-size:22px;font-weight:650;letter-spacing:.3px}
    .uk-time{opacity:.9;font-size:14px;margin-left:auto}
    .toolbar{display:flex;align-items:center;gap:12px;margin:8px 0 16px}
    .btn{appearance:none;border:none;background:var(--brand);color:#101321;padding:10px 14px;border-radius:12px;font-weight:650;cursor:pointer;box-shadow:var(--shadow)}
    .btn.ghost{background:transparent;color:var(--text);outline:1px solid #364063}
    .btn.small{padding:6px 10px;border-radius:10px}
    .tabs{display:flex;gap:10px;margin:10px 0 2px}
    .tab{padding:10px 14px;border-radius:14px;background:var(--panel-2);color:var(--muted);cursor:pointer;border:1px solid #1f2a44}
    .tab.active{background:#202a46;color:var(--text);border-color:#2b3a62}
    .card{background:var(--panel);border:1px solid #1f2a44;border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .row{display:flex;gap:12px;align-items:center;margin:10px 0}
    .input{flex:1;display:flex;align-items:center;background:var(--panel-2);border:1px solid #1f2a44;border-radius:12px;padding:6px 10px}
    .input input{flex:1;background:transparent;border:none;outline:none;color:var(--text);font-size:16px;padding:6px}
    .section-title{font-weight:700;margin:12px 4px 8px}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{background:var(--chip);border:1px solid #243055;color:var(--chip-t);padding:6px 10px;border-radius:10px;font-weight:650}
    .results{margin-top:10px;display:flex;flex-direction:column;gap:10px}
    .item{display:flex;align-items:center;gap:12px;background:var(--panel-2);border:1px solid #1f2a44;border-radius:14px;padding:12px}
    .pill{min-width:44px;height:44px;display:grid;place-items:center;border-radius:10px;background:var(--chip-b);color:#d8e0ff;font-weight:800}
    .dest{font-weight:650}
    .due{margin-left:auto;color:#8fe29f}
    .footer{opacity:.75;font-size:13px;margin-top:14px}
    .error{position:fixed;left:16px;right:16px;bottom:16px;background:#2a0e12;border:1px solid #4e1c23;color:#ffd6d6;padding:12px;border-radius:12px;box-shadow:var(--shadow);display:none}
    .drawer-btn,.settings-btn{width:42px;height:42px;border-radius:12px;border:1px solid #263150;background:var(--panel-2);display:grid;place-items:center;color:var(--text);cursor:pointer}
    .topbar{display:flex;gap:10px;align-items:center}
    dialog{border:none;border-radius:16px;background:#0f1526;color:var(--text);padding:0;box-shadow:0 24px 80px rgba(0,0,0,.6);max-width:520px}
    dialog::backdrop{background:rgba(7,10,20,.65)}
    .dlg-header{padding:14px 16px;border-bottom:1px solid #223055;font-weight:700}
    .dlg-body{padding:14px 16px;display:flex;flex-direction:column;gap:12px}
    .grid-2{display:grid;grid-template-columns:1fr 120px;gap:10px}
    .muted{color:var(--muted)}
    .fav{margin-left:8px}
    a{color:#b6c4ff;text-decoration:none}
    @media (max-width:640px){ .grid-2{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <button class="drawer-btn" id="btnDrawer" title="Men√º">‚ò∞</button>
      <header>
        <h1>üöç Bluestar menetrend √©s meg√°ll√≥ keres≈ë</h1>
      </header>
      <button class="settings-btn" id="btnSettings" title="Be√°ll√≠t√°sok">‚öôÔ∏è</button>
    </div>
    <div class="uk-time" id="ukTime">UK: --:--:--</div>

    <div class="toolbar">
      <div class="tabs">
        <div class="tab active" data-tab="stop">Meg√°ll√≥</div>
        <div class="tab" data-tab="route">Viszonylat</div>
        <div class="tab" data-tab="fav">Kedvencek</div>
      </div>
    </div>

    <!-- STOP TAB -->
    <section id="tab-stop" class="card">
      <div class="row">
        <div class="input">
          <input id="queryStop" type="text" placeholder="Telep√ºl√©s, utca, meg√°ll√≥ neve‚Ä¶" autocomplete="off" />
        </div>
        <button class="btn" id="btnStopSearch">Keres√©s</button>
      </div>

      <div class="section-title">Kiemelt forgalmi v√°ltoz√°sok</div>
      <div class="chips" id="chips">
        <span class="chip">18</span><span class="chip">19</span><span class="chip">1</span>
        <span class="chip">7</span><span class="chip">U1</span><span class="chip">X4</span>
      </div>

      <div class="section-title">Tal√°latok</div>
      <div class="results" id="stopResults"></div>

      <div class="footer" id="statusLine">Friss√≠t√©s: 20 s ‚Ä¢ Build: ‚Äì</div>
    </section>

    <!-- ROUTE TAB (helyfoglal√≥ UI, k√©s≈ëbbre) -->
    <section id="tab-route" class="card" style="display:none">
      <p class="muted">A viszonylat keres≈ë fel√ºlet itt fog b≈ëv√ºlni (√∫tvonal t√©rk√©p, j√°rm≈±lista stb.).</p>
      <p class="muted">A backendhez igaz√≠tott API-v√©gpontok miatt most a Meg√°ll√≥ f√ºl a f≈ë funkci√≥.</p>
    </section>

    <!-- FAV TAB -->
    <section id="tab-fav" class="card" style="display:none">
      <div id="favList" class="results"></div>
      <p class="muted" id="favEmpty" style="display:none">M√©g nincs elmentett meg√°ll√≥. A tal√°latokn√°l a ‚òÖ gombra kattintva tudsz hozz√°adni.</p>
    </section>

    <!-- ERROR TOAST -->
    <div id="toast" class="error">H√°l√≥zati hiba vagy API v√°lasz hiba.</div>
  </div>

  <!-- SETTINGS DIALOG -->
  <dialog id="dlg">
    <div class="dlg-header">Be√°ll√≠t√°sok</div>
    <form method="dialog" class="dlg-body">
      <label class="muted">API el√©r√©si √∫t (√ºres = ugyanarr√≥l a domainr≈ël)</label>
      <input id="apiBase" class="input" style="padding:0">
      <div class="grid-2">
        <label class="muted">Friss√≠t√©si id≈ë (mp)</label>
        <input id="refreshSec" class="input" type="number" min="5" max="180" value="20" style="padding:0">
      </div>
      <div class="grid-2">
        <label class="muted">El≈ëretekint√©si ablak (perc)</label>
        <input id="windowMin" class="input" type="number" min="10" max="240" value="60" style="padding:0">
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
        <button class="btn ghost" value="cancel">M√©gse</button>
        <button class="btn" value="ok">Ment√©s</button>
      </div>
    </form>
  </dialog>

  <script>
    // ------- Config & state -------
    const state = {
      API_BASE: localStorage.getItem('apiBase') || '',
      REFRESH_SEC: +(localStorage.getItem('refreshSec') || 20),
      WINDOW_MIN: +(localStorage.getItem('windowMin') || 60),
      timer: null,
      build: '-',
      stops: [],   // {id,name}
      currentStop: null,
    };

    // ------- Helpers -------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);

    function showToast(msg){
      const t = $('#toast');
      t.textContent = msg || 'H√°l√≥zati hiba vagy API v√°lasz hiba.';
      t.style.display = 'block';
      setTimeout(()=> t.style.display = 'none', 3500);
    }

    async function api(path){
      const url = (state.API_BASE || '') + path;
      const res = await fetch(url, { headers: { 'accept':'application/json' }});
      if(!res.ok) throw new Error('API ' + res.status);
      return res.json();
    }

    function saveFav(stop){
      const arr = JSON.parse(localStorage.getItem('favs')||'[]');
      if(!arr.find(x=>x.id===stop.id)){
        arr.push(stop);
        localStorage.setItem('favs', JSON.stringify(arr));
      }
      renderFavs();
    }
    function delFav(id){
      const arr = JSON.parse(localStorage.getItem('favs')||'[]').filter(x=>x.id!==id);
      localStorage.setItem('favs', JSON.stringify(arr));
      renderFavs();
    }

    // ------- UK time (Europe/London) -------
    function tickClock(){
      try{
        const now = new Date();
        // London offset accounting for DST via Intl
        const uk = new Intl.DateTimeFormat('hu-HU', {
          timeZone: 'Europe/London', hour:'2-digit', minute:'2-digit', second:'2-digit'
        }).format(now);
        $('#ukTime').textContent = 'UK: ' + uk;
      }catch(e){
        // fallback UTC
        const d = new Date().toISOString().substring(11,19);
        $('#ukTime').textContent = 'UK: ' + d + 'Z';
      }
    }
    setInterval(tickClock,1000); tickClock();

    // ------- Tabs -------
    $$('.tab').forEach(el=>{
      el.addEventListener('click',()=>{
        $$('.tab').forEach(t=>t.classList.remove('active'));
        el.classList.add('active');
        const name = el.dataset.tab;
        $('#tab-stop').style.display = (name==='stop')?'block':'none';
        $('#tab-route').style.display = (name==='route')?'block':'none';
        $('#tab-fav').style.display   = (name==='fav')?'block':'none';
      });
    });

    // ------- Settings dialog -------
    const dlg = $('#dlg');
    $('#btnSettings').onclick = ()=>{
      $('#apiBase').value = state.API_BASE;
      $('#refreshSec').value = state.REFRESH_SEC;
      $('#windowMin').value = state.WINDOW_MIN;
      dlg.showModal();
    };
    dlg.addEventListener('close', ()=>{
      if(dlg.returnValue==='ok'){
        state.API_BASE   = $('#apiBase').value.trim();
        state.REFRESH_SEC= Math.max(5, Math.min(180, +$('#refreshSec').value||20));
        state.WINDOW_MIN = Math.max(10, Math.min(240, +$('#windowMin').value||60));
        localStorage.setItem('apiBase', state.API_BASE);
        localStorage.setItem('refreshSec', state.REFRESH_SEC);
        localStorage.setItem('windowMin', state.WINDOW_MIN);
        restartAutoRefresh();
        updateStatusLine();
      }
    });

    // ------- Drawer (csak vizu√°lis placeholder) -------
    $('#btnDrawer').onclick = ()=> showToast('Men√º: k√∂zlem√©nyek, kedvencek friss√≠t√©se, n√©vjegy ‚Äì hamarosan.');

    // ------- Status & build -------
    async function initStatus(){
      try{
        const st = await api('/api/status');
        state.build = st.build || '-';
        updateStatusLine();
      }catch(e){
        updateStatusLine();
      }
    }
    function updateStatusLine(){
      $('#statusLine').textContent = `Friss√≠t√©s: ${state.REFRESH_SEC} s ‚Ä¢ Build: ${state.build}`;
    }

    // ------- Stop search -------
    async function searchStops(){
      const q = $('#queryStop').value.trim();
      $('#stopResults').innerHTML = '';
      if(!q){ return; }
      try{
        const items = await api(`/api/live/stop-search?q=${encodeURIComponent(q)}`);
        state.stops = items;
        if(!items.length){
          $('#stopResults').innerHTML = `<div class="muted">Nincs tal√°lat erre: <b>${q}</b></div>`;
          return;
        }
        renderStopList(items);
      }catch(e){
        showToast('Nem siker√ºlt a meg√°ll√≥keres√©s.');
      }
    }
    function renderStopList(items){
      const host = $('#stopResults');
      host.innerHTML = '';
      items.forEach(s=>{
        const row = document.createElement('div'); row.className = 'item';
        row.innerHTML = `
          <div class="pill">BUS</div>
          <div>
            <div class="dest">${s.name}</div>
            <div class="muted">ID: ${s.id}</div>
          </div>
          <button class="btn small fav" title="Hozz√°ad√°s a kedvencekhez">‚òÖ</button>
          <button class="btn small" title="Indul√°sok megnyit√°sa">Megnyit</button>
        `;
        const [ , , , btnFav, btnOpen ] = row.children;
        btnFav.onclick = (ev)=>{ ev.stopPropagation(); saveFav(s); };
        btnOpen.onclick = ()=> openDepartures(s);
        row.addEventListener('click', ()=> openDepartures(s));
        host.appendChild(row);
      });
    }

    // ------- Departures -------
    async function openDepartures(stop){
      state.currentStop = stop;
      // azonnali lek√©r√©s + auto friss√≠t√©s
      await loadDepartures();
      restartAutoRefresh();
      // v√°ltson a ‚ÄûMeg√°ll√≥‚Äù f√ºl√∂n maradva, a lista al√° √≠rjuk az eredm√©nyt
    }

    async function loadDepartures(){
      if(!state.currentStop) return;
      const host = $('#stopResults');
      const id = state.currentStop.id;
      // bet√∂lt≈ë cs√≠k
      const loader = document.createElement('div');
      loader.className='muted'; loader.textContent='Bet√∂lt√©s‚Ä¶';
      host.prepend(loader);
      try{
        const list = await api(`/api/live/departures?stopId=${encodeURIComponent(id)}&window=${state.WINDOW_MIN}`);
        // T√°bl√°zat render
        const wrap = document.createElement('div');
        wrap.className = 'results';
        wrap.innerHTML = `
          <div class="section-title">Kiv√°lasztott meg√°ll√≥: ${state.currentStop.name} ‚Äî friss√ºl ${state.REFRESH_SEC} mp-enk√©nt</div>
        `;
        list.forEach(d=>{
          const row = document.createElement('div'); row.className = 'item';
          const eta = (d.due_in_min==null)?'': (d.due_in_min===0?'Due':d.due_in_min+"'");
          row.innerHTML = `
            <div class="pill">${(d.line||'').toString().substring(0,4)}</div>
            <div style="min-width:0">
              <div class="dest" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${d.destination||''}</div>
              <div class="muted">V√°rhat√≥: ${d.expected||'--:--'}</div>
            </div>
            <div class="due">${eta}</div>
          `;
          wrap.appendChild(row);
        });
        // cser√©lj√ºk a teljes host tartalmat: fent a kiv√°lasztott meg√°ll√≥ blokk + lista
        host.innerHTML = '';
        const head = document.createElement('div');
        head.className='item';
        head.innerHTML = `
          <div class="pill">BUS</div>
          <div class="dest">${state.currentStop.name}</div>
          <button class="btn small fav" title="Kedvencekhez">‚òÖ</button>
        `;
        head.querySelector('.fav').onclick = ()=> saveFav(state.currentStop);
        host.appendChild(head);
        host.appendChild(wrap);
      }catch(e){
        showToast('Nem siker√ºlt bet√∂lteni az indul√°sokat.');
      }finally{
        loader.remove();
      }
    }

    function restartAutoRefresh(){
      if(state.timer) clearInterval(state.timer);
      if(state.currentStop){
        state.timer = setInterval(loadDepartures, state.REFRESH_SEC*1000);
      }
    }

    // ------- Favourites -------
    function renderFavs(){
      const arr = JSON.parse(localStorage.getItem('favs')||'[]');
      const host = $('#favList'); host.innerHTML='';
      $('#favEmpty').style.display = arr.length ? 'none' : 'block';
      arr.forEach(s=>{
        const row = document.createElement('div'); row.className='item';
        row.innerHTML = `
          <div class="pill">‚òÖ</div>
          <div>
            <div class="dest">${s.name}</div>
            <div class="muted">ID: ${s.id}</div>
          </div>
          <button class="btn small">Megnyit</button>
          <button class="btn small ghost">T√∂rl√©s</button>
        `;
        row.children[2].onclick = ()=> openDepartures(s);
        row.children[3].onclick = ()=> delFav(s.id);
        host.appendChild(row);
      });
    }

    // ------- Events -------
    $('#btnStopSearch').onclick = searchStops;
    $('#queryStop').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); searchStops(); }});
    $('#chips').addEventListener('click', e=>{
      if(e.target.classList.contains('chip')){
        $('#queryStop').value = e.target.textContent.trim();
        searchStops();
      }
    });

    // ------- Boot -------
    (async function boot(){
      updateStatusLine();
      renderFavs();
      await initStatus();
    })();
  </script>
</body>
</html>
