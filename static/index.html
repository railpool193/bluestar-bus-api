<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bluestar Bus – megálló & élő indulások</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0f172a; --card:#ffffff; --txt:#0f172a; --muted:#64748b; --brand:#2563eb; --ok:#16a34a; --bad:#ef4444; }
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:#fff}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    h1{font-size:clamp(24px,3.5vw,40px);margin:0 0 24px}
    .card{background:var(--card);color:var(--txt);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.25);padding:20px}
    .row{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    .grow{flex:1 1 520px}
    input[type=text],input[type=number]{width:100%;padding:14px 16px;border-radius:12px;border:1px solid #e2e8f0;font-size:16px;outline:none}
    button{background:var(--brand);border:none;color:#fff;padding:14px 18px;border-radius:12px;font-weight:700;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .status{display:flex;gap:12px;margin-top:14px}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;background:#f1f5f9;color:#0f172a;font-weight:600}
    .dot{width:10px;height:10px;border-radius:50%}
    .ok{background:var(--ok)} .bad{background:var(--bad)}
    .results{margin-top:18px;border-top:1px solid #e5e7eb;padding-top:12px}
    ul.sugg{list-style:none;margin:8px 0 0;padding:0;border:1px solid #e2e8f0;border-radius:12px;max-height:260px;overflow:auto}
    ul.sugg li{padding:10px 12px;cursor:pointer}
    ul.sugg li:hover{background:#f1f5f9}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:12px;border-bottom:1px solid #e5e7eb}
    .muted{color:var(--muted)}
    .footer{margin-top:18px;color:#cbd5e1;font-size:12px;text-align:center}
    .err{color:#b91c1c;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Bluestar Bus – Megálló keresés & élő indulások</h1>

    <div class="card">
      <div class="row">
        <div class="grow">
          <label class="muted">Megálló név (pl. „Vincent”)</label>
          <input id="q" type="text" placeholder="Kezdj el írni…" autocomplete="off" />
          <ul id="sugg" class="sugg" hidden></ul>
          <div id="qerr" class="err" hidden></div>
        </div>

        <div>
          <label class="muted">Időablak (perc)</label>
          <input id="mins" type="number" value="60" min="5" max="240" />
        </div>

        <div>
          <label class="muted" style="visibility:hidden"> </label>
          <button id="go">Indulások lekérése</button>
        </div>
      </div>

      <div class="status">
        <span class="pill">API <span id="api-dot" class="dot bad"></span></span>
        <span class="pill">GTFS <span id="gtfs-dot" class="dot bad"></span></span>
        <span class="pill">Live <span id="live-dot" class="dot bad"></span></span>
      </div>

      <div id="picked" class="muted" style="margin-top:8px;">Választott megálló: <b id="picked-name">–</b> <span id="picked-id" class="muted"></span></div>

      <div class="results" id="res"></div>
      <div class="footer">UI build: <span id="build"></span> • ❤️</div>
    </div>
  </div>

  <script>
  const API = location.origin;
  let picked = null;
  function el(id){return document.getElementById(id)}
  const q = el('q'), sugg = el('sugg'), res = el('res'), qerr = el('qerr');

  async function status(){
    try{
      const j = await (await fetch(`${API}/api/status`,{cache:'no-store'})).json();
      el('api-dot').className = 'dot ' + (j.status==='ok'?'ok':'bad');
      el('gtfs-dot').className = 'dot ' + (j.gtfs?'ok':'bad');
      el('live-dot').className = 'dot ' + (j.live?'ok':'bad');
      el('build').textContent = j.build || '{{BUILD_ID}}';
    }catch(e){}
  }

  async function search(name){
    sugg.innerHTML = '';
    sugg.hidden = true;
    qerr.hidden = true;
    picked = null;
    el('picked-name').textContent = '–';
    el('picked-id').textContent = '';
    if(!name || name.trim().length<2) return;
    try{
      const r = await fetch(`${API}/api/stops/search?q=`+encodeURIComponent(name),{cache:'no-store'});
      if(!r.ok){ throw new Error(`HTTP ${r.status}`); }
      const data = await r.json();
      if(!Array.isArray(data) || data.length===0){
        const li = document.createElement('li'); li.textContent = 'Nincs találat.'; li.className='muted';
        sugg.appendChild(li); sugg.hidden=false; return;
      }
      data.forEach(s=>{
        const li = document.createElement('li');
        li.textContent = `${s.stop_name} • ${s.stop_id}`;
        li.onclick = ()=>{ picked = s; q.value = s.stop_name; sugg.hidden=true; el('picked-name').textContent=s.stop_name; el('picked-id').textContent='(' + s.stop_id + ')'; };
        sugg.appendChild(li);
      });
      sugg.hidden = false;
    }catch(err){
      qerr.textContent = 'Keresési hiba: ' + (err.message || err);
      qerr.hidden = false;
    }
  }

  async function loadDepartures(){
    if(!picked){ alert('Előbb válassz megállót a listából!'); return; }
    res.innerHTML = 'Betöltés…';
    const mins = Math.max(5, Math.min(240, parseInt(el('mins').value||'60',10)));
    const data = await (await fetch(`${API}/api/stops/${encodeURIComponent(picked.stop_id)}/next_departures?minutes=${mins}`,{cache:'no-store'})).json();
    if(!Array.isArray(data) || data.length===0){ res.innerHTML = '<div class="muted">Nincs megjeleníthető indulás.</div>'; return; }
    let html = '<table><thead><tr><th>Járat</th><th>Cél</th><th>Idő</th></tr></thead><tbody>';
    data.forEach(d=>{ html += `<tr><td>${d.route||'-'}</td><td>${d.destination||'-'}</td><td>${d.time||'-'}</td></tr>`; });
    html += `</tbody></table>`;
    res.innerHTML = html;
  }

  q.addEventListener('input', e=> search(e.target.value));
  q.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); loadDepartures(); }});
  el('go').onclick = loadDepartures;
  status();
  (function(){ const b='{{BUILD_ID}}'; if(b && b!=='{{'+'BUILD_ID'+'}}'){ el('build').textContent=b; }})();
  </script>
</body>
</html>
