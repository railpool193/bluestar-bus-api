<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë</title>
  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --muted:#a7b3d0; --text:#e8eeff;
      --accent:#6b8cff; --accent-2:#8b5cf6; --good:#22c55e; --bad:#ef4444; --chip:#0f172a;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(135deg,#0b1220,#0b1628);color:var(--text);font:16px/1.45 system-ui,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:980px;margin:0 auto;padding:28px 18px 80px}
    h1{font-size:clamp(26px,4.5vw,42px);margin:6px 0 18px;font-weight:800;letter-spacing:.2px}
    .card{background:var(--card);border:1px solid #1f2942;border-radius:16px;padding:18px 18px;box-shadow:0 6px 28px rgba(0,0,0,.35)}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media (min-width:760px){.grid{grid-template-columns: 1.3fr .5fr auto}}
    label{font-size:14px;color:var(--muted);display:block;margin-bottom:6px}
    input[type="text"],input[type="number"]{
      width:100%;background:#0f1530;border:1px solid #243050;color:var(--text);
      border-radius:12px;padding:14px 14px;outline:none;font-size:16px
    }
    input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(107,140,255,.25)}
    .btn{
      border:0;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#fff;
      padding:14px 18px;border-radius:12px;font-weight:700;cursor:pointer;white-space:nowrap
    }
    .btn:active{transform:translateY(1px)}
    .status{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
    .dot{width:10px;height:10px;border-radius:50%;display:inline-block;vertical-align:-1px;margin-right:6px}
    .ok{background:var(--good)} .bad{background:var(--bad)}
    .chip{background:var(--chip);border:1px solid #1f2942;color:#b8c3e8;border-radius:999px;padding:6px 10px;font-size:13px}
    .table{margin-top:18px;overflow:auto;border-radius:12px;border:1px solid #1f2942}
    table{width:100%;border-collapse:collapse;background:#0e152a}
    th,td{padding:12px 14px;border-bottom:1px solid #1a2440}
    th{position:sticky;top:0;background:#0d1426;text-align:left;color:#bcd0ff;font-weight:700}
    tbody tr:hover{background:#0f1a33}
    .sel{color:#a7b3d0}
    /* tal√°lati dropdown */
    .dropdown{position:relative}
    .dd-list{
      position:absolute;z-index:20;left:0;right:0;top:100%;margin-top:6px;
      background:#0f1530;border:1px solid #243050;border-radius:12px;max-height:260px;overflow:auto;display:none
    }
    .dd-item{padding:10px 12px;border-bottom:1px solid #1a2440;cursor:pointer}
    .dd-item:hover{background:#101b36}
    .show{display:block}
    .idpill{background:#0f172a;border:1px solid #27324e;color:#9eb1e7;border-radius:999px;padding:6px 10px}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üöå Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë</h1>

    <div class="card">
      <div class="grid">
        <div class="dropdown">
          <label>Meg√°ll√≥ n√©v (pl. ‚ÄûVincent‚Äù)</label>
          <input id="q" type="text" placeholder="Kezdj el √≠rni‚Ä¶" autocomplete="off" />
          <div id="dd" class="dd-list"></div>
        </div>

        <div>
          <label>Id≈ëablak (perc)</label>
          <input id="mins" type="number" value="60" min="5" max="240" />
        </div>

        <div style="display:flex;align-items:flex-end">
          <button id="go" class="btn">Keres√©s</button>
        </div>
      </div>

      <div class="status">
        <span class="chip"><span id="dot-api" class="dot bad"></span>API</span>
        <span class="chip"><span id="dot-gtfs" class="dot bad"></span>GTFS</span>
        <span class="chip"><span id="dot-live" class="dot bad"></span>Live</span>
        <span class="chip sel">V√°lasztott meg√°ll√≥ ID: <span id="chosen" class="idpill">‚Äì</span></span>
      </div>
    </div>

    <div id="result" class="card" style="margin-top:16px;display:none">
      <div class="table">
        <table>
          <thead>
          <tr>
            <th>J√°rat</th>
            <th>C√©l</th>
            <th>Indul√°s</th>
            <th>√âl≈ë</th>
          </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
(() => {
  const qs = (s) => document.querySelector(s);
  const elQ = qs('#q');
  const elDD = qs('#dd');
  const elGo = qs('#go');
  const elChosen = qs('#chosen');
  const dotApi = qs('#dot-api');
  const dotGtfs = qs('#dot-gtfs');
  const dotLive = qs('#dot-live');
  const elTBody = qs('#tbody');
  const elResult = qs('#result');

  let pickedStop = null;

  const mark = (el, ok) => {
    el.classList.remove('ok', 'bad');
    el.classList.add(ok ? 'ok' : 'bad');
  };

  const apiFetch = (url, opts={}) => {
    const sep = url.includes('?') ? '&' : '?';
    const bust = sep + 'ts=' + Date.now();
    return fetch(url + bust, { cache: 'no-store', ...opts });
  };

  const loadStatus = async () => {
    try {
      const r = await apiFetch('/api/status');
      const j = await r.json();
      mark(dotApi, true);
      mark(dotGtfs, !!j.gtfs);
      mark(dotLive, !!j.live);
    } catch (e) {
      mark(dotApi, false); mark(dotGtfs, false); mark(dotLive, false);
    }
  };

  const renderDD = (items) => {
    elDD.innerHTML = '';
    if (!items.length) { elDD.classList.remove('show'); return; }
    items.forEach(it => {
      const d = document.createElement('div');
      d.className = 'dd-item';
      d.textContent = `${it.stop_name}  ¬∑  ${it.stop_id}`;
      d.addEventListener('click', () => {
        pickedStop = it;
        elChosen.textContent = it.stop_id;
        elQ.value = it.stop_name;
        elDD.classList.remove('show');
      });
      elDD.appendChild(d);
    });
    elDD.classList.add('show');
  };

  let lastQ = 0;
  elQ.addEventListener('input', async () => {
    const v = elQ.value.trim();
    pickedStop = null;
    elChosen.textContent = '‚Äì';
    if (v.length < 2) { elDD.classList.remove('show'); return; }

    const now = Date.now();
    lastQ = now;
    try {
      const r = await apiFetch('/api/stops/search?q=' + encodeURIComponent(v));
      if (lastQ !== now) return;
      const j = await r.json();
      renderDD(j);
    } catch (e) {
      elDD.classList.remove('show');
    }
  });

  const renderRows = (rows) => {
    elTBody.innerHTML = '';
    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.route || ''}</td>
        <td>${r.destination || ''}</td>
        <td>${r.time}</td>
        <td class="muted">${(r.due ?? '-') + (Number.isFinite(r.due) ? ' perc' : '')}</td>
      `;
      elTBody.appendChild(tr);
    });
    elResult.style.display = 'block';
  };

  const search = async () => {
    if (!pickedStop) {
      const v = elQ.value.trim();
      if (!v) return;
      try {
        const r = await apiFetch('/api/stops/search?q=' + encodeURIComponent(v));
        const j = await r.json();
        if (!j.length) { alert('Nincs tal√°lat erre a n√©vre.'); return; }
        pickedStop = j[0];
        elChosen.textContent = pickedStop.stop_id;
        elQ.value = pickedStop.stop_name;
      } catch (e) { return; }
    }

    const mins = Math.max(5, Math.min(240, parseInt(qs('#mins').value || '60', 10)));
    try {
      const url = `/api/stops/${encodeURIComponent(pickedStop.stop_id)}/next_departures?minutes=${mins}`;
      const r = await apiFetch(url);
      const j = await r.json();
      renderRows(j);
    } catch (e) {
      alert('Hiba t√∂rt√©nt az indul√°sok lek√©r√©sekor.');
    }
  };

  elGo.addEventListener('click', search);
  elQ.addEventListener('keydown', (ev) => {
    if (ev.key === 'Enter') { ev.preventDefault(); search(); }
  });

  loadStatus();
})();
</script>
</body>
</html>
