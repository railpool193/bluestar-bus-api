<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë</title>
<link rel="preconnect" href="https://unpkg.com">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  :root{--bg:#0e1220;--card:#141a2b;--muted:#a7b0c0;--fg:#eaf0ff;--pill:#2a3350;--accent:#6c82ff;--live:#18c27e;}
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
  .wrap{max-width:980px;margin:30px auto;padding:0 16px;}
  h1{font-weight:800;letter-spacing:.5px;display:flex;gap:10px;align-items:center}
  .tabs{display:flex;gap:10px;margin:6px 0 12px}
  .tab{padding:10px 16px;border-radius:999px;background:#1c2440;color:#b9c4da;cursor:pointer;font-weight:600}
  .tab.active{background:var(--accent);color:#fff}
  .card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
  label{display:block;font-size:14px;color:#c9d2e4;margin:4px 0}
  input,select{width:100%;background:#0f1430;border:1px solid #223;outline:none;border-radius:10px;color:#fff;padding:14px 12px;font-size:16px}
  button{background:var(--accent);border:none;border-radius:12px;padding:12px 20px;font-weight:700;color:#fff;cursor:pointer}
  .row{display:flex;gap:14px;align-items:end}
  .muted{color:var(--muted)}
  .th{opacity:.85;font-weight:700;letter-spacing:.3px}
  .grid{margin-top:12px}
  .tr{display:grid;grid-template-columns:64px 1fr 120px;gap:10px;align-items:center;padding:12px;border-radius:12px;background:#0f1430;margin:8px 0;cursor:pointer}
  .tr:hover{background:#10183a}
  .pill{width:42px;height:42px;border-radius:50%;background:var(--pill);display:flex;align-items:center;justify-content:center;font-weight:800}
  .time{font-weight:800}
  .due{color:var(--live);font-weight:800;animation:blink 1s infinite}
  @keyframes blink {0%,49%{opacity:1}50%,100%{opacity:.2}}
  .hdr{display:flex;gap:12px;flex-wrap:wrap;justify-content:space-between;align-items:center;margin-bottom:10px}
  .badge{font-size:12px;padding:3px 9px;border-radius:999px;background:#0f1430;color:#b7c0d4}
  .small{font-size:13px}
  #map{height:420px;border-radius:16px;overflow:hidden}
  .footer{margin-top:12px;color:#8e97ab}
  .link{color:#9fb3ff;text-decoration:none}
  /* modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:50}
  .modal .box{background:#0f1430;border:1px solid #233055;border-radius:16px;max-width:760px;width:92%;max-height:80vh;overflow:auto}
  .modal .hd{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #222845}
  .modal .bd{padding:12px 16px}
  .x{cursor:pointer;background:#222a46;border:none;color:#b9c4da;border-radius:10px;padding:6px 10px}
  .rowbar{display:flex;gap:10px;align-items:center}
  .clock{font-variant-numeric:tabular-nums;font-weight:800}
</style>
</head>
<body>
<div class="wrap">
  <div class="hdr">
    <h1>üöå <span data-i18n="title">Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë</span></h1>
    <div class="rowbar">
      <div class="muted small"><span data-i18n="ukt">UK time</span>: <span id="ukclock" class="clock">‚Äì</span></div>
      <div class="muted small"><span data-i18n="refresh">Friss√≠t√©s</span>: <span id="tick">‚Äì</span></div>
      <select id="langSel" style="width:auto">
        <option value="hu">HU</option>
        <option value="en">EN</option>
        <option value="de">DE</option>
      </select>
    </div>
  </div>

  <div class="tabs">
    <div id="tabStop" class="tab active" data-i18n="tab_stop">Meg√°ll√≥</div>
    <div id="tabRoute" class="tab" data-i18n="tab_route">Vonal</div>
  </div>

  <!-- STOP CARD -->
  <div id="cardStop" class="card">
    <div class="row">
      <div style="flex:2">
        <label data-i18n="lbl_stop">Meg√°ll√≥ n√©v</label>
        <input id="qStop" placeholder="pl. Albion, Vincent, ...">
      </div>
      <div style="flex:1">
        <label data-i18n="lbl_minutes">Id≈ëablak (perc)</label>
        <input id="minutes" type="number" min="5" max="240" value="60">
      </div>
      <div style="flex:0">
        <button id="btnStop" data-i18n="btn_search">Keres√©s</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <label data-i18n="lbl_hits_stop">Tal√°latok ‚Äì v√°lassz meg√°ll√≥t</label>
      <select id="selStops"></select>
    </div>

    <div class="hdr" style="margin-top:12px">
      <div class="small"><span data-i18n="chosen_stop">V√°lasztott meg√°ll√≥</span>: <b id="selStopLbl">‚Äì</b></div>
      <div class="small"><span data-i18n="auto20">Friss√≠t√©s 20 mp-enk√©nt</span></div>
    </div>

    <div class="grid">
      <div class="tr th" style="cursor:default">
        <div data-i18n="col_route">J√°rat</div>
        <div data-i18n="col_dest">C√©l</div>
        <div data-i18n="col_dep">Indul√°s</div>
      </div>
      <div id="rows"></div>
    </div>

    <div class="footer small">
      Build: <span id="build">-</span> ¬∑ <span id="cache" data-i18n="cache_on">Cache-bypass akt√≠v</span>
    </div>
  </div>

  <!-- ROUTE CARD -->
  <div id="cardRoute" class="card" style="display:none">
    <div class="row">
      <div style="flex:1">
        <label data-i18n="lbl_route">Vonal sz√°ma</label>
        <input id="qRoute" placeholder="pl. 9, 17, 18...">
      </div>
      <div style="flex:0">
        <button id="btnRoute" data-i18n="btn_search">Keres√©s</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <label data-i18n="lbl_hits_route">Tal√°latok ‚Äì v√°lassz vonalat</label>
      <select id="selRoute"></select>
    </div>

    <div id="map" style="margin-top:12px"></div>
    <div id="vehList" class="small" style="margin-top:10px"></div>

    <div class="footer small" data-i18n="no_veh_hint">
      Ha nincs √©l≈ë j√°rm≈±, a t√©rk√©p √ºres marad.
    </div>
  </div>

  <div style="margin-top:16px" class="small muted">
    <span data-i18n="live_cfg_hint">√âl≈ë feed be√°ll√≠t√°sa:</span> <code>/api/live/config</code> ‚Äì <span data-i18n="live_cfg_hint2">a BODS URL-t (api_key-kel) POST-olhatod.</span>
  </div>
</div>

<!-- Trip modal -->
<div id="tripModal" class="modal">
  <div class="box">
    <div class="hd">
      <div><b data-i18n="trip_title">J√°rat r√©szletei</b> ¬∑ <span id="tripIdLbl" class="muted"></span></div>
      <button class="x" onclick="hideTrip()" data-i18n="close">Bez√°r</button>
    </div>
    <div class="bd">
      <div id="tripBody" class="small"></div>
    </div>
  </div>
</div>

<script>
const i18n = {
  hu:{
    title:"Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë",
    ukt:"UK id≈ë",
    refresh:"Friss√≠t√©s",
    tab_stop:"Meg√°ll√≥", tab_route:"Vonal",
    lbl_stop:"Meg√°ll√≥ n√©v", lbl_minutes:"Id≈ëablak (perc)", btn_search:"Keres√©s",
    lbl_hits_stop:"Tal√°latok ‚Äì v√°lassz meg√°ll√≥t",
    chosen_stop:"V√°lasztott meg√°ll√≥", auto20:"Friss√≠t√©s 20 mp-enk√©nt",
    col_route:"J√°rat", col_dest:"C√©l", col_dep:"Indul√°s",
    cache_on:"Cache-bypass akt√≠v",
    lbl_route:"Vonal sz√°ma", lbl_hits_route:"Tal√°latok ‚Äì v√°lassz vonalat",
    no_veh_hint:"Ha nincs √©l≈ë j√°rm≈±, a t√©rk√©p √ºres marad.",
    live_cfg_hint:"√âl≈ë feed be√°ll√≠t√°sa:", live_cfg_hint2:"a BODS URL-t (api_key-kel) POST-olhatod.",
    trip_title:"J√°rat r√©szletei", close:"Bez√°r",
    no_data:"Nincs adat erre az id≈ëablakra.", loading:"Bet√∂lt√©s‚Ä¶", err:"Hiba t√∂rt√©nt.",
    no_trip:"Nincs r√©szlet ehhez a j√°rathoz."
  },
  en:{
    title:"Bluestar Bus ‚Äì stop & route finder",
    ukt:"UK time",
    refresh:"Refresh",
    tab_stop:"Stop", tab_route:"Route",
    lbl_stop:"Stop name", lbl_minutes:"Window (min)", btn_search:"Search",
    lbl_hits_stop:"Results ‚Äì choose a stop",
    chosen_stop:"Selected stop", auto20:"Refresh every 20 s",
    col_route:"Route", col_dest:"Destination", col_dep:"Departure",
    cache_on:"Cache-bypass active",
    lbl_route:"Route number", lbl_hits_route:"Results ‚Äì choose a route",
    no_veh_hint:"If there is no live vehicle, the map will be empty.",
    live_cfg_hint:"Set live feed:", live_cfg_hint2:"POST the BODS URL (with api_key).",
    trip_title:"Trip details", close:"Close",
    no_data:"No data in this window.", loading:"Loading‚Ä¶", err:"Something went wrong.",
    no_trip:"No details for this trip."
  },
  de:{
    title:"Bluestar Bus ‚Äì Haltestellen- & Linien-Suche",
    ukt:"UK-Zeit",
    refresh:"Aktualisierung",
    tab_stop:"Haltestelle", tab_route:"Linie",
    lbl_stop:"Haltestellenname", lbl_minutes:"Zeitfenster (Min.)", btn_search:"Suchen",
    lbl_hits_stop:"Treffer ‚Äì w√§hle eine Haltestelle",
    chosen_stop:"Gew√§hlte Haltestelle", auto20:"Alle 20 s aktualisieren",
    col_route:"Linie", col_dest:"Ziel", col_dep:"Abfahrt",
    cache_on:"Cache-Bypass aktiv",
    lbl_route:"Liniennummer", lbl_hits_route:"Treffer ‚Äì w√§hle eine Linie",
    no_veh_hint:"Wenn kein Live-Fahrzeug vorhanden ist, bleibt die Karte leer.",
    live_cfg_hint:"Live-Feed einstellen:", live_cfg_hint2:"BODS-URL (mit api_key) per POST senden.",
    trip_title:"Fahrtdetails", close:"Schlie√üen",
    no_data:"Keine Daten in diesem Zeitfenster.", loading:"Laden‚Ä¶", err:"Fehler ist aufgetreten.",
    no_trip:"Keine Details f√ºr diese Fahrt."
  }
};

const state = {
  stopId:null, minutes:60, route:null, map:null, markers:[],
  lastUpdate:null, active:"stop",
  lang: localStorage.getItem('lang') || 'hu'
}
const qs = s=>document.querySelector(s);

// ---------- i18n ----------
function applyI18n(){
  const dict = i18n[state.lang] || i18n.hu;
  document.title = dict.title;
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const k = el.getAttribute('data-i18n');
    if(dict[k]) el.textContent = dict[k];
  });
}
document.getElementById('langSel').onchange = (e)=>{
  state.lang = e.target.value; localStorage.setItem('lang', state.lang);
  applyI18n();
};

// ---------- helpers ----------
function setTick(txt){ qs('#tick').textContent = txt; }
function two(n){return String(n).padStart(2,'0');}
function fmt24(h,m){return `${two(h)}:${two(m)}`;}
function minsUntil(hhmm){
  const [h,m]=hhmm.split(':').map(x=>parseInt(x));
  const now=new Date();
  // UK id≈ëh√∂z igazod√≥ diff ‚Äì csak kijelz√©shez kell
  const nowMin=now.getHours()*60+now.getMinutes();
  let dep=h*60+m; let d=(dep-nowMin)%(24*60); if(d<0)d+=24*60; return d;
}

// UK √≥ra
function startUkClock(){
  function tick(){
    const now = new Date();
    // Felt√©telezz√ºk, hogy a kliens idej√©t haszn√°ljuk UK mutat√°shoz is.
    const hh = two(now.getHours()), mm=two(now.getMinutes()), ss=two(now.getSeconds());
    qs('#ukclock').textContent = `${hh}:${mm}:${ss}`;
  }
  tick(); setInterval(tick, 1000);
}

// tabs
qs('#tabStop').onclick = ()=>{ state.active='stop'; qs('#tabStop').classList.add('active'); qs('#tabRoute').classList.remove('active'); qs('#cardStop').style.display='block'; qs('#cardRoute').style.display='none'; }
qs('#tabRoute').onclick= ()=>{ state.active='route'; qs('#tabRoute').classList.add('active'); qs('#tabStop').classList.remove('active'); qs('#cardStop').style.display='none'; qs('#cardRoute').style.display='block'; if(!state.map) initMap(); }

async function api(path){
  const u = `${path}${path.includes('?')?'&':'?'}_=${Date.now()}`;
  const r = await fetch(u, {headers:{'Cache-Control':'no-cache'}});
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

async function boot(){
  // autodetect alap√©rtelmezett nyelv
  if(!localStorage.getItem('lang')){
    const navLang = navigator.language?.toLowerCase() || '';
    if(navLang.startsWith('hu')) state.lang = 'hu';
    else if(navLang.startsWith('de')) state.lang = 'de';
    else state.lang = 'en';
    localStorage.setItem('lang', state.lang);
  } else {
    state.lang = localStorage.getItem('lang');
  }
  document.getElementById('langSel').value = state.lang;
  applyI18n();
  startUkClock();

  try{
    const st = await api('/api/status');
    qs('#build').textContent = st.build;
  }catch{}
}
boot();

// ------------ STOP ------------
qs('#btnStop').onclick = async ()=>{
  const q = qs('#qStop').value.trim();
  state.minutes = Math.max(5, Math.min(240, parseInt(qs('#minutes').value||'60')));
  if(!q) return;
  const hits = await api(`/api/stops/search?q=${encodeURIComponent(q)}`);
  const sel = qs('#selStops'); sel.innerHTML = '';
  hits.forEach((s,i)=>{
    const o=document.createElement('option');
    o.value = s.stop_id; o.textContent = `${s.stop_name} (${s.stop_id})`;
    sel.appendChild(o);
  });
  if(hits.length){ sel.selectedIndex=0; state.stopId=hits[0].stop_id; qs('#selStopLbl').textContent = hits[0].stop_id; refreshStop(); }
};

qs('#selStops').onchange = (e)=>{ state.stopId = e.target.value; qs('#selStopLbl').textContent = state.stopId; refreshStop(); }

function fmtRow(it){
  const due = minsUntil(it.time) <= 1;
  let when = due ? `<span class="due">Due</span>` : `<span class="time">${it.time}</span>`;
  // Ha a szerver k√©s≈ëbb ETA-t adna (percben), azt itt el≈ër√©bb venn√©nk
  if(typeof it.eta_min === 'number'){
    if(it.eta_min<=1) when = `<span class="due">Due</span>`;
    else when = `<span class="time">${it.eta_min} min</span>`;
  }
  return `<div class="tr" data-trip="${it.trip_id||''}">
    <div class="pill">${it.route||'‚Äì'}</div>
    <div>${it.destination||'‚Äì'}</div>
    <div>${when}</div>
  </div>`;
}

function renderRows(list){
  const dict=i18n[state.lang];
  const seen=new Set(); const uniq=[];
  for(const it of list||[]){
    const k=`${it.route}|${it.destination}|${it.time}`;
    if(seen.has(k)) continue; seen.add(k); uniq.push(it);
  }
  const el=qs('#rows');
  if(!uniq.length){ el.innerHTML=`<div class="muted" style="padding:10px 4px">${dict.no_data}</div>`; return; }
  el.innerHTML = uniq.map(fmtRow).join("");
  [...el.querySelectorAll(".tr")].forEach(row=>{
    const tid=row.dataset.trip;
    if(tid) row.addEventListener("click",()=>showTrip(tid));
  });
}

async function refreshStop(){
  if(!state.stopId) return;
  const items = await api(`/api/stops/${encodeURIComponent(state.stopId)}/next_departures?minutes=${state.minutes}&live=true`);
  // Normaliz√°lt 24h kijelz√©s (ha a backend m√°r √≠gy k√ºldi, ez csak pass-through)
  items.forEach(it=>{
    if(it.time && /^\d{1,2}:\d{2}$/.test(it.time)){
      const [h,m]=it.time.split(':').map(Number);
      it.time = fmt24(h%24,m%60);
    }
  });
  renderRows(items);
  state.lastUpdate=new Date();
}

function startTicker(){
  let t=20;
  setInterval(async ()=>{
    if(state.active==='stop' && state.stopId){ if(--t<=0){ await refreshStop(); t=20; } setTick(`${t}s`); }
    else if(state.active==='route' && state.route){ if(--t<=0){ await refreshRoute(); t=20; } setTick(`${t}s`); }
    else setTick('‚Äì');
  },1000);
}
startTicker();

// ------------ ROUTE ------------
function initMap(){
  state.map=L.map('map').setView([50.909, -1.404], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(state.map);
}
qs('#btnRoute').onclick = async ()=>{
  const q = qs('#qRoute').value.trim();
  if(!q) return;
  const hits = await api(`/api/routes/search?q=${encodeURIComponent(q)}`);
  const sel = qs('#selRoute'); sel.innerHTML='';
  if(!hits.length){ const o=document.createElement('option'); o.textContent='‚Äî'; sel.appendChild(o); return; }
  hits.forEach((r,i)=>{ const o=document.createElement('option'); o.value=r.route; o.textContent=r.route; sel.appendChild(o); });
  sel.selectedIndex=0; state.route=hits[0].route; refreshRoute();
};
qs('#selRoute').onchange=(e)=>{ state.route=e.target.value; refreshRoute(); }

function clearMarkers(){ state.markers.forEach(m=>state.map.removeLayer(m)); state.markers=[]; }
function renderRouteList(vs){
  const dict=i18n[state.lang];
  const el = document.getElementById("vehList");
  if(!vs || !vs.length){ el.innerHTML = `<span class="muted">${dict.no_veh_hint}</span>`; return; }
  const rows = vs
    .sort((a,b)=>String(a.reg||"").localeCompare(String(b.reg||"")))
    .map(v=>`<div style="padding:6px 0;border-bottom:1px solid #222845">
      <b>${v.reg||"‚Äì"}</b>
      ${v.trip_id?` ¬∑ trip: <span class="muted">${v.trip_id}</span>`:""}
      ${v.bearing!=null?` ¬∑ bearing: <span class="muted">${v.bearing}</span>`:""}
    </div>`).join("");
  el.innerHTML = rows;
}

async function refreshRoute(){
  if(!state.route) return;
  const vs = await api(`/api/routes/${encodeURIComponent(state.route)}/vehicles`);
  clearMarkers();
  const seen = new Set();
  const list=[];
  vs.forEach(v=>{
    const key = `${v.reg||""}|${v.trip_id||""}`; if(seen.has(key)) return; seen.add(key);
    list.push(v);
    const icon = L.divIcon({className:'', html:`<div style="background:#2a4bff;color:#fff;border-radius:6px;padding:2px 5px;font-weight:800">${state.route}</div>`});
    const m=L.marker([v.lat,v.lon],{icon}).addTo(state.map);
    m.bindPopup(`<b>${state.route}</b><br>${v.reg||""}${v.trip_id?`<br>trip: ${v.trip_id}`:""}${v.dest?`<br>${v.dest}`:""}`);
    state.markers.push(m);
  });
  if(list.length){
    const lat=list[0].lat, lon=list[0].lon;
    state.map.setView([lat,lon], 12);
  }
  renderRouteList(list);
  state.lastUpdate=new Date();
}

// ------------ TRIP MODAL ------------
function showTrip(tid){
  const dict=i18n[state.lang];
  qs('#tripIdLbl').textContent = tid;
  qs('#tripBody').innerHTML = `<div class="muted">${dict.loading}</div>`;
  qs('#tripModal').style.display='flex';
  api(`/api/trips/${encodeURIComponent(tid)}`).then(d=>{
    if(!d || !d.calls || !d.calls.length){ qs('#tripBody').innerHTML = `<div class="muted">${dict.no_trip}</div>`; return; }
    const nowMin = new Date().getHours()*60 + new Date().getMinutes();
    const rows = d.calls.map(c=>{
      let hhmm = c.time || '';
      if(hhmm && /^\d{1,2}:\d{2}$/.test(hhmm)){
        const [h,m]=hhmm.split(':').map(Number); hhmm = fmt24(h%24,m%60);
      }
      const dep = (()=>{ if(!c.time) return 0; const [h,m]=c.time.split(':').map(Number); return (h%24)*60+(m%60); })();
      const past = ((dep - nowMin + 1440) % 1440) > 1000; // primit√≠v megk√ºl√∂nb√∂ztet√©s
      const color = past ? '#7f8799' : (typeof c.eta_min==='number' ? '#18c27e' : '#eaf0ff');
      return `<div style="display:flex;gap:10px;padding:8px 0;border-bottom:1px solid #222845;color:${color}">
        <div style="width:80px;font-weight:700">${hhmm||''}</div>
        <div>${c.stop_name||c.stop_id}</div>
      </div>`;
    }).join("");
    qs('#tripBody').innerHTML = rows;
  }).catch(()=>{ qs('#tripBody').innerHTML = `<div class="muted">${dict.err}</div>`; })
}
function hideTrip(){ qs('#tripModal').style.display='none'; }

</script>
</body>
</html>
