<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bluestar menetrend √©s meg√°ll√≥ keres≈ë</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ctext y='50' font-size='48'%3E%F0%9F%9A%8C%3C/text%3E%3C/svg%3E">
<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  :root{
    --bg:#0c1220; --card:#11192c; --muted:#8a94b8; --text:#e9ecff;
    --primary:#a9adff; --chip:#2a3350; --ok:#27d17f; --danger:#f06272;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,Helvetica,sans-serif;background:linear-gradient(180deg,#0b1220,#0a0f1b);color:var(--text)}
  .container{max-width:1000px;margin:0 auto;padding:16px}
  header{display:flex;align-items:center;gap:12px}
  h1{margin:.2rem 0;font-size:1.6rem;font-weight:700}
  .clock{color:var(--muted);margin-top:2px}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .card{background:var(--card);border-radius:14px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
  .tabs{display:flex;gap:12px;margin:12px 0}
  .tab{padding:10px 16px;border-radius:12px;background:#0e1526;color:#b9c1e8;border:1px solid #1c2642;cursor:pointer}
  .tab.active{background:var(--chip);color:#fff}
  .input{background:#0f1730;border:1px solid #1f2a4d;color:#fff;padding:14px;border-radius:12px;width:100%}
  .btn{background:var(--primary);color:#101424;border:0;border-radius:12px;padding:12px 18px;font-weight:700;cursor:pointer}
  .btn.icon{display:inline-flex;align-items:center;gap:8px}
  .chip{display:inline-flex;align-items:center;justify-content:center;min-width:46px;padding:8px 12px;border-radius:12px;background:var(--chip);color:#cfe0ff;margin:4px 6px 0 0}
  .list{display:grid;gap:12px}
  .row-item{display:flex;gap:12px;align-items:center;justify-content:space-between;background:#0e1526;border:1px solid #1c2642;border-radius:14px;padding:12px 12px}
  .pill{width:56px;min-width:56px;height:56px;border-radius:14px;background:#233056;display:flex;align-items:center;justify-content:center;font-weight:900}
  .meta{color:#a7b0d7;font-size:.9rem}
  .fav{border:1px solid #2f3a63;background:#182248;color:#cfd7ff;border-radius:12px;padding:10px 12px;cursor:pointer}
  .success{color:var(--ok)} .error{color:var(--danger)}
  .time-live{color:var(--ok);font-weight:800}
  .time-sched{color:#fff;opacity:.95}
  .due{color:var(--ok);animation:blink 1s linear infinite}
  @keyframes blink { 0%,50%{opacity:1} 51%,100%{opacity:.2} }
  /* modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:50}
  .modal.show{display:flex}
  .modal-card{background:var(--card);padding:18px;border-radius:16px;max-width:520px;width:92vw}
  /* map */
  #map{height:340px;border-radius:14px;overflow:hidden}
  .section-title{font-weight:800;margin:8px 0 6px}
  .flags button{background:#0e1526;border:1px solid #1c2642;border-radius:10px;padding:6px 8px;cursor:pointer}
  small.muted{color:var(--muted)}
</style>
</head>
<body>
  <div class="container">
    <header class="row">
      <div style="font-size:1.6rem">üöå</div>
      <div>
        <h1 id="title">Bluestar menetrend √©s meg√°ll√≥ keres≈ë</h1>
        <div class="clock" id="clock">UK: --:--:--</div>
      </div>
      <div style="margin-left:auto" class="row">
        <div class="flags row" aria-label="Language">
          <!-- flags with BCP-47 tag in data-lang -->
          <button data-lang="en">üá¨üáß</button>
          <button data-lang="hu">üá≠üá∫</button>
          <button data-lang="de">üá©üá™</button>
          <button data-lang="fr">üá´üá∑</button>
          <button data-lang="ro">üá∑üá¥</button>
        </div>
        <button id="btnSettings" class="btn icon" title="Be√°ll√≠t√°sok">‚öôÔ∏è <span data-i18n="settings">Be√°ll√≠t√°sok</span></button>
      </div>
    </header>

    <div class="tabs">
      <button id="tabStop" class="tab active" data-i18n="tab_stop">Meg√°ll√≥</button>
      <button id="tabRoute" class="tab" data-i18n="tab_route">Viszonylat</button>
      <button id="tabFav" class="tab" data-i18n="tab_fav">Kedvencek</button>
    </div>

    <!-- STOP TAB -->
    <section id="viewStop" class="card">
      <div class="row" style="gap:10px">
        <input id="stopQuery" class="input" placeholder="Shirley, Vincent, ..." />
        <button id="btnSearchStop" class="btn" data-i18n="search">Keres√©s</button>
      </div>
      <h3 class="section-title" data-i18n="key_changes">Kiemelt forgalmi v√°ltoz√°sok</h3>
      <div id="chipsLines" class="row"></div>

      <h3 class="section-title" data-i18n="results">Tal√°latok</h3>
      <div id="stopResults" class="list"></div>

      <div id="selectedStopBox" style="display:none;margin-top:14px" class="meta"></div>

      <div id="depsBox" style="display:none;margin-top:14px">
        <div id="depsList" class="list"></div>
        <small class="muted" id="refreshMeta"></small>
      </div>
    </section>

    <!-- ROUTE TAB -->
    <section id="viewRoute" class="card" style="display:none">
      <div class="row" style="gap:10px">
        <input id="routeQuery" class="input" placeholder="9, 18, X4, ..." />
        <button id="btnSearchRoute" class="btn" data-i18n="search">Keres√©s</button>
      </div>
      <div id="routeResults" class="list" style="margin-top:8px"></div>
      <div id="tripBox" style="display:none;margin-top:12px">
        <div id="map" class="card"></div>
        <h3 class="section-title" data-i18n="full_trip">Teljes j√°rat</h3>
        <div id="tripStops" class="list"></div>
      </div>
    </section>

    <!-- FAV TAB -->
    <section id="viewFav" class="card" style="display:none">
      <div id="favList" class="list"></div>
      <small class="muted" data-i18n="fav_hint">A megnyitott meg√°ll√≥kat/viszonylatokat itt tal√°lod √∫jra.</small>
    </section>
  </div>

  <!-- SETTINGS MODAL -->
  <div id="modal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card">
      <h3 style="margin:0 0 12px" data-i18n="settings">Be√°ll√≠t√°sok</h3>
      <div style="display:grid;gap:8px">
        <label><small data-i18n="api_base">API el√©r√©si √∫t (√ºres = ugyanarr√≥l a domainr≈ël)</small>
          <input id="cfgBase" class="input" placeholder="/api">
        </label>
        <label><small data-i18n="refresh">Friss√≠t√©si id≈ë (mp)</small>
          <input id="cfgRefresh" type="number" min="5" max="60" step="1" class="input">
        </label>
        <label><small data-i18n="preview">El≈ëretekint√©si ablak (perc)</small>
          <input id="cfgPreview" type="number" min="10" max="180" step="5" class="input">
        </label>
      </div>
      <div class="row" style="margin-top:12px;justify-content:flex-end">
        <button id="btnClose" class="fav" data-i18n="cancel">M√©gse</button>
        <button id="btnSave" class="btn" data-i18n="save">Ment√©s</button>
      </div>
    </div>
  </div>

<script>
/*** i18n ***/
const I18N = {
  en:{title:"Bluestar timetable & stop finder",settings:"Settings",tab_stop:"Stop",tab_route:"Route",tab_fav:"Favourites",
      key_changes:"Key service changes",results:"Results",search:"Search",full_trip:"Full trip",api_base:"API base (empty = same domain)",refresh:"Refresh (s)",
      preview:"Preview window (min)",cancel:"Cancel",save:"Save",fav_hint:"Stops & routes you open will appear here.",open:"Open",delete:"Delete",added:"Added to favourites"},
  hu:{title:"Bluestar menetrend √©s meg√°ll√≥ keres≈ë",settings:"Be√°ll√≠t√°sok",tab_stop:"Meg√°ll√≥",tab_route:"Viszonylat",tab_fav:"Kedvencek",
      key_changes:"Kiemelt forgalmi v√°ltoz√°sok",results:"Tal√°latok",search:"Keres√©s",full_trip:"Teljes j√°rat",api_base:"API el√©r√©si √∫t (√ºres = ugyanarr√≥l a domainr≈ël)",
      refresh:"Friss√≠t√©si id≈ë (mp)",preview:"El≈ëretekint√©si ablak (perc)",cancel:"M√©gse",save:"Ment√©s",fav_hint:"A megnyitott meg√°ll√≥kat/viszonylatokat itt tal√°lod √∫jra.",open:"Megnyit",delete:"T√∂rl√©s",added:"Hozz√°adva a kedvencekhez"},
  de:{title:"Bluestar Fahrplan & Haltestellensuche",settings:"Einstellungen",tab_stop:"Haltestelle",tab_route:"Linie",tab_fav:"Favoriten",
      key_changes:"Wichtige √Ñnderungen",results:"Ergebnisse",search:"Suchen",full_trip:"Gesamte Fahrt",api_base:"API-Basis (leer = gleiche Domain)",refresh:"Aktualisierung (s)",
      preview:"Vorschaufenster (Min.)",cancel:"Abbrechen",save:"Speichern",fav_hint:"Ge√∂ffnete Haltestellen/Linien erscheinen hier.",open:"√ñffnen",delete:"L√∂schen",added:"Zu Favoriten hinzugef√ºgt"},
  fr:{title:"Bluestar ‚Äî horaires & arr√™ts",settings:"R√©glages",tab_stop:"Arr√™t",tab_route:"Ligne",tab_fav:"Favoris",
      key_changes:"Modifications importantes",results:"R√©sultats",search:"Rechercher",full_trip:"Trajet complet",api_base:"Base API (vide = m√™me domaine)",
      refresh:"Rafra√Æch. (s)",preview:"Fen√™tre d‚Äôanticipation (min)",cancel:"Annuler",save:"Enregistrer",fav_hint:"Arr√™ts & lignes ouverts apparaissent ici.",open:"Ouvrir",delete:"Supprimer",added:"Ajout√© aux favoris"},
  ro:{title:"Bluestar ‚Äì orar & cƒÉutare sta»õii",settings:"SetƒÉri",tab_stop:"Sta»õie",tab_route:"Linie",tab_fav:"Favorite",
      key_changes:"ModificƒÉri importante",results:"Rezultate",search:"CautƒÉ",full_trip:"Cursa completƒÉ",api_base:"Baza API (gol = acela»ôi domeniu)",
      refresh:"Re√ÆmprospƒÉtare (s)",preview:"FereastrƒÉ previz. (min)",cancel:"AnuleazƒÉ",save:"SalveazƒÉ",fav_hint:"Sta»õiile »ôi liniile deschise apar aici.",open:"Deschide",delete:"»òterge",added:"AdƒÉugat la favorite"},
};
let lang = localStorage.getItem("lang") || "hu";
function applyI18N(){
  const t=I18N[lang]||I18N.hu;
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const k=el.getAttribute("data-i18n"); if(t[k]) el.textContent=t[k];
  });
  document.getElementById("title").textContent=t.title;
}
document.querySelectorAll(".flags button").forEach(b=>b.addEventListener("click",()=>{
  lang=b.dataset.lang; localStorage.setItem("lang",lang); applyI18N();
}));

/*** config ***/
const cfg = {
  base: localStorage.getItem("api_base") || "", // pl. "" vagy "/api"
  refresh: Number(localStorage.getItem("refresh")||10),
  preview: Number(localStorage.getItem("preview")||60),
};
function api(path){ return (cfg.base || "") + path; }

/*** UI refs ***/
const modal=document.getElementById("modal");
const stopQuery=document.getElementById("stopQuery");
const stopResults=document.getElementById("stopResults");
const selectedStopBox=document.getElementById("selectedStopBox");
const depsBox=document.getElementById("depsBox");
const depsList=document.getElementById("depsList");
const refreshMeta=document.getElementById("refreshMeta");
const chipsLines=document.getElementById("chipsLines");
const routeQuery=document.getElementById("routeQuery");
const routeResults=document.getElementById("routeResults");
const tripBox=document.getElementById("tripBox");
const tripStops=document.getElementById("tripStops");
let map, routeLayer, vehiclesLayer;

/*** tabs ***/
function showTab(tab){
  document.getElementById("tabStop").classList.toggle("active",tab==="stop");
  document.getElementById("tabRoute").classList.toggle("active",tab==="route");
  document.getElementById("tabFav").classList.toggle("active",tab==="fav");
  document.getElementById("viewStop").style.display = tab==="stop"?"block":"none";
  document.getElementById("viewRoute").style.display = tab==="route"?"block":"none";
  document.getElementById("viewFav").style.display = tab==="fav"?"block":"none";
  if(tab==="fav") renderFavs();
}
document.getElementById("tabStop").onclick=()=>showTab("stop");
document.getElementById("tabRoute").onclick=()=>showTab("route");
document.getElementById("tabFav").onclick=()=>showTab("fav");

/*** settings modal ***/
document.getElementById("btnSettings").onclick=()=>{
  document.getElementById("cfgBase").value = cfg.base;
  document.getElementById("cfgRefresh").value = cfg.refresh;
  document.getElementById("cfgPreview").value = cfg.preview;
  modal.classList.add("show");
};
document.getElementById("btnClose").onclick=()=>modal.classList.remove("show");
document.getElementById("btnSave").onclick=()=>{
  cfg.base=document.getElementById("cfgBase").value.trim();
  cfg.refresh=Number(document.getElementById("cfgRefresh").value||10);
  cfg.preview=Number(document.getElementById("cfgPreview").value||60);
  localStorage.setItem("api_base",cfg.base);
  localStorage.setItem("refresh",cfg.refresh);
  localStorage.setItem("preview",cfg.preview);
  modal.classList.remove("show");
};

/*** clock & status ***/
async function tick(){
  try{
    const r=await fetch(api("/api/status"));
    const s=await r.json();
    document.getElementById("clock").textContent = "UK: "+s.time;
  }catch{ /* ignore */ }
}
setInterval(tick, 10000); tick();

/*** key lines chips (demo) ***/
["18","19","1","7","U1","X4"].forEach(n=>{
  const c=document.createElement("div"); c.className="chip"; c.textContent=n; chipsLines.appendChild(c);
});

/*** favourites ***/
function addFav(item){ // {type:"stop"/"route", id, title}
  const arr=JSON.parse(localStorage.getItem("favs")||"[]");
  const has=arr.find(x=>x.type===item.type && x.id===item.id);
  if(!has){ arr.push(item); localStorage.setItem("favs",JSON.stringify(arr)); toast(I18N[lang].added||"Added"); }
  renderFavs();
}
function delFav(idx){ const arr=JSON.parse(localStorage.getItem("favs")||"[]"); arr.splice(idx,1); localStorage.setItem("favs",JSON.stringify(arr)); renderFavs(); }
function renderFavs(){
  const arr=JSON.parse(localStorage.getItem("favs")||"[]");
  const list=document.getElementById("favList"); list.innerHTML="";
  if(!arr.length){ list.innerHTML="<small class='muted'>‚Äî</small>"; return; }
  arr.forEach((f,i)=>{
    const row=document.createElement("div"); row.className="row-item";
    row.innerHTML=`<div><div style="font-weight:800">${f.title}</div><div class='meta'>${f.type.toUpperCase()} ‚Äì ${f.id}</div></div>
                   <div class="row">
                     <button class="btn">${I18N[lang].open}</button>
                     <button class="fav">${I18N[lang].delete}</button>
                   </div>`;
    row.querySelector(".btn").onclick=()=>{
      if(f.type==="stop"){ openStop(f.id, f.title); showTab("stop"); }
      if(f.type==="route"){ routeQuery.value=f.title; searchRoute(); showTab("route"); }
    };
    row.querySelector(".fav").onclick=()=>delFav(i);
    list.appendChild(row);
  });
}

/*** toast (simple) ***/
function toast(text){
  const d=document.createElement("div");
  d.textContent=text;
  d.style.cssText="position:fixed;left:16px;right:16px;bottom:16px;background:#2a0f12;color:#ffdede;padding:12px;border-radius:12px;z-index:60";
  document.body.appendChild(d); setTimeout(()=>d.remove(),2500);
}

/*** STOP SEARCH ***/
document.getElementById("btnSearchStop").onclick=searchStop;
stopQuery.addEventListener("keydown",(e)=>{ if(e.key==="Enter") searchStop(); });

async function searchStop(){
  const q=stopQuery.value.trim(); stopResults.innerHTML="";
  if(q.length<2){ return; }
  try{
    const r=await fetch(api(`/api/live/stop-search?q=${encodeURIComponent(q)}`)); 
    if(!r.ok) throw 0; const items=await r.json();
    if(!items.length){ stopResults.innerHTML="<small class='muted'>‚Äî</small>"; return; }
    items.forEach(it=>{
      const row=document.createElement("div"); row.className="row-item";
      row.innerHTML=`
        <div class="row" style="gap:12px;align-items:center">
          <div class="pill">BUS</div>
          <div><div style="font-weight:800">${it.name}</div><div class="meta">ID: ${it.id}</div></div>
        </div>
        <div class="row">
          <button class="fav" title="‚≠ê" aria-label="Fav">‚≠ê</button>
          <button class="btn">${I18N[lang].open}</button>
        </div>`;
      row.querySelector(".btn").onclick=()=>openStop(it.id, it.name);
      row.querySelector(".fav").onclick=()=>addFav({type:"stop",id:it.id,title:it.name});
      stopResults.appendChild(row);
    });
  }catch(e){ toast("Stop search failed."); }
}

let depsTimer=null, currentStop=null;
async function openStop(id, name){
  currentStop=id;
  selectedStopBox.style.display="block";
  selectedStopBox.textContent = (I18N[lang].results||"Results")+": "+name+" ‚Äî "+`refresh every ${cfg.refresh}s`;
  depsBox.style.display="block";
  if(depsTimer) clearInterval(depsTimer);
  const run=async()=>{ await loadDepartures(id); }
  await run();
  depsTimer=setInterval(run, cfg.refresh*1000);
}

async function loadDepartures(stopId){
  try{
    const r=await fetch(api(`/api/live/departures?stopId=${encodeURIComponent(stopId)}&minutes=${cfg.preview}`));
    const arr=await r.json();
    depsList.innerHTML="";
    arr.forEach(d=>{
      const row=document.createElement("div"); row.className="row-item";
      const dueClass=d.due ? "due" : (d.live?"time-live":"time-sched");
      const timeLabel = d.due ? "Due" : d.time;
      row.innerHTML = `
        <div class="row" style="gap:12px;align-items:center">
          <div class="pill">${d.route||"‚Äì"}</div>
          <div><div style="font-weight:800">${d.headsign||""}</div><div class="meta">trip: ${d.trip_id}</div></div>
        </div>
        <div style="text-align:right">
          <div class="${dueClass}" style="font-size:1.2rem">${timeLabel}</div>
          <button class="fav" style="margin-top:6px">Trip</button>
        </div>`;
      row.querySelector(".fav").onclick=()=>openTrip(d.trip_id, d.route, d.headsign);
      depsList.appendChild(row);
    });
    refreshMeta.textContent = `Friss√≠t√©s: ${cfg.refresh} s ‚Ä¢ Build: ${Math.floor(Date.now()/1000)}`;
  }catch{ depsList.innerHTML=""; toast("Indul√°sok hiba."); }
}

/*** ROUTE SEARCH + TRIP VIEW + MAP ***/
document.getElementById("btnSearchRoute").onclick=searchRoute;
routeQuery.addEventListener("keydown",(e)=>{ if(e.key==="Enter") searchRoute(); });

async function searchRoute(){
  const q=routeQuery.value.trim(); routeResults.innerHTML="";
  if(q.length<1) return;
  try{
    const r=await fetch(api(`/api/route/search?q=${encodeURIComponent(q)}`));
    const items=await r.json();
    items.forEach(it=>{
      const row=document.createElement("div"); row.className="row-item";
      const title=(it.short_name||"")+ (it.long_name?` ‚Äî ${it.long_name}`:"");
      row.innerHTML=`<div class="row"><div class="pill">${it.short_name||"?"}</div><div style="font-weight:800">${title}</div></div>
                     <div class="row"><button class="fav">‚≠ê</button><button class="btn">${I18N[lang].open}</button></div>`;
      row.querySelector(".fav").onclick=()=>addFav({type:"route",id:it.route_id,title:title});
      row.querySelector(".btn").onclick=()=>{ addFav({type:"route",id:it.route_id,title:title}); };
      routeResults.appendChild(row);
    });
  }catch{ toast("Route search failed."); }
}

async function openTrip(trip_id, routeShort, headsign){
  showTab("route");
  tripBox.style.display="block";
  tripStops.innerHTML="";
  // trip stops
  try{
    const r=await fetch(api(`/api/route/trip?trip_id=${encodeURIComponent(trip_id)}`));
    const t=await r.json();
    t.stops.forEach(s=>{
      const row=document.createElement("div"); row.className="row-item";
      row.innerHTML=`<div>${s.stop_name}</div><div class="meta">${s.time||""}</div>`;
      tripStops.appendChild(row);
    });
  }catch{ toast("Trip load failed."); }
  // map init
  if(!map){
    map=L.map("map"); 
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"¬© OSM"}).addTo(map);
    routeLayer=L.polyline([], {weight:5}).addTo(map);
    vehiclesLayer=L.layerGroup().addTo(map);
  }
  // shape
  try{
    const r=await fetch(api(`/api/route/shape?trip_id=${encodeURIComponent(trip_id)}`));
    const sh=await r.json();
    if(sh.coordinates && sh.coordinates.length){
      routeLayer.setLatLngs(sh.coordinates);
      map.fitBounds(routeLayer.getBounds(), {padding:[20,20]});
    }
  }catch{}
  // live vehicles polling
  if(window.__vehTimer) clearInterval(window.__vehTimer);
  const poll = async ()=>{
    try{
      const rr=await fetch(api(`/api/live/vehicles`)); // opcion√°lisan route_id-t is k√ºldhetsz
      const vs=await rr.json();
      vehiclesLayer.clearLayers();
      vs.forEach(v=>{
        const m=L.circleMarker([v.lat,v.lon],{radius:6, color:"#27d17f"}).addTo(vehiclesLayer);
        m.bindPopup(`<b>${v.route||""}</b> ${v.id}<br><small>${v.updated||""}</small>`);
      });
    }catch{}
  };
  await poll();
  window.__vehTimer=setInterval(poll, cfg.refresh*1000);
}

/*** small helpers ***/
function bindEnterToButton(input, button){
  input.addEventListener("keydown", e=>{ if(e.key==="Enter") button.click(); });
}
bindEnterToButton(stopQuery, document.getElementById("btnSearchStop"));
bindEnterToButton(routeQuery, document.getElementById("btnSearchRoute"));

/*** boot ***/
applyI18N();
renderFavs();
</script>
</body>
</html>
