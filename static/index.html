<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë</title>

  <!-- Leaflet (vonal t√©rk√©phez) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#0f1320; --card:#151a2c; --muted:#8ea2c0; --text:#e8eefc;
      --accent:#6ea8fe; --ok:#44d17a; --bad:#ff5d6c; --btn:#6a76ff;
      --chip:#23304d; --chip-b:#3b4c74;
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
    h1{font-size:2rem;margin:0 0 16px}
    .card{background:var(--card);border-radius:14px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    label{display:block;font-size:.9rem;color:var(--muted);margin:4px 0}
    input,select,button{font:inherit}
    input[type="text"],input[type="number"],select{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #2b3553;background:#0f1526;color:var(--text);outline:none}
    button{background:var(--btn);border:0;color:#fff;padding:12px 18px;border-radius:12px;font-weight:600;cursor:pointer}
    button:disabled{opacity:.5;cursor:not-allowed}
    .tabs{display:flex;gap:10px;margin:0 0 12px}
    .tab{padding:8px 12px;border-radius:999px;background:var(--chip);color:var(--muted);cursor:pointer;user-select:none}
    .tab.active{background:var(--chip-b);color:var(--text)}
    .status{display:flex;gap:10px;align-items:center;margin-top:8px}
    .dot{width:10px;height:10px;border-radius:50%;background:#777}
    .dot.ok{background:var(--ok)} .dot.bad{background:var(--bad)}
    .list{margin-top:12px;border-radius:12px;overflow:auto;border:1px solid #2b3553}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px;border-bottom:1px solid #2b3553;text-align:left}
    th{color:var(--muted);font-weight:600;background:#111833;position:sticky;top:0}
    tr:hover{background:#111a36}
    .route-badge{display:inline-block;min-width:36px;text-align:center;border-radius:999px;padding:2px 8px;background:#1e2a3a}
    .muted{color:var(--muted)}
    .sub{font-size:.9rem;color:var(--muted)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal .content{background:var(--card);width:min(720px,96vw);max-height:90vh;overflow:auto;border-radius:14px;padding:16px}
    .modal h3{margin:0 0 8px}
    .modal .close{float:right;cursor:pointer;color:var(--muted)}
    #routeMap{width:100%;height:360px;border-radius:14px;overflow:hidden;margin:10px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üöå Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë <span id="liveDot" class="dot" title="Live"></span></h1>

    <div class="card">
      <div class="tabs">
        <div class="tab active" data-tab="stops">Meg√°ll√≥</div>
        <div class="tab" data-tab="routes">Vonal</div>
      </div>

      <!-- Meg√°ll√≥ f√ºl -->
      <div id="tab-stops">
        <div class="row">
          <div style="flex:2">
            <label>Meg√°ll√≥ n√©v</label>
            <input id="qStop" type="text" placeholder="Pl. Vincent‚Ä¶" autocomplete="off">
          </div>
          <div style="flex:1;min-width:140px">
            <label>Id≈ëablak (perc)</label>
            <input id="win" type="number" value="60" min="5" max="240">
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="btnSearchStop">Keres√©s</button>
          </div>
        </div>

        <div id="stopSelectWrap" style="margin-top:10px;display:none">
          <label>Tal√°latok ‚Äì v√°lassz meg√°ll√≥t</label>
          <select id="stopSelect"></select>
        </div>

        <div class="status">
          <div><span id="dot-api" class="dot"></span> <span class="muted">API</span></div>
          <div><span id="dot-gtfs" class="dot"></span> <span class="muted">GTFS</span></div>
          <div><span id="dot-live" class="dot"></span> <span class="muted">Live</span></div>
          <div class="sub" style="margin-left:auto">V√°lasztott meg√°ll√≥: <span id="chosenStop" class="muted">‚Äì</span></div>
        </div>

        <div id="depWrap" class="list" style="display:none">
          <table>
            <thead><tr><th>J√°rat</th><th>C√©l</th><th>Indul√°s</th><th>√âl≈ë</th><th>Rendsz√°m</th><th></th></tr></thead>
            <tbody id="depBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Vonal f√ºl -->
      <div id="tab-routes" style="display:none">
        <div class="row">
          <div style="flex:2">
            <label>Vonal sz√°ma/n√©v</label>
            <input id="qRoute" type="text" placeholder="Pl. 18">
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="btnSearchRoute">Keres√©s</button>
          </div>
        </div>

        <div id="routeSelectWrap" style="margin-top:10px;display:none">
          <label>Tal√°latok ‚Äì v√°lassz vonalat</label>
          <select id="routeSelect"></select>
        </div>

        <div id="routeMap"></div>

        <div id="vehWrap" class="list" style="display:none">
          <table>
            <thead><tr><th>Rendsz√°m</th><th>T√≠pus</th><th>Ir√°ny</th><th>Poz√≠ci√≥</th><th>Meg√°ll√≥</th></tr></thead>
            <tbody id="vehBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="sub">Build: <span id="build">‚Äì</span> ¬∑ Cache-bypass akt√≠v</div>
    </div>
  </div>

  <!-- Trip modal -->
  <div class="modal" id="tripModal">
    <div class="content">
      <div class="close" id="closeTrip">‚úñ</div>
      <h3>J√°rat r√©szletek</h3>
      <div id="tripTitle" class="sub" style="margin-bottom:8px"></div>
      <div class="list">
        <table>
          <thead><tr><th>Id≈ë</th><th>Meg√°ll√≥</th><th>√âl≈ë</th></tr></thead>
          <tbody id="tripBody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
const qs=(s)=>document.querySelector(s);
const apiFetch=(url,opts={})=>{
  const sep=url.includes('?')?'&':'?';
  return fetch(url+sep+'ts='+Date.now(), {cache:'no-store',...opts});
};

// Tabs
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const name=t.dataset.tab;
    qs('#tab-stops').style.display=(name==='stops')?'block':'none';
    qs('#tab-routes').style.display=(name==='routes')?'block':'none';
  };
});

// Status
async function refreshStatus(){
  try{
    const s=await apiFetch('/api/status').then(r=>r.json());
    qs('#build').textContent=s.build||'‚Äì';
    qs('#liveDot').classList.toggle('ok', !!s.live);
    setDot('#dot-api', true);
    setDot('#dot-gtfs', !!s.gtfs);
    setDot('#dot-live', !!s.live);
  }catch{
    setDot('#dot-api', false); setDot('#dot-gtfs', false); setDot('#dot-live', false);
  }
}
function setDot(id, ok){ const el=qs(id); el.classList.remove('ok','bad'); el.classList.add(ok?'ok':'bad'); }
refreshStatus(); setInterval(refreshStatus, 10000);

// -------- Meg√°ll√≥ keres√©s --------
qs('#btnSearchStop').onclick = async ()=>{
  const q = qs('#qStop').value.trim();
  if(!q) return;
  const arr = await apiFetch('/api/stops/search?q='+encodeURIComponent(q)).then(r=>r.json());
  const sel = qs('#stopSelect');
  sel.innerHTML='';
  arr.forEach(s=>{
    const o=document.createElement('option');
    o.value=s.stop_id;
    o.textContent=`${s.stop_name} (${s.stop_id}${s.stop_code? ' ‚Ä¢ '+s.stop_code:''})`;
    sel.appendChild(o);
  });
  const has=arr.length>0;
  qs('#stopSelectWrap').style.display=has?'block':'none';
  qs('#chosenStop').textContent=has?arr[0].stop_id:'‚Äì';
  if(has){ sel.onchange=()=>{ qs('#chosenStop').textContent=sel.value; getDepartures(); }; await getDepartures(); }
};

async function getDepartures(){
  const id = qs('#stopSelect').value;
  const mins = Math.max(5, Math.min(240, parseInt(qs('#win').value||'60',10)));
  const rows = await apiFetch(`/api/stops/${encodeURIComponent(id)}/next_departures?minutes=${mins}&live=true`).then(r=>r.json());
  const tb = qs('#depBody');
  tb.innerHTML='';
  rows.forEach(d=>{
    const liveTxt = Number.isFinite(d.eta_min) ? `${d.eta_min}'`
                  : (Number.isFinite(d.delay_min) ? (d.delay_min>0?`+${d.delay_min}'`:`${d.delay_min}'`) : '‚Äì');
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td><span class="route-badge">${d.route||''}</span></td>
      <td>${escapeHtml(d.destination||'')}</td>
      <td>${d.time||''}</td>
      <td>${d.live?`<span class="dot ok" title="Live"></span> ${liveTxt}`:liveTxt}</td>
      <td>${d.vehicle_reg||'‚Äì'}</td>
      <td>${d.trip_id?`<button class="linklike" data-trip="${d.trip_id}">R√©szletek</button>`:'‚Äì'}</td>
    `;
    tr.querySelectorAll('button[data-trip]').forEach(b=>{
      b.onclick=()=>openTrip(d.trip_id, d.route, d.destination);
    });
    tb.appendChild(tr);
  });
  qs('#depWrap').style.display = rows.length?'block':'none';
}

function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

// -------- Trip modal --------
const tripModal=qs('#tripModal');
qs('#closeTrip').onclick=()=> tripModal.style.display='none';

async function openTrip(tripId, route, headsign){
  if(!tripId){ return; }
  tripModal.style.display='flex';
  qs('#tripTitle').textContent = `J√°rat ${route||''} ‚Äì ${headsign||''} (trip: ${tripId})`;
  qs('#tripBody').innerHTML = `<tr><td colspan="3" class="muted">Bet√∂lt√©s‚Ä¶</td></tr>`;
  const d = await apiFetch(`/api/trips/${encodeURIComponent(tripId)}`).then(r=>r.json());
  qs('#tripBody').innerHTML = (d.calls||[]).map(c=>`
    <tr><td>${c.time||''}</td><td>${escapeHtml(c.stop_name||c.stop_id||'')}</td><td>${Number.isFinite(c.eta_min)?`${c.eta_min}'`:'‚Äì'}</td></tr>
  `).join('') || `<tr><td colspan="3" class="muted">Nincs adat.</td></tr>`;
}

// -------- Vonal: keres√©s + j√°rm≈±vek + t√©rk√©p --------
let routeMap, routeMarkers=new Map(), routeTimer=null;

qs('#btnSearchRoute').onclick = async ()=>{
  const q = qs('#qRoute').value.trim();
  if(!q) return;
  const arr = await apiFetch('/api/routes/search?q='+encodeURIComponent(q)).then(r=>r.json());
  const sel = qs('#routeSelect');
  sel.innerHTML='';
  arr.forEach(o=>{
    const opt=document.createElement('option');
    opt.value=o.route; opt.textContent=o.route; sel.appendChild(opt);
  });
  const has = arr.length>0;
  qs('#routeSelectWrap').style.display = has?'block':'none';
  if(has){ sel.onchange=()=>loadRouteVehicles(); await loadRouteVehicles(); startRoutePolling(); }
};

function ensureRouteMap(){
  if(routeMap) return routeMap;
  routeMap = L.map('routeMap',{zoomControl:true,attributionControl:false}).setView([50.9097,-1.4043], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(routeMap);
  return routeMap;
}
function iconForBearing(b=0){
  return L.divIcon({className:'',html:`<div style="width:14px;height:14px;border-radius:50%;background:#7aa2ff;border:2px solid white;box-shadow:0 0 10px rgba(0,0,0,.4)"></div>`});
}

async function loadRouteVehicles(){
  ensureRouteMap();
  const route = qs('#routeSelect').value;
  const arr = await apiFetch(`/api/routes/${encodeURIComponent(route)}/vehicles`).then(r=>r.json());
  // t√°bl√°zat
  const tb = qs('#vehBody');
  tb.innerHTML = arr.map(v=>{
    const pos=(v.lat&&v.lon)?`${v.lat.toFixed(5)}, ${v.lon.toFixed(5)}`:'‚Äì';
    const dir=Number.isFinite(v.bearing)?`${Math.round(v.bearing)}¬∞`:'‚Äì';
    return `<tr><td>${escapeHtml(v.reg||'‚Äì')}</td><td>${escapeHtml(v.type||v.fleet_no||'‚Äì')}</td><td>${dir}</td><td>${pos}</td><td>${escapeHtml(v.stop_name||'')}</td></tr>`;
  }).join('') || `<tr><td colspan="5" class="muted">Nincs √©l≈ë j√°rm≈± ezen a vonalon.</td></tr>`;

  // t√©rk√©p
  const keep=new Set(), pts=[];
  arr.forEach(v=>{
    if(!(v.lat&&v.lon)) return;
    const key=v.reg||`${v.lat},${v.lon}`;
    keep.add(key);
    let m=routeMarkers.get(key);
    if(!m){
      m=L.marker([v.lat,v.lon],{icon:iconForBearing(v.bearing||0)}).addTo(routeMap);
      routeMarkers.set(key,m);
    }else{
      m.setLatLng([v.lat,v.lon]);
    }
    const popup=`<b>${escapeHtml(v.reg||'Ismeretlen')}</b><br>${escapeHtml(v.type||'')}<br>${escapeHtml(v.headsign||'')}<br>${escapeHtml(v.stop_name||'')}`;
    m.bindPopup(popup);
    pts.push([v.lat,v.lon]);
  });
  for(const [k,m] of routeMarkers.entries()){
    if(!keep.has(k)){ routeMap.removeLayer(m); routeMarkers.delete(k); }
  }
  if(pts.length){ routeMap.fitBounds(L.latLngBounds(pts).pad(0.2)); }
}

function startRoutePolling(){
  if(routeTimer) clearInterval(routeTimer);
  routeTimer=setInterval(()=>{ loadRouteVehicles().catch(()=>{}); }, 15000);
}
</script>
</body>
</html>
