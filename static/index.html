<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë</title>
  <style>
    :root{
      --bg:#0f172a;       /* h√°tt√©r */
      --card:#111827;     /* k√°rtya */
      --text:#e5e7eb;     /* sz√∂veg */
      --muted:#94a3b8;    /* halv√°ny */
      --accent:#22c55e;   /* gomb z√∂ld */
      --accent-2:#2563eb; /* k√©k */
      --danger:#ef4444;   /* piros */
      --dot-green:#22c55e;
      --dot-red:#ef4444;
      --row:#0b1222;      /* s√∂t√©tebb sor */
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";
      line-height:1.35;
    }
    .wrap{max-width:980px;margin:0 auto;padding:24px 16px 64px}
    h1{font-size:clamp(22px,4.5vw,36px);margin:0 0 18px;display:flex;gap:12px;align-items:center}
    h1 .bus{font-size:1.2em}
    .panel{
      background:var(--card);
      border-radius:16px;
      padding:16px;
      box-shadow:0 8px 30px rgba(0,0,0,.35);
      margin-bottom:18px;
    }
    .search-row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input[type="text"]{
      flex:1 1 260px;
      background:#0b1020;border:1px solid #1f2937;color:var(--text);
      border-radius:12px;padding:14px 16px;font-size:16px;outline:none;
    }
    button.primary{
      background:var(--accent); color:#03210e; border:0; border-radius:12px;
      padding:14px 18px; font-weight:700; font-size:16px; cursor:pointer;
      box-shadow:0 6px 16px rgba(34,197,94,.35);
    }
    button.primary:active{transform:translateY(1px)}
    .badges{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .badge{
      background:#0b1020; border:1px solid #1f2937; color:var(--text);
      border-radius:999px; padding:8px 12px; font-size:14px; display:inline-flex;align-items:center;gap:8px
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.green{background:var(--dot-green)}
    .dot.red{background:var(--dot-red)}
    .muted{color:var(--muted)}
    /* v√°laszt√≥ lista t√∂bb meg√°ll√≥hoz */
    .choices{margin-top:10px;display:grid;gap:8px}
    .choice{
      background:#0b1020;border:1px solid #1f2937;border-radius:12px;padding:12px;
      display:flex;justify-content:space-between;align-items:center;gap:10px;cursor:pointer;
    }
    .choice:hover{border-color:#394150}
    .choice small{color:var(--muted)}
    /* Eredm√©nyt√°bla */
    .table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:12px;margin-top:8px}
    .table th,.table td{padding:12px 14px;text-align:left}
    .table thead{background:#0b1020}
    .table tbody tr:nth-child(odd){background:var(--row)}
    .table tbody tr:nth-child(even){background:#0c1426}
    .center{text-align:center}
    .footer{color:var(--muted);text-align:center;margin-top:28px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1><span class="bus">üöå</span> Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë</h1>

    <div class="panel" id="searchPanel">
      <div class="search-row">
        <input id="q" type="text" placeholder="√çrj be egy meg√°ll√≥nevet‚Ä¶ (pl. Hanover, Vincent, Shirley)" />
        <button class="primary" id="btnSearch">Keres√©s</button>
      </div>

      <div class="badges" id="badges">
        <div class="badge"><span class="dot" id="apiDot"></span><span id="apiTxt">API: ‚Ä¶</span></div>
        <div class="badge"><span class="dot" id="gtfsDot"></span><span id="gtfsTxt">GTFS: ‚Ä¶</span></div>
        <div class="badge"><span class="dot" id="liveDot"></span><span id="liveTxt">Live: ‚Ä¶</span></div>
      </div>

      <!-- t√∂bb meg√°ll√≥ v√°laszt√≥ -->
      <div id="choices" class="choices" style="display:none"></div>
      <div id="choiceHint" class="muted" style="display:none;margin-top:8px">
        T√∂bb meg√°ll√≥ van erre a n√©vre. V√°lassz egyet:
      </div>
      <div id="msg" class="muted" style="margin-top:8px"></div>
    </div>

    <!-- eredm√©ny panel -->
    <div class="panel" id="resultPanel" style="display:none">
      <div id="resultTitle" style="font-weight:700;margin-bottom:8px"></div>
      <table class="table" id="tbl">
        <thead>
          <tr>
            <th>J√°rat</th>
            <th>C√©l</th>
            <th>Indul√°s</th>
            <th class="center">√âl≈ë</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="footer">UI &amp; API: te ‚Äì ‚ù§Ô∏è</div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);

    // --- St√°tusz bet√∂lt√©s ---
    async function loadStatus(){
      try{
        const r = await fetch('/api/status');
        const s = await r.json();
        // API
        setBadge('api', true, 'API: ok');
        // GTFS
        setBadge('gtfs', !!s.gtfs_loaded, `GTFS: ${s.gtfs_loaded ? 'bet√∂ltve' : 'nincs'}`);
        // Live
        setBadge('live', !!s.siri_configured, `Live: ${s.siri_configured ? 'el√©rhet≈ë' : 'nincs'}`);
      }catch{
        setBadge('api', false, 'API: hiba');
        setBadge('gtfs', false, 'GTFS: nincs');
        setBadge('live', false, 'Live: nincs');
      }
    }
    function setBadge(kind, ok, text){
      $(kind+'Dot').className = 'dot ' + (ok ? 'green' : 'red');
      $(kind+'Txt').textContent = text;
    }

    // --- Keres√©s ---
    $('btnSearch').addEventListener('click', onSearch);
    $('q').addEventListener('keydown', (e)=>{ if(e.key==='Enter') onSearch(); });

    async function onSearch(){
      clearUI();
      const q = $('q').value.trim();
      if(q.length < 2){ alert('√çrj be legal√°bb 2 karaktert.'); return; }

      // keres√©s
      const url = '/api/stops/search?q=' + encodeURIComponent(q);
      try{
        const r = await fetch(url);
        const arr = await r.json(); // [{stop_id, stop_name}]
        if(!Array.isArray(arr) || arr.length===0){
          $('msg').textContent = 'Nincs tal√°lat erre a n√©vre.';
          return;
        }
        if(arr.length === 1){
          const s = arr[0];
          loadDepartures(s.stop_id, s.stop_name);
          return;
        }
        // t√∂bb tal√°lat
        $('choiceHint').style.display = '';
        const box = $('choices');
        box.style.display = '';
        arr.forEach((s)=>{
          const div = document.createElement('button');
          div.className = 'choice';
          div.innerHTML = `<span>${escapeHtml(s.stop_name)}</span><small>${s.stop_id}</small>`;
          div.onclick = ()=>{ loadDepartures(s.stop_id, s.stop_name); window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'}); };
          box.appendChild(div);
        });
      }catch(err){
        $('msg').textContent = 'Hiba t√∂rt√©nt a keres√©s k√∂zben.';
        console.error(err);
      }
    }

    // --- Indul√°sok bet√∂lt√©se ---
    async function loadDepartures(stopId, stopName){
      $('resultPanel').style.display = 'none';
      $('tbody').innerHTML = '';
      $('resultTitle').textContent = `Meg√°ll√≥: ${stopName} ‚Ä¢ (${stopId})`;

      try{
        const r = await fetch(`/api/stops/${encodeURIComponent(stopId)}/next_departures`);
        if(!r.ok){ $('msg').textContent = 'Nem siker√ºlt lek√©rni az indul√°sokat.'; return; }
        const data = await r.json(); // {stop_id, minutes, results:[{route,destination,time_iso,is_live}]}
        const rows = data.results || [];
        const body = $('tbody');
        if(rows.length===0){
          body.innerHTML = `<tr><td colspan="4" class="center muted">Nincs k√∂zelg≈ë indul√°s.</td></tr>`;
        }else{
          for(const it of rows){
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${escapeHtml(it.route ?? '')}</td>
              <td>${escapeHtml(it.destination ?? '')}</td>
              <td>${fmtTime(it.time_iso)}</td>
              <td class="center">${liveCell(it.is_live)}</td>
            `;
            body.appendChild(tr);
          }
        }
        $('resultPanel').style.display = '';
      }catch(err){
        $('msg').textContent = 'Hiba t√∂rt√©nt az indul√°sok bet√∂lt√©se k√∂zben.';
        console.error(err);
      }
    }

    // --- seg√©dek ---
    function fmtTime(iso){
      try{
        const d = new Date(iso);
        const hh = String(d.getHours()).padStart(2,'0');
        const mm = String(d.getMinutes()).padStart(2,'0');
        return `${hh}:${mm}`;
      }catch{return iso || '';}
    }
    function liveCell(isLive){
      return isLive ? `<span class="dot green" title="√âl≈ë adat"></span>` : '‚Äì';
    }
    function clearUI(){
      $('msg').textContent='';
      $('choices').style.display='none';
      $('choices').innerHTML='';
      $('choiceHint').style.display='none';
    }
    function escapeHtml(s){
      return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // indul√°skor
    loadStatus();
  </script>
</body>
</html>
