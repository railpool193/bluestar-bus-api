<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë</title>
  <style>
    :root{
      --bg:#0f172a;          /* h√°tt√©r */
      --panel:#0b1224;       /* k√°rtya */
      --text:#e2e8f0;        /* f≈ë sz√∂veg */
      --muted:#94a3b8;       /* halv√°ny */
      --accent:#22c55e;      /* z√∂ld */
      --accent-2:#38bdf8;    /* k√©kes */
      --danger:#ef4444;      /* piros */
      --sep:#1f2a44;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text); background:linear-gradient(180deg,#0b1328 0%, #060914 100%);
    }
    .container{max-width:980px; margin:40px auto; padding:0 16px}
    h1{font-size:clamp(24px,4vw,36px); margin:0 0 18px; display:flex; align-items:center; gap:10px}
    .bus{font-size:1.1em}
    .panel{
      background:var(--panel); border:1px solid var(--sep); border-radius:16px;
      padding:18px; box-shadow:0 8px 28px rgba(0,0,0,.35);
    }
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    input[type="text"]{
      flex:1 1 340px; background:#0a1226; color:var(--text); border:1px solid #1a2340;
      border-radius:12px; padding:14px 16px; outline:none;
    }
    input[type="text"]::placeholder{color:#6b7280}
    button{
      background:linear-gradient(180deg,#34d399 0%, #10b981 100%); color:#053a2b;
      border:none; padding:12px 18px; border-radius:12px; font-weight:700; cursor:pointer;
      box-shadow:0 6px 20px rgba(16,185,129,.35);
    }
    button:active{transform:translateY(1px)}
    .badges{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    .badge{
      display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px;
      background:#0a1226; border:1px solid #142046; color:var(--muted); font-weight:600
    }
    .dot{width:10px;height:10px;border-radius:50%;}
    .dot.ok{background:var(--accent)}
    .dot.no{background:#374151}
    .dot.err{background:var(--danger)}
    .statusline{margin-top:8px; color:var(--muted)}
    /* v√°laszt√≥lista t√∂bb azonos nev≈± meg√°ll√≥hoz */
    #choices{display:none; margin-top:14px}
    .choice{
      display:flex; justify-content:space-between; align-items:center; gap:8px;
      padding:10px 12px; border:1px solid #1a2340; border-radius:10px; margin:8px 0; background:#0a1226;
      cursor:pointer;
    }
    .choice:hover{border-color:#28407f}
    .choice small{color:var(--muted)}
    /* t√°bl√°zat */
    #resultsWrap{display:none; margin-top:18px}
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:12px; border:1px solid var(--sep)}
    thead{background:#0a1329; color:#cbd5e1}
    th,td{padding:12px 14px; text-align:left}
    tbody tr{border-top:1px solid var(--sep)}
    tbody tr:hover{background:#0c1631}
    .liveCell{display:flex; align-items:center; gap:8px}
    .muted{color:var(--muted)}
    .footer{color:var(--muted); text-align:center; margin:26px 0}
  </style>
</head>
<body>
  <div class="container">
    <h1><span class="bus">üöå</span> Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë</h1>

    <div class="panel">
      <div class="row">
        <input id="q" type="text" placeholder="√çrd be a meg√°ll√≥ nev√©t‚Ä¶ (pl. Hanover, Vincent, Shirley)" />
        <button id="searchBtn">Keres√©s</button>
      </div>

      <div class="badges" id="badges">
        <span class="badge"><span class="dot no" id="apiDot"></span> API</span>
        <span class="badge"><span class="dot no" id="gtfsDot"></span> GTFS</span>
        <span class="badge"><span class="dot no" id="liveDot"></span> Live</span>
      </div>
      <div class="statusline" id="statusLine">√Ållapot ellen≈ërz√©se‚Ä¶</div>

      <!-- t√∂bb tal√°lat eset√©n v√°laszt√≥ -->
      <div id="choices">
        <div class="muted" style="margin-bottom:6px;">T√∂bb meg√°ll√≥ is van erre a n√©vre. V√°lassz egyet:</div>
        <div id="choiceList"></div>
      </div>

      <!-- eredm√©nyek -->
      <div id="resultsWrap">
        <h3 id="stopTitle" class="muted" style="font-weight:600"></h3>
        <table>
          <thead>
            <tr><th>J√°rat</th><th>C√©l</th><th>Indul√°s</th><th>√âl≈ë</th></tr>
          </thead>
          <tbody id="resultsBody"></tbody>
        </table>
      </div>
    </div>

    <div class="footer">UI & API: te ‚Äì ‚ù§Ô∏è</div>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);
    const apiBase = window.location.origin;

    // ---- √Ållapotjelz≈ëk ----
    async function refreshStatus(){
      try{
        const r = await fetch(`${apiBase}/api/status`);
        const js = await r.json();

        setDot('#apiDot', r.ok ? 'ok' : 'err');
        setDot('#gtfsDot', js.gtfs_loaded ? 'ok' : 'no');
        setDot('#liveDot', js.siri_configured ? 'ok' : 'no');

        $('#statusLine').textContent =
          `API: ${r.ok ? 'ok' : 'hiba'} ¬∑ GTFS: ${js.gtfs_loaded ? 'bet√∂ltve' : 'nincs'} ¬∑ Live: ${js.siri_configured ? 'el√©rhet≈ë' : 'nincs'}`;
      }catch(e){
        console.error(e);
        setDot('#apiDot','err'); setDot('#gtfsDot','no'); setDot('#liveDot','no');
        $('#statusLine').textContent = 'Nem siker√ºlt lek√©rdezni az √°llapotot.';
      }
    }
    function setDot(sel, state){
      const el = $(sel); el.className='dot ' + (state||'no');
    }

    // ---- Keres√©s gomb / Enter ----
    $('#searchBtn').addEventListener('click', onSearch);
    $('#q').addEventListener('keydown', e => { if(e.key==='Enter') onSearch(); });

    async function onSearch(){
      const q = $('#q').value.trim();
      hideChoices();
      $('#resultsWrap').style.display = 'none';
      if(q.length < 2) return;

      let stops = [];
      try{
        const r = await fetch(`${apiBase}/api/stops/search?q=${encodeURIComponent(q)}`);
        stops = await r.json();
      }catch(e){ console.error(e); }

      if(!stops || stops.length === 0){
        alert('Nincs tal√°lat erre a n√©vre.');
        return;
      }
      if(stops.length === 1){
        loadDeparturesForStop(stops[0]);
        return;
      }
      // t√∂bb tal√°lat ‚Äì mutassuk a v√°laszt√≥t
      showChoices(stops);
    }

    function hideChoices(){
      $('#choices').style.display = 'none';
      $('#choiceList').innerHTML = '';
    }
    function showChoices(stops){
      const list = $('#choiceList');
      list.innerHTML = '';
      stops.forEach(st => {
        const div = document.createElement('div');
        div.className = 'choice';
        div.innerHTML = `<div><strong>${escapeHtml(st.stop_name || st.name || '')}</strong><br><small>${escapeHtml(st.stop_id)}</small></div>
                         <div style="color:var(--accent-2);font-weight:700">V√°laszt</div>`;
        div.addEventListener('click', ()=> { hideChoices(); loadDeparturesForStop(st); });
        list.appendChild(div);
      });
      $('#choices').style.display = 'block';
    }

    async function loadDeparturesForStop(stop){
      const stopId = stop.stop_id || stop.id;
      const title = `${stop.stop_name || stop.name} ‚Ä¢ (${stopId})`;
      $('#stopTitle').textContent = 'Meg√°ll√≥: ' + title;

      let data = null;
      try{
        const r = await fetch(`${apiBase}/api/stops/${encodeURIComponent(stopId)}/next_departures`);
        data = await r.json();
      }catch(e){ console.error(e); }

      const tbody = $('#resultsBody');
      tbody.innerHTML = '';

      if(!data || !data.results || data.results.length === 0){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="4" class="muted">Nincs indul√°s a k√∂vetkez≈ë √≥r√°ban.</td>`;
        tbody.appendChild(tr);
      }else{
        data.results.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><strong>${escapeHtml(row.route)}</strong></td>
            <td>${escapeHtml(row.destination)}</td>
            <td>${fmtTime(row.time_iso)}</td>
            <td class="liveCell">
              <span class="dot ${row.is_live ? 'ok' : 'no'}"></span>
              <span class="muted">${row.is_live ? '√©l≈ë' : '‚Äì'}</span>
            </td>`;
          tbody.appendChild(tr);
        });
      }
      $('#resultsWrap').style.display = 'block';
      window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
    }

    function fmtTime(iso){
      try{
        const d = new Date(iso);
        const hh = String(d.getHours()).padStart(2,'0');
        const mm = String(d.getMinutes()).padStart(2,'0');
        return `${hh}:${mm}`;
      }catch{ return iso; }
    }
    function escapeHtml(s){
      return String(s ?? '').replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      })[c]);
    }

    // els≈ë bet√∂lt√©skor
    refreshStatus();
  </script>
</body>
</html>
