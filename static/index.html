<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Busz indul√°sok</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background: #111; color: #eee; }
    input { padding: 8px; width: 250px; }
    ul { list-style: none; padding: 0; }
    li { cursor: pointer; padding: 4px; }
    li:hover { background: #333; }
    .live-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      margin-left: 8px;
      border-radius: 50%;
      background-color: limegreen;
    }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #444; padding: 6px; text-align: left; }
  </style>
</head>
<body>
  <h1>üöå Bluestar Bus ‚Äì meg√°ll√≥ & indul√°sok</h1>
  <input id="search" placeholder="Meg√°ll√≥ keres√©s‚Ä¶" />
  <ul id="results"></ul>

  <h2 id="stop-title"></h2>
  <table id="departures">
    <thead>
      <tr><th>J√°rat</th><th>C√©l</th><th>Indul√°s</th></tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
const apiBase = location.origin + "/api";

document.getElementById("search").addEventListener("input", async e => {
  const q = e.target.value;
  if (q.length < 2) return;
  const res = await fetch(`${apiBase}/stops/search?q=${encodeURIComponent(q)}`);
  const data = await res.json();
  const ul = document.getElementById("results");
  ul.innerHTML = "";
  data.forEach(stop => {
    const li = document.createElement("li");
    li.textContent = stop.stop_name + " (" + stop.stop_id + ")";
    li.onclick = () => loadStop(stop.stop_id, stop.stop_name);
    ul.appendChild(li);
  });
});

async function loadStop(stopId, stopName) {
  document.getElementById("stop-title").textContent = stopName;

  // GTFS alap√∫ indul√°sok
  const depRes = await fetch(`${apiBase}/stops/${stopId}/next_departures?minutes=60`);
  const depData = await depRes.json();

  // √âl≈ë adatok (pl. VehicleMonitoring)
  const liveRes = await fetch(`${apiBase}/live/${stopId}`);
  const liveData = await liveRes.json();

  // √âl≈ë j√°ratok azonos√≠t√≥i (route+destination alapj√°n vagy vehicleRef alapj√°n)
  const liveTrips = new Set();
  if (liveData.vehicles) {
    liveData.vehicles.forEach(v => {
      if (v.lineRef && v.destinationName) {
        liveTrips.add(v.lineRef + "|" + v.destinationName);
      }
    });
  }

  const tbody = document.querySelector("#departures tbody");
  tbody.innerHTML = "";
  depData.results.forEach(dep => {
    const key = dep.route + "|" + dep.destination;
    const hasLive = liveTrips.has(key);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${dep.route}</td>
      <td>${dep.destination}</td>
      <td>${new Date(dep.time_iso).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}
          ${hasLive ? '<span class="live-indicator"></span>' : ''}
      </td>`;
    tbody.appendChild(tr);
  });
}
</script>
</body>
</html>
