<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Megállóhelyi Menetrend – web</title>

  <!-- Ikonok -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400" rel="stylesheet" />

  <!-- Leaflet térkép -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <style>
    :root{
      --bg:#13151a;--card:#1b1f27;--muted:#8892a6;--txt:#e9eefb;--accent:#72a0ff;--pill-blue:#1ea7ff;--pill-yellow:#f3c312;--pill-pink:#ff6fa9;--pill-black:#111;--ok:#7CFF6B;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--txt);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif;
      -webkit-font-smoothing:antialiased;scroll-behavior:smooth;
    }
    .appbar{
      height:56px;display:flex;align-items:center;gap:10px;padding:0 14px;background:#0f1116;border-bottom:1px solid #10131a;position:sticky;top:0;z-index:30;
    }
    .appbar .title{font-weight:600;font-size:18px}
    .icon{font-family:"Material Symbols Outlined";font-variation-settings:"FILL" 0,"wght" 400,"GRAD" 0,"opsz" 24;display:inline-flex;align-items:center;justify-content:center}
    .btn{display:inline-flex;align-items:center;gap:8px;background:#2a3040;border:1px solid #30384a;color:var(--txt);padding:10px 12px;border-radius:12px;cursor:pointer}
    .btn:hover{background:#31384b}
    .layout{display:grid;grid-template-columns:1fr;max-width:980px;margin:0 auto;padding:12px;gap:12px}
    .card{background:var(--card);border:1px solid #22293a;border-radius:14px;padding:12px}
    .muted{color:var(--muted)}
    /* Drawer */
    .drawer{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:40}
    .drawer.open{display:block}
    .drawer-panel{width:min(86vw,320px);height:100%;background:#11151d;border-right:1px solid #232a3a;padding:16px 12px 24px}
    .drawer h3{margin:6px 0 14px 8px;font-size:14px;font-weight:600;color:#bfc7dc}
    .drawer a, .drawer button{
      width:100%;text-align:left;border:0;background:transparent;color:var(--txt);padding:12px;border-radius:10px;display:flex;gap:10px;align-items:center;
    }
    .drawer a:hover, .drawer button:hover{background:#1e2431}
    /* Tabs */
    .tabs{display:flex;gap:8px}
    .tab{flex:0 0 auto;padding:8px 12px;border-radius:12px;background:#22283a;color:#cbd5f5;cursor:pointer}
    .tab.active{background:#43507a;color:#fff}
    /* Search */
    .search{display:flex;gap:8px}
    .search .input{
      flex:1;background:#0f1320;border:1px solid #27304a;border-radius:12px;display:flex;align-items:center;padding:8px 10px;gap:8px
    }
    .search input{flex:1;border:0;outline:0;background:transparent;color:var(--txt);font-size:16px}
    .pill{display:inline-flex;align-items:center;justify-content:center;border-radius:8px;padding:6px 8px;font-weight:600;min-width:44px}
    .pill.blue{background:var(--pill-blue)}
    .pill.yellow{background:var(--pill-yellow);color:#111}
    .pill.pink{background:var(--pill-pink)}
    .pill.black{background:var(--pill-black);border:1px solid #3b3b3b}
    .row{display:flex;gap:12px;align-items:center}
    .row + .row{margin-top:8px}
    .grow{flex:1}
    .dest{font-weight:600}
    .mins{margin-left:auto;font-family:"Roboto Mono",monospace;font-weight:600;color:var(--ok)}
    .section-title{font-weight:600;margin:2px 4px 10px 4px;color:#c9d2ee}
    .chips{display:flex;flex-wrap:wrap;gap:6px}
    /* Lists */
    .list{display:flex;flex-direction:column;gap:8px}
    .item{background:#101522;border:1px solid #1f2738;border-radius:12px;padding:10px}
    .item:hover{background:#131a2a}
    .item .subtitle{font-size:12px;color:#9aa6c9;margin-top:4px}
    .right{margin-left:auto}
    /* Dialogs */
    dialog{border:0;border-radius:14px;padding:0;max-width:min(96vw,840px);background:var(--card);color:var(--txt);box-shadow:0 30px 120px rgba(0,0,0,.5)}
    dialog::backdrop{background:rgba(0,0,0,.55)}
    .dialog-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #232b40}
    .dialog-body{padding:12px}
    .map{height:60vh;border-radius:12px;border:1px solid #27324b;overflow:hidden}
    /* Toast */
    #toast{position:fixed;left:12px;right:12px;bottom:14px;display:none;z-index:60}
    .toast{background:#5f1f1f;color:#ffd8d8;border:1px solid #722; padding:10px 12px;border-radius:10px}
    @media(min-width:720px){ .layout{padding:18px;gap:16px} }
  </style>
</head>
<body>
  <header class="appbar">
    <button id="btn-menu" class="btn" aria-label="Menü"><span class="icon">menu</span></button>
    <div class="title">Megállóhelyi Menetrend</div>
    <div style="margin-left:auto"></div>
    <button id="btn-settings" class="btn" aria-label="Beállítások"><span class="icon">settings</span></button>
  </header>

  <div class="layout">
    <!-- Tabs + search -->
    <div class="card">
      <div class="tabs" role="tablist" aria-label="Nézetek">
        <button class="tab active" data-tab="stop">Megálló</button>
        <button class="tab" data-tab="route">Viszonylat</button>
        <button class="tab" data-tab="fav">Kedvencek</button>
      </div>

      <div style="height:10px"></div>

      <div class="search">
        <div class="input">
          <span class="icon" aria-hidden="true">search</span>
          <input id="q" type="text" autocomplete="off" placeholder="Megálló vagy viszonylat keresése">
          <button id="clear" class="btn" title="Törlés"><span class="icon">close</span></button>
        </div>
        <button id="btn-search" class="btn"><span class="icon">travel_explore</span>Keresés</button>
      </div>
    </div>

    <!-- Kiemelt változások -->
    <section class="card" id="alerts-box">
      <div class="section-title">Kiemelt forgalmi változások</div>
      <div id="alerts" class="chips">
        <!-- dynamikusan -->
      </div>
    </section>

    <!-- Találatok -->
    <section class="card">
      <div class="section-title" id="res-title">Találatok</div>
      <div id="results" class="list"></div>
    </section>

    <!-- Kedvencek -->
    <section class="card" id="favs-card" hidden>
      <div class="section-title">Kedvenc megállók és viszonylatok</div>
      <div id="favs" class="list"></div>
    </section>
  </div>

  <!-- Drawer -->
  <div id="drawer" class="drawer" aria-hidden="true">
    <div class="drawer-panel" role="dialog" aria-label="Menü">
      <div class="row" style="gap:10px;padding:6px 8px 16px 8px">
        <div class="pill blue" style="border-radius:12px">MM</div>
        <div style="font-weight:600">Megállóhelyi Menetrend</div>
      </div>
      <h3>Közlekedési információk</h3>
      <button onclick="openAlerts()"><span class="icon">info</span> Aktuális közlemények</button>
      <h3>Kedvencek</h3>
      <button onclick="refreshFavs()"><span class="icon">sync</span> Kedvencek frissítése</button>
      <button onclick="clearFavs()"><span class="icon">delete</span> Kedvencek törlése</button>
      <h3>Megjelenés</h3>
      <button onclick="toggleTheme()"><span class="icon">dark_mode</span> Téma váltása</button>
      <h3>Az alkalmazásról</h3>
      <a href="#" onclick="alertInfo();return false;"><span class="icon">help</span> Névjegy</a>
    </div>
  </div>

  <!-- Dialog: Megálló indulások -->
  <dialog id="dlg-stop">
    <div class="dialog-head">
      <div class="dest" id="dlg-stop-title">Megálló</div>
      <div class="row">
        <button class="btn" id="btn-stop-map"><span class="icon">map</span>Térkép</button>
        <button class="btn" onclick="closeStopDialog()"><span class="icon">close</span></button>
      </div>
    </div>
    <div class="dialog-body">
      <div class="muted" id="dlg-stop-sub"></div>
      <div style="height:8px"></div>
      <div id="departures" class="list"></div>
    </div>
  </dialog>

  <!-- Dialog: Térkép -->
  <dialog id="dlg-map">
    <div class="dialog-head">
      <div class="dest" id="dlg-map-title">Térkép</div>
      <button class="btn" onclick="closeMap()"><span class="icon">close</span></button>
    </div>
    <div class="dialog-body">
      <div id="map" class="map" role="application" aria-label="Útvonal térképe"></div>
    </div>
  </dialog>

  <!-- Dialog: Viszonylat -->
  <dialog id="dlg-route">
    <div class="dialog-head">
      <div class="dest" id="dlg-route-title">Viszonylat</div>
      <div class="row">
        <button class="btn" id="btn-route-map"><span class="icon">map</span>Térkép</button>
        <button class="btn" onclick="closeRouteDialog()"><span class="icon">close</span></button>
      </div>
    </div>
    <div class="dialog-body">
      <div class="list" id="route-sections">
        <!-- járművek / megállók irányonként -->
      </div>
    </div>
  </dialog>

  <!-- Dialog: Járműlista -->
  <dialog id="dlg-vehicles">
    <div class="dialog-head">
      <div class="dest" id="dlg-veh-title">Járművek</div>
      <button class="btn" onclick="closeVehicles()"><span class="icon">close</span></button>
    </div>
    <div class="dialog-body">
      <div class="list" id="veh-list"></div>
    </div>
  </dialog>

  <!-- Dialog: Járat idővonal -->
  <dialog id="dlg-trip">
    <div class="dialog-head">
      <div class="dest" id="dlg-trip-title">Járat</div>
      <button class="btn" onclick="closeTrip()"><span class="icon">close</span></button>
    </div>
    <div class="dialog-body">
      <div class="list" id="trip-list"></div>
    </div>
  </dialog>

  <!-- Toast -->
  <div id="toast"><div class="toast" id="toast-msg"></div></div>

<script>
/* =======================
   KONFIG
======================= */
const API_BASE = (window.API_BASE_OVERRIDE) || location.origin; // állítsd a Railway API URL-re, pl. "https://bluestar-bus-api-production-XXXX.up.railway.app"
const S = (q,el=document)=>el.querySelector(q);
const SS = (q,el=document)=>el.querySelectorAll(q);

/* =======================
   ÁLLAPOT
======================= */
let activeTab = 'stop';
let mapObj = null;
let mapLayer = null;
let currentStop = null;
let currentRoute = null;

/* =======================
   SEGÉDFÜGGVÉNYEK
======================= */
function toast(msg, ms=3500){
  const box = S('#toast'); const t = S('#toast-msg');
  t.textContent = msg; box.style.display='block';
  setTimeout(()=>box.style.display='none', ms);
}
function fmtMins(mins){ return (mins<=0?'&lt;1':mins) + "′"; }
function pill(color, text){ return `<span class="pill ${color}">${text}</span>`; }
function linePill(code){
  // egyszerű színlogika: szám → kék, H… → pink, sárga pl. éjszakai
  if(/^N/i.test(code)) return pill('yellow', code.toUpperCase());
  if(/^H/i.test(code)) return pill('pink', code.toUpperCase());
  if(/^[0-9]+$/.test(code)) return pill('blue', code);
  return pill('black', code);
}
function saveFav(key, value){
  const f = JSON.parse(localStorage.getItem('mm_favs')||'[]');
  if(!f.find(x=>x.key===key)){ f.push({key, value}); localStorage.setItem('mm_favs', JSON.stringify(f)); refreshFavs(true); toast('Hozzáadva a kedvencekhez'); }
}
function refreshFavs(silent){
  const cont = S('#favs'); cont.innerHTML='';
  const f = JSON.parse(localStorage.getItem('mm_favs')||'[]');
  if(!f.length){ cont.innerHTML = `<div class="muted">Nincs még kedvenc.</div>`; if(!silent) toast('Kedvencek frissítve'); return; }
  for(const {key,value} of f){
    const div = document.createElement('div'); div.className='item row';
    div.innerHTML = `<div class="pill black">${value.type==='stop'?'M':'V'}</div>
      <div class="grow"><div class="dest">${value.title}</div><div class="subtitle">${value.sub||''}</div></div>
      <button class="btn right"><span class="icon">open_in_new</span>Megnyitás</button>`;
    div.querySelector('button').onclick = ()=> {
      if(value.type==='stop') openStop(value.id, value.title, value.sub);
      else openRoute(value.id, value.title);
    };
    cont.appendChild(div);
  }
}
function clearFavs(){ localStorage.removeItem('mm_favs'); refreshFavs(); toast('Kedvencek törölve'); }
function openAlerts(){ toast('A közlemények a felső sávban látszanak.'); S('#drawer').classList.remove('open'); }
function toggleTheme(){ document.body.classList.toggle('light'); toast('Téma váltva'); }

/* =======================
   ESEMÉNYKEZELÉS
======================= */
S('#btn-menu').onclick = ()=>{ S('#drawer').classList.add('open'); S('#drawer').ariaHidden='false'; };
S('#drawer').onclick = (e)=>{ if(e.target.id==='drawer') S('#drawer').classList.remove('open'); };
S('#clear').onclick = ()=>{ S('#q').value=''; S('#results').innerHTML=''; };
SS('.tab').forEach(b=>b.onclick = ()=>{
  SS('.tab').forEach(x=>x.classList.remove('active')); b.classList.add('active');
  activeTab = b.dataset.tab;
  S('#favs-card').hidden = activeTab!=='fav';
  S('#res-title').textContent = activeTab==='stop' ? 'Találatok megállókra' :
                                activeTab==='route'? 'Találatok viszonylatokra' : 'Kedvencek';
  if(activeTab==='fav') refreshFavs(true);
});
S('#btn-search').onclick = ()=> runSearch();
S('#q').addEventListener('keydown', e=>{ if(e.key==='Enter') runSearch(); });

/* =======================
   KERESÉS
======================= */
async function runSearch(){
  const q = S('#q').value.trim();
  if(!q){ toast('Írj be egy megállót vagy viszonylatot!'); return; }
  try{
    const resBox = S('#results'); resBox.innerHTML='';
    if(activeTab==='stop'){
      const r = await fetch(`${API_BASE}/api/stops/search?q=${encodeURIComponent(q)}`);
      if(!r.ok) throw new Error('Stop search failed');
      const items = await r.json();
      if(!items.length){ resBox.innerHTML='<div class="muted">Nincs találat.</div>'; return; }
      for(const it of items){
        const div = document.createElement('div'); div.className='item';
        div.innerHTML = `
          <div class="row">
            <div class="pill black">M</div>
            <div class="grow">
              <div class="dest">${it.name}</div>
              <div class="subtitle">${it.id}</div>
            </div>
            <button class="btn"><span class="icon">star</span></button>
            <button class="btn"><span class="icon">open_in_new</span></button>
          </div>`;
        div.querySelectorAll('button')[0].onclick = ()=> saveFav(`stop:${it.id}`, {type:'stop', id:it.id, title:it.name});
        div.querySelectorAll('button')[1].onclick = ()=> openStop(it.id, it.name);
        resBox.appendChild(div);
      }
    } else if(activeTab==='route'){
      const r = await fetch(`${API_BASE}/api/routes/search?q=${encodeURIComponent(q)}`);
      if(!r.ok) throw new Error('Route search failed');
      const items = await r.json();
      if(!items.length){ resBox.innerHTML='<div class="muted">Nincs találat.</div>'; return; }
      for(const it of items){
        const div = document.createElement('div'); div.className='item';
        div.innerHTML = `
          <div class="row">
            ${linePill(it.code || it.name)}
            <div class="grow">
              <div class="dest">${it.name || it.code}</div>
              <div class="subtitle">${it.id}</div>
            </div>
            <button class="btn"><span class="icon">star</span></button>
            <button class="btn"><span class="icon">open_in_new</span></button>
          </div>`;
        div.querySelectorAll('button')[0].onclick = ()=> saveFav(`route:${it.id}`, {type:'route', id:it.id, title:(it.name||it.code)});
        div.querySelectorAll('button')[1].onclick = ()=> openRoute(it.id, it.name || it.code);
        resBox.appendChild(div);
      }
    } else {
      refreshFavs(true);
    }
  } catch(err){
    console.error(err); toast('Hálózati hiba vagy API válasz hiba.');
  }
}

/* =======================
   KIEMELT VÁLTOZÁSOK (dummy vagy API)
======================= */
async function loadAlerts(){
  try{
    const box = S('#alerts'); box.innerHTML='';
    // Ha van API: /api/alerts  — ha nincs, készítsünk pár példát
    const r = await fetch(`${API_BASE}/api/alerts`).catch(()=>null);
    let arr = [];
    if(r && r.ok){ arr = await r.json(); }
    else {
      arr = [{code:'H5'},{code:'1'},{code:'12'},{code:'14'},{code:'59A'},{code:'16'},{code:'16A'},{code:'107'},{code:'116'},{code:'139'},{code:'140'},{code:'140A'},{code:'212'},{code:'277'},{code:'960', style:'black'}];
    }
    for(const a of arr){
      const el = document.createElement('button');
      el.className='pill ' + (a.style==='black'?'black': (/^[0-9]+$/.test(a.code)?'yellow': 'blue'));
      el.style.cursor='pointer'; el.textContent = a.code;
      el.onclick = ()=>{ activeTab='route'; SS('.tab').forEach(x=>x.classList.remove('active')); S('.tab[data-tab="route"]').classList.add('active'); S('#q').value=a.code; runSearch(); };
      box.appendChild(el);
    }
  }catch(e){ /* csendben */ }
}

/* =======================
   MEGÁLLÓ NÉZET
======================= */
async function openStop(stopId, name, sub){
  currentStop = {id:stopId,name};
  S('#dlg-stop-title').textContent = name || 'Megálló';
  S('#dlg-stop-sub').textContent = sub || stopId;
  S('#departures').innerHTML = '';
  S('#dlg-stop').showModal();
  await loadDepartures(stopId);
}
async function loadDepartures(stopId){
  try{
    const r = await fetch(`${API_BASE}/api/stop/${encodeURIComponent(stopId)}/departures`);
    if(!r.ok) throw new Error('Departures failed');
    const rows = await r.json();
    const box = S('#departures'); box.innerHTML='';
    if(!rows.length){ box.innerHTML='<div class="muted">Nincs indulás.</div>'; return; }
    for(const d of rows){
      const div = document.createElement('div'); div.className='item row';
      div.innerHTML = `
        ${linePill(d.line)}
        <div class="grow">
          <div class="dest">${d.destination}</div>
          <div class="subtitle">Következő megálló: ${d.next_stop || '-'}</div>
        </div>
        <div class="mins">${fmtMins(d.minutes)}</div>
        <button class="btn right"><span class="icon">star</span></button>
      `;
      div.querySelector('.btn').onclick = ()=> saveFav(`stop:${stopId}`, {type:'stop', id:stopId, title:currentStop?.name||stopId});
      box.appendChild(div);
    }
    // térkép gomb
    S('#btn-stop-map').onclick = ()=> showMapForStop(stopId);
  }catch(e){
    console.error(e); toast('Indulások lekérése sikertelen.');
  }
}
function closeStopDialog(){ S('#dlg-stop').close(); }

/* =======================
   VISZONYLAT NÉZET
======================= */
async function openRoute(routeId, title){
  currentRoute = {id:routeId,title};
  S('#dlg-route-title').textContent = `${title} – viszonylat`;
  S('#route-sections').innerHTML='';
  S('#dlg-route').showModal();
  try{
    // irányonként megállók + járművek
    const [stopsRes, vehRes] = await Promise.all([
      fetch(`${API_BASE}/api/route/${encodeURIComponent(routeId)}/stops`),
      fetch(`${API_BASE}/api/vehicles?route_id=${encodeURIComponent(routeId)}`)
    ]);
    const stopsData = stopsRes.ok ? await stopsRes.json() : [];
    const vehiclesData = vehRes.ok ? await vehRes.json() : [];

    const cont = S('#route-sections');

    // járműlista szekció
    const vehCard = document.createElement('div'); vehCard.className='item';
    vehCard.innerHTML = `
      <div class="row">
        ${linePill(title.split(' ')[0] || 'V')}
        <div class="grow"><div class="dest">Járművek listája</div>
        <div class="subtitle">${vehiclesData.length} db</div></div>
        <button class="btn right"><span class="icon">directions_bus</span>Megnyitás</button>
      </div>`;
    vehCard.querySelector('button').onclick = ()=> openVehicles(vehiclesData);
    cont.appendChild(vehCard);

    // megállók irányonként
    for(const dir of stopsData){
      const card = document.createElement('div'); card.className='item';
      card.innerHTML = `
        <div class="row">
          ${linePill(dir.code || title)}
          <div class="grow"><div class="dest">${dir.direction_name || 'Irány'}</div>
          <div class="subtitle">${(dir.stops||[]).length} megálló</div></div>
          <button class="btn right"><span class="icon">list</span>Megállók</button>
        </div>`;
      const btn = card.querySelector('button');
      btn.onclick = ()=>{
        const list = (dir.stops||[]).map(s=>`<div class="row" style="padding:6px 0;border-top:1px dashed #2a3550"><div class="pill black">M</div><div class="grow">${s.name}</div><button class="btn" onclick="openStop('${s.id}','${s.name.replaceAll("'","\\'")}')"><span class='icon'>open_in_new</span></button></div>`).join('');
        card.innerHTML += `<div style="margin-top:8px">${list || '<div class="muted">Nincs adat.</div>'}</div>`;
        btn.remove();
      };
      cont.appendChild(card);
    }

    // térkép gomb
    S('#btn-route-map').onclick = ()=> showMapForRoute(routeId, title);

  }catch(e){
    console.error(e); toast('Viszonylat részletek nem érhetők el.');
  }
}
function closeRouteDialog(){ S('#dlg-route').close(); }

/* =======================
   JÁRMŰ LISTA & JÁRAT
======================= */
function openVehicles(list){
  S('#dlg-veh-title').textContent = 'Járművek';
  const box = S('#veh-list'); box.innerHTML='';
  for(const v of list){
    const div = document.createElement('div'); div.className='item';
    div.innerHTML = `
      <div class="row">
        ${linePill(v.line || 'V')}
        <div class="grow">
          <div class="dest">${v.headsign || v.destination || ''}</div>
          <div class="subtitle">${v.label || v.vehicle_id || ''} • Következő megálló: ${v.next_stop || '-'}</div>
        </div>
        <button class="btn right"><span class="icon">timeline</span>Járat</button>
      </div>`;
    div.querySelector('button').onclick = ()=> openTrip(v.trip_id || v.block_id || v.vehicle_id, v);
    box.appendChild(div);
  }
  S('#dlg-vehicles').showModal();
}
function closeVehicles(){ S('#dlg-vehicles').close(); }

async function openTrip(tripId, v){
  S('#dlg-trip-title').textContent = `${v?.line||''} – ${v?.headsign||''}`;
  const box = S('#trip-list'); box.innerHTML='';
  try{
    const r = await fetch(`${API_BASE}/api/trip/${encodeURIComponent(tripId)}/timetable`);
    const rows = r.ok ? await r.json() : [];
    if(!rows.length){ box.innerHTML='<div class="muted">Nincs menetrendi adat.</div>'; }
    for(const row of rows){
      const div = document.createElement('div'); div.className='item row';
      div.innerHTML = `<div class="pill black">M</div>
        <div class="grow">${row.stop_name}</div>
        <div class="mins">${row.time || ''}</div>`;
      box.appendChild(div);
    }
    S('#dlg-trip').showModal();
  }catch(e){ console.error(e); toast('Járat adatok nem elérhetők.'); }
}
function closeTrip(){ S('#dlg-trip').close(); }

/* =======================
   TÉRKÉP
======================= */
function ensureMap(){
  if(mapObj) return;
  mapObj = L.map('map',{zoomControl:true, scrollWheelZoom:true});
  const url='https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
  L.tileLayer(url,{attribution:'&copy; OpenStreetMap & CARTO'}).addTo(mapObj);
}
function showMap(title){
  S('#dlg-map-title').textContent = title || 'Térkép';
  S('#dlg-map').showModal();
  setTimeout(()=>{ if(mapObj) mapObj.invalidateSize(true); }, 100);
}
async function showMapForStop(stopId){
  ensureMap();
  try{
    // megálló koordináták
    const r = await fetch(`${API_BASE}/api/stop/${encodeURIComponent(stopId)}`);
    const st = r.ok ? await r.json() : null;
    if(!st || !st.lat){ toast('Nincs koordináta a megállóhoz.'); return; }
    if(mapLayer){ mapObj.removeLayer(mapLayer); }
    mapLayer = L.layerGroup().addTo(mapObj);
    L.marker([st.lat, st.lon]).addTo(mapLayer).bindPopup(st.name||stopId);
    mapObj.setView([st.lat, st.lon], 15);
    showMap(st.name||'Megálló');
  }catch(e){ console.error(e); toast('Térkép betöltése sikertelen.'); }
}
async function showMapForRoute(routeId, title){
  ensureMap();
  try{
    const r = await fetch(`${API_BASE}/api/route/${encodeURIComponent(routeId)}/shape`);
    const data = r.ok ? await r.json() : null;
    if(!data || !data.shape || !data.shape.length){ toast('Nincs térképi adat ehhez a viszonylathoz.'); return; }
    if(mapLayer){ mapObj.removeLayer(mapLayer); }
    mapLayer = L.layerGroup().addTo(mapObj);

    // vonal & megállók
    const latlngs = data.shape.map(p=>[p.lat,p.lon]);
    L.polyline(latlngs,{weight:5,opacity:.9}).addTo(mapLayer);

    (data.stops||[]).forEach(s=>{
      L.circleMarker([s.lat,s.lon],{radius:5,opacity:.9,fillOpacity:.9}).addTo(mapLayer).bindTooltip(s.name);
    });

    const b = L.latLngBounds(latlngs);
    mapObj.fitBounds(b.pad(0.15));
    showMap(`${title} – térkép`);
  }catch(e){ console.error(e); toast('Térkép betöltése sikertelen.'); }
}
function closeMap(){ S('#dlg-map').close(); }

/* =======================
   NÉVJEGY
======================= */
function alertInfo(){
  alert('Megállóhelyi Menetrend – web\nNem hivatalos demó felület.\nAPI: Bluestar Bus API');
}

/* =======================
   INIT
======================= */
loadAlerts();
refreshFavs(true);
</script>
</body>
</html>
