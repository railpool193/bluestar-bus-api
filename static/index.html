<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f1a" />
  <title>Bluestar menetrend √©s meg√°ll√≥ keres≈ë</title>
  <style>
    :root{--bg:#0b0f1a;--panel:#121829;--panel-2:#0f1524;--muted:#8fa3b8;--text:#e8ecf1;--brand:#9aa6ff;--ok:#25d366;--err:#ef4444;--radius:16px}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;color:var(--text);
      background:radial-gradient(1200px 800px at 70% -20%,#1b2441 0%,#0b0f1a 55%) fixed,var(--bg)}
    .container{max-width:980px;margin:0 auto;padding:16px 16px 48px}
    header{display:flex;align-items:center;gap:12px;padding:18px 0 6px}
    header h1{margin:0;font-size:22px;font-weight:650;letter-spacing:.3px}
    .uk-time{opacity:.9;font-size:14px;margin-left:auto}
    .tabs{display:flex;gap:10px;margin:10px 0 2px}
    .tab{padding:10px 14px;border-radius:14px;background:#0f1524;color:#8fa3b8;cursor:pointer;border:1px solid #1f2a44}
    .tab.active{background:#202a46;color:var(--text);border-color:#2b3a62}
    .card{background:#121829;border:1px solid #1f2a44;border-radius:var(--radius);padding:14px}
    .row{display:flex;gap:12px;align-items:center;margin:10px 0}
    .input{flex:1;display:flex;align-items:center;background:#0f1524;border:1px solid #1f2a44;border-radius:12px;padding:6px 10px}
    .input input{flex:1;background:transparent;border:none;outline:none;color:var(--text);font-size:16px;padding:6px}
    .btn{appearance:none;border:none;background:var(--brand);color:#101321;padding:10px 14px;border-radius:12px;font-weight:650;cursor:pointer}
    .btn.small{padding:6px 10px;border-radius:10px}
    .section-title{font-weight:700;margin:12px 4px 8px}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{background:#1b2238;border:1px solid #243055;color:#bcd0ff;padding:6px 10px;border-radius:10px;font-weight:650}
    .results{margin-top:10px;display:flex;flex-direction:column;gap:10px}
    .item{display:flex;align-items:center;gap:12px;background:#0f1524;border:1px solid #1f2a44;border-radius:14px;padding:12px}
    .pill{min-width:44px;height:44px;display:grid;place-items:center;border-radius:10px;background:#273255;color:#d8e0ff;font-weight:800}
    .dest{font-weight:650}
    .due{margin-left:auto;color:#8fe29f}
    .footer{opacity:.75;font-size:13px;margin-top:14px}
    .error{position:fixed;left:16px;right:16px;bottom:16px;background:#2a0e12;border:1px solid #4e1c23;color:#ffd6d6;padding:12px;border-radius:12px;display:none}
    .settings-btn,.drawer-btn{width:42px;height:42px;border-radius:12px;border:1px solid #263150;background:#0f1524;display:grid;place-items:center;color:var(--text);cursor:pointer}
    .topbar{display:flex;gap:10px;align-items:center}
    dialog{border:none;border-radius:16px;background:#0f1526;color:var(--text);padding:0;max-width:520px}
    dialog::backdrop{background:rgba(7,10,20,.65)}
    .dlg-header{padding:14px 16px;border-bottom:1px solid #223055;font-weight:700}
    .dlg-body{padding:14px 16px;display:flex;flex-direction:column;gap:12px}
    .grid-2{display:grid;grid-template-columns:1fr 120px;gap:10px}
    .muted{color:#8fa3b8}
    a{color:#b6c4ff;text-decoration:none}
    @media (max-width:640px){.grid-2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <button class="drawer-btn" id="btnDrawer" title="Men√º">‚ò∞</button>
      <header><h1>üöç Bluestar menetrend √©s meg√°ll√≥ keres≈ë</h1></header>
      <button class="settings-btn" id="btnSettings" title="Be√°ll√≠t√°sok">‚öôÔ∏è</button>
    </div>
    <div class="uk-time" id="ukTime">UK: --:--:--</div>

    <div class="tabs">
      <div class="tab active" data-tab="stop">Meg√°ll√≥</div>
      <div class="tab" data-tab="route">Viszonylat</div>
      <div class="tab" data-tab="fav">Kedvencek</div>
    </div>

    <!-- STOP -->
    <section id="tab-stop" class="card">
      <div class="row">
        <div class="input"><input id="queryStop" placeholder="Telep√ºl√©s, utca, meg√°ll√≥‚Ä¶" autocomplete="off"></div>
        <button class="btn" id="btnStopSearch">Keres√©s</button>
      </div>

      <div class="section-title">Kiemelt forgalmi v√°ltoz√°sok</div>
      <div class="chips" id="chips"><span class="chip">18</span><span class="chip">19</span><span class="chip">1</span><span class="chip">7</span><span class="chip">U1</span><span class="chip">X4</span></div>

      <div class="section-title">Tal√°latok</div>
      <div class="results" id="stopResults"></div>

      <div class="footer" id="statusLine">Friss√≠t√©s: 20 s ‚Ä¢ Build: ‚Äì</div>
    </section>

    <!-- ROUTE placeholder -->
    <section id="tab-route" class="card" style="display:none">
      <p class="muted">A viszonylat keres≈ë fel√ºlet itt fog b≈ëv√ºlni (√∫tvonal, j√°rm≈±vek).</p>
    </section>

    <!-- FAV -->
    <section id="tab-fav" class="card" style="display:none">
      <div id="favList" class="results"></div>
      <p class="muted" id="favEmpty" style="display:none">M√©g nincs kedvenc. A tal√°latokn√°l a ‚òÖ gombbal adhatsz hozz√°.</p>
    </section>

    <div id="toast" class="error"></div>
  </div>

  <!-- SETTINGS -->
  <dialog id="dlg">
    <div class="dlg-header">Be√°ll√≠t√°sok</div>
    <form method="dialog" class="dlg-body">
      <label class="muted">API el√©r√©si √∫t (√ºres = ugyanarr√≥l a domainr≈ël)</label>
      <input id="apiBase" class="input" style="padding:0">
      <div class="grid-2">
        <label class="muted">Friss√≠t√©si id≈ë (mp)</label>
        <input id="refreshSec" class="input" type="number" min="5" max="180" value="20" style="padding:0">
      </div>
      <div class="grid-2">
        <label class="muted">El≈ëretekint√©si ablak (perc)</label>
        <input id="windowMin" class="input" type="number" min="10" max="240" value="60" style="padding:0">
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
        <button class="btn" value="cancel" style="background:transparent;border:1px solid #364063;color:#e8ecf1">M√©gse</button>
        <button class="btn" value="ok">Ment√©s</button>
      </div>
    </form>
  </dialog>

  <script>
    // ---------- √°llapot ----------
    const state = {
      API_BASE: localStorage.getItem('apiBase') || '',
      REFRESH_SEC: +(localStorage.getItem('refreshSec') || 20),
      WINDOW_MIN: +(localStorage.getItem('windowMin') || 60),
      timer:null, build:'-', currentStop:null
    };
    const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);

    // ---------- seg√©dek ----------
    function showToast(msg){
      const t=$('#toast'); t.textContent=msg||'H√°l√≥zati hiba vagy API v√°lasz hiba.'; t.style.display='block';
      clearTimeout(t._h); t._h=setTimeout(()=>t.style.display='none',4200);
    }
    async function api(path){
      const url=(state.API_BASE||'')+path;
      const r=await fetch(url,{headers:{accept:'application/json'}});
      if(!r.ok) {
        const txt=await r.text().catch(()=> '');
        throw new Error(`HTTP ${r.status} ‚Äì ${txt.slice(0,160)}`);
      }
      return r.json();
    }

    // ---------- UK √≥ra ----------
    function tickClock(){
      try{
        const uk=new Intl.DateTimeFormat('hu-HU',{timeZone:'Europe/London',hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(new Date());
        $('#ukTime').textContent='UK: '+uk;
      }catch{ $('#ukTime').textContent='UK: '+new Date().toISOString().substring(11,19)+'Z'; }
    }
    setInterval(tickClock,1000); tickClock();

    // ---------- Tabs ----------
    $$('.tab').forEach(t=>t.onclick=()=>{
      $$('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
      const k=t.dataset.tab;
      $('#tab-stop').style.display=(k==='stop')?'block':'none';
      $('#tab-route').style.display=(k==='route')?'block':'none';
      $('#tab-fav').style.display=(k==='fav')?'block':'none';
    });

    // ---------- Settings ----------
    const dlg=$('#dlg');
    $('#btnSettings').onclick=()=>{
      $('#apiBase').value=state.API_BASE;
      $('#refreshSec').value=state.REFRESH_SEC;
      $('#windowMin').value=state.WINDOW_MIN;
      dlg.showModal();
    };
    dlg.addEventListener('close',()=>{
      if(dlg.returnValue==='ok'){
        state.API_BASE=$('#apiBase').value.trim();
        state.REFRESH_SEC=Math.max(5,Math.min(180,+$('#refreshSec').value||20));
        state.WINDOW_MIN=Math.max(10,Math.min(240,+$('#windowMin').value||60));
        localStorage.setItem('apiBase',state.API_BASE);
        localStorage.setItem('refreshSec',state.REFRESH_SEC);
        localStorage.setItem('windowMin',state.WINDOW_MIN);
        restartAutoRefresh(); updateStatusLine();
      }
    });

    // ---------- √Ållapot sor ----------
    async function initStatus(){
      try{
        const st=await api('/api/status'); state.build=st.build||'-';
      }catch(e){ console.warn(e); }
      updateStatusLine();
    }
    function updateStatusLine(){ $('#statusLine').textContent=`Friss√≠t√©s: ${state.REFRESH_SEC} s ‚Ä¢ Build: ${state.build}`; }

    // ---------- Kedvencek ----------
    function favs(){ return JSON.parse(localStorage.getItem('favs')||'[]'); }
    function saveFav(s){ const a=favs(); if(!a.find(x=>x.id===s.id)){a.push(s); localStorage.setItem('favs',JSON.stringify(a));} renderFavs(); }
    function delFav(id){ localStorage.setItem('favs',JSON.stringify(favs().filter(x=>x.id!==id))); renderFavs(); }
    function renderFavs(){
      const a=favs(), host=$('#favList'); host.innerHTML=''; $('#favEmpty').style.display=a.length?'none':'block';
      a.forEach(s=>{
        const row=document.createElement('div'); row.className='item';
        row.innerHTML=`<div class="pill">‚òÖ</div><div><div class="dest">${s.name}</div><div class="muted">ID: ${s.id}</div></div>
          <button class="btn small">Megnyit</button><button class="btn small" style="background:transparent;border:1px solid #364063;color:#e8ecf1">T√∂rl√©s</button>`;
        row.children[2].onclick=()=>openDepartures(s); row.children[3].onclick=()=>delFav(s.id);
        host.appendChild(row);
      });
    }

    // ---------- Stop-keres√©s ----------
    async function searchStops(){
      const q=$('#queryStop').value.trim(); $('#stopResults').innerHTML='';
      if(!q) return;
      try{
        const variants=[
          `/api/live/stop-search?q=${encodeURIComponent(q)}`,
          `/api/live/stop-search?query=${encodeURIComponent(q)}`,
          `/api/live/stop-search?term=${encodeURIComponent(q)}`
        ];
        let items=null, lastErr=null;
        for(const p of variants){
          try{ items=await api(p); if(Array.isArray(items)) break; }catch(e){ lastErr=e; }
        }
        if(!Array.isArray(items)) throw lastErr||new Error('Ismeretlen API v√°lasz (stop-search).');

        if(!items.length){ $('#stopResults').innerHTML=`<div class="muted">Nincs tal√°lat: <b>${q}</b></div>`; return; }
        renderStopList(items);
      }catch(e){
        console.error(e); showToast('Meg√°ll√≥keres√©s hiba: '+e.message);
      }
    }
    function renderStopList(items){
      const host=$('#stopResults'); host.innerHTML='';
      items.forEach(s=>{
        const row=document.createElement('div'); row.className='item';
        row.innerHTML=`<div class="pill">BUS</div><div><div class="dest">${s.name||s.stop_name||'Ismeretlen'}</div><div class="muted">ID: ${s.id||s.stop_id}</div></div>
          <button class="btn small" title="Kedvenc">‚òÖ</button><button class="btn small">Megnyit</button>`;
        const stopObj={ id:s.id||s.stop_id, name:s.name||s.stop_name||String(s.id||s.stop_id) };
        row.children[2].onclick=ev=>{ev.stopPropagation(); saveFav(stopObj);};
        row.children[3].onclick=()=>openDepartures(stopObj);
        row.onclick=()=>openDepartures(stopObj);
        host.appendChild(row);
      });
    }

    // ---------- Indul√°sok: "mindent elk√ºld√ºnk" megold√°s ----------
    async function openDepartures(stop){
      state.currentStop=stop; await loadDepartures(); restartAutoRefresh();
    }
    async function loadDepartures(){
      if(!state.currentStop) return;
      const host=$('#stopResults');
      const loader=document.createElement('div'); loader.className='muted'; loader.textContent='Bet√∂lt√©s‚Ä¶'; host.prepend(loader);
      try{
        const id=encodeURIComponent(state.currentStop.id);
        const mins=encodeURIComponent(state.WINDOW_MIN);
        // Egyetlen k√©r√©s: elk√ºldj√ºk az √∂sszes ismert n√©vv√°ltozatot is
        const url = `/api/live/departures?stopId=${id}&stop_id=${id}&stop=${id}&id=${id}&window=${mins}&window_mins=${mins}&minutes=${mins}&horizon=${mins}`;
        const list = await api(url);
        if(!Array.isArray(list)) throw new Error('Ismeretlen API v√°lasz (departures).');

        const wrap=document.createElement('div'); wrap.className='results';
        wrap.innerHTML=`<div class="section-title">Kiv√°lasztott meg√°ll√≥: ${state.currentStop.name} ‚Äî friss√ºl ${state.REFRESH_SEC} mp-enk√©nt</div>`;
        list.forEach(d=>{
          const row=document.createElement('div'); row.className='item';
          const line=d.line||d.route||d.service||'';
          const dest=d.destination||d.headsign||'';
          const exp=d.expected||d.expected_time||d.time||'--:--';
          const due=(d.due_in_min!=null)?(d.due_in_min===0?'Due':d.due_in_min+"'"): (d.due||'');
          row.innerHTML=`<div class="pill">${String(line).slice(0,4)}</div>
            <div style="min-width:0"><div class="dest" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${dest}</div>
            <div class="muted">V√°rhat√≥: ${exp}</div></div><div class="due">${due}</div>`;
          wrap.appendChild(row);
        });

        host.innerHTML='';
        const head=document.createElement('div'); head.className='item';
        head.innerHTML=`<div class="pill">BUS</div><div class="dest">${state.currentStop.name}</div>
          <button class="btn small" title="Kedvenc">‚òÖ</button>`;
        head.querySelector('button').onclick=()=>saveFav(state.currentStop);
        host.appendChild(head); host.appendChild(wrap);
      }catch(e){ console.error(e); showToast('Indul√°sok hiba: '+e.message); }
      finally{ loader.remove(); }
    }
    function restartAutoRefresh(){ if(state.timer) clearInterval(state.timer); if(state.currentStop){ state.timer=setInterval(loadDepartures,state.REFRESH_SEC*1000); } }

    // ---------- Esem√©nyek ----------
    $('#btnStopSearch').onclick=searchStops;
    $('#queryStop').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); searchStops(); }});
    $('#chips').onclick=e=>{ if(e.target.classList.contains('chip')){ $('#queryStop').value=e.target.textContent.trim(); searchStops(); } };
    $('#btnDrawer').onclick=()=>showToast('Men√º: k√∂zlem√©nyek, kedvencek friss√≠t√©se, n√©vjegy ‚Äì hamarosan.');

    // ---------- Boot ----------
    (async function boot(){ renderFavs(); updateStatusLine(); await initStatus(); })();
  </script>
</body>
</html>
