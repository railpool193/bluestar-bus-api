<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bluestar Bus – Megálló keresés</title>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    /* Ha van külön style.css, ez csak apró kiegészítés */
    body { max-width: 960px; margin: 0 auto; padding: 16px; font-family: system-ui, sans-serif; }
    h1 { margin: 0 0 12px; }
    .card { background: #0f1115; color: #eaeaea; border: 1px solid #252a34; border-radius: 12px; padding: 16px; margin: 12px 0; }
    .row { display: grid; gap: 12px; grid-template-columns: 1fr 120px 120px; }
    input, select, button { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #343b47; background: #151923; color: #eaeaea; }
    button { background: #3b82f6; border: none; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { padding: 10px; border-bottom: 1px solid #2a3140; text-align: left; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: .75rem; }
    .pill-live { background: #22c55e22; color: #22c55e; border: 1px solid #22c55e55; }
    .muted { color: #94a3b8; }
    .hint { font-size: .85rem; color: #a1a1aa; margin-top: 6px; }
    .small { font-size: .9rem; }
    @media (max-width: 640px) {
      .row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <h1>Bluestar Bus – Megálló keresés</h1>

  <div class="card">
    <div class="row">
      <div>
        <label for="q" class="small muted">Megálló neve</label>
        <input id="q" type="text" placeholder="Írj pár betűt (pl. Vincent) és Enter…" />
        <div class="hint">Tipp: írd be a települést is (pl. <em>Southampton, Vincent</em>), hogy könnyebb legyen találni.</div>
      </div>
      <div>
        <label for="minutes" class="small muted">Időablak (perc)</label>
        <select id="minutes">
          <option value="30">30</option>
          <option value="60" selected>60</option>
          <option value="90">90</option>
          <option value="120">120</option>
        </select>
      </div>
      <div>
        <label class="small muted">&nbsp;</label>
        <button id="btn-search">Keresés</button>
      </div>
    </div>

    <div id="stops" class="hint" style="margin-top:12px;">Nincs találat. Kezdj el gépelni és nyomj Entert vagy kattints a Keresés gombra.</div>
  </div>

  <div class="card">
    <h3 id="chosen-stop" class="muted" style="margin-top:0;">Nincs kiválasztott megálló</h3>
    <table id="results-table" style="display:none;">
      <thead>
        <tr>
          <th>Route</th>
          <th>Destination</th>
          <th>Time</th>
          <th>Forrás</th>
        </tr>
      </thead>
      <tbody id="results-body"></tbody>
    </table>
    <div id="no-results" class="hint">Nincs indulás ebben az időablakban.</div>
  </div>

  <script>
    const qEl = document.getElementById('q');
    const minutesEl = document.getElementById('minutes');
    const btnSearch = document.getElementById('btn-search');
    const stopsEl = document.getElementById('stops');

    const chosenStopEl = document.getElementById('chosen-stop');
    const tableEl = document.getElementById('results-table');
    const tbodyEl = document.getElementById('results-body');
    const noResultsEl = document.getElementById('no-results');

    async function apiGet(path) {
      const res = await fetch(path, { headers: { 'accept': 'application/json' }});
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return res.json();
    }

    async function searchStops() {
      const q = qEl.value.trim();
      if (!q) { stopsEl.textContent = 'Írj be valamit a kereséshez.'; return; }
      stopsEl.textContent = 'Keresés…';
      try {
        const data = await apiGet(`/api/stops/search?q=${encodeURIComponent(q)}`);
        if (!data || !data.length) { stopsEl.textContent = 'Nincs találat.'; return; }
        // listázzuk kattinthatóvá
        const ul = document.createElement('ul');
        ul.style.listStyle = 'none';
        ul.style.padding = '0';
        data.forEach(s => {
          const li = document.createElement('li');
          li.style.padding = '8px 0';
          li.style.borderBottom = '1px solid #2a3140';
          const a = document.createElement('a');
          a.href = '#';
          a.textContent = `${s.stop_name} — ${s.stop_id}`;
          a.addEventListener('click', (e) => {
            e.preventDefault();
            loadDepartures(s.stop_id, s.stop_name);
          });
          li.appendChild(a);
          ul.appendChild(li);
        });
        stopsEl.innerHTML = '';
        stopsEl.appendChild(ul);
      } catch (err) {
        stopsEl.textContent = `Hiba a keresésnél: ${err.message}`;
      }
    }

    async function loadDepartures(stopId, stopName) {
      chosenStopEl.textContent = `${stopName} — ${stopId}`;
      tbodyEl.innerHTML = '';
      tableEl.style.display = 'none';
      noResultsEl.style.display = 'block';

      const minutes = Number(minutesEl.value || 60);
      try {
        const data = await apiGet(`/api/stops/${encodeURIComponent(stopId)}/next_departures?minutes=${minutes}`);
        const rows = (data && data.results) || [];
        if (!rows.length) { return; }
        noResultsEl.style.display = 'none';
        tableEl.style.display = 'table';
        rows.forEach(r => {
          const tr = document.createElement('tr');
          const tdRoute = document.createElement('td');
          const tdDest = document.createElement('td');
          const tdTime = document.createElement('td');
          const tdLive = document.createElement('td');

          tdRoute.textContent = r.route || '';
          tdDest.textContent  = r.destination || '';

          // idő formázás helyi szerint
          const dt = r.time_iso ? new Date(r.time_iso) : null;
          tdTime.textContent = dt ? dt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';

          // live jelző
          if (r.is_live) {
            const pill = document.createElement('span');
            pill.className = 'pill pill-live';
            pill.textContent = 'live';
            tdLive.appendChild(pill);
          } else {
            tdLive.innerHTML = '<span class="muted">GTFS</span>';
          }

          tr.appendChild(tdRoute);
          tr.appendChild(tdDest);
          tr.appendChild(tdTime);
          tr.appendChild(tdLive);
          tbodyEl.appendChild(tr);
        });
      } catch (err) {
        noResultsEl.style.display = 'block';
        noResultsEl.textContent = `Hiba a letöltésnél: ${err.message}`;
      }
    }

    // UI események
    btnSearch.addEventListener('click', searchStops);
    qEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') searchStops();
    });

    // opcionális: státusz kiírás
    (async () => {
      try {
        const st = await apiGet('/api/status');
        const ok = st?.status === 'ok';
        const gtfs = st?.gtfs_loaded ? 'betöltve' : 'nincs betöltve';
        const siri = st?.siri_configured ? 'SIRI OK' : 'SIRI nincs';
        const p = document.createElement('div');
        p.className = 'hint';
        p.textContent = ok ? `Státusz: OK • GTFS: ${gtfs} • ${siri}` : 'Státusz: hiba';
        document.body.insertBefore(p, document.body.firstChild.nextSibling);
      } catch { /* csendben: nem létfontosságú */ }
    })();
  </script>
</body>
</html>
