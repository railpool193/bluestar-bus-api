<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë</title>
  <link rel="icon" href="data:," />
  <style>
    :root{
      --bg:#0e1320;--panel:#151b2f;--panel-2:#0f1629;--text:#e6ebff;--muted:#9aa6c1;
      --primary:#6a77ff;--good:#18c08f;--bad:#ff6b6b;--chip:#223056;--chip-t:#bcd4ff;
      --row:#1a2139;--row-alt:#151c31;
      --shadow:0 8px 28px rgba(0,0,0,.35);
      --radius:16px
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:980px;margin:0 auto;padding:20px}
    h1{display:flex;align-items:center;gap:.5rem;font-weight:800;letter-spacing:.2px;margin:8px 0 20px}
    h1 .bus{font-size:28px}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
    .tabs{display:flex;gap:12px;margin-bottom:16px}
    .tab{border:none;border-radius:999px;padding:10px 18px;background:#222b47;color:#93a6d8}
    .tab.active{background:#2f3b6a;color:#fff}
    .grid{display:grid;grid-template-columns:1fr auto;gap:14px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    label{display:block;font-size:13px;color:var(--muted);margin:6px 2px}
    input,select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #2a3354;background:#0c1122;color:#dfe6ff}
    button.primary{padding:12px 18px;border:none;border-radius:12px;background:var(--primary);color:white;font-weight:700}
    .badges{display:flex;gap:14px;align-items:center;margin:10px 0 14px;color:var(--muted)}
    .dot{width:10px;height:10px;border-radius:50%}
    .ok{background:var(--good)} .no{background:var(--bad)}
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th,td{padding:14px}
    thead th{color:#9fb0d8;font-weight:700}
    tbody tr{background:var(--row);border-radius:12px}
    tbody tr:nth-child(even){background:var(--row-alt)}
    tbody tr td:first-child{border-radius:12px 0 0 12px}
    tbody tr td:last-child{border-radius:0 12px 12px 0}
    .chip{display:inline-flex;min-width:38px;justify-content:center;padding:6px 10px;border-radius:999px;background:var(--chip);color:var(--chip-t);font-weight:700}
    .muted{color:var(--muted)}
    .footer{opacity:.7;margin-top:18px;font-size:13px}
    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:18px}
    .modal.open{display:flex}
    .modal .box{width:min(860px,95vw);max-height:85vh;overflow:auto;background:linear-gradient(180deg,var(--panel),var(--panel-2));border-radius:18px;padding:18px;box-shadow:var(--shadow)}
    .modal h3{margin:0 0 12px}
    .close{border:none;background:#2a355f;color:#bcd4ff;border-radius:8px;padding:6px 10px;float:right}
    /* Map placeholder container */
    #routeMap{width:100%;height:360px;border-radius:14px;overflow:hidden;background:#0c1122}
    /* Mobile tweaks */
    @media (max-width:640px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <h1><span class="bus">üöå</span> Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë</h1>

    <div class="card">
      <div class="tabs">
        <button id="tabStop"  class="tab active">Meg√°ll√≥</button>
        <button id="tabRoute" class="tab">Vonal</button>
      </div>

      <!-- STOP PANEL -->
      <div id="panelStop">
        <div class="grid">
          <div>
            <label>Meg√°ll√≥ n√©v</label>
            <input id="stopQuery" placeholder="Pl. Vincent‚Ä¶" />
          </div>
          <div>
            <label>Id≈ëablak (perc)</label>
            <input id="minutes" type="number" value="60" min="5" max="240"/>
          </div>
          <div></div>
          <div style="display:flex;align-items:flex-end;justify-content:flex-end">
            <button id="btnSearchStop" class="primary">Keres√©s</button>
          </div>
        </div>

        <label>Tal√°latok ‚Äì v√°lassz meg√°ll√≥t</label>
        <select id="stopSelect"></select>

        <div class="badges">
          <span><span id="apiDot"   class="dot no"></span> API</span>
          <span><span id="gtfsDot"  class="dot no"></span> GTFS</span>
          <span><span id="liveDot"  class="dot no"></span> Live</span>
          <span class="muted" id="chosenStopNote"></span>
        </div>

        <div style="overflow:auto">
          <table>
            <thead>
              <tr>
                <th>J√°rat</th>
                <th>C√©l</th>
                <th>Indul√°s</th>
                <th>√âl≈ë</th>
                <th>Rendsz√°m</th>
                <th>T√≠pus</th>
              </tr>
            </thead>
            <tbody id="depBody"></tbody>
          </table>
        </div>
      </div>

      <!-- ROUTE PANEL -->
      <div id="panelRoute" style="display:none">
        <div class="grid">
          <div>
            <label>Vonal sz√°ma/n√©v</label>
            <input id="routeQuery" placeholder="Pl. 18‚Ä¶" />
          </div>
          <div></div>
          <div></div>
          <div style="display:flex;align-items:flex-end;justify-content:flex-end">
            <button id="btnSearchRoute" class="primary">Keres√©s</button>
          </div>
        </div>

        <label>Tal√°latok ‚Äì v√°lassz vonalat</label>
        <select id="routeSelect"></select>

        <div id="routeMap" class="card" style="margin-top:12px"></div>
        <div class="muted" style="margin-top:8px">Ha nincs √©l≈ë j√°rm≈±, a t√©rk√©p √ºres marad.</div>
      </div>

      <div class="footer muted" id="buildInfo"></div>
    </div>
  </div>

  <!-- Trip modal -->
  <div id="tripModal" class="modal" role="dialog" aria-modal="true">
    <div class="box">
      <button class="close" id="closeTrip">‚úï</button>
      <h3 id="tripTitle">J√°rat r√©szletek</h3>
      <div style="overflow:auto">
        <table>
          <thead><tr><th>Id≈ë</th><th>Meg√°ll√≥</th></tr></thead>
          <tbody id="tripBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- OPTIONAL: Leaflet for map (CDN) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="" crossorigin=""></script>

  <script>
  (()=> {
    const Q = (s,root=document)=>root.querySelector(s)
    const Qa = (s,root=document)=>[...root.querySelectorAll(s)]
    const api = (p, params={}) => {
      // cache bypass
      const v = Date.now().toString()
      const url = p + (p.includes('?') ? '&' : '?') + 'v='+v
      return fetch(url, params).then(r=>r.json())
    }

    const dots = {api:Q('#apiDot'), gtfs:Q('#gtfsDot'), live:Q('#liveDot')}
    const setDot = (el, ok)=>{ el.classList.toggle('ok', ok); el.classList.toggle('no', !ok) }

    // Tabs
    const tabStop = Q('#tabStop'), tabRoute = Q('#tabRoute')
    const panelStop = Q('#panelStop'), panelRoute = Q('#panelRoute')
    tabStop.onclick = ()=>{ tabStop.classList.add('active'); tabRoute.classList.remove('active'); panelStop.style.display='block'; panelRoute.style.display='none' }
    tabRoute.onclick= ()=>{ tabRoute.classList.add('active'); tabStop.classList.remove('active'); panelRoute.style.display='block'; panelStop.style.display='none' }

    // Build info + status lights
    api('/api/status').then(s=>{
      Q('#buildInfo').textContent = `Build: ${s.build} ¬∑ Cache-bypass akt√≠v`
      setDot(dots.api, true)
      setDot(dots.gtfs, !!s.gtfs)
      setDot(dots.live, !!s.live)
    }).catch(()=>{ setDot(dots.api,false); setDot(dots.gtfs,false); setDot(dots.live,false) })

    // Elements
    const stopQuery = Q('#stopQuery'), minutes = Q('#minutes'), stopSelect = Q('#stopSelect'), depBody = Q('#depBody'), chosenNote = Q('#chosenStopNote')
    const routeQuery = Q('#routeQuery'), routeSelect = Q('#routeSelect')
    let leafletMap=null, leafletLayer=null

    // --- STOP SEARCH ---
    Q('#btnSearchStop').onclick = async ()=>{
      depBody.innerHTML = ''
      stopSelect.innerHTML = ''
      chosenNote.textContent = 'Keres√©s‚Ä¶'
      const q = stopQuery.value.trim()
      if(!q){ chosenNote.textContent = '√çrj be egy meg√°ll√≥nevet.'; return }
      try{
        const data = await api('/api/stops/search?q='+encodeURIComponent(q))
        if(!data || !data.length){ chosenNote.textContent = 'Nincs tal√°lat.'; return }
        data.forEach((s,i)=>{
          const opt = document.createElement('option')
          opt.value = s.stop_id
          opt.textContent = `${s.stop_name} (${s.stop_id})`
          stopSelect.appendChild(opt)
        })
        chosenNote.textContent = 'V√°lassz egy meg√°ll√≥t, az indul√°sok automatikusan bet√∂lt≈ëdnek.'
        stopSelect.onchange()
      }catch(e){ chosenNote.textContent='Hiba a keres√©sn√©l.' }
    }

    stopSelect.onchange = async ()=>{
      const stop_id = stopSelect.value
      if(!stop_id){ return }
      chosenNote.textContent = 'Indul√°sok bet√∂lt√©se‚Ä¶'
      depBody.innerHTML = ''
      try{
        const m = Number(minutes.value||60)
        const deps = await api(`/api/stops/${encodeURIComponent(stop_id)}/next_departures?minutes=${m}`)
        chosenNote.textContent = `V√°lasztott meg√°ll√≥: ${stop_id}`
        renderDepartures(deps||[], stop_id)
      }catch(e){ chosenNote.textContent='Hiba az indul√°sok lek√©r√©sekor.' }
    }

    // render departures + attach click to open trip modal
    async function renderDepartures(deps, stop_id){
      depBody.innerHTML=''
      if(!deps.length){
        depBody.innerHTML = `<tr><td colspan="6" class="muted">Nincs indul√°s az id≈ëablakban.</td></tr>`
        return
      }
      // csoportos√≠tunk route szerint, hogy min√©l kevesebb live h√≠v√°s legyen
      const routes = [...new Set(deps.map(d=>d.route_short_name||d.route||'').filter(Boolean))]
      const liveByRoute = {}
      // √âl≈ë adatok lek√©r√©se p√°rhuzamosan (ha van live)
      try{
        const status = await api('/api/status')
        if(status.live){
          await Promise.all(routes.map(async r=>{
            liveByRoute[r] = await api(`/api/routes/${encodeURIComponent(r)}/vehicles`).catch(()=>[])
          }))
        }
      }catch{}

      // Seg√©df√ºggv√©ny: megpr√≥b√°ljuk √∂sszep√°ros√≠tani a departure-t a route live j√°rm≈±veihez
      const findLiveFor = (d)=>{
        const arr = liveByRoute[d.route_short_name||d.route||'']||[]
        // pr√≥b√°ljunk trip_id alapj√°n, ha van
        if(d.trip_id){
          const hit = arr.find(v=>v.trip_id && v.trip_id===d.trip_id)
          if(hit) return hit
        }
        // m√°sodik es√©ly: headsign / direction (best-effort)
        if(d.headsign){
          const norm = s=>String(s).toLowerCase().replace(/\s+/g,'').replace(/[^\p{L}\p{N}]/gu,'')
          const h = norm(d.headsign)
          const hit = arr.find(v=>norm(v.headsign||v.destination||'')===h)
          if(hit) return hit
        }
        return null
      }

      deps.forEach(d=>{
        const tr = document.createElement('tr')
        tr.innerHTML = `
          <td><span class="chip">${escapeHtml(d.route_short_name||d.route||'?')}</span></td>
          <td>${escapeHtml(d.headsign||d.destination||'')}</td>
          <td>${escapeHtml(d.departure_time||d.time||'')}</td>
          <td class="liveCell muted">‚Äì</td>
          <td class="regCell  muted">‚Äì</td>
          <td class="typCell  muted">‚Äì</td>
        `
        // kattint√°s = trip modal
        if(d.trip_id){
          tr.style.cursor='pointer'
          tr.addEventListener('click', ()=> openTripModal(d))
          tr.title = 'Koppints a j√°rat r√©szleteihez'
        }
        depBody.appendChild(tr)

        // √©l≈ë kit√∂lt√©se (ha van tal√°lat)
        const live = findLiveFor(d)
        if(live){
          // ETA becsl√©s: ha a backend ad "eta_minutes", haszn√°ljuk, k√ºl√∂nben hagyjuk ‚Äû‚Äì‚Äù-on
          const eta = live.eta_minutes!=null ? `${live.eta_minutes}‚Ä≤` : '‚Ä¢'
          tr.querySelector('.liveCell').textContent = eta
          tr.querySelector('.liveCell').classList.remove('muted')

          if(live.registration){ tr.querySelector('.regCell').textContent = live.registration; tr.querySelector('.regCell').classList.remove('muted') }
          if(live.vehicle_type){ tr.querySelector('.typCell').textContent = live.vehicle_type; tr.querySelector('.typCell').classList.remove('muted') }
        }
      })
    }

    // --- TRIP MODAL ---
    const tripModal = Q('#tripModal'), tripBody = Q('#tripBody'), tripTitle = Q('#tripTitle')
    Q('#closeTrip').onclick = ()=> tripModal.classList.remove('open')

    async function openTripModal(dep){
      tripBody.innerHTML = '<tr><td colspan="2" class="muted">Bet√∂lt√©s‚Ä¶</td></tr>'
      tripTitle.textContent = `J√°rat ${dep.route_short_name||dep.route||''} ‚Äì ${dep.headsign||''} (trip: ${dep.trip_id||'?'})`
      tripModal.classList.add('open')
      if(!dep.trip_id){ tripBody.innerHTML = '<tr><td colspan="2" class="muted">Ehhez a sorhoz nincs trip azonos√≠t√≥.</td></tr>'; return }
      try{
        const t = await api(`/api/trips/${encodeURIComponent(dep.trip_id)}`)
        const rows = (t.stop_times||t.stops||[]).map(st=>{
          const time = st.arrival_time || st.departure_time || st.time || ''
          const name = st.stop_name || st.name || ''
          return `<tr><td>${escapeHtml(time)}</td><td>${escapeHtml(name)}</td></tr>`
        }).join('')
        tripBody.innerHTML = rows || '<tr><td colspan="2" class="muted">Nincs menetrendi adat ehhez a triphez.</td></tr>'
      }catch(e){
        tripBody.innerHTML = '<tr><td colspan="2" class="muted">Hiba a trip lek√©r√©sekor.</td></tr>'
      }
    }

    // --- ROUTE SEARCH + MAP ---
    Q('#btnSearchRoute').onclick = async ()=>{
      routeSelect.innerHTML=''
      const q = routeQuery.value.trim()
      if(!q) return
      const res = await api('/api/routes/search?q='+encodeURIComponent(q)).catch(()=>[])
      if(!res.length){ const o=document.createElement('option');o.textContent='Nincs tal√°lat';routeSelect.appendChild(o);return }
      res.forEach(r=>{
        const o=document.createElement('option')
        o.value = r.route_short_name || r.route || r.id
        o.textContent = r.long_name ? `${o.value} ‚Äì ${r.long_name}` : o.value
        routeSelect.appendChild(o)
      })
      await loadRouteVehicles(routeSelect.value)
    }

    routeSelect.onchange = ()=> loadRouteVehicles(routeSelect.value)

    async function loadRouteVehicles(route){
      if(!route) return
      const vehicles = await api(`/api/routes/${encodeURIComponent(route)}/vehicles`).catch(()=>[])
      ensureMap()
      // t√∂r√∂lj√ºk az el≈ëz≈ë r√©teget
      if(leafletLayer){ leafletLayer.clearLayers() } else { leafletLayer = L.layerGroup().addTo(leafletMap) }
      if(!vehicles.length) return
      vehicles.forEach(v=>{
        const m = L.marker([v.lat||v.latitude, v.lon||v.longitude], {rotationAngle: v.bearing||0})
        const title = [
          `<b>${escapeHtml(v.registration||v.label||'J√°rm≈±')}</b>`,
          `Vonal: ${escapeHtml(route)}`,
          v.headsign? `Ir√°ny: ${escapeHtml(v.headsign)}`:'',
          v.vehicle_type? `T√≠pus: ${escapeHtml(v.vehicle_type)}`:''
        ].filter(Boolean).join('<br/>')
        m.bindPopup(title)
        leafletLayer.addLayer(m)
      })
      // f√≥kusz
      const grp = L.featureGroup(leafletLayer.getLayers())
      leafletMap.fitBounds(grp.getBounds().pad(0.2))
    }

    function ensureMap(){
      if(leafletMap) return
      leafletMap = L.map('routeMap')
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '&copy; OpenStreetMap'
      }).addTo(leafletMap)
      leafletMap.setView([50.9,-1.4], 12)
    }

    // Utils
    function escapeHtml(s){ return String(s??'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) }

    // Autof√≥kusz ‚Äì k√©nyelmi
    stopQuery.focus()
  })();
  </script>
</body>
</html>
