<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë</title>
  <link rel="icon" href="data:,"/>
  <style>
    :root{
      --bg:#0e1320;--panel:#151b2f;--panel-2:#0f1629;--text:#e6ebff;--muted:#9aa6c1;
      --primary:#6a77ff;--good:#18c08f;--bad:#ff6b6b;--chip:#223056;--chip-t:#bcd4ff;
      --row:#1a2139;--row-alt:#151c31;--shadow:0 8px 28px rgba(0,0,0,.35);--radius:16px
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:980px;margin:0 auto;padding:20px}
    h1{display:flex;gap:.5rem;align-items:center;margin:8px 0 20px;font-weight:800}
    .bus{font-size:28px}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
    .tabs{display:flex;gap:12px;margin-bottom:16px}
    .tab{border:none;border-radius:999px;padding:10px 18px;background:#222b47;color:#93a6d8}
    .tab.active{background:#2f3b6a;color:#fff}
    .grid{display:grid;grid-template-columns:1fr auto;gap:14px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    label{display:block;font-size:13px;color:var(--muted);margin:6px 2px}
    input,select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #2a3354;background:#0c1122;color:#dfe6ff}
    button.primary{padding:12px 18px;border:none;border-radius:12px;background:var(--primary);color:#fff;font-weight:700}
    .badges{display:flex;gap:14px;align-items:center;margin:10px 0 14px;color:var(--muted);flex-wrap:wrap}
    .dot{width:10px;height:10px;border-radius:50%}.ok{background:var(--good)}.no{background:var(--bad)}
    .small{font-size:13px}
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th,td{padding:14px}
    thead th{color:#9fb0d8;font-weight:700}
    tbody tr{background:var(--row)} tbody tr:nth-child(even){background:var(--row-alt)}
    tbody tr td:first-child{border-radius:12px 0 0 12px}
    tbody tr td:last-child{border-radius:0 12px 12px 0}
    .chip{display:inline-flex;min-width:38px;justify-content:center;padding:6px 10px;border-radius:999px;background:var(--chip);color:var(--chip-t);font-weight:700}
    .muted{color:var(--muted)} .footer{opacity:.7;margin-top:18px;font-size:13px}
    #routeMap{width:100%;height:360px;border-radius:14px;overflow:hidden;background:#0c1122}
    .live{color:var(--good);font-weight:700}
    @keyframes blink { 50% { opacity:.2 } }
    .blink{animation:blink 1s linear infinite}
    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:18px}
    .modal.open{display:flex}
    .modal .box{width:min(900px,95vw);max-height:85vh;overflow:auto;background:linear-gradient(180deg,var(--panel),var(--panel-2));border-radius:18px;padding:18px;box-shadow:var(--shadow)}
    .close{border:none;background:#2a355f;color:#bcd4ff;border-radius:8px;padding:6px 10px;float:right}
    #tripMap{width:100%;height:260px;border-radius:12px;margin-bottom:12px;background:#0c1122}
    @media (max-width:640px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <h1><span class="bus">üöå</span> Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë</h1>

    <div class="card">
      <div class="tabs">
        <button id="tabStop" class="tab active">Meg√°ll√≥</button>
        <button id="tabRoute" class="tab">Vonal</button>
      </div>

      <!-- STOP -->
      <div id="panelStop">
        <div class="grid">
          <div><label>Meg√°ll√≥ n√©v</label><input id="stopQuery" placeholder="Pl. Vincent‚Ä¶"/></div>
          <div><label>Id≈ëablak (perc)</label><input id="minutes" type="number" value="60" min="5" max="240"/></div>
          <div></div>
          <div style="display:flex;align-items:flex-end;justify-content:flex-end"><button id="btnSearchStop" class="primary">Keres√©s</button></div>
        </div>

        <label>Tal√°latok ‚Äì v√°lassz meg√°ll√≥t</label>
        <select id="stopSelect"></select>

        <div class="badges">
          <span><span id="apiDot" class="dot no"></span> API</span>
          <span><span id="gtfsDot" class="dot no"></span> GTFS</span>
          <span><span id="liveDot" class="dot no"></span> Live</span>
          <span class="muted" id="chosenStopNote"></span>
          <span id="refreshBadge" class="small"></span>
        </div>

        <div style="overflow:auto">
          <table>
            <thead><tr>
              <th>J√°rat</th><th>C√©l</th><th>Indul√°s</th><th>√âl≈ë</th><th>Rendsz√°m</th><th>T√≠pus</th>
            </tr></thead>
            <tbody id="depBody"></tbody>
          </table>
        </div>
      </div>

      <!-- ROUTE -->
      <div id="panelRoute" style="display:none">
        <div class="grid">
          <div><label>Vonal sz√°ma/n√©v</label><input id="routeQuery" placeholder="Pl. 18‚Ä¶"/></div>
          <div></div><div></div>
          <div style="display:flex;align-items:flex-end;justify-content:flex-end"><button id="btnSearchRoute" class="primary">Keres√©s</button></div>
        </div>

        <label>Tal√°latok ‚Äì v√°lassz vonalat</label>
        <select id="routeSelect"></select>

        <div id="routeMap" class="card" style="margin-top:12px"></div>
        <div class="muted" style="margin-top:8px">Ha nincs √©l≈ë j√°rm≈±, a t√©rk√©p √ºres marad.</div>
      </div>

      <div class="footer muted" id="buildInfo"></div>
    </div>
  </div>

  <!-- Trip modal -->
  <div id="tripModal" class="modal" role="dialog" aria-modal="true">
    <div class="box">
      <button class="close" id="closeTrip">‚úï</button>
      <h3 id="tripTitle" style="margin-top:0">J√°rat r√©szletek</h3>
      <div id="tripMap"></div>
      <div style="overflow:auto">
        <table>
          <thead><tr><th>Id≈ë</th><th>Meg√°ll√≥</th></tr></thead>
          <tbody id="tripBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
  (()=> {
    const Q = (s,root=document)=>root.querySelector(s)
    const esc=s=>String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))
    const num = n => Number.isFinite(+n) ? +n : null

    // cache-bypass minden k√©r√©sn√©l
    const api = (p, params={})=>{
      const v = Date.now().toString()
      const url = p + (p.includes('?')?'&':'?') + 'v='+v
      return fetch(url, params).then(r=>r.json())
    }

    // --- Status p√∂tty√∂k
    const dots={api:Q('#apiDot'),gtfs:Q('#gtfsDot'),live:Q('#liveDot')}
    const setDot=(el,ok)=>{el.classList.toggle('ok',ok);el.classList.toggle('no',!ok)}
    api('/api/status').then(s=>{
      setDot(dots.api,true); setDot(dots.gtfs,!!s.gtfs); setDot(dots.live,!!s.live)
      Q('#buildInfo').textContent = `Build: ${s.build} ¬∑ Cache-bypass akt√≠v`
    }).catch(()=>{ /* ha hib√°s, maradnak pirosan */ })

    // Tabs
    const tabStop=Q('#tabStop'),tabRoute=Q('#tabRoute'),panelStop=Q('#panelStop'),panelRoute=Q('#panelRoute')
    tabStop.onclick = ()=>{tabStop.classList.add('active');tabRoute.classList.remove('active');panelStop.style.display='block';panelRoute.style.display='none'}
    tabRoute.onclick= ()=>{tabRoute.classList.add('active');tabStop.classList.remove('active');panelRoute.style.display='block';panelStop.style.display='none'}

    // Elems
    const stopQuery=Q('#stopQuery'), minutes=Q('#minutes'), stopSelect=Q('#stopSelect'), depBody=Q('#depBody'), chosenNote=Q('#chosenStopNote')
    const routeQuery=Q('#routeQuery'), routeSelect=Q('#routeSelect'), refreshBadge=Q('#refreshBadge')

    // --- Keres√©s meg√°ll√≥ra ---
    Q('#btnSearchStop').onclick = async ()=>{
      depBody.innerHTML=''; stopSelect.innerHTML=''; chosenNote.textContent='Keres√©s‚Ä¶'
      const q=stopQuery.value.trim(); if(!q){chosenNote.textContent='√çrj be egy meg√°ll√≥nevet.';return}
      try{
        const list=await api('/api/stops/search?q='+encodeURIComponent(q))
        if(!list?.length){chosenNote.textContent='Nincs tal√°lat.';return}
        list.forEach(s=>{
          const o=document.createElement('option');o.value=s.stop_id;o.textContent=`${s.stop_name} (${s.stop_id})`;stopSelect.appendChild(o)
        })
        chosenNote.textContent='V√°lassz egy meg√°ll√≥t ‚Äì az indul√°sok bet√∂lt≈ëdnek.'
        stopSelect.onchange()
      }catch{ chosenNote.textContent='Hiba a keres√©sn√©l.' }
    }

    // --- √Ålland√≥ friss√≠t√©s 5 mp-enk√©nt (l√°that√≥ visszasz√°ml√°l√≥val) ---
    let tickInt=null, reloadIn=5, lastStop=null
    function startTicker(){
      clearInterval(tickInt); reloadIn = 5
      refreshBadge.textContent = `Friss√≠t√©s: ${reloadIn}s`
      tickInt = setInterval(()=>{
        reloadIn--; if(reloadIn<=0){ reloadIn=5; if(lastStop) stopSelect.onchange(true) }
        refreshBadge.textContent = `Friss√≠t√©s: ${reloadIn}s`
      }, 1000)
    }

    stopSelect.onchange = async (auto=false)=>{
      const stop_id=stopSelect.value; if(!stop_id) return
      lastStop = stop_id
      if(!auto){ chosenNote.textContent='Indul√°sok bet√∂lt√©se‚Ä¶' }
      depBody.innerHTML=''
      try{
        const m=Number(minutes.value||60)
        let deps=await api(`/api/stops/${encodeURIComponent(stop_id)}/next_departures?minutes=${m}`) || []

        // ---- DEDUP: trip_id el≈ënyben; ha nincs, route+headsign+time (m√°sodpercek n√©lk√ºl)
        const seen=new Set(), out=[]
        for(const d of deps){
          const time=(d.departure_time||d.time||'').slice(0,5)
          const key = d.trip_id || `${d.route_short_name||d.route||''}|${(d.headsign||d.destination||'').toLowerCase()}|${time}`
          if(seen.has(key)) continue; seen.add(key); out.push({...d, __timeHHMM: time})
        }
        deps = out

        chosenNote.textContent=`V√°lasztott meg√°ll√≥: ${stop_id}`

        // √©l≈ë adatok route-onk√©nt
        const routes=[...new Set(deps.map(d=>d.route_short_name||d.route||''))].filter(Boolean)
        const liveByRoute={}
        await Promise.all(routes.map(async r=>{
          try{ liveByRoute[r]=await api(`/api/routes/${encodeURIComponent(r)}/vehicles`)||[] }catch{ liveByRoute[r]=[] }
        }))

        // render
        depBody.innerHTML=''
        if(!deps.length){ depBody.innerHTML='<tr><td colspan="6" class="muted">Nincs indul√°s az id≈ëablakban.</td></tr>'; startTicker(); return }

        const norm=s=>String(s||'').toLowerCase().replace(/\s+/g,'').replace(/[^\p{L}\p{N}]/gu,'')
        deps.forEach(d=>{
          const tr=document.createElement('tr')
          tr.innerHTML = `
            <td><span class="chip">${esc(d.route_short_name||d.route||'?')}</span></td>
            <td>${esc(d.headsign||d.destination||'')}</td>
            <td class="whenCell">${esc(d.__timeHHMM)}</td>
            <td class="liveCell muted">‚Äì</td>
            <td class="regCell muted">‚Äì</td>
            <td class="typCell muted">‚Äì</td>`
          depBody.appendChild(tr)

          const arr = liveByRoute[d.route_short_name||d.route||''] || []
          let live = d.trip_id ? arr.find(v=>v.trip_id===d.trip_id) : null
          if(!live && (d.headsign||d.destination)){
            const h = norm(d.headsign||d.destination)
            live = arr.find(v=>norm(v.headsign||v.destination||'')===h)
          }

          if(live){
            // ETA megjelen√≠t√©s (z√∂ld; Due <1 perc)
            const eta = num(live.eta_minutes)
            if(eta!=null){
              const w=tr.querySelector('.whenCell')
              w.textContent = eta<=0 ? 'Due' : `${eta}‚Ä≤`
              w.classList.add('live')
              if(eta<=0) w.classList.add('blink')
              const lc=tr.querySelector('.liveCell'); lc.textContent='Live'; lc.classList.remove('muted')
            }
            if(live.registration){ tr.querySelector('.regCell').textContent = live.registration; tr.querySelector('.regCell').classList.remove('muted') }
            if(live.vehicle_type){ tr.querySelector('.typCell').textContent = live.vehicle_type; tr.querySelector('.typCell').classList.remove('muted') }
          }
        })

        startTicker()
      }catch{
        chosenNote.textContent='Hiba az indul√°sok lek√©r√©sekor.'
        startTicker()
      }
    }

    // --- Trip modal marad, de csak akkor t√∂lt, ha van adat a backendben ---
    const tripModal=Q('#tripModal'), tripBody=Q('#tripBody'), tripTitle=Q('#tripTitle')
    let tripMap=null, tripLine=null
    Q('#closeTrip').onclick = ()=> tripModal.classList.remove('open')

    // (Opcion√°lis: sor-kattint√°sra trip ‚Äì akkor √©rdemes bekapcsolni, ha /api/trips/{id} visszaad meg√°ll√≥kat)
    depBody.addEventListener('click', async (e)=>{
      const tr=e.target.closest('tr'); if(!tr) return
      // nincs biztos trip_id a t√°bl√°ban ‚Äì itt backend fejleszt√©s kellene; ez√©rt most kihagyjuk
    })

    // --- Vonal keres√©s + t√©rk√©p (marad) ---
    let routeMap=null, routeLayer=null, routeShape=null, liveTimer=null
    function ensureRouteMap(){
      if(routeMap) return
      routeMap = L.map('routeMap')
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(routeMap)
      routeMap.setView([50.9,-1.4],12)
    }

    Q('#btnSearchRoute').onclick = async ()=>{
      clearInterval(liveTimer); routeSelect.innerHTML=''
      const q=routeQuery.value.trim(); if(!q) return
      const res=await api('/api/routes/search?q='+encodeURIComponent(q)).catch(()=>[])
      if(!res?.length){ const o=document.createElement('option');o.textContent='Nincs tal√°lat';routeSelect.appendChild(o);return }
      res.forEach(r=>{ const o=document.createElement('option'); o.value=r.route_short_name||r.route||r.id; o.textContent=r.long_name?`${o.value} ‚Äì ${r.long_name}`:o.value; routeSelect.appendChild(o) })
      routeSelect.onchange()
    }

    routeSelect.onchange = async ()=>{
      const r = routeSelect.value; if(!r) return
      ensureRouteMap()
      // jelen verzi√≥ban a shape rajzol√°sa opcion√°lis a backendt≈ël f√ºgg≈ëen (ha nincs, semmi hiba)
      try{
        if(routeShape){ routeMap.removeLayer(routeShape); routeShape=null }
        const shape = await api(`/api/routes/${encodeURIComponent(r)}/shape`)
        if(Array.isArray(shape) && shape.length>=2){
          const pts = shape.map(p=>[p.lat||p.latitude, p.lon||p.longitude])
          routeShape = L.polyline(pts,{weight:4}).addTo(routeMap)
          routeMap.fitBounds(routeShape.getBounds().pad(0.2))
        }
      }catch{}
      await drawRouteVehicles(r)
      clearInterval(liveTimer)
      liveTimer = setInterval(()=>drawRouteVehicles(r), 20000)
    }

    async function drawRouteVehicles(route){
      if(!routeMap) return
      if(!routeLayer){ routeLayer = L.layerGroup().addTo(routeMap) } else { routeLayer.clearLayers() }
      const vehicles = await api(`/api/routes/${encodeURIComponent(route)}/vehicles`).catch(()=>[])
      if(!vehicles?.length) return
      vehicles.forEach(v=>{
        if(v.lat==null && v.latitude==null) return
        const m=L.marker([v.lat||v.latitude, v.lon||v.longitude])
        const title=[
          `<b>${esc(v.registration||v.label||'J√°rm≈±')}</b>`,
          `Vonal: ${esc(route)}`,
          v.headsign?`Ir√°ny: ${esc(v.headsign)}`:'',
          v.vehicle_type?`T√≠pus: ${esc(v.vehicle_type)}`:'',
          num(v.eta_minutes)!=null?`ETA: ${esc(v.eta_minutes)}‚Ä≤`:''
        ].filter(Boolean).join('<br/>')
        m.bindPopup(title); routeLayer.addLayer(m)
      })
      try{
        const grp=L.featureGroup(routeLayer.getLayers())
        routeMap.fitBounds(grp.getBounds().pad(0.2))
      }catch{}
    }

    // Autof√≥kusz
    Q('#stopQuery').focus()
  })();
  </script>
</body>
</html>
