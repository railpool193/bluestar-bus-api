<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='80'>üöå</text></svg>">
  <style>
    :root{
      --bg:#0b1220; --card:#111a2b; --text:#eaf2ff; --muted:#b8c3d9;
      --ok:#29d; --bad:#e74c3c; --btn:#4e8df5; --btn-h:#6aa3ff; --chip:#1b2740;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    h1{font-weight:800;margin:0 0 16px}
    .card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input[type=text],input[type=number]{width:100%;padding:14px 16px;border-radius:12px;border:1px solid #26324b;background:#0e1628;color:var(--text)}
    .btn{background:var(--btn);color:#fff;border:0;border-radius:12px;padding:14px 18px;font-weight:700;cursor:pointer}
    .btn:hover{background:var(--btn-h)}
    .chips{display:flex;gap:8px;margin-top:12px}
    .chip{background:var(--chip);border-radius:999px;padding:6px 10px;font-size:13px;display:inline-flex;align-items:center;gap:6px}
    .dot{width:10px;height:10px;border-radius:50%}
    .ok{background:#24d164}.bad{background:#e74c3c}.warn{background:#f1c40f}
    .list{margin-top:14px}
    .item{padding:10px 12px;border-radius:10px;background:#0e1628;margin:6px 0;cursor:pointer}
    .item:hover{background:#12203a}
    table{width:100%;border-collapse:collapse;margin-top:14px}
    th,td{text-align:left;padding:10px 8px;border-bottom:1px solid #1a2944}
    th{opacity:.9}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#0e1628;border:1px solid #253354;border-radius:999px;padding:6px 10px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üöå Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë</h1>

    <div class="card">
      <div class="row">
        <div style="flex:1 1 520px">
          <label>Meg√°ll√≥ n√©v</label>
          <input id="q" type="text" placeholder='pl. "Vincent"' />
          <div id="multi" class="list" style="display:none"></div>
        </div>

        <div>
          <label>Id≈ëablak (perc)</label>
          <input id="win" type="number" min="5" max="240" value="60" style="width:130px" />
        </div>

        <div>
          <label style="opacity:0"> </label>
          <button id="go" class="btn">Keres√©s</button>
        </div>
      </div>

      <div class="chips">
        <span class="chip"><span id="apiDot" class="dot bad"></span> API</span>
        <span class="chip"><span id="gtfsDot" class="dot bad"></span> GTFS</span>
        <span class="chip"><span id="liveDot" class="dot bad"></span> Live</span>
      </div>

      <div id="hint" style="margin-top:10px;color:var(--muted)">√çrj be egy meg√°ll√≥nevet, majd kattints egy tal√°latra.</div>
    </div>

    <div id="result" class="card" style="display:none;margin-top:16px"></div>
  </div>

<script>
const api = (p)=>fetch(p).then(r=>r.json());

async function refreshStatus(){
  try{
    const s = await api('/api/status');
    setDot('apiDot', true);
    setDot('gtfsDot', !!s.gtfs);
    setDot('liveDot', !!s.live);
  }catch{ setDot('apiDot', false); setDot('gtfsDot', false); setDot('liveDot', false); }
}
function setDot(id, ok){ const el=document.getElementById(id); el.classList.remove('ok','bad'); el.classList.add(ok?'ok':'bad'); }

async function doSearch(){
  const q = document.getElementById('q').value.trim();
  const win = +document.getElementById('win').value || 60;
  if(q.length < 2){ alert('√çrj be legal√°bb 2 karaktert.'); return; }

  const listBox = document.getElementById('multi');
  listBox.innerHTML=''; listBox.style.display='none';
  document.getElementById('result').style.display='none';

  let arr = [];
  try { arr = await api('/api/stops/search?q='+encodeURIComponent(q)); }
  catch { alert('Hiba a keres√©s k√∂zben.'); return; }

  if(!arr || arr.length === 0){
    listBox.style.display='block';
    listBox.innerHTML = '<div class="item" style="cursor:default;opacity:.8">Nincs tal√°lat erre a n√©vre.</div>';
    return;
  }
  if(arr.length === 1){
    fetchStop(arr[0].stop_id, arr[0].stop_name, win);
    return;
  }

  listBox.style.display='block';
  listBox.innerHTML = '<div class="item" style="cursor:default;opacity:.8">T√∂bb meg√°ll√≥ is van erre a n√©vre. V√°lassz egyet:</div>' +
    arr.map(s=>`<div class="item" data-id="${s.stop_id}" data-name="${s.stop_name}">${s.stop_name} <span class="pill" style="float:right">${s.stop_id}</span></div>`).join('');
  listBox.querySelectorAll('.item[data-id]').forEach(el=>{
    el.addEventListener('click', ()=> fetchStop(el.dataset.id, el.dataset.name, win));
  });
}

async function fetchStop(id, name, win){
  const resBox = document.getElementById('result');
  resBox.style.display='block';
  resBox.innerHTML = `<h3>Meg√°ll√≥: ${name} <span class="pill" style="margin-left:8px">${id}</span></h3><div style="opacity:.8">Bet√∂lt√©s‚Ä¶</div>`;

  let data=null;
  try{ data = await api(`/api/stops/${encodeURIComponent(id)}/next_departures?window=${win}`); }
  catch{ resBox.innerHTML='<div>Hiba t√∂rt√©nt az adatok let√∂lt√©sekor.</div>'; return; }

  const deps = (data && data.departures) ? data.departures : [];
  if(deps.length===0){
    resBox.innerHTML = `<h3>Meg√°ll√≥: ${name} <span class="pill" style="margin-left:8px">${id}</span></h3>
                        <div style="opacity:.8">Nincs indul√°s ebben az id≈ëablakban.</div>`;
    return;
  }
  const rows = deps.map(d=>`<tr>
    <td style="width:80px;font-weight:700">${d.route||''}</td>
    <td>${(d.destination||'').replaceAll('<','&lt;')}</td>
    <td style="width:90px">${d.time}</td>
    <td style="width:70px;text-align:center">${d.live===true?'<span class="dot ok"></span>': d.live===false?'<span class="dot bad"></span>':'‚Äì'}</td>
  </tr>`).join('');

  resBox.innerHTML = `<h3>Meg√°ll√≥: ${name} <span class="pill" style="margin-left:8px">${id}</span></h3>
  <table>
    <thead><tr><th>J√°rat</th><th>C√©l</th><th>Indul√°s</th><th>√âl≈ë</th></tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
}

document.getElementById('go').addEventListener('click', doSearch);
document.getElementById('q').addEventListener('keydown', (e)=>{ if(e.key==='Enter') doSearch(); });

refreshStatus();
</script>
</body>
</html>
