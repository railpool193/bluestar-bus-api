<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üöç Bluestar ‚Äì Bus Departures</title>
  <!-- Opcion√°lis k√ºl√∂n CSS helyett egy kis be√©p√≠tett st√≠lus -->
  <style>
    :root {
      --bg: #0f1115;
      --card: #151923;
      --muted: #9aa4b2;
      --text: #e6e8ec;
      --accent: #6ea8fe;
      --good: #3ecf8e;
      --warn: #a0aec0;
      --border: #242936;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 24px;
      background: var(--bg); color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }
    h1 { font-size: 1.4rem; margin: 0 0 16px; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      margin: 0 auto 16px;
      max-width: 900px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.25);
    }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    input, select, button {
      background: #0f1320; color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px; padding: 10px 12px;
      font-size: 16px;
      outline: none;
    }
    input:focus, select:focus { border-color: var(--accent); }
    button.primary {
      background: var(--accent); color: #0b1220; font-weight: 700;
      border: none; cursor: pointer;
    }
    button.secondary { cursor: pointer; }
    .muted { color: var(--muted); font-size: 0.9rem; }
    ul.stops { list-style: none; padding: 0; margin: 8px 0 0; display: grid; gap: 6px; }
    ul.stops li {
      background: #0f1320; border: 1px solid var(--border); border-radius: 10px;
      padding: 10px 12px; display: flex; justify-content: space-between; align-items: center; gap: 8px;
    }
    ul.stops li button { white-space: nowrap; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    thead th {
      text-align: left; font-weight: 600; color: var(--muted);
      border-bottom: 1px solid var(--border); padding: 8px;
    }
    tbody td { padding: 10px 8px; border-bottom: 1px solid var(--border); vertical-align: middle; }
    .badge {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 4px 8px; border-radius: 999px; font-size: 0.75rem; font-weight: 700;
    }
    .live   { background: rgba(62, 207, 142, .15); color: var(--good); border: 1px solid rgba(62, 207, 142, .35); }
    .sched  { background: rgba(160, 174, 192, .15); color: var(--muted); border: 1px solid rgba(160, 174, 192, .35); }
    .dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: currentColor; display: inline-block;
      box-shadow: 0 0 10px currentColor;
    }
    .right { text-align: right; }
    .nowrap { white-space: nowrap; }
    .small { font-size: .85rem; color: var(--muted); }
    .spacer { flex: 1; }
    .error { color: #ff8080; }
  </style>
</head>
<body>
  <div class="card">
    <h1>üöç Bluestar ‚Äì Bus Departures</h1>
    <div class="row" style="margin-top:8px;">
      <input id="stopSearch" type="text" placeholder="Meg√°ll√≥ neve (pl. Vincent, City Centre‚Ä¶)" style="flex:2;min-width:240px;">
      <button class="primary" id="btnSearch">Keres√©s</button>

      <div class="spacer"></div>

      <label class="small">Id≈ëablak:
        <select id="minutes">
          <option value="30">30 perc</option>
          <option value="60" selected>60 perc</option>
          <option value="90">90 perc</option>
          <option value="120">120 perc</option>
        </select>
      </label>
      <button class="secondary" id="btnRefresh" title="Friss√≠t√©s">Friss√≠t√©s</button>
    </div>
    <p class="muted" style="margin:8px 2px 0;">√çrj be legal√°bb 3 karaktert, majd v√°lassz meg√°ll√≥t a tal√°lati list√°b√≥l.</p>
  </div>

  <div class="card" id="stopsCard" style="display:none;">
    <h2 style="margin:0 0 8px;">Tal√°latok</h2>
    <ul class="stops" id="stopsList"></ul>
  </div>

  <div class="card" id="depsCard" style="display:none;">
    <div class="row">
      <h2 id="depsTitle" style="margin:0;">Indul√°sok</h2>
      <div class="spacer"></div>
      <span id="statusBadge" class="small"></span>
    </div>
    <div id="depsWrap"></div>
  </div>

  <div class="card" id="msgCard" style="display:none;">
    <p id="msgText"></p>
  </div>

  <script>
    // A backend alap URL-je (azonos domain + /api)
    const API_BASE = window.location.origin + "/api";

    // √Ållapot
    let selectedStop = null;

    // DOM elemek
    const elSearch = document.getElementById("stopSearch");
    const elMinutes = document.getElementById("minutes");
    const elBtnSearch = document.getElementById("btnSearch");
    const elBtnRefresh = document.getElementById("btnRefresh");
    const elStopsCard = document.getElementById("stopsCard");
    const elStopsList = document.getElementById("stopsList");
    const elDepsCard = document.getElementById("depsCard");
    const elDepsWrap = document.getElementById("depsWrap");
    const elDepsTitle = document.getElementById("depsTitle");
    const elMsgCard = document.getElementById("msgCard");
    const elMsgText = document.getElementById("msgText");
    const elStatusBadge = document.getElementById("statusBadge");

    // Helper: √ºzenet
    function showMsg(text, isError=false) {
      elMsgText.textContent = text;
      elMsgText.className = isError ? "error" : "";
      elMsgCard.style.display = "block";
      setTimeout(() => (elMsgCard.style.display = "none"), 4000);
    }

    // Keres√©s
    async function searchStops() {
      const q = elSearch.value.trim();
      if (q.length < 3) {
        showMsg("√çrj be legal√°bb 3 karaktert a keres√©shez.");
        return;
      }
      elStopsList.innerHTML = "";
      elStopsCard.style.display = "block";

      try {
        const res = await fetch(`${API_BASE}/stops/search?q=${encodeURIComponent(q)}`);
        if (!res.ok) throw new Error("Keres√©si hiba");
        const data = await res.json(); // [{stop_id, stop_name}, ...]
        if (!Array.isArray(data) || data.length === 0) {
          elStopsList.innerHTML = `<li class="muted">Nincs tal√°lat.</li>`;
          return;
        }
        elStopsList.innerHTML = data.map(s => `
          <li>
            <div>
              <div><strong>${escapeHtml(s.stop_name)}</strong></div>
              <div class="small muted">${s.stop_id}</div>
            </div>
            <button class="secondary" onclick="selectStop('${s.stop_id}', '${escapeAttr(s.stop_name)}')">Megnyit√°s</button>
          </li>
        `).join("");
      } catch (e) {
        console.error(e);
        showMsg("H√°l√≥zati vagy szerver hiba a keres√©sn√©l.", true);
      }
    }

    // Meg√°ll√≥ kiv√°laszt√°sa
    async function selectStop(stopId, stopName) {
      selectedStop = { id: stopId, name: stopName };
      elDepsTitle.textContent = `Indul√°sok ‚Äì ${stopName}`;
      await loadDepartures();
    }

    // Indul√°sok lek√©r√©se
    async function loadDepartures() {
      if (!selectedStop) return;
      const mins = parseInt(elMinutes.value || "60", 10);

      elDepsCard.style.display = "block";
      elDepsWrap.innerHTML = `<p class="muted">Bet√∂lt√©s‚Ä¶</p>`;
      elStatusBadge.textContent = "";

      try {
        const res = await fetch(`${API_BASE}/stops/${encodeURIComponent(selectedStop.id)}/next_departures?minutes=${mins}`);
        if (!res.ok) throw new Error("Lek√©r√©si hiba");
        const payload = await res.json();
        const list = payload?.results ?? [];
        const countLive = list.filter(d => d.is_live).length;

        // st√°tusz jelz√©s
        elStatusBadge.innerHTML = countLive > 0
          ? `<span class="badge live"><span class="dot"></span> ${countLive} LIVE</span>`
          : `<span class="badge sched">nincs √©l≈ë adat</span>`;

        if (list.length === 0) {
          elDepsWrap.innerHTML = `<p class="muted">Nincs indul√°s a k√∂vetkez≈ë ${mins} percben.</p>`;
          return;
        }

        // t√°bl√°zat
        let html = `
          <table>
            <thead>
              <tr>
                <th>J√°rat</th>
                <th>√öti c√©l</th>
                <th class="right">Id≈ë</th>
                <th class="right">√Ållapot</th>
              </tr>
            </thead>
            <tbody>
        `;
        for (const d of list) {
          const t = new Date(d.time_iso);
          const timeHHMM = t.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
          const liveBadge = d.is_live
            ? `<span class="badge live"><span class="dot"></span> LIVE</span>`
            : `<span class="badge sched">SCHEDULED</span>`;

          html += `
            <tr>
              <td class="nowrap"><strong>${escapeHtml(d.route)}</strong></td>
              <td>${escapeHtml(d.destination)}</td>
              <td class="right nowrap">${timeHHMM}</td>
              <td class="right">${liveBadge}</td>
            </tr>
          `;
        }
        html += `</tbody></table>`;
        elDepsWrap.innerHTML = html;
      } catch (e) {
        console.error(e);
        elDepsWrap.innerHTML = "";
        showMsg("Hiba az indul√°sok lek√©r√©sekor.", true);
      }
    }

    // Kiseg√≠t≈ë: HTML escape
    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function escapeAttr(s) {
      return String(s ?? "").replaceAll("'","\\'");
    }

    // Esem√©nyek
    elBtnSearch.addEventListener("click", searchStops);
    elBtnRefresh.addEventListener("click", loadDepartures);
    elSearch.addEventListener("keydown", (e) => { if (e.key === "Enter") searchStops(); });
    elMinutes.addEventListener("change", loadDepartures);
  </script>
</body>
</html>
