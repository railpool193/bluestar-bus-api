<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bluestar menetrend √©s meg√°ll√≥ keres≈ë</title>
  <meta name="color-scheme" content="dark">
  <style>
    :root{
      --bg:#0c1220; --panel:#111a2e; --panel-2:#0f1730;
      --text:#dfe7ff; --text-dim:#a9b4d0; --muted:#5b6a90;
      --brand:#b9b8ff; --chip:#1c2746; --ok:#44d07a; --err:#e36b6b;
      --btn:#b7b6ff; --btn-text:#12142a; --shadow: 0 10px 26px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:radial-gradient(1200px 600px at 20% -10%,#1a2140 0%,#0e1530 50%,#0b1120 100%), var(--bg);
      color:var(--text); font:500 16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }
    header{display:flex;align-items:center;gap:12px;padding:18px 20px 8px}
    .icon{width:36px;height:36px;display:grid;place-items:center;border-radius:12px;background:#0e1932}
    h1{font-size:26px;margin:0}
    .sub{margin:2px 0 0 68px;color:var(--text-dim);font-weight:600}
    .wrap{max-width:960px;margin:0 auto;padding:6px 14px 60px}
    .tabs{display:flex;gap:12px;padding:16px 0}
    .tab{border-radius:999px;border:1px solid #1c2746;background:#0f1630;color:var(--text);
      padding:12px 18px;cursor:pointer}
    .tab.active{background:#141f42;border-color:#2a3a72}
    .card{background:linear-gradient(180deg,var(--panel) 0%,var(--panel-2) 100%);
      border:1px solid #1b2443;border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin:6px 0}
    .row{display:flex;gap:12px;align-items:center}
    .grow{flex:1}
    .input{
      width:100%;border:1px solid #27335e;background:#0e1733;color:#fff;border-radius:14px;
      padding:14px 16px;font-size:16px;outline:none;box-shadow:inset 0 1px 0 rgba(255,255,255,.03)
    }
    .input::placeholder{color:#8ea0cf}
    .btn{
      border:none;background:var(--btn);color:var(--btn-text);font-weight:700;
      padding:12px 18px;border-radius:14px;cursor:pointer;box-shadow:var(--shadow)
    }
    .chips{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .chip{background:var(--chip);border:1px solid #25325d;color:#c7d5ff;border-radius:12px;padding:10px 14px;font-weight:800}
    .list{display:flex;flex-direction:column;gap:14px;margin-top:12px}
    .stop{display:flex;gap:14px;align-items:center;padding:14px;border-radius:14px;
      background:#0f1733;border:1px solid #22305c}
    .pill{width:64px;height:64px;border-radius:18px;background:#16244a;display:grid;place-items:center;font-weight:900}
    .stop h3{margin:0 0 2px 0}
    .stop small{color:var(--muted)}
    .tag{margin-left:auto;display:flex;gap:8px;align-items:center}
    .fbtn{background:#a9a8ff;color:#111;border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
    .linkbtn{background:#b7b6ff;color:#111;border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
    .muted{color:var(--muted)}
    .status{margin-top:12px;color:var(--text-dim);font-size:14px}
    .toast{position:fixed;left:20px;right:20px;bottom:20px;background:#2a1212;color:#fff;border:1px solid #4b1e1e;
      border-radius:14px;padding:14px 16px;box-shadow:var(--shadow)}
    dialog::backdrop{background:rgba(0,0,0,.55)}
    dialog{border:none;border-radius:16px;padding:0;background:#0f1733;color:var(--text);box-shadow:var(--shadow);max-width:520px}
    .modal-head{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:1px solid #23305b}
    .modal-body{padding:16px 20px 22px;display:flex;flex-direction:column;gap:14px}
    label{font-size:14px;color:#aebbe2}
    select.input{appearance:none;background-image:linear-gradient(45deg,transparent 50%,#8ea0cf 50%),
        linear-gradient(135deg,#8ea0cf 50%,transparent 50%),linear-gradient(to right,#8ea0cf,#8ea0cf);
      background-position:calc(100% - 22px) calc(1em + 2px), calc(100% - 16px) calc(1em + 2px), calc(100% - 2.5rem) 0.6rem;
      background-size:6px 6px,6px 6px,1px 1.6rem;background-repeat:no-repeat;padding-right:46px}
    .flag{font-size:18px;margin-right:8px}
    .hidden{display:none}
  </style>
</head>
<body>
  <header class="wrap">
    <div class="icon">üöå</div>
    <div>
      <h1 id="appTitle">Bluestar menetrend √©s meg√°ll√≥ keres≈ë</h1>
      <div class="sub" id="ukClock">UK: --:--:--</div>
    </div>
    <div style="margin-left:auto">
      <button id="openSettings" class="btn" title="Be√°ll√≠t√°sok">‚öôÔ∏è</button>
    </div>
  </header>

  <main class="wrap">
    <div class="tabs">
      <button class="tab active" data-tab="stop" id="tabStop">Meg√°ll√≥</button>
      <button class="tab" data-tab="route" id="tabRoute">Viszonylat</button>
      <button class="tab" data-tab="fav" id="tabFav">Kedvencek</button>
    </div>

    <!-- STOP TAB -->
    <section class="card" id="view-stop">
      <div class="row">
        <div class="grow">
          <input id="qStop" class="input" placeholder="Shirley, Vincent, stb." />
        </div>
        <button id="btnSearch" class="btn">Keres√©s</button>
      </div>

      <div class="muted" style="margin-top:14px" id="featuredLabel">Kiemelt forgalmi v√°ltoz√°sok</div>
      <div class="chips" id="featuredChips"></div>

      <div style="margin-top:18px;font-weight:800" id="resultsHdr">Tal√°latok</div>
      <div class="list" id="stopResults"></div>

      <div class="status" id="selInfo">‚Äî</div>
      <div class="status" id="buildInfo"></div>
    </section>

    <!-- ROUTE TAB -->
    <section class="card hidden" id="view-route">
      <p class="muted" id="routeInfo">
        A viszonylat keres≈ë fel√ºlet itt fog b≈ëv√ºlni (√∫tvonal, j√°rm≈±vek). Jelenleg a Meg√°ll√≥ f√ºl a f≈ë funkci√≥.
      </p>
    </section>

    <!-- FAV TAB -->
    <section class="card hidden" id="view-fav">
      <div class="list" id="favList"></div>
      <div class="status muted" id="favHint"></div>
    </section>
  </main>

  <!-- SETTINGS MODAL -->
  <dialog id="settings">
    <div class="modal-head">
      <strong id="settingsTitle">Be√°ll√≠t√°sok</strong>
      <button class="btn" id="closeSettings">‚úñ</button>
    </div>
    <div class="modal-body">
      <div>
        <label for="apiBase">API el√©r√©si √∫t (√ºres = ugyanarr√≥l a domainr≈ël)</label>
        <input id="apiBase" class="input" placeholder="" />
      </div>
      <div>
        <label for="refreshSec">Friss√≠t√©si id≈ë (mp)</label>
        <input id="refreshSec" class="input" type="number" min="5" step="1" />
      </div>
      <div>
        <label for="windowMin">El≈ëretekint√©si ablak (perc)</label>
        <input id="windowMin" class="input" type="number" min="10" step="5" />
      </div>
      <div>
        <label for="langSel">Nyelv / Language</label>
        <select id="langSel" class="input">
          <option value="hu">üá≠üá∫ Magyar</option>
          <option value="en">üá¨üáß English</option>
        </select>
      </div>
      <div class="row" style="justify-content:flex-end">
        <button id="saveSettings" class="btn">Ment√©s</button>
      </div>
    </div>
  </dialog>

  <div id="toast" class="toast hidden"></div>

<script>
/* ---------- i18n ---------- */
const i18n = {
  hu: {
    title: "Bluestar menetrend √©s meg√°ll√≥ keres≈ë",
    tabs: { stop:"Meg√°ll√≥", route:"Viszonylat", fav:"Kedvencek" },
    featured: "Kiemelt forgalmi v√°ltoz√°sok",
    results: "Tal√°latok",
    selected: (name)=>`Kiv√°lasztott meg√°ll√≥: ${name} ‚Äî friss√ºl`,
    build: (s,b)=>`Friss√≠t√©s: ${s} s ‚Ä¢ Build: ${b}`,
    open:"Megnyit", fav:"Kedvenc", del:"T√∂rl√©s",
    settings:"Be√°ll√≠t√°sok",
    apiHint:"API el√©r√©si √∫t (√ºres = ugyanarr√≥l a domainr≈ël)",
    refresh:"Friss√≠t√©si id≈ë (mp)", window:"El≈ëretekint√©si ablak (perc)",
    lang:"Nyelv / Language",
    favHint:"A megnyitott meg√°ll√≥k helyben elmenthet≈ëk √©s itt jelennek meg.",
    routeInfo:"A viszonylat keres≈ë fel√ºlet itt fog b≈ëv√ºlni (√∫tvonal, j√°rm≈±vek). Jelenleg a Meg√°ll√≥ f√ºl a f≈ë funkci√≥.",
    errors:{
      searchFail:"Nem siker√ºlt a meg√°ll√≥keres√©s.",
      depFail:(msg)=>`Indul√°sok hiba: ${msg}`,
    }
  },
  en: {
    title: "Bluestar bus ‚Äî stop & route finder",
    tabs: { stop:"Stop", route:"Route", fav:"Favourites" },
    featured: "Featured service changes",
    results: "Results",
    selected: (name)=>`Selected stop: ${name} ‚Äî auto refresh`,
    build: (s,b)=>`Refresh: ${s} s ‚Ä¢ Build: ${b}`,
    open:"Open", fav:"Favourite", del:"Delete",
    settings:"Settings",
    apiHint:"API base (empty = same origin)",
    refresh:"Refresh (sec)", window:"Look-ahead window (min)",
    lang:"Language",
    favHint:"Stops you open can be saved locally and will appear here.",
    routeInfo:"Route view will expand here (path, vehicles). For now, the Stop tab is the main feature.",
    errors:{
      searchFail:"Stop search failed.",
      depFail:(msg)=>`Departures error: ${msg}`,
    }
  }
};
let lang = localStorage.getItem("lang") || "hu";

/* ---------- state ---------- */
const S = {
  apiBase: localStorage.getItem("apiBase") || "",
  refreshSec: +(localStorage.getItem("refreshSec") || 10),
  windowMin: +(localStorage.getItem("windowMin") || 60),
  build: window.BUILD_ID || (new Date().getTime()/1000|0),
  selectedStop: null,
  timer: null,
  favs: JSON.parse(localStorage.getItem("favs") || "[]"),
};

/* ---------- helpers ---------- */
const $ = (x)=>document.querySelector(x);
const el = (t,cls,txt)=>{const e=document.createElement(t); if(cls)e.className=cls; if(txt!==undefined)e.textContent=txt; return e;};
const api = (p)=> (S.apiBase || "") + p;
function toast(msg){
  const t=$("#toast"); t.textContent=msg; t.classList.remove("hidden");
  clearTimeout(t._h); t._h=setTimeout(()=>t.classList.add("hidden"), 4200);
}
function fmtUK(){
  const d=new Date();
  return d.toLocaleTimeString(lang==="hu"?"hu-HU":"en-GB", {timeZone:"Europe/London", hour12:false});
}

/* ---------- UI init ---------- */
function applyLang(){
  const L=i18n[lang];
  document.title=L.title; $("#appTitle").textContent=L.title;
  $("#tabStop").textContent=L.tabs.stop;
  $("#tabRoute").textContent=L.tabs.route;
  $("#tabFav").textContent=L.tabs.fav;
  $("#featuredLabel").textContent=L.featured;
  $("#resultsHdr").textContent=L.results;
  $("#routeInfo").textContent=L.routeInfo;
  $("#favHint").textContent=L.favHint;
  $("#openSettings").title=L.settings;
  $("#settingsTitle").textContent=L.settings;
  $("label[for='apiBase']").textContent=L.apiHint;
  $("label[for='refreshSec']").textContent=L.refresh;
  $("label[for='windowMin']").textContent=L.window;
  $("label[for='langSel']").textContent=L.lang;
}
function tickClock(){ $("#ukClock").textContent="UK: "+fmtUK(); }
setInterval(tickClock, 1000); tickClock();

/* ---------- tabs ---------- */
document.querySelectorAll(".tab").forEach(b=>{
  b.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    const tab=b.dataset.tab;
    $("#view-stop").classList.toggle("hidden", tab!=="stop");
    $("#view-route").classList.toggle("hidden", tab!=="route");
    $("#view-fav").classList.toggle("hidden", tab!=="fav");
    if(tab==="fav") renderFavs();
  });
});

/* ---------- featured chips (dummy route numbers to match Bluestar look) ---------- */
["18","19","1","7","U1","X4"].forEach(r=>{
  const c=el("div","chip",r); $("#featuredChips").appendChild(c);
});

/* ---------- settings ---------- */
$("#openSettings").onclick=()=>{ 
  $("#apiBase").value=S.apiBase; $("#refreshSec").value=S.refreshSec; $("#windowMin").value=S.windowMin;
  $("#langSel").value=lang; $("#settings").showModal();
};
$("#closeSettings").onclick=()=>$("#settings").close();
$("#saveSettings").onclick=()=>{
  S.apiBase=$("#apiBase").value.trim();
  S.refreshSec=Math.max(5, +$("#refreshSec").value||10);
  S.windowMin=Math.max(10, +$("#windowMin").value||60);
  lang=$("#langSel").value||"hu";
  localStorage.setItem("apiBase",S.apiBase);
  localStorage.setItem("refreshSec",S.refreshSec);
  localStorage.setItem("windowMin",S.windowMin);
  localStorage.setItem("lang",lang);
  applyLang();
  $("#settings").close();
  updateBuildInfo();
};

/* ---------- stop search ---------- */
$("#btnSearch").onclick=doSearch;
$("#qStop").addEventListener("keydown",e=>{ if(e.key==="Enter") doSearch(); });

async function doSearch(){
  const q=$("#qStop").value.trim();
  const L=i18n[lang];
  $("#stopResults").innerHTML="";
  if(!q) return;
  try{
    const r=await fetch(api(`/api/live/stop-search?q=${encodeURIComponent(q)}`));
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    const list=await r.json(); // [{id,name,mode?}]
    if(!Array.isArray(list) || list.length===0){ $("#stopResults").append(el("div","muted","‚Äî")); return; }
    list.forEach(s=>{
      const row=el("div","stop");
      row.append(el("div","pill","BUS"));
      const box=el("div","grow");
      box.append(el("h3","",s.name||s.id));
      box.append(el("small","muted","ID: "+s.id));
      row.append(box);
      const tag=el("div","tag");
      const favBtn=el("button","fbtn","‚òÖ");
      favBtn.title=L.fav; favBtn.onclick=()=>toggleFav(s);
      const openBtn=el("button","linkbtn",L.open);
      openBtn.onclick=()=>openStop(s);
      tag.append(favBtn, openBtn);
      row.append(tag);
      $("#stopResults").append(row);
    });
  }catch(err){
    toast(L.errors.searchFail);
    console.error(err);
  }
}

function updateBuildInfo(){
  const L=i18n[lang];
  $("#buildInfo").textContent=L.build(S.refreshSec, S.build);
}
updateBuildInfo();

/* ---------- favourites ---------- */
function toggleFav(s){
  const i=S.favs.findIndex(x=>x.id===s.id);
  if(i>=0) S.favs.splice(i,1); else S.favs.unshift({id:s.id,name:s.name});
  localStorage.setItem("favs",JSON.stringify(S.favs));
  renderFavs();
}
function renderFavs(){
  const L=i18n[lang];
  const box=$("#favList"); box.innerHTML="";
  if(!S.favs.length){ box.append(el("div","muted","‚Äî")); return; }
  S.favs.forEach(s=>{
    const row=el("div","stop");
    row.append(el("div","pill","BUS"));
    const b=el("div","grow"); b.append(el("h3","",s.name)); b.append(el("small","muted","ID: "+s.id)); row.append(b);
    const tag=el("div","tag");
    const openBtn=el("button","linkbtn",L.open); openBtn.onclick=()=>openStop(s);
    const delBtn=el("button","fbtn",L.del); delBtn.onclick=()=>{ S.favs=S.favs.filter(x=>x.id!==s.id); localStorage.setItem("favs",JSON.stringify(S.favs)); renderFavs(); };
    tag.append(openBtn, delBtn); row.append(tag);
    box.append(row);
  });
}

/* ---------- open stop & auto-refresh departures ---------- */
async function openStop(s){
  S.selectedStop=s;
  tickSelected();
  if(S.timer) clearInterval(S.timer);
  await loadDepartures(); // first fetch immediately
  S.timer=setInterval(loadDepartures, S.refreshSec*1000);
}
function tickSelected(){
  const L=i18n[lang];
  $("#selInfo").textContent = S.selectedStop ? `${L.selected(S.selectedStop.name)} ${S.refreshSec} mp-enk√©nt.` : "‚Äî";
}
async function loadDepartures(){
  if(!S.selectedStop) return;
  const L=i18n[lang];
  try{
    const r=await fetch(api(`/api/live/departures?stopId=${encodeURIComponent(S.selectedStop.id)}&minutes=${S.windowMin}`));
    if(!r.ok){
      const txt=await r.text();
      throw new Error(`HTTP ${r.status} ‚Äì ${txt}`);
    }
    const data=await r.json(); // form√°tum: {departures:[{line,to,timeText,isDue,...}], stop:{...}}
    // egyszer≈± megjelen√≠t√©s: a tal√°lati lista tetej√©n mutatjuk a k√∂vetkez≈ë 6 indul√°st
    renderDeparturesPreview(data);
  }catch(err){
    toast(L.errors.depFail(err.message));
    console.error(err);
  }
}
function renderDeparturesPreview(data){
  // t√∂r√∂lj√ºk a lista tetej√©t √©s besz√∫rjuk a preview k√°rty√°t
  const list=$("#stopResults");
  const old=$("#depPreview"); if(old) old.remove();
  const card=el("div","card"); card.id="depPreview";
  const h=el("div","", S.selectedStop ? (S.selectedStop.name) : "‚Äî");
  h.style.fontWeight="800"; h.style.marginBottom="8px"; card.append(h);
  const ul=el("div","");
  const deps=(data && data.departures)||[];
  if(!deps.length){ ul.append(el("div","muted","Nincs indul√°s a megadott ablakban.")); }
  deps.slice(0,6).forEach(d=>{
    const row=el("div","row");
    row.style.justifyContent="space-between";
    row.style.padding="6px 0";
    const left=el("div","", `${d.line || d.route || "‚Äî"}  ‚Ä¢  ${d.to || d.destination || ""}`);
    const right=el("div","", d.timeText || d.when || "");
    if((d.isDue||false) || (d.timeText||"").toLowerCase()==="due"){ right.style.color="var(--ok)"; right.style.fontWeight="900"; }
    row.append(left,right); ul.append(row);
  });
  card.append(ul);
  list.prepend(card);
}

/* ---------- boot ---------- */
applyLang();
$("#langSel").value=lang;

/* clock already running */

/* build info from /api/status for tz + build if available */
(async ()=>{
  try{
    const r=await fetch(api("/api/status"));
    if(r.ok){
      const s=await r.json();
      if(s.build) S.build=s.build;
      // ha a backend m√©g Budapest TZ-t √≠r, a fejl√©c akkor is UK-et mutat a frontenden.
      updateBuildInfo();
    }
  }catch{}
})();
</script>
</body>
</html>
