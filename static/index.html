<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    /* kis kieg√©sz√≠t√©s a tal√°latv√°laszt√≥hoz */
    .choices { margin-top: .5rem; border: 1px solid rgba(255,255,255,.1); border-radius: .75rem; overflow: hidden; }
    .choice-head { padding: .5rem .75rem; background: rgba(255,255,255,.05); font-size: .9rem; }
    .choice-list { max-height: 240px; overflow: auto; }
    .choice-item { display:flex; justify-content:space-between; align-items:center; padding:.6rem .75rem; border-top: 1px solid rgba(255,255,255,.06); cursor:pointer; }
    .choice-item:hover { background: rgba(255,255,255,.04); }
    .pill { display:inline-flex; align-items:center; gap:.4rem; padding:.25rem .55rem; border-radius:999px; font-size:.85rem; background:#0f172a; border:1px solid rgba(255,255,255,.1);}
    .dot {width:.55rem;height:.55rem;border-radius:999px;background:#22c55e;}
    .dot.red{background:#ef4444}
    .muted { opacity:.8 }
    .btn { background:#22c55e; color:#0b1220; font-weight:700; padding:.75rem 1.1rem; border-radius:.9rem; border:none; cursor:pointer;}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .input { width:100%; background:#0b1220; border:1px solid rgba(255,255,255,.12); color:#fff; padding:.85rem 1rem; border-radius:.9rem; }
    .wrap { max-width:980px; margin: 0 auto; padding: 1.25rem;}
    .card { background:#0b1220; border:1px solid rgba(255,255,255,.08); border-radius:1rem; padding:1rem;}
    table { width:100%; border-collapse: collapse; }
    th, td { padding: .9rem; border-top:1px solid rgba(255,255,255,.06); }
    th { text-align:left; opacity:.8; font-weight:700; }
    .center { text-align:center }
    .badge-row {display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; margin-top:.6rem}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 style="font-size:2rem; display:flex; align-items:center; gap:.6rem;">
      üöå Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë
    </h1>

    <div class="card" style="margin-top:1rem;">
      <div style="display:flex; gap:.75rem; flex-wrap:wrap; align-items:center;">
        <div style="flex:1 1 360px;">
          <input id="q" class="input" type="text" placeholder="√çrj be egy meg√°ll√≥ nevet (pl. Hanover, Vincent‚Ä¶)" />
        </div>
        <button id="go" class="btn">Keres√©s</button>
      </div>

      <!-- st√°tusz jelv√©nyek -->
      <div class="badge-row">
        <span class="pill"><span class="dot" id="apiDot"></span> API: <span id="apiTxt">‚Äî</span></span>
        <span class="pill"><span class="dot red" id="gtfsDot"></span> GTFS: <span id="gtfsTxt">‚Äî</span></span>
        <span class="pill"><span class="dot red" id="liveDot"></span> Live: <span id="liveTxt">‚Äî</span></span>
      </div>

      <!-- t√∂bb tal√°lat eset√©n v√°laszt√≥ -->
      <div id="choices" class="choices" style="display:none;">
        <div class="choice-head">T√∂bb meg√°ll√≥ is van erre a n√©vre. V√°lassz egyet:</div>
        <div id="choiceList" class="choice-list"></div>
      </div>

    </div>

    <div id="resultsWrap" class="card" style="margin-top:1rem; display:none;">
      <h2 id="stopTitle" style="margin:.2rem 0 1rem;"></h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>J√°rat</th>
              <th>C√©l</th>
              <th>Indul√°s</th>
              <th class="center">√âl≈ë</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>

    <p class="muted" style="text-align:center; margin:2rem 0 1rem;">UI & API: te ‚Äì ‚ù§Ô∏è</p>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);
    const apiBase = location.origin;

    // st√°tusz bet√∂lt√©se
    async function loadStatus() {
      try {
        const r = await fetch(`${apiBase}/api/status`);
        const s = await r.json();
        setBadge('api', true, 'ok');
        setBadge('gtfs', !!s.gtfs_loaded, s.gtfs_loaded ? 'bet√∂ltve' : 'nincs');
        setBadge('live', !!s.siri_configured, s.siri_configured ? 'el√©rhet≈ë' : 'nem el√©rhet≈ë');
      } catch {
        setBadge('api', false, 'hiba');
      }
    }
    function setBadge(kind, ok, text){
      const dot = $(`#${kind}Dot`);
      const tx = $(`#${kind}Txt`);
      if (!dot || !tx) return;
      dot.classList.toggle('red', !ok);
      tx.textContent = text;
    }

    // keres√©s
    $('#go').addEventListener('click', onSearch);
    $('#q').addEventListener('keydown', e => { if (e.key === 'Enter') onSearch(); });

    async function onSearch() {
      const q = $('#q').value.trim();
      hideChoices();
      $('#resultsWrap').style.display = 'none';
      if (q.length < 2) return;

      // 1) meg√°ll√≥k keres√©se
      let stops = [];
      try {
        const r = await fetch(`${apiBase}/api/stops/search?q=${encodeURIComponent(q)}`);
        stops = await r.json();
      } catch (e) {
        console.error(e);
      }

      if (!stops || stops.length === 0) {
        showChoices([{stop_id:'', stop_name:'Nincs tal√°lat.'}], true);
        return;
      }
      if (stops.length === 1) {
        loadDeparturesForStop(stops[0]);
        return;
      }
      // t√∂bb tal√°lat ‚Äì v√°laszt√≥ megjelen√≠t√©se
      showChoices(stops);
    }

    function showChoices(stops, readonly=false) {
      const box = $('#choices');
      const list = $('#choiceList');
      list.innerHTML = '';
      stops.forEach(s => {
        const div = document.createElement('div');
        div.className = 'choice-item';
        const left = document.createElement('div');
        left.innerHTML = `<strong>${s.stop_name || 'Ismeretlen meg√°ll√≥'}</strong> ${s.stop_id ? `<span class="muted">‚Ä¢ ${s.stop_id}</span>` : ''}`;
        div.appendChild(left);
        if (!readonly && s.stop_id) {
          const btn = document.createElement('button');
          btn.className = 'btn';
          btn.textContent = 'V√°laszt';
          btn.addEventListener('click', () => {
            hideChoices();
            loadDeparturesForStop(s);
          });
          div.appendChild(btn);
          // teljes sor kattinthat√≥
          div.addEventListener('click', (e) => {
            if (e.target === btn) return;
            hideChoices();
            loadDeparturesForStop(s);
          });
        }
        list.appendChild(div);
      });
      box.style.display = 'block';
    }
    function hideChoices(){ $('#choices').style.display = 'none'; }

    // indul√°sok + √©l≈ë
    async function loadDeparturesForStop(stop){
      $('#stopTitle').textContent = `Meg√°ll√≥: ${stop.stop_name} ‚Ä¢ (${stop.stop_id})`;
      $('#rows').innerHTML = '';
      $('#resultsWrap').style.display = 'block';

      let data = { results: [] };
      try {
        const r = await fetch(`${apiBase}/api/stops/${encodeURIComponent(stop.stop_id)}/next_departures`);
        data = await r.json();
      } catch (e) { console.error(e); }

      // opcion√°lis: √©l≈ë adat lek√©r√©se a p√∂tty√∂kh√∂z (ha van ilyen endpoint: /api/live/{stop_id})
      let liveByKey = {};
      try {
        const lr = await fetch(`${apiBase}/api/live/${encodeURIComponent(stop.stop_id)}`);
        if (lr.ok) {
          const live = await lr.json(); // te form√°tumodhoz igazodik
          // ha a backend egy list√°t ad vissza, k√©sz√≠t√ºnk egy gyors kulcsv√°laszt (route+time alapj√°n)
          // ez opcion√°lis ‚Äì ha m√°s a form√°tum, a p√∂tty akkor is ‚Äû‚Äì‚Äù lesz
          if (Array.isArray(live)) {
            live.forEach(item => {
              const k = `${item.route}|${item.time_iso}`;
              liveByKey[k] = true;
            });
          }
        }
      } catch (_) {}

      const tbody = $('#rows');
      if (!data.results || data.results.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="center muted">Nincs indul√°s a megadott id≈ët√°vban.</td></tr>`;
        return;
      }

      data.results.forEach(row => {
        const tr = document.createElement('tr');
        const tdR = document.createElement('td'); tdR.textContent = row.route || '';
        const tdD = document.createElement('td'); tdD.textContent = row.destination || '';
        const tdT = document.createElement('td'); tdT.textContent = fmtTime(row.time_iso);
        const tdL = document.createElement('td'); tdL.className = 'center';
        const liveKey = `${row.route}|${row.time_iso}`;
        const isLive = !!row.is_live || !!liveByKey[liveKey];
        tdL.innerHTML = isLive ? 'üü¢' : '‚Äì';

        tr.appendChild(tdR); tr.appendChild(tdD); tr.appendChild(tdT); tr.appendChild(tdL);
        tbody.appendChild(tr);
      });
    }

    function fmtTime(iso){
      try {
        const d = new Date(iso);
        const hh = String(d.getHours()).padStart(2,'0');
        const mm = String(d.getMinutes()).padStart(2,'0');
        return `${hh}:${mm}`;
      } catch { return iso; }
    }

    // init
    loadStatus();
  </script>
</body>
</html>
