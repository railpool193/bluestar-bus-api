<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë</title>
  <style>
    :root{
      --bg:#0b1320; --panel:#11192a; --muted:#8292b4; --txt:#e8eefc;
      --btn:#5b6ef5; --btnh:#6e80ff; --ok:#2ecc71; --no:#ff4d4f; --chip:#1a2440;
      --row:#0f1a30; --row2:#0c172a; --border:#223152;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
      background:linear-gradient(180deg,#0a1020 0%, #0b1320 100%);
      color:var(--txt);
    }
    .wrap{max-width:980px; margin:0 auto; padding:28px 16px 64px}
    h1{font-weight:800; font-size:clamp(28px,4vw,44px); margin:8px 0 24px; line-height:1.15}
    .card{background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:20px; box-shadow:0 12px 30px rgba(0,0,0,.35)}
    label{display:block; color:var(--muted); font-size:14px; margin-bottom:6px}
    input[type="text"], input[type="number"]{
      width:100%; padding:14px 16px; font-size:16px; color:var(--txt);
      background:#0e1730; border:1px solid var(--border); border-radius:12px; outline:none;
    }
    input[type="text"]::placeholder{color:#99a7c7}
    .row{display:grid; gap:16px}
    @media (min-width:760px){ .row{grid-template-columns: 1fr 140px 160px} }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      background:var(--btn); color:#fff; padding:14px 18px; border:none; border-radius:12px; font-weight:700; cursor:pointer;
      box-shadow:0 10px 24px rgba(91,110,245,.35); transition:transform .04s ease, background .15s ease;
    }
    .btn:active{ transform:translateY(1px) }
    .status{display:flex; gap:14px; align-items:center; flex-wrap:wrap; margin-top:14px}
    .dot{width:10px; height:10px; border-radius:50%}
    .badge{display:flex; align-items:center; gap:8px; background:var(--chip); padding:8px 12px; border-radius:999px; color:var(--muted); border:1px solid var(--border)}
    .sel{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
         background:var(--chip); padding:6px 10px; border-radius:10px; border:1px solid var(--border); color:#a9b7de}
    .help{color:var(--muted); font-size:14px; margin-top:8px}
    /* drop */
    .drop{position:relative}
    .menu{
      position:absolute; left:0; right:0; top:calc(100% + 6px); z-index:40;
      background:var(--panel); border:1px solid var(--border); border-radius:12px; overflow:hidden;
      box-shadow:0 16px 40px rgba(0,0,0,.45); max-height:280px; overflow-y:auto;
      display:none;
    }
    .menu.show{display:block}
    .item{padding:12px 14px; cursor:pointer; display:flex; justify-content:space-between; gap:10px}
    .item:hover{background:#0f1f3c}
    .it-name{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .it-id{font-family:ui-monospace,monospace; color:#9eb0dd; background:#0f1a30; padding:2px 8px; border-radius:8px; border:1px solid var(--border)}
    table{width:100%; border-collapse:collapse; margin-top:18px; border:1px solid var(--border); border-radius:14px; overflow:hidden}
    thead{background:#0b1731}
    th,td{padding:14px 12px; text-align:left; border-bottom:1px solid var(--border)}
    tbody tr:nth-child(odd){background:var(--row)}
    tbody tr:nth-child(even){background:var(--row2)}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .empty{padding:18px; text-align:center; color:var(--muted)}
    .bus{font-size:32px; margin-right:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üöå Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë</h1>

    <div class="card" id="card">
      <div class="row">
        <div class="drop">
          <label>Meg√°ll√≥ n√©v (pl. ‚ÄûVincent‚Äù)</label>
          <input id="q" type="text" placeholder="Kezdj el √≠rni‚Ä¶" autocomplete="off" />
          <div id="menu" class="menu"></div>
        </div>

        <div>
          <label>Id≈ëablak (perc)</label>
          <input id="mins" type="number" min="5" max="240" step="5" value="60" />
        </div>

        <div style="align-self:end">
          <button id="go" class="btn">Keres√©s</button>
        </div>
      </div>

      <div class="status">
        <span class="badge"><span id="apiDot" class="dot" style="background:var(--no)"></span> API</span>
        <span class="badge"><span id="gtfsDot" class="dot" style="background:var(--no)"></span> GTFS</span>
        <span class="badge"><span id="liveDot" class="dot" style="background:var(--no)"></span> Live</span>
        <span class="badge">V√°lasztott meg√°ll√≥ ID: <span id="sel" class="sel">‚Äì</span></span>
      </div>

      <p class="help">Tipp: g√©peld be a meg√°ll√≥ nev√©t, majd kattints egy tal√°latra. Ezut√°n nyomd meg a Keres√©s gombot vagy az Entert.</p>
    </div>

    <div id="out" class="card" style="margin-top:18px; display:none"></div>
  </div>

<script>
const api = (p)=> `${location.origin}${p}`;
const $ = (id)=> document.getElementById(id);

const q = $("q");
const menu = $("menu");
const mins = $("mins");
const go = $("go");
const out = $("out");
const sel = $("sel");

let chosenStop = null;
let lastQuery = "";
let typingTimer;

function setDots(ok){
  $("apiDot").style.background = ok ? "var(--ok)" : "var(--no)";
}
function setFlag(id, ok){
  $(id).style.background = ok ? "var(--ok)" : "var(--no)";
}

async function loadStatus(){
  try{
    const r = await fetch(api("/api/status"));
    if(!r.ok) throw 0;
    const s = await r.json();
    setDots(true);
    setFlag("gtfsDot", !!s.gtfs);
    setFlag("liveDot", !!s.live);
  }catch{
    setDots(false);
    setFlag("gtfsDot", false);
    setFlag("liveDot", false);
  }
}

// --- search drop ---
function showMenu(items){
  if(!items.length){ menu.classList.remove("show"); return; }
  menu.innerHTML = items.map(it=>`
    <div class="item" data-id="${it.stop_id}">
      <span class="it-name">${it.stop_name || "(n√©vtelen meg√°ll√≥)"}</span>
      <span class="it-id">${it.stop_id}</span>
    </div>`).join("");
  menu.classList.add("show");
}
menu.addEventListener("click", (e)=>{
  const el = e.target.closest(".item");
  if(!el) return;
  chosenStop = { id: el.dataset.id, name: el.querySelector(".it-name").textContent };
  q.value = chosenStop.name;
  sel.textContent = chosenStop.id;
  menu.classList.remove("show");
});
document.addEventListener("click", (e)=>{
  if(!e.target.closest(".drop")) menu.classList.remove("show");
});

q.addEventListener("input", ()=>{
  const v = q.value.trim();
  chosenStop = null;
  sel.textContent = "‚Äì";
  clearTimeout(typingTimer);
  typingTimer = setTimeout(async ()=>{
    if(v.length < 2 || v === lastQuery){ menu.classList.remove("show"); return; }
    lastQuery = v;
    try{
      const r = await fetch(api(`/api/stops/search?q=${encodeURIComponent(v)}`));
      const data = r.ok ? await r.json() : [];
      showMenu(data.slice(0, 20));
    }catch{ showMenu([]); }
  }, 180);
});
q.addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){ e.preventDefault(); run(); }
});

// --- fetch departures ---
async function run(){
  const m = Math.max(5, Math.min(240, parseInt(mins.value||"60",10)));
  mins.value = m;
  if(!chosenStop || !chosenStop.id){
    q.focus();
    q.select();
    return;
  }
  out.style.display = "block";
  out.innerHTML = `<div class="empty">Lek√©r√©s‚Ä¶</div>`;
  try{
    const r = await fetch(api(`/api/stops/${encodeURIComponent(chosenStop.id)}/next_departures?minutes=${m}`));
    if(!r.ok) throw 0;
    const items = await r.json();
    if(!items.length){
      out.innerHTML = `<div class="empty">Nincs tal√°lat a k√∂vetkez≈ë ${m} percben.</div>`;
      return;
    }
    const rows = items.map(it=>`
      <tr>
        <td class="right"><strong>${it.route || ""}</strong></td>
        <td>${it.destination || ""}</td>
        <td class="right">${it.time || ""}</td>
        <td class="right">${it.live || "‚Äì"}</td>
      </tr>`).join("");
    out.innerHTML = `
      <table>
        <thead><tr><th>J√°rat</th><th>C√©l</th><th class="right">Indul√°s</th><th class="right">√âl≈ë</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
  }catch{
    out.innerHTML = `<div class="empty">Hiba t√∂rt√©nt a lek√©r√©sn√©l.</div>`;
  }
}
go.addEventListener("click", run);

// start
loadStatus();
</script>
</body>
</html>
