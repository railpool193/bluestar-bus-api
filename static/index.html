<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f172a;--card:#111827;--txt:#e5e7eb;--muted:#9ca3af;--accent:#60a5fa;
      --ok:#22c55e;--bad:#ef4444;--chip:#1f2937;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0c1324 60%,#0b1328);}
    .wrap{max-width:980px;margin:24px auto;padding:16px;}
    h1{color:#fff;font-weight:800;letter-spacing:.2px;margin:0 0 20px;display:flex;align-items:center;gap:10px}
    h1 .bus{font-size:28px}
    .panel{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:18px;color:var(--txt);box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:flex;flex-wrap:wrap;gap:14px;align-items:center}
    .grow{flex:1}
    input[type=text],input[type=number]{width:100%;padding:14px 16px;border-radius:12px;border:1px solid #243244;background:#0b1220;color:var(--txt);font-size:16px;outline:none}
    input[type=text]::placeholder{color:var(--muted)}
    .btn{background:#4f46e5;border:none;color:#fff;padding:14px 18px;border-radius:12px;font-weight:700;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .pills{display:flex;gap:8px;margin-top:12px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:var(--chip);color:var(--txt);font-size:14px}
    .dot{width:10px;height:10px;border-radius:50%}
    .ok{background:var(--ok)} .bad{background:var(--bad)}
    .hint{color:var(--muted);font-size:14px;margin-top:12px}
    table{width:100%;border-collapse:collapse;margin-top:16px;overflow:hidden;border-radius:14px;border:1px solid #1f2937}
    th,td{padding:14px 12px;text-align:left;color:var(--txt)}
    th{background:#0e172a;color:#cbd5e1;font-weight:700}
    tr:nth-child(even){background:#0b1220}
    tr:nth-child(odd){background:#0a1020}
    .empty{color:#cbd5e1;padding:18px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:#0b1220;border:1px solid #23314b;color:#9ec0ff}
    /* v√°laszt√≥ modal */
    dialog{border:none;border-radius:16px;padding:0;max-width:620px;width:92%}
    .modal{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:12px}
    .modal h3{margin:6px 10px 10px;color:#fff}
    .opt{padding:12px;border-radius:10px;cursor:pointer;color:#e5e7eb;border:1px solid #1f2937;background:#0b1220;margin:8px}
    .opt:hover{background:#0d162a}
    @media (max-width:640px){ .row{flex-direction:column;align-items:stretch} .btn{width:100%} }
  </style>
</head>
<body>
  <div class="wrap">
    <h1><span class="bus">üöå</span> Bluestar Bus ‚Äì meg√°ll√≥ & j√°rat keres≈ë</h1>

    <div class="panel">
      <div class="row">
        <div class="grow">
          <label>Meg√°ll√≥ n√©v (pl. ‚ÄûVincent‚Äù)</label>
          <input id="q" type="text" placeholder="Kezdj el √≠rni‚Ä¶">
        </div>
        <div>
          <label>Id≈ëablak (perc)</label>
          <input id="mins" type="number" value="60" min="5" max="240">
        </div>
        <div style="align-self:flex-end">
          <button id="btn" class="btn">Keres√©s</button>
        </div>
      </div>

      <div class="pills" id="status">
        <span class="pill"><span class="dot" id="apiDot"></span>API</span>
        <span class="pill"><span class="dot" id="gtfsDot"></span>GTFS</span>
        <span class="pill"><span class="dot" id="liveDot"></span>Live</span>
      </div>

      <div class="hint">
        V√°lasztott meg√°ll√≥ ID: <span class="badge" id="chosen">‚Äì</span>
      </div>
    </div>

    <div id="results" class="panel" style="margin-top:18px; display:none"></div>
  </div>

  <!-- v√°laszt√≥ modal -->
  <dialog id="chooser">
    <div class="modal">
      <h3>T√∂bb meg√°ll√≥ is van erre a n√©vre. V√°lassz egyet:</h3>
      <div id="options"></div>
    </div>
  </dialog>

  <script>
    const api = (p) => p.startsWith('/') ? p : ('/' + p);

    async function loadStatus() {
      try {
        const r = await fetch(api('api/status'));
        const s = await r.json();
        setDot('apiDot', true);
        setDot('gtfsDot', !!s.gtfs);
        setDot('liveDot', !!s.live);
      } catch (_) {
        setDot('apiDot', false);
        setDot('gtfsDot', false);
        setDot('liveDot', false);
      }
    }

    function setDot(id, ok) {
      const el = document.getElementById(id);
      el.className = 'dot ' + (ok ? 'ok':'bad');
    }

    async function searchStops(q){
      const r = await fetch(api('api/stops/search?q=') + encodeURIComponent(q));
      return await r.json();
    }

    async function getDeps(stopId, mins){
      const r = await fetch(api(`api/stops/${encodeURIComponent(stopId)}/next_departures?minutes=${mins}`));
      return await r.json();
    }

    function renderTable(rows){
      const box = document.getElementById('results');
      box.style.display = 'block';
      if(!rows || rows.length === 0){
        box.innerHTML = `<div class="empty">Nincs tal√°lat.</div>`;
        return;
      }
      const head = `
        <table>
          <thead><tr><th>J√°rat</th><th>C√©l</th><th>Indul√°s</th><th>√âl≈ë</th></tr></thead>
          <tbody>
      `;
      const body = rows.map(r => `
        <tr>
          <td>${escapeHtml(r.route || '')}</td>
          <td>${escapeHtml(r.destination || '')}</td>
          <td>${escapeHtml(r.time || '')}</td>
          <td>${r.live === true ? '‚úî' : (r.live === false ? '‚Äî' : '‚Äì')}</td>
        </tr>
      `).join('');
      box.innerHTML = head + body + '</tbody></table>';
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

    async function startSearch(){
      const q = document.getElementById('q').value.trim();
      const mins = Math.max(5, Math.min(240, parseInt(document.getElementById('mins').value || '60',10)));
      if(!q){ alert('√çrj be meg√°ll√≥ nevet!'); return; }

      const stops = await searchStops(q);
      if(stops.length === 0){
        alert('Nincs tal√°lat erre a n√©vre.');
        return;
      }
      if(stops.length === 1){
        pickStop(stops[0], mins);
        return;
      }
      // t√∂bb tal√°lat ‚Äì modal
      const dlg = document.getElementById('chooser');
      const box = document.getElementById('options');
      box.innerHTML = '';
      stops.slice(0,50).forEach(s=>{
        const div = document.createElement('div');
        div.className='opt';
        div.textContent = `${s.stop_name} (${s.stop_id})`;
        div.onclick = ()=>{ dlg.close(); pickStop(s, mins); };
        box.appendChild(div);
      });
      dlg.showModal();
    }

    async function pickStop(s, mins){
      document.getElementById('chosen').textContent = s.stop_id;
      const deps = await getDeps(s.stop_id, mins);
      renderTable(deps);
    }

    document.getElementById('btn').addEventListener('click', startSearch);
    document.getElementById('q').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ startSearch(); } });

    loadStatus();
  </script>
</body>
</html>
